<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gerador de Encartes Profissional (Corrigido)</title>
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Anton&amp;family=Inter:wght@400;700;900&amp;family=Oswald:wght@700&amp;family=Roboto:wght@700&amp;family=Orbitron:wght@700&amp;display=swap" rel="stylesheet"/>
<style>
        body { font-family: 'Inter', sans-serif; }
        .font-anton { font-family: 'Anton', sans-serif; }
        .font-oswald { font-family: 'Oswald', sans-serif; }
        .font-roboto { font-family: 'Roboto', sans-serif; }
        .font-orbitron { font-family: 'Orbitron', sans-serif; }
        textarea { resize: vertical; }
        #controlPanelContainer::-webkit-scrollbar { display: none; }
        #controlPanelContainer { -ms-overflow-style: none; scrollbar-width: none; }
        .dragging { opacity: 0.5; }
        .drag-over { border-style: dashed; background-color: rgba(37, 99, 235, 0.1); }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 0.25rem; }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #ddd; border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #1D4ED8; border-radius: 50%; cursor: pointer; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; color: #1f2937; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 90%; max-width: 400px; text-align: center; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .dark .modal-content { background-color: #1f2937; color: #f3f4f6; }
        .template-preview-card { border: 2px solid transparent; transition: border-color 0.2s; }
        .template-preview-card.selected { border-color: #3b82f6; box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
		
		
		/* Em telas com 768px ou mais de largura (tablets e desktops)... */
@media (min-width: 768px) {
  /* ...quando o painel estiver aberto (body com a classe 'panel-is-open')... */
  body.panel-is-open #mainContent {
    /* ...aplique a margem para empurrar a área de visualização para o lado. */
    margin-left: 24rem;
  }
}



 /* ▼▼▼ COLE O NOVO BLOCO DE CÓDIGO AQUI ▼▼▼ */
    #password-overlay {
        background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.5)), url('https://i.imgur.com/bnFSlSc.jpeg');
		        background-size: cover;
        background-position: center;
    }
    /* ▲▲▲ FIM DO BLOCO NOVO ▲▲▲ */
	
	
	
	/* ▼▼▼ NOVO ESTILO PARA A BUSCA DE IMAGENS ▼▼▼ */
    #imageSearchResults .result-item {
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
    }
    #imageSearchResults .result-item:hover {
        transform: scale(1.05);
        border-color: #60a5fa; /* Azul claro */
    }
    #imageSearchResults .result-item.selected {
        border-color: #2563eb; /* Azul forte */
        box-shadow: 0 0 10px rgba(37, 99, 235, 0.7);
    }
    /* ▲▲▲ FIM DO NOVO ESTILO ▲▲▲ */
		
		
    </style>
</head>
<body class="bg-gray-200 dark:bg-gray-900 text-gray-800 dark:text-gray-200"><div class="relative h-screen w-screen flex">

<div id="password-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm text-center flex flex-col">

        <img src="https://i.imgur.com/UNNOiNU.png" alt="Logo do Sistema" class="h-34 w-auto mx-auto mb-6 object-contain">

        <h2 class="text-2xl font-bold text-white mb-4">Acesso Restrito</h2>
        <p class="text-gray-400 mb-6">Por favor, insira a senha para continuar.</p>

        <input type="password" id="password-input" class="w-full bg-gray-700 text-white p-3 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="********">

        <div class="flex items-center justify-start mt-4">
            <label for="remember-me" class="flex items-center cursor-pointer">
                <input id="remember-me" type="checkbox" class="h-4 w-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500 focus:ring-offset-gray-800">
                <span class="ml-2 text-sm text-gray-400">Lembrar de mim</span>
            </label>
        </div>
        <button id="password-submit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
            Entrar
        </button>
        <p id="password-error" class="text-red-500 text-sm mt-3 h-4"></p>

        <div class="mt-8 pt-4 border-t border-gray-700 text-center">
            <p class="text-xs text-gray-500 mb-2">Desenvolvido por:</p>
            <img src="https://i.imgur.com/iG789VV.png" alt="Logo do Desenvolvedor" class="h-14 w-auto mx-auto object-contain">
        </div>
        </div>
</div>



<div class="relative z-30 flex-shrink-0 flex items-center h-full">
<nav class="bg-gray-800 dark:bg-gray-900 text-white flex flex-col items-center p-1 space-y-1 shadow-lg rounded-r-2xl h-full overflow-y-auto">
<h2 class="text-lg font-bold text-white mb-1">Encartes</h2>


<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-format-list" href="#">
    <svg class="h-4 w-4 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.25 22.5l-.648-1.938a3.375 3.375 0 00-2.6-2.6L11.25 18l1.938-.648a3.375 3.375 0 002.6-2.6l.648-1.938 1.938.648a3.375 3.375 0 002.6 2.6l.648 1.938-1.938.648a3.375 3.375 0 00-2.6 2.6z"></path>
    </svg>
    <span class="text-xs">Formatar Lista</span>
</a>


<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-pages" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" stroke-linecap="round" stroke-linejoin="round"></path></svg>
<span class="text-xs">Páginas</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-layout" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span class="text-xs">Layout</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-add-product" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span class="text-xs">Produtos</span>
</a>




<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-product-list" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span class="text-xs">No Encarte</span>
</a>

<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-price-update" href="#">
    <svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 8h6m-5 4h4m5 6H5a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
    <span class="text-xs">Atualizar Preços</span>
</a>

<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-price-tag" href="#">
    <svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M7 7h.01M7 3h5a2 2 0 012 2v5a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2zm10 14h.01M17 11h5a2 2 0 012 2v5a2 2 0 01-2 2h-5a2 2 0 01-2-2v-5a2 2 0 012-2z" stroke-linecap="round" stroke-linejoin="round"></path>
    </svg>
    <span class="text-xs">Cartaz Preço</span>
</a>


<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-margins" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" stroke-linecap="round" stroke-linejoin="round"></path> </svg>
<span class="text-xs">Margens</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-logos" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke-linecap="round" stroke-linejoin="round"></path><path d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"></path></svg>
<span class="text-xs">Logos</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-images" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"></path></svg>
<span class="text-xs">Imagens</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-fonts" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 7v10m0 0h16M4 17h16M12 3v14M5 7h14" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span class="text-xs">Fontes</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-custom-fonts" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
<span class="text-xs">Fontes Custom</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-themes" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span class="text-xs">Balões</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-validity" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg>
<span class="text-xs">Data Val.</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-header-validity" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"></path>
<path d="M3 10h18" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
<span class="text-xs">Val. Topo</span>
</a>

<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-stock" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4H5z" stroke-linecap="round" stroke-linejoin="round"></path>
<path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
<span class="text-xs">Estoque</span>
</a>
<a class="menu-item p-1 rounded-lg w-full flex flex-col items-center hover:bg-gray-700" data-panel="panel-projects" href="#">
<svg class="h-4 w-4 mb-1" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
<span class="text-xs">Projetos</span>
</a>
</nav>
</div>
<div class="fixed inset-0 z-10 hidden" id="menuBackdrop"></div>
<aside class="flex-shrink-0 h-full w-0 bg-white dark:bg-gray-800 shadow-lg overflow-y-auto z-20 transition-all duration-300 ease-in-out -translate-x-full" id="controlPanelContainer">
<div class="w-60 md:w-96 p-6">
<div class="panel space-y-6" id="panel-pages">
<h3 class="text-2xl font-bold border-b pb-2">Gerenciar Páginas</h3>
<div class="space-y-2">
<button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" id="addPageBtn">Adicionar Nova Página</button>
</div>
<div class="flex items-center gap-2 mt-2 hidden" id="useFirstPageBgContainer">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="useFirstPageBg" type="checkbox"/>
<label class="text-sm font-medium" for="useFirstPageBg">Usar fundo da 1ª página</label>
</div>
<div class="pt-2">
<button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-sm" id="applyP2BackgroundBtn">
        Usar Fundo da Pág. 2 (para Pág. 3+)
    </button>
</div>


<div class="pt-2">
    <button class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg text-sm" id="applyFontsToAllOthersBtn">
        Aplicar Fontes Atuais (para Pág. 2+)
    </button>
	
	
</div>

<div class="pt-4 mt-4 border-t border-gray-600 space-y-3 bg-gray-700/50 p-3 rounded-lg">
    <h4 class="text-base font-bold text-center text-cyan-400">Aplicar Estilo Mestre</h4>
    <p class="text-xs text-center text-gray-400 -mt-2 mb-2">
        Copie o estilo de uma página de origem para páginas de destino específicas.
    </p>

    <div>
        <label for="masterPageSelect" class="block text-sm font-medium mb-1">
            1. Usar estilo da página:
        </label>
        <select id="masterPageSelect" class="w-full bg-gray-50 dark:bg-gray-800 border rounded-lg p-2 text-sm">
            </select>
    </div>

    <div>
        <label class="block text-sm font-medium mb-1">
            2. Aplicar nas páginas:
        </label>
        <div id="targetPagesContainer" class="max-h-40 overflow-y-auto space-y-1 p-2 rounded-lg bg-gray-900 border border-gray-600">
            </div>
        <div class="grid grid-cols-2 gap-2 mt-2">
             <button id="selectAllTargetsBtn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-1 px-2 rounded-lg text-xs">
                Marcar Todas
            </button>
            <button id="deselectAllTargetsBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-1 px-2 rounded-lg text-xs">
                Desmarcar Todas
            </button>
        </div>
    </div>

    <button id="applyMasterSettingsBtn" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg text-sm">
        Aplicar Estilo nas Páginas Marcadas
    </button>
</div>

  <div class="pt-4 mt-4 border-t border-gray-600">
         <button class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="applyPosterLayoutToAllBtn">
            Aplicar Layout do Cartaz (p/ outros)
        </button>
    </div>

<div class="space-y-2">
<label class="block text-sm font-medium">Páginas do Encarte:</label>
<div class="space-y-2 max-h-60 overflow-y-auto" id="pageListContainer">
</div>
</div>
<div class="pt-4 border-t">
<button class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" id="deletePageBtn">Deletar Página Atual</button>
</div>
<div class="pt-4 border-t border-green-500">
<h4 class="text-lg font-semibold text-center mb-2 text-green-400">Otimização</h4>
<button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="adaptForSocialMediaBtn">
        Adaptar Encarte para Redes Sociais
    </button>
</div>
<div class="pt-6 mt-auto grid grid-cols-1 gap-4">
<button class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="downloadBtn">Baixar Página Atual</button>
<button class="w-full bg-green-900 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="downloadAllBtn">Baixar TODAS as Páginas</button>
<button class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg mt-2" id="downloadPdfBtn">Baixar Página em PDF</button>
<button class="w-full bg-red-900 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg mt-2" id="downloadPdfAllBtn">Baixar TODAS as Páginas em PDF</button>
<button class.="w-full bg-cyan-700 hover:bg-cyan-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg mt-2" id="exportPostersPdfBtn">Baixar CARTAZES de Preço (PDF)</button>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-layout">
<h3 class="text-2xl font-bold border-b pb-2">Layout e Fundo</h3>
<div>
<label class="block text-sm font-medium mb-1" for="pageSize">Formato do Encarte</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="pageSize">
<option value="1080x1080">Feed (quadrado) 1:1</option>
<option selected="" value="1080x1350">Feed (vertical) 4:5</option>
<option selected="" value="1769x2212 ">Instagram</option>
<option value="1080x1920">Stories/Reels 9:16</option>
<option value="1843x966">Feed (paisagem) 1.91:1</option>
<option value="2953x4134">Tabloide (25x35cm)</option>
<option value="custom">Customizado (px)</option>
</select>
</div>
<div class="hidden grid grid-cols-2 gap-4" id="custom-size-inputs">
<div>
<label class="block text-xs font-medium mb-1" for="customWidth">Largura (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="customWidth" type="number" value="1080"/>
</div>
<div>
<label class="block text-xs font-medium mb-1" for="customHeight">Altura (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="customHeight" type="number" value="1350"/>
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="predefinedLayoutSelect">Grades Pré-definidas</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="predefinedLayoutSelect">
    <option value="manual">Manual</option>
    <optgroup label="Layouts Pequenos (4-8 Produtos)">
        <option value="2x2">4 Produtos - Grade 2x2</option>
        <option value="5_4_1d">5 Produtos - 4 + 1 Destaque Direito</option>
        <option value="5_4_1e">5 Produtos - 4 + 1 Destaque Esquerdo</option>
		<option value="5_4_1c_center">5 Produtos - 4 + 1 Destaque Central</option>
        <option value="3x2">6 Produtos - Grade 3x2</option>
		        <option value="7_1t_6">7 Produtos - 1 Destaque Topo + 6</option>
				<option value="7_1c_6">7 Produtos - 1 Destaque central + 6</option>
        <option value="7_3t_4">7 Produtos - 3 Destaques Topo + 4</option>
        <option value="7_4_3b">7 Produtos - 4 + 3 Destaques Abaixo</option>
        <option value="7_1l_6">7 Produtos - 1 Destaque Lateral + 6</option>
        <option value="4x2">8 Produtos - Grade 4x2</option>
        <option value="8_5_3b">8 Produtos - 5 + 3 Destaques Abaixo</option>
        <option value="8_3t_5">8 Produtos - 3 Destaques Topo + 5</option>
    </optgroup>
    <optgroup label="Layouts Médios (9-15 Produtos)">
        <option value="3x3">9 Produtos - Grade 3x3</option>
        <option value="10_1t_9">10 Produtos - 1 Destaque Topo + 9</option>
        <option value="11_3t_8">11 Produtos - 3 Destaques Topo + 8</option>
        
        <option value="3x4">12 Produtos - Grade 3x4</option>
        <option value="12_4t_8">12 Produtos - 4 Destaques Topo + 8</option>
        <option value="12_8_4b">12 Produtos - 8 + 4 Destaques Abaixo</option>
        <option value="14_13_1tc">14 Produtos - Grade 3x5 (Destaque Topo Central)</option>
        <option value="14_13_1bc">14 Produtos - Grade 3x5 (Destaque Abaixo Central)</option>
        <option value="14_2d_12">14 Produtos - 2 Destaques + Grade 4x3</option>
        <option value="15_3d_12">15 Produtos - 3 Destaques + Grade 4x3</option>
    </optgroup>
    <optgroup label="Layouts Grandes (16+ Produtos)">
        <option value="4x4">16 Produtos - Grade 4x4</option>
        <option value="17_1t_16">17 Produtos - 1 Destaque Topo + 4x4</option>
        <option value="18_2t_16">18 Produtos - 2 Destaques Topo + 4x4</option>
        <option value="18_4t_14">18 Produtos - 4 Destaques Topo + 14</option>
        <option value="18_14_4b">18 Produtos - 14 + 4 Destaques Abaixo</option>
        <option value="19_3t_16">19 Produtos - 3 Destaques Topo + 4x4</option>
        <option value="4x5">20 Produtos - Grade 4x5</option>
        <option value="21_1t_20">21 Produtos - 1 Destaque Topo + 4x5</option>
        <option value="22_2t_20">22 Produtos - 2 Destaques Topo + 4x5</option>
        <option value="23_3t_20">23 Produtos - 3 Destaques Topo + 4x5</option>
        <option value="26_2t_24">26 Produtos - 2 Destaques Topo + 4x6</option>
        <option value="29_3t_8c_18">29 Produtos - Grade 3x6 (Complexo)</option>
        <option value="30_3l_24_3r">30 Produtos - 3 Laterais + 24 + 3 Laterais</option>
    </optgroup>
</select>
</div>
<div class="hidden" id="predefined-border-style-container">
    <label class="block text-sm font-medium mb-1" for="predefinedBorderStyle">Estilo da Borda (Grade)</label>
    <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="predefinedBorderStyle">
        <option value="straight">Reta</option>
        <option value="rounded">Arredondada</option>
        <option value="dashed">Pontilhada Reta</option>
        <option value="dashed-rounded">Pontilhada Arredondada</option>
        <option value="none">Sem Borda</option>
    </select>
</div>
<div id="manual-layout-controls">
<label class="block text-sm font-medium mb-2">Estrutura das Linhas (Manual)</label>
<div class="space-y-4 border-b pb-4 mb-4">
<div class="flex items-center gap-2">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="highlightFirstLine" type="checkbox"/>
<label class="text-sm font-medium" for="highlightFirstLine">Destacar primeira linha</label>
</div>
<div class="hidden space-y-4" id="highlight-color-container">
<div>
<label class="block text-sm font-medium mb-1" for="highlightColor">Cor do Destaque</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="highlightColor" type="color" value="#FFFF00"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="highlightStyleSelect">Estilo do Destaque</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5 text-sm" id="highlightStyleSelect">
<option value="individual">Slots Separados</option>
<option value="unified">Bloco Único</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="highlightHeightMultiplier">
            Tamanho da Linha Destacada: <span class="font-bold text-blue-500" id="highlightMultiplierValue">1.4x</span>
</label>
<input class="w-full" id="highlightHeightMultiplier" max="2.5" min="1.0" step="0.1" type="range" value="1.4"/>
</div>
</div>
<div class="hidden flex items-center gap-2 mt-2" id="highlight-no-border-container">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="highlightNoBorder" type="checkbox"/>
<label class="text-sm font-medium" for="highlightNoBorder">Remover borda da linha destacada</label>
</div>
</div>
<div class="space-y-3" id="line-layout-container">
</div>
<button class="w-full mt-2 text-sm bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 py-1 px-2 rounded-lg" id="addLineBtn">+ Adicionar nova linha</button>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
<div class="flex items-center gap-2">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableSlotBorder" type="checkbox"/>
<label class="text-sm font-medium" for="enableSlotBorder">Mudar Cor da Borda</label>
</div>
<div class="hidden" id="slot-color-container">
<label class="block text-sm font-medium mb-1" for="slotColor">Cor da Borda</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="slotColor" type="color" value="#007c11"/>
</div>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
<h4 class="text-lg font-semibold -mb-2">Fundo do Produto</h4>
<div class="flex items-center gap-2">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableSlotBackground" type="checkbox"/>
<label class="text-sm font-medium" for="enableSlotBackground">Ativar Fundo do Produto</label>
</div>
<div class="space-y-2" id="slot-background-options">
<div>
<label class="block text-sm font-medium mb-1" for="slotBackgroundColor">Cor do Fundo Padrão</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="slotBackgroundColor" type="color" value="#FFFFFF"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="slotBackgroundOpacity">Opacidade do Fundo (%)</label>
<input class="w-full" id="slotBackgroundOpacity" max="100" min="0" type="range" value="100"/>
</div>
</div>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
<label class="block text-sm font-medium" for="imageAreaScale">Tamanho da Área da Imagem (%)</label>
<input class="w-full" id="imageAreaScale" max="100" min="10" type="range" value="100"/>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700">
<label class="block text-sm font-medium mb-1" for="backgroundImage">Imagem de Fundo (Opcional)</label>
<input accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-gray-700 dark:file:text-gray-300 file:text-blue-700 hover:file:bg-blue-100" id="backgroundImage" type="file"/>
</div>
<div class="pt-6 border-t mt-6">
<button class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="applyLayoutToAllOthersBtn">
                            Aplicar Layout Atual (para Pág. 2+)
                        </button>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-margins">
<h3 class="text-2xl font-bold border-b pb-2">Margens</h3>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium mb-1" for="topMargin">Margem Topo (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="topMargin" min="0" type="number" value="375"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="lateralSpacing">Margem Lados (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="lateralSpacing" min="0" type="number" value="40"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerSpacing">Margem Rodapé (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerSpacing" min="0" type="number" value="100"/>
</div>
</div>
</div>



<div class="panel hidden space-y-6" id="panel-logos">
    <h3 class="text-2xl font-bold border-b pb-2">Logos &amp; Slogan</h3>
    
    <div class="space-y-3 pt-2">
        <label class="block text-sm font-medium" for="promoLogoInput">Logo da Promoção (esquerda)</label>
        <input accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-gray-700 dark:file:text-gray-300 file:text-blue-700 hover:file:bg-blue-100" id="promoLogoInput" type="file">
        <div class="grid grid-cols-3 gap-2">
            <div>
                <label class="block text-xs font-medium" for="promoLogoWidth">Largura</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="promoLogoWidth" min="10" type="number" value="200">
            </div>
            <div>
                <label class="block text-xs font-medium" for="promoLogoX">Posição X</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="promoLogoX" type="number" value="40">
            </div>
            <div>
                <label class="block text-xs font-medium" for="promoLogoY">Posição Y</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="promoLogoY" type="number" value="40">
            </div>
        </div>
    </div>

    <div class="space-y-3 pt-4 border-t border-gray-600">
        <label class="block text-sm font-medium" for="storeLogoInput">Logo da Loja (direita)</label>
        <input accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-gray-700 dark:file:text-gray-300 file:text-blue-700 hover:file:bg-blue-100" id="storeLogoInput" type="file">
        <div class="grid grid-cols-3 gap-2">
            <div>
                <label class="block text-xs font-medium" for="storeLogoWidth">Largura</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="storeLogoWidth" min="10" type="number" value="200">
            </div>
            <div>
                <label class="block text-xs font-medium" for="storeLogoX">Posição X</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="storeLogoX" type="number" value="840">
            </div>
            <div>
                <label class="block text-xs font-medium" for="storeLogoY">Posição Y</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="storeLogoY" type="number" value="40">
            </div>
        </div>
    </div>

    <div class="space-y-3 pt-4 border-t border-gray-600">
        <label class="block text-sm font-medium" for="complementaryLogoInput">Imagem de Complemento</label>
        <input accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-gray-700 dark:file:text-gray-300 file:text-blue-700 hover:file:bg-blue-100" id="complementaryLogoInput" type="file">
        <div class="grid grid-cols-3 gap-2">
            <div>
                <label class="block text-xs font-medium" for="complementaryLogoWidth">Largura</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="complementaryLogoWidth" min="10" type="number" value="150">
            </div>
            <div>
                <label class="block text-xs font-medium" for="complementaryLogoX">Posição X</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="complementaryLogoX" type="number" value="440">
            </div>
            <div>
                <label class="block text-xs font-medium" for="complementaryLogoY">Posição Y</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="complementaryLogoY" type="number" value="50">
            </div>
        </div>
    </div>
    
    <div class="space-y-4 pt-4 border-t border-gray-600">
        <div class="flex items-center gap-2">
            <input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableSlogan" type="checkbox">
            <label class="text-sm font-medium" for="enableSlogan">Ativar Slogan da Promoção</label>
        </div>
        <div class="hidden space-y-4" id="slogan-options">
            <div>
                <label class="block text-sm font-medium" for="sloganText">Texto do Slogan</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="sloganText" type="text" value="OFERTAS ARRASADORAS">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium" for="sloganPositionX">Posição X (px)</label>
                    <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="sloganPositionX" type="number" value="540">
                </div>
                <div>
                    <label class="block text-sm font-medium" for="sloganPositionY">Posição Y (px)</label>
                    <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="sloganPositionY" type="number" value="150">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="sloganFontFamily">Fonte do Slogan</label>
                <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="sloganFontFamily">
                    <optgroup label="Fontes Padrão">
                        <option value="Anton">Anton</option>
                        <option value="Oswald">Oswald</option>
                        <option value="Inter">Inter</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Amsi Pro Bold">Amsi Pro Bold</option>
                    </optgroup>
                    <optgroup id="custom-fonts-slogan" label="Fontes Customizadas"></optgroup>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium" for="sloganFontSize">Tamanho (px)</label>
                    <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="sloganFontSize" type="number" value="60">
                </div>
                <div>
                    <label class="block text-sm font-medium" for="sloganColor">Cor da Fonte</label>
                    <input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="sloganColor" type="color" value="#e63946">
                </div>
            </div>
            <div class="flex items-center gap-2 pt-4 border-t border-gray-600">
                <input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableSloganBorder" type="checkbox">
                <label class="text-sm font-medium" for="enableSloganBorder">Ativar Contorno no Slogan</label>
            </div>
            <div class="hidden space-y-4" id="slogan-border-color-container">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium" for="sloganBorderWidth">Espessura</label>
                        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="sloganBorderWidth" type="number" value="4">
                    </div>
                    <div>
                        <label class="block text-sm font-medium" for="sloganBorderColor">Cor do Contorno</label>
                        <input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="sloganBorderColor" type="color" value="#000000">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="panel hidden space-y-6" id="panel-images">
    <h3 class="text-2xl font-bold border-b pb-2">Editor de Produto Selecionado</h3>
    <div>
        <label class="block text-sm font-medium mb-1">Selecione um ou mais Produtos</label>
        <div class="max-h-60 overflow-y-auto space-y-2 p-2 rounded-lg ..." id="productMultiSelectContainer">
            </div>

        
		<div class="grid grid-cols-2 gap-2 mt-2">
    <button id="selectAllProductsBtn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-1 px-2 rounded-lg text-xs">
        Selecionar Todos
    </button>
    <button id="deselectAllProductsBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-1 px-2 rounded-lg text-xs">
        Desselecionar Todos
    </button>
</div>
		
        </div>
    <div class="hidden space-y-4 pt-4 ..." id="image-controls-container">
        
        <h4 class="text-md font-semibold -mb-2 text-blue-400">Controle de Imagem</h4>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1" for="imageRepetitions">Repetições</label>
                <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="imageRepetitions" min="1" type="number" value="1"/>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="imageRepetitionDirection">Direção da Repetição</label>
                <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="imageRepetitionDirection">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                </select>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1" for="imagePositionX">Posição Horizontal (%)</label>
                <input class="w-full" id="imagePositionX" max="100" min="0" type="range" value="50"/>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="imagePositionY">Posição Vertical (%)</label>
                <input class="w-full" id="imagePositionY" max="100" min="0" type="range" value="50"/>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="imageFit">Ajuste Individual</label>
            <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="imageFit">
                <option value="contain">Conter (Manter Proporção)</option>
                <option value="cover">Preencher (Manter Proporção)</option>
                <option value="fill">Distorcer (Preencher Slot)</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="imageWidthPercent">Largura Imagem (%)</label>
            <input class="w-full" id="imageWidthPercent" max="200" min="1" type="range" value="100"/>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="imageHeightPercent">Altura Imagem (%)</label>
            <input class="w-full" id="imageHeightPercent" max="200" min="1" type="range" value="100"/>
        </div>

        <div class="pt-4 border-t border-gray-600">
    <h4 class="text-md font-semibold -mb-2 text-blue-400">Controle de Texto (Selecionado)</h4>
    <div class="grid grid-cols-2 gap-x-4 pt-2 mt-2 border-t">

        <div>
            <label class="block text-xs font-medium" for="descScaleX">Largura Descrição (%)</label>
            <input class="w-full" id="descScaleX" min="50" max="200" type="range" value="100"/>
        </div>
        <div>
            <label class="block text-xs font-medium" for="descScaleY">Altura Descrição (%)</label>
            <input class="w-full" id="descScaleY" min="50" max="200" type="range" value="100"/>
        </div>
        <div>
            <label class="block text-xs font-medium" for="priceScaleX">Largura Preço (%)</label>
            <input class="w-full" id="priceScaleX" min="50" max="200" type="range" value="100"/>
        </div>
        <div>
            <label class="block text-xs font-medium" for="priceScaleY">Altura Preço (%)</label>
            <input class="w-full" id="priceScaleY" min="50" max="200" type="range" value="100"/>
        </div>
    </div>

    <div class="pt-2 mt-2 border-t">
        <label class="block text-sm font-medium mt-1 mb-1" for="default_priceOffsetY">Posição Y do Preço (px)</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="default_priceOffsetY" type="number" value="4"/>
    </div>
</div>
</div>
</div>


<div class="panel hidden space-y-6" id="panel-fonts">
<h3 class="text-2xl font-bold border-b pb-2">Fontes das Descrições</h3>
<div class="hidden" id="font-controls-default">
    <h4 class="text-lg font-semibold mb-2 text-blue-400">Estilo: Padrão / Círculo / Retângulo</h4>
    <div class="space-y-2">
        <div>
            <label class="block text-sm font-medium mb-1" for="productNameFont">Fonte da Descrição</label>
            <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="productNameFont">
                <optgroup label="Fontes Padrão">
                    <option value="Inter">Inter</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Oswald">Oswald</option>
                    <option value="Anton">Anton</option>
                </optgroup>
                <optgroup id="custom-fonts-product-name" label="Fontes Customizadas"></optgroup>
            </select>
            <label class="block text-sm font-medium mt-2 mb-1" for="productNameFontSize">Tamanho da Fonte (px)</label>
            <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="productNameFontSize" type="number" value="42"/>
            <label class="block text-sm font-medium mt-2 mb-1" for="descriptionStartY">Posição Y Inicial da Descrição (px)</label>
            <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="descriptionStartY" type="number" value="25"/>
            
            <div class="grid grid-cols-2 gap-x-4 pt-2 mt-2 border-t">
                <div>
                    <label class="block text-xs font-medium" for="descScaleX">Largura Descrição (%)</label>
                    <input class="w-full" id="descScaleX" min="50" max="200" type="range" value="100"/>
                </div>
                <div>
                    <label class="block text-xs font-medium" for="descScaleY">Altura Descrição (%)</label>
                    <input class="w-full" id="descScaleY" min="50" max="200" type="range" value="100"/>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="hidden" id="font-controls-contour">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Estilo: Texto Contornado</h4>
<div class="space-y-2">
<label class="block text-sm font-medium" for="descFontContour">Fonte da Descrição</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="descFontContour">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Roboto">Roboto</option>
<option value="Inter">Inter</option>
</optgroup>
<optgroup id="custom-fonts-desc-contour" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium" for="descFontSizeContour">Tamanho da Descrição (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="descFontSizeContour" type="number" value="42"/>
<label class="block text-sm font-medium" for="descColorContour">Cor da Descrição</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="descColorContour" type="color" value="#000000"/>
<label class="block text-sm font-medium mt-2" for="descOffsetYContour">Deslocamento Vertical da Descrição (px)</label>
<div>
<label class="block text-sm font-medium mt-2" for="contourImageTextSpacing">Espaçamento Imagem-Texto (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="contourImageTextSpacing" type="number" value="5"/>
</div>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="descOffsetYContour" type="number" value="21"/>
</div>
</div>
<div class="hidden" id="font-controls-currency-highlight">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Estilo: Cifrão Destacado</h4>
<div class="space-y-2">
<div>
<label class="block text-sm font-medium mb-1" for="chDescFont">Fonte da Descrição</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="chDescFont">
<optgroup label="Fontes Padrão">
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Oswald">Oswald</option>
<option value="Anton">Anton</option>
</optgroup>
<optgroup id="custom-fonts-ch-desc" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="chDescFontSize">Tamanho da Descrição (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="chDescFontSize" type="number" value="38"/>
</div>
</div>
</div>
<div class="hidden" id="font-controls-yellow-tag">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Estilo: Tag Amarela</h4>
<div class="space-y-2">
<label class="block text-sm font-medium mb-1" for="ytDescFont">Fonte da Descrição</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="ytDescFont">
<optgroup label="Fontes Padrão">
<option value="Oswald">Oswald</option>
<option value="Anton">Anton</option>
<option value="Roboto">Roboto</option>
<option value="Inter">Inter</option>
</optgroup>
<optgroup id="custom-fonts-yt-desc" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="ytDescFontSize">Tamanho da Descrição (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="ytDescFontSize" type="number" value="40"/>
<label class="block text-sm font-medium mt-2 mb-1" for="ytDescColor">Cor da Descrição</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="ytDescColor" type="color" value="#000000"/>
</div>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-custom-fonts">
    <h3 class="text-2xl font-bold border-b pb-2">Fontes Customizadas</h3>

    <div class="space-y-4 pb-4 border-b border-gray-600">
        <p class="text-sm text-gray-400">Adicione múltiplas fontes de uma só vez selecionando uma pasta do seu computador.</p>
        <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg" id="addFontsFromFolderBtn">
            Adicionar Fontes via Pasta
        </button>
        <input type="file" id="fontFolderInput" webkitdirectory directory multiple class="hidden">
    </div>
    <div class="space-y-4">
        <p class="text-xs text-gray-500">Adicione fontes do seu computador. Elas ficarão salvas no seu navegador para uso futuro.</p>
        <div>
            <label class="block text-sm font-medium mb-1" for="customFontInput">Arquivo da Fonte (.ttf, .otf, .woff)</label>
<input accept=".ttf,.otf,.woff,.woff2" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-gray-700 dark:file:text-gray-300 file:text-blue-700 hover:file:bg-blue-100" id="customFontInput" type="file"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="customFontNameInput">Nome da Fonte</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="customFontNameInput" placeholder="Ex: Minha Fonte Bold" type="text"/>
</div>
<button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="addCustomFontBtn">Adicionar Fonte</button>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700">
<h4 class="text-lg font-semibold mb-2">Fontes Carregadas</h4>
<div class="space-y-2 max-h-60 overflow-y-auto" id="customFontList">
</div>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-themes">
<h3 class="text-2xl font-bold border-b pb-2">Balões de Preço</h3>
<div>
<label class="block text-sm font-medium mb-1" for="firstLineBalloonStyle">Estilo do Balão (1ª Linha)</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="firstLineBalloonStyle">
<option value="default">Padrão com Ponteiro</option>
<option value="desc-left-red-tag">Descrição à Esquerda (Tag Vermelha)</option>
 <option value="red-yellow-outlined">Tag Vermelha/Amarela Contornada</option>
<option value="yellow-tag-green-text">Tag Amarela (Modelo Verde)</option>
<option value="red-tag-white-text">Tag Vermelha (Escrita Branca)</option>
<option value="desc-left-3d-tag">Descrição à Esquerda (3D Vermelho)</option>
<option value="circle-model">Círculo (Modelo Novo)</option>
<option value="rectangle">Retângulo Arredondado</option>
<option value="currency-highlight">Cifrão Destacado</option>
<option value="currency-highlight-2">Cifrão Destacado 2</option>
<option value="text-outline">Texto Contornado</option>
<option value="yellow-tag">Tag Amarela</option>
<option value="red-tag-3d">Tag Vermelha 3D</option>
<option value="green-on-yellow-tag">Tag Verde/Amarela</option>
<option value="red-tag-separate-rs">Tag Vermelha (R$ Separado)</option>
<option value="gigante-tag">Gigante (Preto/Amarelo)</option>
<option value="none">Nenhum</option>
</select>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700">
<label class="block text-sm font-medium mb-1" for="otherLinesBalloonStyle">Estilo do Balão (Demais Linhas)</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="otherLinesBalloonStyle">
<option value="default">Padrão com Ponteiro</option>
<option value="desc-left-red-tag">Descrição à Esquerda (Tag Vermelha)</option>
 <option value="red-yellow-outlined">Tag Vermelha/Amarela Contornada</option>
<option value="yellow-tag-green-text">Tag Amarela (Modelo Verde)</option>
<option value="red-tag-white-text">Tag Vermelha (Escrita Branca)</option>
<option value="desc-left-3d-tag">Descrição à Esquerda (3D Vermelho)</option>
<option value="circle-model">Círculo (Modelo Novo)</option>
<option value="rectangle">Retângulo Arredondado</option>
<option value="currency-highlight">Cifrão Destacado</option>
<option value="currency-highlight-2">Cifrão Destacado 2</option>
<option value="text-outline">Texto Contornado</option>
<option value="yellow-tag">Tag Amarela</option>
<option value="red-tag-3d">Tag Vermelha 3D</option>
<option value="green-on-yellow-tag">Tag Verde/Amarela</option>
<option value="red-tag-separate-rs">Tag Vermelha (R$ Separado)</option>
<option value="gigante-tag">Gigante (Preto/Amarelo)</option>
<option selected="" value="none">Nenhum</option>
</select>
</div>
<div class="hidden pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2" id="highlight-balloon-controls">
<label class="block text-sm font-medium" for="highlightedBalloonOffsetY">Deslocamento Vertical do Balão (Destaque)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="highlightedBalloonOffsetY" type="number" value="0"/>
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
<h4 class="text-lg font-semibold -mb-2">Ajustes Globais de Tamanho</h4>
<div>
<label class="block text-sm font-medium mt-2 mb-1" for="balloonHeightPercent">Altura do Balão (%)</label>
<input class="w-full" id="balloonHeightPercent" max="150" min="50" type="range" value="70"/>
</div>

<div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
    <h4 class="text-lg font-semibold">Balões Customizados</h4>
    <p class="text-xs text-gray-500">Adicione suas próprias imagens (PNG com fundo transparente é ideal) para usar como balões de preço.</p>
    <div class="space-y-2 p-3 bg-gray-100 dark:bg-gray-900 rounded-lg">
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonImageInput">Arquivo de Imagem</label>
            <input accept="image/png,image/jpeg,image/webp" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-gray-700 dark:file:text-gray-300 file:text-blue-700 hover:file:bg-blue-100" id="customBalloonImageInput" type="file"/>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonNameInput">Nome do Novo Estilo</label>
            <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="customBalloonNameInput" placeholder="Ex: Balão Dia das Mães" type="text"/>
        </div>
        <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="saveCustomBalloonBtn">Salvar Novo Balão</button>
    </div>
    <div class="pt-2">
        <label class="block text-sm font-medium mb-2">Balões Salvos:</label>
        <div class="space-y-2 max-h-40 overflow-y-auto" id="customBalloonList">
            </div>
    </div>
</div>

<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-custom-image">
    <h4 class="text-lg font-semibold mb-2 text-cyan-400">Opções do Balão Customizado</h4>
    <div class="space-y-2">
	
	  <div class="flex items-center gap-2 p-2 bg-gray-100 dark:bg-gray-900 rounded-lg">
            <input id="customBalloonDescLeftToggle" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <label for="customBalloonDescLeftToggle" class="text-sm font-medium">Ativar layout com descrição à esquerda</label>
        </div>
	
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonPriceColor">Cor da Fonte do Preço</label>
            <input class="w-full h-10 p-1" id="customBalloonPriceColor" type="color" value="#FFFFFF"/>
        </div>
		
		   <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonPriceFont">Fonte do Preço</label>
            <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="customBalloonPriceFont">
                <optgroup label="Fontes Padrão">
                    <option value="Anton">Anton</option>
                    <option value="Oswald">Oswald</option>
                    <option value="Inter">Inter</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Orbitron">Orbitron</option>
                </optgroup>
                <optgroup id="custom-fonts-custom-balloon" label="Fontes Customizadas"></optgroup>
            </select>
        </div>
		
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonWidth">Largura do Balão (%)</label>
            <input class="w-full" id="customBalloonWidth" max="150" min="10" type="range" value="85"/>
        </div>
        
		 <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonHeight">Altura do Balão (%)</label>
            <input class="w-full" id="customBalloonHeight" max="150" min="10" type="range" value="85"/>
        </div>
		
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonPriceFontSize">Tamanho da Fonte do Preço (px)</label>
            <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="customBalloonPriceFontSize" type="number" value="80"/>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonPriceOffsetX">Posição Horizontal do Preço (%)</label>
            <input class="w-full" id="customBalloonPriceOffsetX" max="100" min="0" type="range" value="50"/>
        </div>
        <div>
            <label class="block text-sm font-medium mb-1" for="customBalloonPriceOffsetY">Posição Vertical do Preço (%)</label>
            <input class="w-full" id="customBalloonPriceOffsetY" max="100" min="0" type="range" value="50"/>
        </div>
    </div>
</div>


</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
<h4 class="text-lg font-semibold -mb-2">Ajustes Globais de Posição</h4>
<div>
<label class="block text-sm font-medium" for="descriptionGlobalOffsetY">Deslocamento Vertical das Descrições (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="descriptionGlobalOffsetY" type="number" value="0"/>
</div>
<div>
<label class="block text-sm font-medium" for="balloonGlobalOffsetY">Deslocamento Vertical dos Balões (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="balloonGlobalOffsetY" type="number" value="0"/>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-default">
    <h4 class="text-lg font-semibold mb-2 text-blue-400">Opções (Padrão / 3D / Desc. Esquerda 3D)</h4>
    <div class="mb-4">
        <label class="block text-sm font-medium mb-1" for="default_balloon_color">Cor Principal do Balão</label>
        <input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="default_balloon_color" type="color" value="#FF0000"/>
    </div>
    <div class="space-y-2">
        <label class="block text-sm font-medium mb-1" for="priceFont">Fonte do Preço</label>
        <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="priceFont">
            <optgroup label="Fontes Padrão">
                <option value="Anton">Anton</option>
                <option value="Oswald">Oswald</option>
                <option value="Inter">Inter</option>
                <option value="Roboto">Roboto</option>
                <option value="Orbitron">Orbitron</option>
            </optgroup>
            <optgroup id="custom-fonts-price" label="Fontes Customizadas"></optgroup>
        </select>
        <label class="block text-sm font-medium mt-2 mb-1" for="firstLinePriceFontSize">Tamanho Fonte (1ª Linha) (px)</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="firstLinePriceFontSize" type="number" value="40"/>
        <label class="block text-sm font-medium mt-2 mb-1" for="otherLinesPriceFontSize">Tamanho Fonte (Demais Linhas) (px)</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="otherLinesPriceFontSize" type="number" value="30"/>

        <div class="grid grid-cols-2 gap-x-4 pt-2 mt-2 border-t">
            <div>
                <label class="block text-xs font-medium" for="priceScaleX">Largura Preço (%)</label>
                <input class="w-full" id="priceScaleX" min="50" max="200" type="range" value="100"/>
            </div>
            <div>
                <label class="block text-xs font-medium" for="priceScaleY">Altura Preço (%)</label>
                <input class="w-full" id="priceScaleY" min="50" max="200" type="range" value="100"/>
            </div>
        </div>
    </div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-contour">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções do Preço (Contornado)</h4>
<div class="space-y-2">
<label class="block text-sm font-medium" for="priceFontContour">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="priceFontContour">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Orbitron">Orbitron</option>
</optgroup>
<optgroup id="custom-fonts-price-contour" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium" for="firstLinePriceFontSizeContour">Tamanho Fonte (1ª Linha) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="firstLinePriceFontSizeContour" type="number" value="45"/>
<label class="block text-sm font-medium" for="otherLinesPriceFontSizeContour">Tamanho Fonte (Demais Linhas) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="otherLinesPriceFontSizeContour" type="number" value="35"/>
<label class="block text-sm font-medium" for="priceColorContour">Cor do Preço</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="priceColorContour" type="color" value="#FFDE17"/>
<label class="block text-sm font-medium" for="priceBorderColorContour">Cor da Borda do Preço</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="priceBorderColorContour" type="color" value="#E62228"/>
<label class="block text-sm font-medium mt-2" for="priceBorderWidthContour">Espessura da Borda (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="priceBorderWidthContour" type="number" value="6"/>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-currency-highlight">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções do Balão (Cifrão Destacado)</h4>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1" for="chBgColor">Cor do Balão</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="chBgColor" type="color" value="#009688"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="chPriceColor">Cor do Preço</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="chPriceColor" type="color" value="#FFFFFF"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="chCircleColor">Cor do Círculo</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="chCircleColor" type="color" value="#FFFFFF"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="chCurrencyColor">Cor do Cifrão</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="chCurrencyColor" type="color" value="#004D40"/>
</div>
</div>
<div class="pt-4 border-t mt-4 border-gray-200 dark:border-gray-700 space-y-2">
<label class="block text-sm font-medium mb-1" for="chPriceFont">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="chPriceFont">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Orbitron">Orbitron</option>
</optgroup>
<optgroup id="custom-fonts-ch-price" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="firstLineChPriceFontSize">Tamanho Máx. Fonte (1ª Linha) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="firstLineChPriceFontSize" type="number" value="50"/>
<label class="block text-sm font-medium mt-2 mb-1" for="otherLinesChPriceFontSize">Tamanho Máx. Fonte (Demais Linhas) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="otherLinesChPriceFontSize" type="number" value="40"/>
<label class="block text-sm font-medium mt-2 mb-1" for="chBorderRadius">Raio da Borda (Retângulo)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="chBorderRadius" min="0" type="number" value="20"/>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-currency-highlight-2">
<h4 class="text-lg font-semibold mb-2 text-teal-400">Opções do Balão (Cifrão Destacado 2)</h4>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1" for="ch2BgColor">Cor do Balão</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="ch2BgColor" type="color" value="#5E548E"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="ch2PriceColor">Cor do Preço</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="ch2PriceColor" type="color" value="#FFFFFF"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="ch2CircleColor">Cor do Círculo</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="ch2CircleColor" type="color" value="#FFFFFF"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="ch2CurrencyColor">Cor do Cifrão</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="ch2CurrencyColor" type="color" value="#231942"/>
</div>
</div>
<div class="pt-4 border-t mt-4 border-gray-200 dark:border-gray-700 space-y-2">
<label class="block text-sm font-medium mb-1" for="ch2PriceFont">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="ch2PriceFont">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Orbitron">Orbitron</option>
</optgroup>
<optgroup id="custom-fonts-ch2-price" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="firstLineCh2PriceFontSize">Tamanho Máx. Fonte (1ª Linha) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="firstLineCh2PriceFontSize" type="number" value="50"/>
<label class="block text-sm font-medium mt-2 mb-1" for="otherLinesCh2PriceFontSize">Tamanho Máx. Fonte (Demais Linhas) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="otherLinesCh2PriceFontSize" type="number" value="40"/>
<label class="block text-sm font-medium mt-2 mb-1" for="ch2BorderRadius">Raio da Borda (Retângulo)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="ch2BorderRadius" min="0" type="number" value="20"/>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-yellow-tag">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções do Balão (Tag Amarela)</h4>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1" for="ytBgColor">Cor do Balão</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="ytBgColor" type="color" value="#ffde00"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="ytPriceColor">Cor do Preço</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="ytPriceColor" type="color" value="#d90429"/>
</div>
</div>
<div class="pt-4 border-t mt-4 border-gray-200 dark:border-gray-700 space-y-2">
<label class="block text-sm font-medium mb-1" for="ytPriceFont">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="ytPriceFont">
<optgroup label="Fontes Padrão">
<option value="Oswald">Oswald</option>
<option value="Anton">Anton</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Orbitron">Orbitron</option>
</optgroup>
<optgroup id="custom-fonts-yt-price" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="firstLineYtPriceFontSize">Tamanho Fonte (1ª Linha) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="firstLineYtPriceFontSize" type="number" value="60"/>
<label class="block text-sm font-medium mt-2 mb-1" for="otherLinesYtPriceFontSize">Tamanho Fonte (Demais) (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="otherLinesYtPriceFontSize" type="number" value="50"/>
<label class="block text-sm font-medium mt-2 mb-1" for="ytBorderRadius">Raio da Borda (Tag)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="ytBorderRadius" min="0" type="number" value="15"/>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-gigante-tag">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções do Balão (Gigante)</h4>
<div class="space-y-4">




<div>
<label class="block text-sm font-medium mb-1" for="gt_balloonHeight">Altura do Balão (%)</label>
<input class="w-full" id="gt_balloonHeight" max="200" min="10" type="range" value="100"/>
</div>
<div>
<label class="block text-sm font-medium" for="gt_offsetX">Deslocamento Horizontal (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_offsetX" type="number" value="0"/>
</div>
<div>
<label class="block text-sm font-medium" for="gt_offsetY">Deslocamento Vertical (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_offsetY" type="number" value="0"/>
</div>
<div class="pt-4 border-t border-gray-500 mt-4">
<p class="text-sm font-semibold text-blue-300 mb-2">Ajustes Finos do Texto do Preço</p>

    <div>
            <label class="block text-sm font-medium" for="gt_priceFont">Fonte do Preço</label>
            <select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="gt_priceFont">
                <optgroup label="Fontes Padrão">
                    <option value="Anton">Anton</option>
                    <option value="Oswald">Oswald</option>
                    <option value="Inter">Inter</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Orbitron">Orbitron</option>
                </optgroup>
                <optgroup id="custom-fonts-gt-price" label="Fontes Customizadas"></optgroup>
            </select>
        </div>

<div>
<label class="block text-sm font-medium" for="gt_priceOffsetX">Posição X do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_priceOffsetX" type="number" value="0"/>
</div>
<div class="mt-2">
<label class="block text-sm font-medium" for="gt_priceOffsetY">Posição Y do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_priceOffsetY" type="number" value="0"/>
</div>
</div></div>
<div class="pt-4 border-t border-gray-500 mt-4">
<p class="text-sm font-semibold text-blue-300 mb-2">Opções da Descrição</p>
<div class="space-y-2">
<div>
<label class="block text-sm font-medium mb-1" for="gt_descFont">Fonte da Descrição</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="gt_descFont">
<optgroup label="Fontes Padrão">
<option value="Oswald">Oswald</option>
<option value="Anton">Anton</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
</optgroup>
<optgroup id="custom-fonts-gt-desc" label="Fontes Customizadas"></optgroup>
</select>
</div>
<div>
<label class="block text-sm font-medium mt-2 mb-1" for="gt_descFontSize">Tamanho da Fonte da Descrição (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_descFontSize" type="number" value="30"/>
</div>
<div class="grid grid-cols-2 gap-2">
<div>
<label class="block text-sm font-medium" for="gt_descOffsetX">Posição X da Descrição</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_descOffsetX" type="number" value="0"/>
</div>
<div>
<label class="block text-sm font-medium" for="gt_descOffsetY">Posição Y da Descrição</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="gt_descOffsetY" type="number" value="0"/>
</div>
</div>
</div>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-green-on-yellow-tag">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções do Balão (Tag Verde/Amarela)</h4>
<div class="space-y-2">
<label class="block text-sm font-medium mb-1" for="goy_priceFont">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="goy_priceFont">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Orbitron">Orbitron</option>
</optgroup>
<optgroup id="custom-fonts-goy-price" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="goy_priceFontSize">Tamanho Máx. Fonte (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="goy_priceFontSize" type="number" value="70"/>
<div class="grid grid-cols-2 gap-4 pt-2 mt-2 border-t border-gray-500">
<div>
<label class="block text-xs font-medium mb-1" for="goy_priceOffsetX">Posição X do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="goy_priceOffsetX" type="number" value="0"/>
</div>
<div>
<label class="block text-xs font-medium mb-1" for="goy_priceOffsetY">Posição Y do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="goy_priceOffsetY" type="number" value="0"/>
</div>
</div>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-red-tag-separate-rs">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções do Balão (Tag Vermelha R$)</h4>
<div class="space-y-2">
<label class="block text-sm font-medium mb-1" for="rt_priceFont">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="rt_priceFont">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Orbitron">Orbitron</option>
</optgroup>
<optgroup id="custom-fonts-rt-price" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="rt_priceFontSize">Tamanho Máx. Fonte (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="rt_priceFontSize" type="number" value="60"/>
<div class="grid grid-cols-2 gap-4 pt-2 mt-2 border-t border-gray-500">
<div>
<label class="block text-xs font-medium mb-1" for="rt_priceOffsetX">Posição X do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="rt_priceOffsetX" type="number" value="0"/>
</div>
<div>
<label class="block text-xs font-medium mb-1" for="rt_priceOffsetY">Posição Y do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="rt_priceOffsetY" type="number" value="0"/>
</div>
</div>
</div>
</div>
<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-desc-left-red-tag">
<h4 class="text-lg font-semibold mb-2 text-blue-400">Opções (Descrição à Esquerda)</h4>
<div class="space-y-2 pb-4 border-b border-gray-500">
<p class="text-sm font-semibold text-blue-300">Ajustes da Descrição</p>
<div>
<label class="block text-sm font-medium mb-1" for="dlrt_descFont">Fonte da Descrição</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="dlrt_descFont">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
</optgroup>
<optgroup id="custom-fonts-dlrt-desc" label="Fontes Customizadas"></optgroup>
</select>
</div>
<div>
<label class="block text-sm font-medium mt-2 mb-1" for="dlrt_descFontSize">Tamanho da Fonte (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="dlrt_descFontSize" type="number" value="17"/>
</div>
<div>
<label class="block text-sm font-medium mt-2 mb-1" for="dlrt_descColor">Cor da Descrição</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border rounded-lg cursor-pointer" id="dlrt_descColor" type="color" value="#000000"/>
</div>
</div>
<div class="space-y-2 pt-4">
<p class="text-sm font-semibold text-blue-300">Ajustes do Balão de Preço</p>
<label class="block text-sm font-medium mb-1" for="dlrt_priceFont">Fonte do Preço</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="dlrt_priceFont">
<optgroup label="Fontes Padrão">
<option value="Anton">Anton</option>
<option value="Oswald">Oswald</option>
<option value="Inter">Inter</option>
</optgroup>
<optgroup id="custom-fonts-dlrt-price" label="Fontes Customizadas"></optgroup>
</select>
<label class="block text-sm font-medium mt-2 mb-1" for="dlrt_priceFontSize">Tamanho Máx. Fonte (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="dlrt_priceFontSize" type="number" value="70"/>
<div class="grid grid-cols-2 gap-4 pt-2 mt-2 border-t border-gray-500">
<div>
<label class="block text-xs font-medium mb-1" for="dlrt_priceOffsetX">Posição X do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="dlrt_priceOffsetX" type="number" value="0"/>
</div>
<div>
<label class="block text-xs font-medium mb-1" for="dlrt_priceOffsetY">Posição Y do Preço (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="dlrt_priceOffsetY" type="number" value="0"/>
</div>
</div>
</div>
</div>



<div class="hidden pt-4 border-t border-gray-600" id="balloon-settings-desc-left-custom">
    <h4 class="text-lg font-semibold mb-2 text-cyan-400">Opções (Descrição à Esquerda - Custom)</h4>
    <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium mb-1" for="dlc_balloon_select">Balão de Preço a ser Usado</label>
            <select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="dlc_balloon_select">
                <option value="">Nenhum balão customizado salvo</option>
            </select>
        </div>
        
        <div class="grid grid-cols-2 gap-4 pt-4 border-t">
            <div>
                <label class="block text-xs font-medium mb-1" for="dlc_balloonWidth">Largura Balão (%)</label>
                <input type="range" id="dlc_balloonWidth" class="w-full" min="30" max="100" value="85">
            </div>
            <div>
                <label class="block text-xs font-medium mb-1" for="dlc_balloonHeight">Altura Balão (%)</label>
                <input type="range" id="dlc_balloonHeight" class="w-full" min="30" max="100" value="85">
            </div>
        </div>
    </div>
</div>




</div>




<div class="panel hidden space-y-6" id="panel-validity">
<h3 class="text-2xl font-bold border-b pb-2">Data de Validade e Rodapé</h3>
<div class="pt-4 border-t border-gray-200 dark:border-gray-600 space-y-4">
<div class="flex items-center gap-2">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableFooterText" type="checkbox"/>
<label class="text-sm font-medium" for="enableFooterText">Ativar Texto de Rodapé</label>
</div>
<div class="hidden space-y-4" id="footer-text-options">
<div>
<label class="block text-sm font-medium mb-1" for="validity">Texto Principal do Rodapé</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="validity" type="text"/>
<label class="block text-xs font-medium mt-1" for="footerFont">Fonte</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerFont">
<optgroup label="Fontes Padrão">
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Oswald">Oswald</option>
<option value="Anton">Anton</option>
</optgroup>
<optgroup id="custom-fonts-footer" label="Fontes Customizadas"></optgroup>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerSubtext">Subtexto do Rodapé</label>
<textarea class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="footerSubtext" rows="3"></textarea>
<label class="block text-xs font-medium mt-1" for="footerSubtextFont">Fonte Subtexto</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerSubtextFont">
<optgroup label="Fontes Padrão">
<option value="Inter">Inter</option>
<option value="Roboto">Roboto</option>
<option value="Oswald">Oswald</option>
<option value="Anton">Anton</option>
</optgroup>
<optgroup id="custom-fonts-footer-subtext" label="Fontes Customizadas"></optgroup>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerTextSpacing">Espaçamento entre Textos (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerTextSpacing" min="0" type="number" value="10"/>
</div>
<div class="flex items-center gap-2">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableFooterBackground" type="checkbox"/>
<label class="text-sm font-medium" for="enableFooterBackground">Ativar Fundo no Rodapé</label>
</div>
<div class="hidden space-y-4" id="footer-options">
<div class="flex items-center gap-2 mt-2">
<input checked="" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="footerAutoPosition" type="checkbox"/>
<label class="text-sm font-medium" for="footerAutoPosition">Posicionar Rodapé Automaticamente</label>
</div>
<div id="footerManualPositionContainer">
<label class="block text-sm font-medium mb-1" for="footerTextVerticalAlign">Alinhamento Vertical do Texto</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerTextVerticalAlign">
<option value="middle">Centro</option>
<option value="top">Topo</option>
<option value="bottom">Fundo</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerPositionY">Ajuste Posição Y (px) </label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerPositionY" min="0" type="number" value="35"/>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1" for="footerBgColor">Cor do Fundo</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="footerBgColor" type="color"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerTextColor">Cor do Texto</label>
<input class="w-full h-10 p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer" id="footerTextColor" type="color"/>
</div>
</div>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1" for="footerFontSize">Tamanho da Fonte</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerFontSize" min="10" type="number" value="50"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerSubtextFontSize">Tamanho Subtexto</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerSubtextFontSize" min="8" type="number" value="37"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerBorderRadius">Raio da Borda</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerBorderRadius" min="0" type="number"/>
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="footerPaddingY">Espaçamento Interno (Y)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="footerPaddingY" min="0" type="number" value="30"/>
</div>
</div>
</div>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-add-product">
<div class="space-y-4 pb-4 border-b">
<h3 class="text-xl font-bold" id="productDbLabel">Busca Inteligente no Banco de Dados</h3>
<p class="text-sm text-gray-500">Digite um ou mais nomes de produtos (um por linha) e clique em buscar. O sistema encontrará o produto mesmo com variações no nome.</p>
<textarea class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="productSearchTextarea" placeholder="OVOS CARTELA 30UNDS
PEITO DE FRANGO KG
..." rows="5"></textarea>
<button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg" id="searchDbBtn">Buscar e Adicionar ao Encarte</button>
</div>
<div class="space-y-4">
    <h3 class="text-xl font-bold">Gerar Para Instagram</h3>
    <textarea class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="bulkAddTextarea" placeholder="Produto A, 10.99
Produto B, 5.50" rows="5"></textarea>
    <button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg" id="bulkAddBtn">Gerar Post Para Instagram</button>
</div>
<div class="space-y-4 pt-4 border-t">
<h3 class="text-xl font-bold">Adicionar (Individual)</h3>
<label class="block text-sm font-medium">Nome do Produto</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="productName" type="text"/>
<label class="block text-sm font-medium">Preço</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="price" step="0.01" type="number"/>
<label class="block text-sm font-medium">Imagem do Produto</label>
<input accept="image/*" class="w-full text-sm" id="productImage" type="file"/>
<button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="addProductBtn">Adicionar Produto</button>
    </div>
</div>

<div class="panel hidden space-y-6" id="panel-format-list">
    <h3 class="text-2xl font-bold border-b pb-2">Formatação Inteligente de Lista</h3>
    
    <div class="space-y-2">
        <label for="inputList" class="block text-sm font-medium">1. Cole sua lista de produtos aqui:</label>
        <textarea id="inputList" class="w-full h-48 bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" placeholder="Exemplo: ARROZ REI ARTHUR 5KG: 21,40 	 DICKOW"></textarea>
    </div>

<div class="flex items-center gap-2 my-4">
    <input id="removePricesToggle" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
    <label for="removePricesToggle" class="text-sm font-medium cursor-pointer">Remover preços e texto subsequente</label>
</div>



    <button id="formatarListaBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">
    Formatar e Limpar Lista
</button>

    <div class="space-y-2">
        <label for="outputList" class="block text-sm font-medium">2. Sua lista formatada aparecerá aqui:</label>
        <textarea id="outputList" readonly class="w-full h-48 bg-gray-200 dark:bg-gray-900 border rounded-lg p-2.5" placeholder="O resultado aparecerá aqui..."></textarea>
		<button id="copyOutputBtn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
    </svg>
    <span>Copiar Lista</span>
</button>
    </div>
    
    <div class="p-4 bg-gray-100 dark:bg-gray-900 rounded-lg text-xs text-gray-500 space-y-2">
        <p class="font-bold text-gray-700 dark:text-gray-300">Como a Inteligência Funciona:</p>
        <ul class="list-disc list-inside">
            <li class="font-bold text-teal-500">Textos após o preço são excluídos automaticamente.</li>
            <li>O sistema localiza a descrição e o preço.</li>
            <li>Um ";" é sempre usado como separador no resultado final.</li>
            <li>O símbolo "R$" é removido.</li>
        </ul>
    </div>
</div>
<div class="panel hidden space-y-6" id="panel-header-validity">
    <h3 class="text-2xl font-bold border-b pb-2">Validade do Cabeçalho</h3>
<p class="text-xs text-gray-500">Controle o selo de data de validade. Clique e arraste o selo no encarte para movê-lo.</p>
<div class="space-y-4 pt-2">
<div class="flex items-center gap-2">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="enableHeaderValidity" type="checkbox"/>
<label class="text-sm font-medium" for="enableHeaderValidity">Ativar Selo de Validade</label>
</div>
<div class="flex items-center gap-2">
<input class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" id="headerValidityEnableBg" type="checkbox"/>
<label class="text-sm font-medium" for="headerValidityEnableBg">Ativar Fundo Verde</label>
</div>
</div>
<div class="hidden space-y-4 pt-4 border-t border-gray-200 dark:border-gray-700" id="header-validity-options">
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1" for="headerStartDate">Data de Início</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerStartDate" type="date"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="headerEndDate">Data de Fim</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerEndDate" type="date"/>
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="headerTitleText">Texto do Título (opcional)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="headerTitleText" type="text"/>
</div>
<div class="pt-4 border-t mt-4">
<button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg text-sm" id="applyP2ValidityBtn">
            Aplicar Validade (P1 única, P2+ iguais)
        </button>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="headerStockText">Texto Extra (use Enter para quebrar linha)</label>
<textarea class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="headerStockText" rows="3">OU ENQUANTO DURAREM OS ESTOQUES.</textarea>
</div>

<div class="pt-2">
    <label class="block text-sm font-medium mb-1" for="headerExtraText2">Segundo Texto Extra</label>
    <textarea class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="headerExtraText2" rows="2"></textarea>
</div>

<div class="pt-4 border-t">
<h4 class="text-lg font-semibold -mb-2">Ajustes de Posição e Tamanho</h4>
<div class="grid grid-cols-2 gap-4 mt-4">
<div>
<label class="block text-sm font-medium mb-1" for="headerValidityX">Posição X (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerValidityX" type="number" value="50"/>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="headerValidityY">Posição Y (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerValidityY" type="number" value="50"/>
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="headerValidityWidth">Largura (px)</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerValidityWidth" type="number" value="350"/>
</div>

<div class="mt-2">
    <label class="block text-sm font-medium mb-1" for="headerValidityScale">Escala Geral (%)</label>
    <input class="w-full" id="headerValidityScale" min="50" max="200" type="range" value="100"/>
</div>


</div>
<div class="pt-4 border-t">
<h4 class="text-lg font-semibold -mb-2">Ajustes de Fonte e Espaçamento</h4>
<div class="grid grid-cols-2 gap-x-4 gap-y-3 mt-4">
    <div>
        <label class="block text-xs font-medium mb-1" for="headerFontSizeLine1">Fonte Título</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerFontSizeLine1" type="number" value="25"/>
    </div>
    <div>
        <label class="block text-xs font-medium mb-1" for="headerFontSizeStartDate">Fonte Data Início</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerFontSizeStartDate" type="number" value="60"/>
    </div>
    <div>
        <label class="block text-xs font-medium mb-1" for="headerFontSizeDates">Fonte Data Fim</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerFontSizeDates" type="number" value="50"/>
    </div>
    <div>
        <label class="block text-xs font-medium mb-1" for="headerFontSizeStock">Fonte Estoque</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerFontSizeStock" type="number" value="35"/>
    </div>
    <div class="col-span-2">
        <label class="block text-xs font-medium mb-1" for="headerFontSizeExtra2">Fonte Texto Extra 2</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerFontSizeExtra2" type="number" value="25"/>
    </div>
    <div class="col-span-2 mt-2 pt-3 border-t">
        <label class="block text-xs font-medium mb-1" for="headerExtraTextAlign">Alinhamento Texto Extra</label>
        <select class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerExtraTextAlign">
            <option value="center">Centro</option>
            <option value="justify">Justificado</option>
        </select>
    </div>
</div>
<div class="grid grid-cols-2 gap-2 mt-2">
    <div>
        <label class="block text-xs font-medium mb-1" for="headerLineSpacing">Espaç. Linhas</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerLineSpacing" type="number" value="10"/>
    </div>
	
	<div>
        <label class="block text-xs font-medium mb-1" for="headerSeparatorSpacing">Espaç. Separador</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerSeparatorSpacing" type="number" value="10"/>
    </div>
	
    <div>
        <label class="block text-xs font-medium mb-1" for="headerExtraSpacing">Espaç. Extras</label>
        <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerExtraSpacing" type="number" value="5"/>
    </div>
		
</div>

<div class="mt-2">
    <label class="block text-xs font-medium mb-1" for="headerDateToStockSpacing">Espaç. Data Fim &gt; Estoque (px)</label>
    <input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" id="headerDateToStockSpacing" type="number" value="15"/>
</div>

</div>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-product-list">
<h3 class="text-2xl font-bold border-b pb-2">Produtos no Encarte</h3>
<p class="text-sm text-gray-500">Arraste para reordenar, edite e clique em "Atualizar".</p>
<div class="space-y-3 max-h-96 overflow-y-auto" id="productList">
</div>
<div class="pt-4 border-t border-gray-200 dark:border-gray-600 mt-4 space-y-2">
<button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg" id="saveProductsToDbBtn">
                            Salvar Produtos no Banco de Dados
                        </button>
<button class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg" id="clearProductListBtn">
                            Limpar Lista de Produtos
                        </button>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-templates">
<h3 class="text-2xl font-bold border-b pb-2">Gerenciar Templates</h3>
<p class="text-xs text-gray-500">Salve as configurações atuais (fontes, cores, margens, etc.) como um template para reusar depois.</p>
<div class="space-y-4">
<label class="block text-sm font-medium" for="templateNameInput">Nome do Template</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="templateNameInput" placeholder="Ex: Template de Fim de Semana" type="text"/>
<div class="pt-2">
<label class="block text-sm font-medium mb-2">Templates Salvos (no navegador)</label>
<div class="grid grid-cols-2 gap-4 max-h-[40vh] overflow-y-auto p-2 bg-gray-100 dark:bg-gray-900 rounded-lg" id="savedTemplatesGrid">
</div>
</div>
</div>
<div class="grid grid-cols-2 gap-4 pt-4 border-t">
<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="saveTemplateBtn">Salvar</button>
<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" id="loadTemplateBtn">Carregar</button>
<button class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg col-span-2" id="exportTemplatesBtn">Exportar Todos</button>
<button class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg col-span-2" id="importTemplatesBtn">Importar</button>
</div>
<input accept=".json" class="hidden" id="importTemplateInput" type="file"/>
<div class="pt-4 border-t">
<button class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" id="deleteTemplateBtn">Deletar Template Selecionado</button>
</div>
</div>
<div class="panel hidden space-y-4" id="panel-stock">
<h3 class="text-2xl font-bold border-b pb-2">Gerenciar Estoque de Produtos</h3>
<div class="space-y-4 pt-2 pb-4 border-b">
<h4 class="text-lg font-semibold">Cadastrar Novos Produtos</h4>
<p class="text-xs text-gray-500">Cadastre produtos selecionando uma pasta. O nome do arquivo será o nome do produto. O preço inicial será 0,00.</p>
<button class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg" id="registerFromFolderBtn">
            Cadastrar via Pasta
        </button>
<input class="hidden" directory="" id="folderInput" multiple="" type="file" webkitdirectory=""/>
</div>
<div class="space-y-2">
<div class="flex justify-between items-center">
<h4 class="text-lg font-semibold" id="stockDbLabel">Produtos no Banco de Dados</h4>
<button class="p-1 rounded-full hover:bg-gray-700" id="refreshStockListBtn">
<svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
</button>
</div>
<div class="grid grid-cols-3 gap-2 max-h-[50vh] overflow-y-auto p-2 bg-gray-100 dark:bg-gray-900 rounded-lg" id="stockProductList">
</div>
<div class="pt-4 mt-4 border-t">
<button class="w-full bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg" id="deleteAllStockBtn">
                Deletar TODO o Estoque de Produtos
            </button>
			
			
			<div class="pt-4 mt-4 border-t space-y-3">
    <h4 class="text-lg font-semibold text-center text-teal-400">Backup e Transferência</h4>
    <p class="text-xs text-center text-gray-500 -mt-2 mb-2">
        Salve seu banco de dados em um arquivo para segurança ou para movê-lo para outro computador.
    </p>
    <button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg" id="exportDbBtn">
        Exportar Banco de Dados (Salvar Arquivo)
    </button>
    <button class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg" id="importDbBtn">
        Importar Banco de Dados (Carregar Arquivo)
    </button>
    <input type="file" id="importDbInput" class="hidden" accept=".json">
</div>
			
			
</div>
</div>
</div>
<div class="panel hidden space-y-6" id="panel-projects">
<h3 class="text-2xl font-bold border-b pb-2">Gerenciar Projetos</h3>
<div class="space-y-2">
<label class="block text-sm font-medium" for="projectNameInput">Nome do Projeto</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="projectNameInput" placeholder="Ex: Encarte de Fim de Ano" type="text"/>
</div>
<div class="space-y-2">
    <label class="block text-sm font-medium" id="savedProjectsLabel">Projetos Salvos (Nuvem) ☁️</label>
    <div class="grid grid-cols-3 gap-2 ..." id="savedProjectsGrid">
        </div>
</div>
<div class="grid grid-cols-2 gap-4 pt-4 border-t">
<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="saveProjectBtn">Salvar Projeto</button>
<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" id="loadProjectBtn">Carregar Projeto</button>
</div>
<div class="pt-2">
<button class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" id="deleteProjectBtn">Deletar Projeto</button>
</div>
<div class="space-y-4 pt-6 border-t mt-4">
<p class="text-sm font-semibold text-center">Backup / Transferência Manual</p>
<button class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" id="exportProjectBtn">
            Exportar (Gerar Arquivo)
        </button>
<button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg" id="importProjectBtn">
            Importar (Carregar Arquivo)
        </button>
</div>
<input accept=".json" class="hidden" id="importProjectInput" type="file"/>
</div>
<input accept=".json" class="hidden" id="importTemplateInput" type="file"/>
<div class="panel hidden space-y-6" id="panel-save-load">
<h3 class="text-2xl font-bold border-b pb-2">Salvar &amp; Carregar Projeto</h3>
<p class="text-xs text-gray-500">Salva e carrega o projeto inteiro, incluindo produtos e páginas, na nuvem.</p>
<div class="space-y-4">
<label class="block text-sm font-medium" for="flyerName">Nome do Encarte</label>
<input class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="flyerName" placeholder="Ex: Encarte de Fim de Semana" type="text"/>
<div class="pt-2" id="savedFlyersContainer">
<label class="block text-sm font-medium mb-1">Encartes Salvos (na nuvem)</label>
<select class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2.5" id="savedFlyersSelect">
<option value="">Selecione para carregar ou deletar</option>
</select>
</div>
</div>
<div class="grid grid-cols-2 gap-4 pt-4 border-t">
<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="saveFlyerBtn">Salvar</button>
<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" id="loadFlyerBtn">Carregar</button>
</div>
<div class="pt-4 border-t">
<button class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" id="deleteFlyerBtn">Deletar Encarte Selecionado</button>
</div>
</div>
</div>


<div class="panel hidden space-y-6" id="panel-price-update">
    <h3 class="text-2xl font-bold border-b pb-2">Atualizações em Lote</h3>
    
    <div class="space-y-4">
        <h4 class="text-lg font-semibold">Atualizar Preços em Lote</h4>
        <p class="text-sm text-gray-400">
            Cole sua lista de produtos abaixo. O sistema irá procurar os produtos pelo nome em TODAS as páginas do encarte e atualizar apenas o preço.
        </p>
        <div>
            <label class="block text-sm font-medium mb-1" for="priceUpdateTextarea">Lista de Preços (Nome; Preço)</label>
            <textarea class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="priceUpdateTextarea" placeholder="Exemplo:&#10;ARROZ TIPO 1 5KG; 22,50&#10;FEIJÃO CARIOCA 1KG; 8,99" rows="8"></textarea>
        </div>
        <button class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="priceUpdateBtn">
            Atualizar Preços Agora
        </button>
    </div>

    <div class="space-y-4 pt-6 border-t border-gray-600">
        <h4 class="text-lg font-semibold">Atualizar Descrições em Lote</h4>
        <p class="text-sm text-gray-400">
            Use para corrigir ou alterar nomes de produtos no encarte. O sistema buscará pelo "Nome Antigo" e o substituirá pela "Nova Descrição".
        </p>
        <div>
            <label class="block text-sm font-medium mb-1" for="descriptionUpdateTextarea">Lista de Descrições (Nome Antigo; Nova Descrição)</label>
            <textarea class="w-full bg-gray-50 dark:bg-gray-700 border rounded-lg p-2.5" id="descriptionUpdateTextarea" placeholder="Exemplo:&#10;REFRIGERANTE COCA-COLA 2L; COCA-COLA SEM AÇÚCAR 2L&#10;BISTECA SUINA KG; BISTECA SUÍNA SADIA KG" rows="8"></textarea>
        </div>
        <button class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="descriptionUpdateBtn">
            Atualizar Descrições Agora
        </button>
    </div>
    </div>


<div class="panel hidden space-y-6" id="panel-price-tag">
    <h3 class="text-2xl font-bold border-b pb-2">Gerador de Cartazes de Preço</h3>

    <div class="space-y-4 p-4 bg-gray-100 dark:bg-gray-700/50 rounded-lg">
        <h4 class="text-lg font-semibold">Gerar via Lista Rápida</h4>
        <p class="text-sm text-gray-400">
            Cole a lista no formato <strong>NOME; PREÇO</strong> (um por linha). A imagem será buscada do seu Banco de Dados de Estoque.
        </p>
        <div>
            <label class="block text-sm font-medium mb-1" for="priceTagListTextarea">Lista de Produtos:</label>
            <textarea class="w-full bg-gray-50 dark:bg-gray-800 border rounded-lg p-2.5" id="priceTagListTextarea" placeholder="Exemplo:&#10;ARROZ TIPO 1 5KG; 22,50&#10;FEIJÃO CARIOCA 1KG; 8,99" rows="6"></textarea>
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="generatePriceTagFromListBtn">
            Gerar Cartazes da Lista
        </button>
    </div>

    <div class="text-center text-sm text-gray-400">OU</div>

    <div class="space-y-4">
        <h4 class="text-lg font-semibold">Gerar a Partir do Encarte Atual</h4>
        <p class="text-sm text-gray-400">
            Marque os produtos do seu encarte para criar cartazes individuais para cada um.
        </p>
        
        <div class="grid grid-cols-2 gap-2">
            <button id="priceTagSelectAllBtn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-1 px-2 rounded-lg text-xs">
                Selecionar Todos
            </button>
            <button id="priceTagDeselectAllBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-1 px-2 rounded-lg text-xs">
                Desselecionar Todos
            </button>
        </div>

        <div>
            <label class="block text-sm font-medium mb-1">Produtos no Encarte:</label>
            <div class="max-h-80 overflow-y-auto space-y-1 p-2 rounded-lg bg-gray-100 dark:bg-gray-900 border" id="priceTagProductList">
                <p class="text-xs text-gray-500 p-2">Nenhum produto no encarte.</p>
            </div>
        </div>
        
        <div class="pt-4 border-t border-gray-600">
            <label class="block text-sm font-medium mb-1" for="priceTagLineSpacing">
                Espaçamento entre Linhas da Descrição
            </label>
            <input type="number" id="priceTagLineSpacing" step="0.1" value="1.2" class="w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm">
            <p class="text-xs text-gray-500 mt-1">Valor padrão: 1.2 (20% de espaçamento). Use 1.0 para nenhum espaço extra.</p>
        </div>

        <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg" id="generatePriceTagBtn">
            Gerar Cartazes Selecionados
        </button>
    </div>
</div>





</aside>
<main class="flex-1 flex items-center justify-center p-4 lg:p-8 transition-all duration-300 ease-in-out" id="mainContent">
<canvas class="shadow-2xl rounded-lg max-w-full max-h-full" id="flyerCanvas"></canvas>

 <div class="absolute bottom-4 right-4 z-50 flex gap-2">
 
 <button id="multiDeletePageBtn" class="bg-red-700 text-white p-2 rounded-full shadow-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500" title="Deletar Múltiplas Páginas">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
    </button>
 
    <button id="refreshPreviewBtn" class="bg-gray-700 text-white p-2 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" title="Atualizar Pré-visualização">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M4 4v5h5M23 19v-5h-5" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M20.49 9A9 9 0 0012 3a9 9 0 00-9 9" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M3.51 15a9 9 0 0014.98 3" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
    </button>

    <button id="prevPageBtn" class="bg-gray-700 text-white p-2 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" title="Página Anterior">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
        </svg>
    </button>

    <button id="nextPageBtn" class="bg-gray-700 text-white p-2 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" title="Próxima Página">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg>
    </button>

 <button id="duplicatePageBtn" class="bg-gray-700 text-white p-2 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" title="Nova Página (Duplicar Atual)">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
		</button>



    <button id="resetZoomBtn" class="bg-gray-700 text-white p-2 rounded-full shadow-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" title="Resetar Zoom e Posição">
        <svg class="h-6 w-6" fill="none" viewbox="0 0 24 24" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10l6 6m0-6l-6 6" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
    </button>
</div>



</main>



</main> <div class="modal-overlay" id="multiDeleteModal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Deletar Páginas em Lote</h3>
        <p class="text-sm text-gray-400 mb-2">
            Selecione as páginas que deseja excluir permanentemente.
            <strong class="text-yellow-400">A página atual não pode ser selecionada.</strong>
        </p>
        <div class="grid grid-cols-2 gap-2 mt-4">
            <button id="selectAllDeleteBtn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-1 px-2 rounded-lg text-xs">Marcar Todas</button>
            <button id="deselectAllDeleteBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-1 px-2 rounded-lg text-xs">Desmarcar Todas</button>
        </div>
        <div id="multiDeletePageListContainer" class="max-h-60 overflow-y-auto space-y-2 my-4 text-left p-2 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-600">
            </div>
        <div class="flex justify-center gap-4 mt-6">
            <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg" id="confirmMultiDeleteBtn">Deletar Selecionadas</button>
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" id="cancelMultiDeleteBtn">Cancelar</button>
        </div>
    </div>
</div>
<div class="modal-overlay" id="exportPosterModal">
    <div class="modal-content">
        <h3 class="text-xl font-bold mb-4">Exportar Cartazes de Preço em PDF</h3>
        <p class="text-sm text-gray-400 mb-6">
            Escolha as opções para o seu arquivo PDF. Todos os cartazes gerados serão incluídos.
        </p>
        <div class="text-left space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1" for="posterSheetSize">Tamanho da Folha:</label>
                <select class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" id="posterSheetSize">
                    <option value="A4">A4 (210 x 297 mm)</option>
                    <option value="A5">A5 (148 x 210 mm)</option>
                    <option value="SRA3">SRA3 (320 x 450 mm)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="posterLayout">Layout por Folha:</label>
                <select class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" id="posterLayout">
                    <option value="1up">1 Cartaz por Folha</option>
                    <option value="2up">2 Cartazes por Folha (em A4 Paisagem)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="posterDPI">Qualidade (Resolução):</label>
                <select class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" id="posterDPI">
                    <option value="96">Rascunho (96 DPI)</option>
                    <option value="150" selected>Boa (150 DPI)</option>
                    <option value="300">Impressão (300 DPI)</option>
                    <option value="custom">Personalizado...</option>
                </select>
            </div>
            <div class="hidden mt-2" id="customDpiContainer">
                <label class="block text-sm font-medium mb-1" for="customDpiInput">DPI Personalizado (Ex: 72 para WhatsApp):</label>
                <input type="number" id="customDpiInput" class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" value="72">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" for="jpegQualitySlider">
                    Compressão (Qualidade da Imagem): <span id="jpegQualityValue" class="font-bold text-blue-400">80%</span>
                </label>
                <input type="range" id="jpegQualitySlider" class="w-full" min="0.1" max="1.0" step="0.05" value="0.8">
                <p class="text-xs text-gray-500 mt-1">Menor qualidade gera arquivos menores.</p>
            </div>
        </div>
        <div class="flex justify-center gap-4 mt-8">
            <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg" id="runPosterExportBtn">Exportar PDF</button>
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" id="cancelPosterExportBtn">Cancelar</button>
        </div>
    </div>
</div>


</div>

<div class="modal-overlay" id="customModal">
<div class="modal-content">
<p class="mb-4" id="modalMessage"></p>
<div class="hidden text-left space-y-3" id="modal-edit-form">
<input id="originalProductNameInput" type="hidden"/>
<div>
<label class="block text-sm font-medium" for="editProductNameInput">Nome do Produto</label>
<input class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2" id="editProductNameInput" type="text"/>
</div>
<div>
<label class="block text-sm font-medium" for="editProductPriceInput">Preço</label>
<input class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2" id="editProductPriceInput" step="0.01" type="number"/>
</div>
<div>
<label class="block text-sm font-medium">Imagem</label>
<img class="w-24 h-24 object-contain mx-auto my-2 rounded-md bg-gray-300" id="editProductImagePreview"/>
<input class="w-full text-sm" id="editProductImageInput" type="file"/>
</div>
</div>
<div class="hidden mb-4" id="modal-input-container">
<label class="block text-sm font-medium text-left mb-1" for="modalTextInput" id="modalInputLabel"></label>
<input class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" id="modalTextInput" type="text"/>
</div>
<div class="flex justify-center gap-4 mt-6" id="modal-buttons">
<button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg" id="modalOkBtn">OK</button>
<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg" id="modalConfirmBtn">Confirmar</button>
<button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg" id="modalCancelBtn">Cancelar</button>
</div>
</div>
</div>
<div class="modal-overlay" id="loadingSpinner">
<div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
</div>
<div class="modal-overlay" id="adaptModal">
<div class="modal-content">
<h3 class="text-xl font-bold mb-4">Adaptar para Redes Sociais</h3>
<p class="text-sm text-gray-500 mb-6">Esta ferramenta irá pegar todos os produtos do seu encarte atual e reorganizá-los em um novo layout otimizado.</p>
<div class="text-left space-y-4">
<div>
<label class="block text-sm font-medium mb-1" for="targetFormatSelect">Formato de Destino:</label>
<select class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" id="targetFormatSelect">
<option value="1080x1350">Instagram Feed Vertical (4:5)</option>
<option value="1080x1080">Instagram Feed Quadrado (1:1)</option>
<option value="1080x1920">Instagram Stories (9:16)</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1" for="productsPerPageSelect">Produtos por Página:</label>
<select class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" id="productsPerPageSelect">
<option value="4">4 Produtos (Grade 2x2)</option>
<option value="6">6 Produtos (Grade 2x3)</option>
<option value="3">3 Produtos (Lista Vertical)</option>
</select>
</div>
</div>
<div class="mt-4 p-3 bg-yellow-100 dark:bg-yellow-900 border-l-4 border-yellow-500 text-yellow-700 dark:text-yellow-300 text-xs">
<strong>Atenção:</strong> Esta ação irá substituir o seu projeto atual. Salve seu trabalho de impressão antes de continuar!
        </div>
<div class="flex justify-center gap-4 mt-6">
<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg" id="runAdaptationBtn">Adaptar Agora</button>
<button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" id="cancelAdaptationBtn">Cancelar</button>
</div>
</div>
</div>






<div class="modal-overlay" id="imageSearchModal">
    <div class="modal-content" style="max-width: 800px;">
        <h3 class="text-xl font-bold mb-4">Selecionar Imagem do Banco de Dados</h3>
        <p class="text-sm text-gray-400 mb-4">
            Busque pelo nome do produto e clique na imagem desejada para selecioná-la.
        </p>

        <div class="mb-4">
            <input type="text" id="imageSearchInput" class="w-full bg-gray-200 dark:bg-gray-600 border rounded-lg p-2.5" placeholder="Digite para buscar..."/>
        </div>

        <div id="imageSearchResults" class="max-h-96 overflow-y-auto grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-4 p-2 rounded-lg bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-600">
            </div>
        
        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-6">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" id="useSelectedImageBtn" disabled>
                Usar Imagem Selecionada
            </button>
            <button class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg" id="triggerFileUploadBtn">
                Ou Fazer Upload do Computador
            </button>
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" id="cancelImageSearchBtn">
                Cancelar
            </button>
        </div>
    </div>
</div>


<script>
        
// ▼▼▼ COLE TODO ESTE CÓDIGO NO LUGAR DO SEU SCRIPT ANTIGO ▼▼▼

const SUPABASE_URL = 'https://dbtzigjdcmabfinpqmfh.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRidHppZ2pkY21hYmZpbnBxbWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NDkxNjQsImV4cCI6MjA3MDUyNTE2NH0.zNCJ9A5GH5urXcjmkRqr2g1VufK7qk5O4ye1QFiH8fA';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// =================================================================
// --- BLOCO DE CÓDIGO DO BANCO DE DADOS SUPABASE ---
// =================================================================

let productDatabase = {};

async function loadProductDatabase() {
    const productDbLabel = document.getElementById('productDbLabel');
    if(productDbLabel) productDbLabel.innerHTML = 'Carregando Banco de Dados (Nuvem) ☁️...';
    try {
        const { data, error } = await supabaseClient.from('products').select('*');
        if (error) throw error;

        productDatabase = {};
        if (data && data.length > 0) {
            productDatabase = Object.fromEntries(data.map(p => [p.name, { name: p.name, price: p.price, src: p.image_url }]));
        }
        isDatabaseSynced = true; // ALTERAÇÃO AQUI
    } catch (e) {
        console.error("Erro ao carregar do Supabase:", e);
        productDatabase = {};
        isDatabaseSynced = false; // ALTERAÇÃO AQUI
    } finally {
        populateStockList();
        updateSyncStatusUI(); // ALTERAÇÃO AQUI
    }
}

// ▼▼▼ COLE ESTA NOVA VERSÃO DA FUNÇÃO ▼▼▼
async function syncProductDatabase() {
    try {
        const productsArray = Object.values(productDatabase);
        showSpinner(true);
        showAlert("Sincronizando com a nuvem... Isso pode demorar.");

        for (const product of productsArray) {
            if (product.src && product.src.startsWith('data:image')) {
                const blob = dataUrlToBlob(product.src);
                const fileName = `${Date.now()}-${product.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                const { error: uploadError } = await supabaseClient.storage.from('product-images').upload(fileName, blob);
                if (uploadError) throw uploadError;
                const { data: publicUrlData } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
                product.src = publicUrlData.publicUrl;
            }
        }

        const productsToStore = productsArray.map(p => ({
            name: p.name,
            price: p.price,
            image_url: p.src
        }));

        if (productsToStore.length > 0) {
            const { error: upsertError } = await supabaseClient.from('products').upsert(productsToStore, { onConflict: 'name' });
            if (upsertError) throw upsertError;
        }

        showAlert("Banco de dados salvo na nuvem com sucesso!");
        isDatabaseSynced = true; // ALTERAÇÃO AQUI
        return true;
    } catch (e) {
        console.error("Falha grave ao salvar no Supabase:", e);
        showAlert(`Ocorreu um erro ao salvar na nuvem: ${e.message}`);
        isDatabaseSynced = false; // ALTERAÇÃO AQUI
        return false;
    } finally {
        showSpinner(false);
        populateStockList();
        updateSyncStatusUI(); // ALTERAÇÃO AQUI
    }
}



// ▼▼▼ ADICIONE ESTE BLOCO DE NOVAS FUNÇÕES ▼▼▼

/**
 * Deleta um único produto do banco de dados na nuvem e localmente.
 * @param {string} productName - O nome do produto a ser deletado.
 */
async function deleteProductFromCloud(productName) {
    showSpinner(true);
    try {
        // Deleta da nuvem (Supabase)
        const { error } = await supabaseClient
            .from('products')
            .delete()
            .eq('name', productName);
        
        if (error) throw error;

        // Deleta do banco de dados local (na memória)
        delete productDatabase[productName];
        
        // Atualiza a interface
        populateStockList();
        showAlert(`Produto "${productName}" deletado com sucesso da nuvem!`);

    } catch (e) {
        console.error("Erro ao deletar produto:", e);
        showAlert(`Falha ao deletar o produto: ${e.message}`);
    } finally {
        showSpinner(false);
    }
}

/**
 * Atualiza os dados de um produto na nuvem e localmente.
 * @param {string} originalName - O nome original do produto.
 * @param {object} productData - Objeto com os novos dados (name, price, src).
 */
async function updateProductInCloud(originalName, productData) {
    showSpinner(true);
    try {
        let finalProductData = { ...productData };

        // Se uma nova imagem foi enviada (base64), faz o upload para o Storage
        if (finalProductData.src && finalProductData.src.startsWith('data:image')) {
            const blob = dataUrlToBlob(finalProductData.src);
            const fileName = `${Date.now()}-${finalProductData.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
            
            const { error: uploadError } = await supabaseClient.storage.from('product-images').upload(fileName, blob);
            if (uploadError) throw uploadError;
            
            const { data: publicUrlData } = supabaseClient.storage.from('product-images').getPublicUrl(fileName);
            finalProductData.src = publicUrlData.publicUrl;
        }

        // Atualiza a tabela 'products' no Supabase
        const { error } = await supabaseClient
            .from('products')
            .update({
                name: finalProductData.name,
                price: finalProductData.price,
                image_url: finalProductData.src
            })
            .eq('name', originalName);

        if (error) throw error;

        // Atualiza o banco de dados local
        delete productDatabase[originalName]; // Remove o antigo
        productDatabase[finalProductData.name] = finalProductData; // Adiciona o novo

        populateStockList();
        showAlert(`Produto "${finalProductData.name}" atualizado com sucesso na nuvem!`);

    } catch (e) {
        console.error("Erro ao atualizar produto:", e);
        showAlert(`Falha ao atualizar o produto: ${e.message}`);
    } finally {
        showSpinner(false);
    }
}

// ▲▲▲ FIM DO BLOCO ▲▲▲






function dataUrlToBlob(dataUrl) {
    const arr = dataUrl.split(',');
    const mime = arr[0].match(/:(.*?);/)[1];
    const bstr = atob(arr[1]);
    let n = bstr.length;
    const u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}


// =================================================================
// --- RESTANTE DO CÓDIGO DA APLICAÇÃO ---
// =================================================================

function applyCurrentPosterLayoutToOthers() {
    const currentPageIndex = flyerData.currentPageIndex;
    const templatePage = flyerData.pages[currentPageIndex];

    if (!templatePage.isPricePoster) {
        showAlert("Esta função só pode ser usada a partir de uma página de cartaz de preço.");
        return;
    }

    showConfirm("Isso aplicará o layout, fundo e data de validade deste cartaz para TODOS os outros cartazes do projeto. Deseja continuar?", (confirmed) => {
        if (confirmed) {
            const settingsTemplate = JSON.parse(JSON.stringify(templatePage.settings));
            const backgroundTemplate = templatePage.backgroundImage;
            const backgroundSrcTemplate = templatePage.backgroundImageSrc;
            let updatedCount = 0;
            flyerData.pages.forEach((page, index) => {
                if (page.isPricePoster && index !== currentPageIndex) {
                    page.settings = JSON.parse(JSON.stringify(settingsTemplate));
                    page.backgroundImage = backgroundTemplate;
                    page.backgroundImageSrc = backgroundSrcTemplate;
                    updatedCount++;
                }
            });
            redrawCanvas();
            showAlert(`${updatedCount} outros cartazes foram atualizados com sucesso!`);
        }
    });
}

async function downloadAllPages() {
    showSpinner(true);
    showAlert("Iniciando download de todas as páginas... Aguarde um momento.");
    const originalPageIndex = flyerData.currentPageIndex;
    const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
    for (let i = 0; i < flyerData.pages.length; i++) {
        switchPage(i, true);
        await delay(500);
        const link = document.createElement('a');
        link.download = `encarte-pagina-${i + 1}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        await delay(300);
    }
    switchPage(originalPageIndex, false);
    showSpinner(false);
    showAlert(`Download de ${flyerData.pages.length} páginas concluído!`);
}

function applyCurrentFontsToAllOthers() {
    if (flyerData.pages.length < 2) {
        showAlert("Você precisa de pelo menos 2 páginas para usar esta função.");
        return;
    }
    showConfirm("Isso aplicará as configurações de fontes e balões da página atual para todas as páginas a partir da segunda. Deseja continuar?", (confirmed) => {
        if (confirmed) {
            const currentPageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
            const fontsTemplate = JSON.parse(JSON.stringify(currentPageSettings.fonts));
            const balloonStylesTemplate = JSON.parse(JSON.stringify(currentPageSettings.balloonStyles));
            for (let i = 1; i < flyerData.pages.length; i++) {
                flyerData.pages[i].settings.fonts = JSON.parse(JSON.stringify(fontsTemplate));
                flyerData.pages[i].settings.balloonStyles = JSON.parse(JSON.stringify(balloonStylesTemplate));
            }
            redrawCanvas();
            showAlert("Fontes e estilos de preço aplicados com sucesso a todas as páginas a partir da segunda!");
        }
    });
}

const masterPageSelect = document.getElementById('masterPageSelect');
const targetPagesContainer = document.getElementById('targetPagesContainer');
const applyMasterSettingsBtn = document.getElementById('applyMasterSettingsBtn');
const selectAllTargetsBtn = document.getElementById('selectAllTargetsBtn');
const deselectAllTargetsBtn = document.getElementById('deselectAllTargetsBtn');

function populateMasterPageControls() {
    if (!masterPageSelect || !targetPagesContainer) return;
    const currentSourceSelection = masterPageSelect.value;
    masterPageSelect.innerHTML = '';
    targetPagesContainer.innerHTML = '';
    if (flyerData.pages.length < 2) {
        targetPagesContainer.innerHTML = '<p class="text-xs text-center text-gray-500 p-2">Você precisa de pelo menos 2 páginas.</p>';
        applyMasterSettingsBtn.disabled = true;
        return;
    }
    applyMasterSettingsBtn.disabled = false;
    flyerData.pages.forEach((page, index) => {
        const sourceOption = document.createElement('option');
        sourceOption.value = index;
        sourceOption.textContent = `Página ${index + 1}`;
        masterPageSelect.appendChild(sourceOption);
        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex items-center gap-2 p-1 rounded';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `target-page-${index}`;
        checkbox.value = index;
        checkbox.className = 'h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500';
        const label = document.createElement('label');
        label.htmlFor = `target-page-${index}`;
        label.textContent = `Página ${index + 1}`;
        label.className = 'text-sm cursor-pointer flex-grow';
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        targetPagesContainer.appendChild(itemDiv);
    });
    masterPageSelect.value = currentSourceSelection || flyerData.currentPageIndex;
    updateTargetPagesState();
}

function updateTargetPagesState() {
    const sourcePageIndex = masterPageSelect.value;
    const allCheckboxes = targetPagesContainer.querySelectorAll('input[type="checkbox"]');
    allCheckboxes.forEach(cb => {
        if (cb.value === sourcePageIndex) {
            cb.checked = false;
            cb.disabled = true;
            cb.parentElement.classList.add('opacity-50');
        } else {
            cb.disabled = false;
            cb.parentElement.classList.remove('opacity-50');
        }
    });
}

// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ABAIXO ▼▼▼
function applyMasterSettingsToSelectedPages() {
    const sourcePageIndex = parseInt(masterPageSelect.value, 10);
    const targetCheckboxes = targetPagesContainer.querySelectorAll('input[type="checkbox"]:checked');
    const targetPageIndexes = Array.from(targetCheckboxes).map(cb => parseInt(cb.value, 10));

    if (isNaN(sourcePageIndex) || !flyerData.pages[sourcePageIndex]) {
        showAlert("Página de origem inválida.");
        return;
    }

    if (targetPageIndexes.length === 0) {
        showAlert("Por favor, marque pelo menos uma página de destino para aplicar o estilo.");
        return;
    }

    const sourcePage = flyerData.pages[sourcePageIndex];
    const confirmationMessage = `Isso aplicará o estilo da Página ${sourcePageIndex + 1} para as ${targetPageIndexes.length} página(s) marcadas. Deseja continuar?`;

    showConfirm(confirmationMessage, (confirmed) => {
        if (confirmed) {
            showSpinner(true);
            
            // Cria uma cópia completa e segura das configurações e do layout da página de origem
            const settingsTemplate = JSON.parse(JSON.stringify(sourcePage.settings));
            const manualLayoutTemplate = JSON.parse(JSON.stringify(sourcePage.manualLayout));

            targetPageIndexes.forEach(targetIndex => {
                const targetPage = flyerData.pages[targetIndex];
                if (targetPage) {
                    // Preserva os produtos e o fundo da página de destino
                    const originalProducts = targetPage.products;
                    const originalBackgroundImage = targetPage.backgroundImage;
                    const originalBackgroundImageSrc = targetPage.backgroundImageSrc;

                    // Aplica as novas configurações e layouts
                    targetPage.settings = JSON.parse(JSON.stringify(settingsTemplate));
                    targetPage.manualLayout = JSON.parse(JSON.stringify(manualLayoutTemplate));

                    // Restaura os produtos e fundo originais
                    targetPage.products = originalProducts;
                    targetPage.backgroundImage = originalBackgroundImage;
                    targetPage.backgroundImageSrc = originalBackgroundImageSrc;
                }
            });

            // Atualiza a interface e redesenha o canvas
            applyPageSettingsToUI(flyerData.pages[flyerData.currentPageIndex]);
            redrawCanvas();
            showSpinner(false);
            showAlert(`Estilo aplicado com sucesso em ${targetPageIndexes.length} página(s)!`);
        }
    });
}

function generateAutoLayout(productCount) {
    if (productCount <= 0) return [];
    let layout = [];
    if (productCount <= 4) layout = [{ products: productCount }];
    else if (productCount === 5) layout = [{ products: 3 }, { products: 2 }];
    else if (productCount === 6) layout = [{ products: 3 }, { products: 3 }];
    else if (productCount === 7) layout = [{ products: 4 }, { products: 3 }];
    else if (productCount === 8) layout = [{ products: 4 }, { products: 4 }];
    else if (productCount === 9) layout = [{ products: 3 }, { products: 3 }, { products: 3 }];
    else if (productCount === 10) layout = [{ products: 4 }, { products: 3 }, { products: 3 }];
    else if (productCount === 11) layout = [{ products: 4 }, { products: 4 }, { products: 3 }];
    else if (productCount === 12) layout = [{ products: 4 }, { products: 4 }, { products: 4 }];
    else {
        let count = productCount;
        while (count > 0) {
            const productsInRow = Math.min(count, 4);
            layout.push({ products: productsInRow });
            count -= productsInRow;
        }
    }
    layout.forEach((line, index) => {
        line.rowSpacing = (index === layout.length - 1) ? 0 : 0;
    });
    return layout;
}
		
		
		
        // DOM Elements
        const canvas = document.getElementById('flyerCanvas');
        const ctx = canvas.getContext('2d');
		// ▼▼▼ ADICIONE ESTAS LINHAS ABAIXO ▼▼▼
const downloadAllBtn = document.getElementById('downloadAllBtn');
downloadAllBtn.addEventListener('click', downloadAllPages);
// ▲▲▲ FIM DA ADIÇÃO ▲▲▲
		
        const menuItems = document.querySelectorAll('.menu-item');
        const panels = document.querySelectorAll('.panel');
        const menuBackdrop = document.getElementById('menuBackdrop');
        const mainContent = document.getElementById('mainContent');
        const pageSizeSelect = document.getElementById('pageSize');
        const customSizeInputs = document.getElementById('custom-size-inputs');
        const customWidthInput = document.getElementById('customWidth');
        const customHeightInput = document.getElementById('customHeight');
        const predefinedLayoutSelect = document.getElementById('predefinedLayoutSelect');
        const manualLayoutControls = document.getElementById('manual-layout-controls');
        const lineLayoutContainer = document.getElementById('line-layout-container');
        const addLineBtn = document.getElementById('addLineBtn');
        const enableSlotBorderCheckbox = document.getElementById('enableSlotBorder');
        const slotColorContainer = document.getElementById('slot-color-container');
        const slotColorInput = document.getElementById('slotColor');
        const highlightFirstLineCheckbox = document.getElementById('highlightFirstLine');
        const highlightColorContainer = document.getElementById('highlight-color-container');
        const highlightColorInput = document.getElementById('highlightColor');
        const topMarginInput = document.getElementById('topMargin');
        const promoLogoInput = document.getElementById('promoLogoInput');
        const promoLogoWidthInput = document.getElementById('promoLogoWidth');
        const storeLogoInput = document.getElementById('storeLogoInput');
        const storeLogoWidthInput = document.getElementById('storeLogoWidth');
        const complementaryLogoInput = document.getElementById('complementaryLogoInput');
        const complementaryLogoWidthInput = document.getElementById('complementaryLogoWidth');
        const enableSloganCheckbox = document.getElementById('enableSlogan');
        const sloganOptionsDiv = document.getElementById('slogan-options');
        const sloganTextInput = document.getElementById('sloganText');
        const sloganFontSizeInput = document.getElementById('sloganFontSize');
        const sloganColorInput = document.getElementById('sloganColor');
        const enableSloganBorderCheckbox = document.getElementById('enableSloganBorder');
        const sloganBorderColorContainer = document.getElementById('slogan-border-color-container');
        const sloganBorderColorInput = document.getElementById('sloganBorderColor');
        const firstLineBalloonStyleSelect = document.getElementById('firstLineBalloonStyle');
        const otherLinesBalloonStyleSelect = document.getElementById('otherLinesBalloonStyle');
        const highlightedBalloonControls = document.getElementById('highlight-balloon-controls');
        const highlightedBalloonOffsetYInput = document.getElementById('highlightedBalloonOffsetY');
        const balloonGlobalOffsetYInput = document.getElementById('balloonGlobalOffsetY');
        const descriptionGlobalOffsetYInput = document.getElementById('descriptionGlobalOffsetY');
        const validityInput = document.getElementById('validity');
        const footerSubtextInput = document.getElementById('footerSubtext');
        const footerSpacingInput = document.getElementById('footerSpacing');
        const enableFooterTextCheckbox = document.getElementById('enableFooterText');
        const footerTextOptionsDiv = document.getElementById('footer-text-options');
        const enableFooterBackgroundCheckbox = document.getElementById('enableFooterBackground');
        const footerOptionsDiv = document.getElementById('footer-options');
        const footerBgColorInput = document.getElementById('footerBgColor');
        const footerTextColorInput = document.getElementById('footerTextColor');
        const footerFontSelect = document.getElementById('footerFont');
        const footerFontSizeInput = document.getElementById('footerFontSize');
        const footerSubtextFontSelect = document.getElementById('footerSubtextFont');
        const footerSubtextFontSizeInput = document.getElementById('footerSubtextFontSize');
        const footerTextVerticalAlignSelect = document.getElementById('footerTextVerticalAlign');
        const footerBorderRadiusInput = document.getElementById('footerBorderRadius');
        const footerPaddingYInput = document.getElementById('footerPaddingY');
        const footerPositionYInput = document.getElementById('footerPositionY');
        const footerTextSpacingInput = document.getElementById('footerTextSpacing');
        const lateralSpacingInput = document.getElementById('lateralSpacing');
        const backgroundImageInput = document.getElementById('backgroundImage');
        const productNameInput = document.getElementById('productName');
        const priceInput = document.getElementById('price');
        const productImageInput = document.getElementById('productImage');
        const addProductBtn = document.getElementById('addProductBtn');
        const bulkAddTextarea = document.getElementById('bulkAddTextarea');
        const bulkAddBtn = document.getElementById('bulkAddBtn');
        const productListDiv = document.getElementById('productList');
        const downloadBtn = document.getElementById('downloadBtn');
        const saveFlyerBtn = document.getElementById('saveFlyerBtn');
		
		// ▼▼▼ ADICIONE ESTAS 4 LINHAS ABAIXO ▼▼▼
const generatePriceTagFromListBtn = document.getElementById('generatePriceTagFromListBtn');
if(generatePriceTagFromListBtn) {
    generatePriceTagFromListBtn.addEventListener('click', generatePostersFromList);
}
		
		
        const loadFlyerBtn = document.getElementById('loadFlyerBtn');
        const deleteFlyerBtn = document.getElementById('deleteFlyerBtn');
        const flyerNameInput = document.getElementById('flyerName');
        const savedFlyersSelect = document.getElementById('savedFlyersSelect');
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalInputLabel = document.getElementById('modalInputLabel');
        const modalTextInput = document.getElementById('modalTextInput');
        const modalOkBtn = document.getElementById('modalOkBtn');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const controlPanelContainer = document.getElementById('controlPanelContainer');
        const customFontInput = document.getElementById('customFontInput');
        const customFontNameInput = document.getElementById('customFontNameInput');
        const addCustomFontBtn = document.getElementById('addCustomFontBtn');
        const customFontList = document.getElementById('customFontList');
        const fontControlsDefault = document.getElementById('font-controls-default');
        const productNameFontSelect = document.getElementById('productNameFont');
        const productNameFontSizeInput = document.getElementById('productNameFontSize');
        const fontControlsContour = document.getElementById('font-controls-contour');
        const descFontContour = document.getElementById('descFontContour');
        const descFontSizeContour = document.getElementById('descFontSizeContour');
        const descColorContour = document.getElementById('descColorContour');
        const descOffsetYContour = document.getElementById('descOffsetYContour');
        const fontControlsCurrencyHighlight = document.getElementById('font-controls-currency-highlight');
        const chDescFontSelect = document.getElementById('chDescFont');
        const chDescFontSizeInput = document.getElementById('chDescFontSize');
        const fontControlsYellowTag = document.getElementById('font-controls-yellow-tag');
        const ytDescFontSelect = document.getElementById('ytDescFont');
        const ytDescFontSizeInput = document.getElementById('ytDescFontSize');
        const ytDescColorInput = document.getElementById('ytDescColor');
        const balloonSettingsDefault = document.getElementById('balloon-settings-default');
        const priceFontSelect = document.getElementById('priceFont');
        const firstLinePriceFontSizeInput = document.getElementById('firstLinePriceFontSize');
        const otherLinesPriceFontSizeInput = document.getElementById('otherLinesPriceFontSize');
        const balloonHeightPercentInput = document.getElementById('balloonHeightPercent');
        const balloonSettingsContour = document.getElementById('balloon-settings-contour');
        const priceFontContour = document.getElementById('priceFontContour');
        const firstLinePriceFontSizeContour = document.getElementById('firstLinePriceFontSizeContour');
        const otherLinesPriceFontSizeContour = document.getElementById('otherLinesPriceFontSizeContour');
        const priceColorContour = document.getElementById('priceColorContour');
        const priceBorderColorContour = document.getElementById('priceBorderColorContour');
        const priceBorderWidthContour = document.getElementById('priceBorderWidthContour');
        const balloonSettingsCurrencyHighlight = document.getElementById('balloon-settings-currency-highlight');
        const chBgColorInput = document.getElementById('chBgColor');
        const chPriceColorInput = document.getElementById('chPriceColor');
        const chCircleColorInput = document.getElementById('chCircleColor');
        const chCurrencyColorInput = document.getElementById('chCurrencyColor');
        const chPriceFontSelect = document.getElementById('chPriceFont');
        const firstLineChPriceFontSizeInput = document.getElementById('firstLineChPriceFontSize');
        const otherLinesChPriceFontSizeInput = document.getElementById('otherLinesChPriceFontSize');
        const chBorderRadiusInput = document.getElementById('chBorderRadius');
        const balloonSettingsYellowTag = document.getElementById('balloon-settings-yellow-tag');
        const ytBgColorInput = document.getElementById('ytBgColor');
        const ytPriceColorInput = document.getElementById('ytPriceColor');
        const ytPriceFontSelect = document.getElementById('ytPriceFont');
        const firstLineYtPriceFontSizeInput = document.getElementById('firstLineYtPriceFontSize');
        const otherLinesYtPriceFontSizeInput = document.getElementById('otherLinesYtPriceFontSize');
        const ytBorderRadiusInput = document.getElementById('ytBorderRadius');
        const balloonSettingsGiganteTag = document.getElementById('balloon-settings-gigante-tag');
        const gtBalloonHeightInput = document.getElementById('gt_balloonHeight');
        const gtOffsetXInput = document.getElementById('gt_offsetX');
        const gtOffsetYInput = document.getElementById('gt_offsetY');
        const imageControlsContainer = document.getElementById('image-controls-container');
		const selectAllProductsBtn = document.getElementById('selectAllProductsBtn');
		const deselectAllProductsBtn = document.getElementById('deselectAllProductsBtn');

        //const productImageSelect = document.getElementById('productImageSelect');
        const imageRepetitionsInput = document.getElementById('imageRepetitions');
        const imageRepetitionDirectionSelect = document.getElementById('imageRepetitionDirection');
        const imagePositionXInput = document.getElementById('imagePositionX');
        const imagePositionYInput = document.getElementById('imagePositionY');
        const imageFitSelect = document.getElementById('imageFit');
        const imageWidthPercentInput = document.getElementById('imageWidthPercent');
        const imageHeightPercentInput = document.getElementById('imageHeightPercent');
        const enableSlotBackgroundCheckbox = document.getElementById('enableSlotBackground');
        const slotBackgroundOptionsDiv = document.getElementById('slot-background-options');
        const slotBackgroundColorInput = document.getElementById('slotBackgroundColor');
        const slotBackgroundOpacityInput = document.getElementById('slotBackgroundOpacity');
        const addPageBtn = document.getElementById('addPageBtn');
        const deletePageBtn = document.getElementById('deletePageBtn');
        const pageListContainer = document.getElementById('pageListContainer');
        const useFirstPageBgContainer = document.getElementById('useFirstPageBgContainer');
        const useFirstPageBgCheckbox = document.getElementById('useFirstPageBg');
        
		const clearProductListBtn = document.getElementById('clearProductListBtn');
		
        // --- TEMPLATE DOM ELEMENTS ---
        const templateNameInput = document.getElementById('templateNameInput');
        const saveTemplateBtn = document.getElementById('saveTemplateBtn');
        const loadTemplateBtn = document.getElementById('loadTemplateBtn');
        const deleteTemplateBtn = document.getElementById('deleteTemplateBtn');
        const savedTemplatesGrid = document.getElementById('savedTemplatesGrid');
		
		
		// Encontre este bloco de código
const adaptForSocialMediaBtn = document.getElementById('adaptForSocialMediaBtn');
const adaptModal = document.getElementById('adaptModal');
const runAdaptationBtn = document.getElementById('runAdaptationBtn');
const cancelAdaptationBtn = document.getElementById('cancelAdaptationBtn');
const applyP2ValidityBtn = document.getElementById('applyP2ValidityBtn');
const applyP2FooterBtn = document.getElementById('applyP2FooterBtn');
const applyP2BackgroundBtn = document.getElementById('applyP2BackgroundBtn');

// ▼▼▼ ADICIONE A NOVA LINHA AQUI ▼▼▼
const applyLayoutToAllOthersBtn = document.getElementById('applyLayoutToAllOthersBtn');

       

	   // --- App State ---
		// ▼▼▼ COLE ESTE BLOCO DE VARIÁVEIS AQUI ▼▼▼
let viewTransform = { scale: 1, origin: { x: 0, y: 0 } };
let panStart = { x: 0, y: 0 };
const MIN_SCALE = 0.2;
const MAX_SCALE = 5;
let mouseAction = 'none'; // Ação atual: 'none', 'panning', 'draggingLogo', 'draggingHeader'
let validityOffsetX, validityOffsetY;
// ▲▲▲ FIM DO BLOCO PARA COLAR ▲▲▲
		
		
        let flyerData = { pages: [], currentPageIndex: 0, logos: { promo: { name: 'promoLogo', img: null, src: null }, store: { name: 'storeLogo', img: null, src: null }, complementary: { name: 'complementaryLogo', img: null, src: null } } };
        let newProductImage = null;
        let dragStartIndex;
        let productSlots = [];
        let activeDragObject = null;
        let activePanelId = null;
        let app, auth, db, userId;
		let selectedProductIndices = new Set();
		let isPanelLocked = false;
		let isDatabaseSynced = true; // LINHA ADICIONADA: Assume que está sincronizado ao iniciar
let selectedProjectName = null; // LINHA ADICIONADA

		
		
		// ▼▼▼ COLE ESTE BLOCO DE CONFIGURAÇÕES PADRÃO ▼▼▼
// ▼▼▼ SUBSTITUA O BLOCO anstagramHeaderDefaults INTEIRO POR ESTE ▼▼▼
const instagramHeaderDefaults = {
    enabled: true,
    backgroundEnabled: false, // Opção "Ativar Fundo Verde" desativada
    startDate: '2025-07-31', // Data de Início da imagem
    endDate: '2025-08-06', // Data de Fim da imagem
    titleText: '', // Texto do Título da imagem
    stockText: '', // Texto Extra está vazio na imagem
      x: 1324, // Posição X (px) da imagem
    y: -10, // Posição Y (px) da imagem
    width: 430, // Largura (px) da imagem
    headerValidityScale: 100, // Escala Geral (%) da imagem
    fontSizeLine1: 44, // Fonte Título da imagem
    fontSizeStartDate: 52, // Fonte Data Início da imagem
    fontSizeDates: 52, // Fonte Data Fim da imagem
    fontSizeStock: 25, // Fonte Estoque da imagem
    fontSizeExtra2: 22, // Fonte Texto Extra 2 da imagem
    extraTextAlign: 'center', // Alinhamento Texto Extra da imagem
    lineSpacing: -7, // Espaç. Linhas da imagem
    headerSeparatorSpacing: 10, // Espaç. Separador da imagem
    extraSpacing: 5, // Espaç. Extras da imagem
    dateToStockSpacing: -206 // Espaç. Data Fim > Estoque (px) da imagem
};
// ▲▲▲ FIM DO BLOCO ▲▲▲
// ▲▲▲ FIM DO BLOCO ▲▲▲

// ▼▼▼ COLE O NOVO BLOCO DE MARGENS PADRÃO AQUI ▼▼▼
const instagramMarginDefaults = {
    top: 580,
    lateral: 50,
    footer: 50
};
		
		// ▼▼▼ COLE TODO ESTE BLOCO DE CÓDIGO ▼▼▼

// --- BANCO DE DADOS DE PROJETOS PRÉ-CARREGADOS ---
const preloadedProjects = {
    "Semana Atacarejo": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Quarta Verde": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Terça Quarta Verde": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Semana Atacarejo Post": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Aquecimento Operação Combate": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Fecha Mes": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "SABADO DA PADARIA": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Semana Imbatível": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Terça da Carne": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVado O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}},
    "Virada do Preço Baixo": {"pages":[{"products":[],"manualLayout":[],"lineObjects":[],"backgroundImage":null,"backgroundImageSrc":null,"settings":{"pageSize":"1080x1350","predefinedLayout":"manual","predefinedBorderStyle":"straight","customWidth":1080,"customHeight":1350,"margins":{"top":375,"lateral":40,"footer":100},"backgroundImageSrc":null,"logos":{"promo":{"name":"promoLogo","width":200,"x":40,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"store":{"name":"storeLogo","width":200,"x":840,"y":40,"isDragging":false,"offsetX":0,"offsetY":0,"src":null},"complementary":{"name":"complementaryLogo","width":150,"x":440,"y":50,"isDragging":false,"offsetX":0,"offsetY":0,"src":null}},"slogan":{"enabled":false,"text":"OFERTAS ARRASADORAS","fontSize":60,"color":"#e63946","borderEnabled":false,"borderColor":"#000000"},"slotBorder":{"customColorEnabled":false,"color":"#007c11"},"highlight":{"enabled":false,"color":"#FFFF00","noBorder":false,"highlightHeightMultiplier":1.4,"style":"individual"},"slotBackground":{"enabled":true,"color":"#FFFFFF","opacity":100},"imageAreaScale":100,"fonts":{"default":{"productName":{"family":"Inter","size":14},"descriptionOffsetY":0,"descriptionStartY":25,"descScaleX":100,"descScaleY":100},"contour":{"descFont":"Anton","descSize":14,"descColor":"#000000","descOffsetY":21,"priceFont":"Anton","firstLinePriceSize":45,"otherLinesPriceSize":35,"priceColor":"#FFDE17","priceBorderColor":"#E62228","priceBorderWidth":6,"imageTextSpacing":5},"currencyHighlight":{"chDescFont":"Inter","chDescFontSize":14},"yellowTag":{"descFont":"Oswald","descSize":17,"descColor":"#000000"}},"balloonStyles":{"default":{"price":{"family":"Anton","firstLineSize":40,"otherLinesSize":30,"scaleX":100,"scaleY":100,"priceOffsetY":4},"color":"#FF0000"},"currencyHighlight":{"bgColor":"#009688","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#004D40","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"currencyHighlight2":{"bgColor":"#008000","priceColor":"#FFFFFF","circleColor":"#FFFFFF","currencyColor":"#007647","priceFont":"Anton","firstLinePriceSize":50,"otherLinesPriceSize":40,"borderRadius":20},"yellowTag":{"tagBgColor":"#ffde00","priceColor":"#d90429","priceFont":"Oswald","firstLinePriceSize":60,"otherLinesPriceSize":50,"borderRadius":15},"greenOnYellowTag":{"priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":7},"redTagSeparateRS":{"priceFont":"Anton","priceFontSize":60,"priceOffsetX":0,"priceOffsetY":0},"giganteTag":{"height":20,"offsetX":0,"offsetY":0,"priceOffsetX":0,"priceOffsetY":7,"descFont":"Oswald","descFontSize":20,"descOffsetX":0,"descOffsetY":0},"descLeftRedTag":{"descFont":"Anton","descFontSize":17,"descColor":"#000000","priceFont":"Anton","priceFontSize":70,"priceOffsetX":0,"priceOffsetY":0},"customBalloons":{"priceColor":"#FFFFFF","priceFontSize":80,"priceOffsetX":50,"priceOffsetY":50,"balloonWidth":85,"balloonHeight":85,"priceFont":"Anton","descLeftLayout":false},"descLeftCustom":{"selectedBalloonName":"","balloonWidthPercent":85,"balloonHeightPercent":85}},"balloons":{"firstLine":"default","otherLines":"default","highlightedBalloonOffsetY":0,"globalOffsetY":0,"balloonHeightPercent":70},"footer":{"textEnabled":false,"text":"OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.","fontFamily":"Roboto","footerSubtext":"POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.","subtextFontFamily":"Roboto","footerSubtextFontSize":18,"backgroundEnabled":true,"bgColor":"#000000","textColor":"#FFFFFF","textVerticalAlign":"middle","borderRadius":0,"paddingY":20,"positionY":2150,"textSpacing":10,"autoPosition":true},"headerValidity":{"enabled":false,"startDate":"","endDate":"","titleText":"","stockText":"OU ENQUANTO DURAREM OS ESTOQUES.","extraText2":"","x":50,"y":50,"width":350,"bgColor":"#00843D","textColor":"#FFFFFF","fontSizeLine1":25,"fontSizeStartDate":60,"fontSizeDates":50,"fontSizeStock":35,"fontSizeExtra2":25,"extraTextAlign":"center","lineSpacing":10,"extraSpacing":5,"headerSeparatorSpacing":10,"dateToStockSpacing":15,"backgroundEnabled":true,"headerValidityScale":100}}}],"currentPageIndex":0,"logos":{"promo":{"name":"promoLogo","img":null,"src":null},"store":{"name":"storeLogo","img":null,"src":null},"complementary":{"name":"complementaryLogo","img":null,"src":null}}}
};

// ▲▲▲ FIM DO BLOCO ▲▲▲

        
	

        // --- UI & Utility Functions ---
        function showSpinner(show) { loadingSpinner.classList.toggle('visible', show); }
        function showAlert(message) { modalMessage.textContent = message; modalInputContainer.classList.add('hidden'); modalOkBtn.style.display = 'inline-block'; modalConfirmBtn.style.display = 'none'; modalCancelBtn.style.display = 'none'; customModal.classList.add('visible'); }
        function showConfirm(message, onConfirm) { modalMessage.textContent = message; modalInputContainer.classList.add('hidden'); modalOkBtn.style.display = 'none'; modalConfirmBtn.style.display = 'inline-block'; modalCancelBtn.style.display = 'inline-block'; customModal.classList.add('visible'); modalConfirmBtn.onclick = () => { customModal.classList.remove('visible'); onConfirm(true); }; modalCancelBtn.onclick = () => { customModal.classList.remove('visible'); onConfirm(false); }; }
        function showPrompt(message, label, defaultValue, onConfirm) { modalMessage.textContent = message; modalInputLabel.textContent = label; modalTextInput.value = defaultValue; modalInputContainer.classList.remove('hidden'); modalOkBtn.style.display = 'none'; modalConfirmBtn.style.display = 'inline-block'; modalCancelBtn.style.display = 'inline-block'; customModal.classList.add('visible'); modalConfirmBtn.onclick = () => { customModal.classList.remove('visible'); onConfirm(modalTextInput.value); }; modalCancelBtn.onclick = () => { customModal.classList.remove('visible'); onConfirm(null); }; }
        modalOkBtn.addEventListener('click', () => customModal.classList.remove('visible'));
        
		// CORREÇÃO: Garante que o painel de layout manual apareça ao ser selecionado.
        predefinedLayoutSelect.addEventListener('change', () => {
            const isManual = predefinedLayoutSelect.value === 'manual';
            const manualControls = document.getElementById('manual-layout-controls');
            const predefinedControls = document.getElementById('predefined-border-style-container');

            manualControls.classList.toggle('hidden', !isManual);
            predefinedControls.classList.toggle('hidden', isManual);
        });
		
		
		function openControlPanel(panelId) { 
		menuBackdrop.style.pointerEvents = 'auto'; // << LINHA ADICIONADA
            if (!activePanelId || activePanelId !== panelId || controlPanelContainer.classList.contains('-translate-x-full')) { 
                controlPanelContainer.classList.remove('-translate-x-full'); 
                // Verifica se a tela é menor que 768px (padrão para tablets/celulares)
if (window.innerWidth < 768) {
    // Se for tela pequena, aplica uma largura menor (15rem ≈ 240px)
    controlPanelContainer.style.width = '15rem'; 
} else {
    // Se for tela grande, mantém a largura original (24rem = 384px)
    controlPanelContainer.style.width = '24rem';
}
                menuBackdrop.classList.remove('hidden'); 
                document.body.classList.add('panel-is-open');
            } 
            panels.forEach(panel => panel.classList.add('hidden')); 
            document.getElementById(panelId).classList.remove('hidden'); 
            activePanelId = panelId; 
            
            // LINHA ADICIONADA AQUI
            if (panelId === 'panel-stock') {
                populateStockList();
            }
        }
		
        function closeControlPanel() { 
		menuBackdrop.style.pointerEvents = 'auto'; // << LINHA ADICIONADA
		isPanelLocked = false;
		controlPanelContainer.classList.add('-translate-x-full'); controlPanelContainer.style.width = '0'; menuBackdrop.classList.add('hidden');     document.body.classList.remove('panel-is-open');
activePanelId = null; menuItems.forEach(i => i.classList.remove('bg-blue-600')); }
       menuItems.forEach(item => {
    item.addEventListener('click', e => {
        e.preventDefault();
        const targetPanelId = item.dataset.panel;

        // Se o painel estiver travado, ignora o clique em qualquer outro ícone.
        if (isPanelLocked && targetPanelId !== 'panel-images') {
            return; // Não faz nada
        }

        // A lógica original de abrir/fechar o painel.
        // Agora, o ícone "Imagens" funciona como um botão para fechar e destravar.
        if (activePanelId === targetPanelId && !controlPanelContainer.classList.contains('-translate-x-full')) {
            closeControlPanel();
        } else {
            // Se um novo painel for aberto, ele não deve ser travado.
            isPanelLocked = false; 
            openControlPanel(targetPanelId);
            menuItems.forEach(i => i.classList.remove('bg-blue-600'));
            item.classList.add('bg-blue-600');
        }
    });
});
	   
	   
	   
        menuBackdrop.addEventListener('click', () => {
    // Só fecha o painel se ele NÃO estiver travado
    if (!isPanelLocked) {
        closeControlPanel();
    }
});
		
		
		
        enableSlotBackgroundCheckbox.addEventListener('change', () => slotBackgroundOptionsDiv.classList.toggle('hidden', !enableSlotBackgroundCheckbox.checked));

        // --- Manual Layout Logic ---
        function updateLineLabels() { document.querySelectorAll('.line-definition').forEach((line, index) => { const label = line.querySelector('label.line-label'); if (label) label.textContent = `Linha ${index + 1}:`; line.dataset.lineIndex = index; }); }
        function addNewLine(lineData = {}) {
            const lineIndex = lineLayoutContainer.children.length;
            const newLine = document.createElement('div');
            newLine.className = 'line-definition border-t pt-3 mt-3';
            newLine.dataset.lineIndex = lineIndex;
            
            const data = { 
                products: 4, rowSpacing: 0, colSpacing: 0, borderStyle: 'straight', 
                useFirstSlotAsTitle: false, titleText: 'Título da Oferta', titleLogoSrc: null, titleLogoImg: null,
                titleBgEnabled: false, titleBgColor: '#000000', titleWidthPercent: 100, titleHeightPercent: 100,
                titleAspectRatio: 'fill', titleFontSize: 40,
                titleStyle: 'individual', 
                lineBgSrc: null, lineBgImg: null,
                isTwoLineLayout: false,
                secondLineProducts: 6,
                ...lineData 
            };

            // HTML atualizado com a opção "Pontilhada Arredondada"
            newLine.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label class="line-label text-sm font-bold text-white bg-blue-500 px-2 py-1 rounded-md">Linha ${lineIndex + 1}:</label>
                    <button class="remove-line-btn text-red-500 hover:text-red-700 font-bold p-1 text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                    <div><label class="text-xs block">Produtos (1ª Linha)</label><input type="number" class="line-input w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" value="${data.products}" min="1"></div>
                    <div>
                        <label class="text-xs block">Borda</label>
                        <select class="line-border-style-input w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm">
                            <option value="straight" ${data.borderStyle === 'straight' ? 'selected' : ''}>Reta</option>
                            <option value="rounded" ${data.borderStyle === 'rounded' ? 'selected' : ''}>Arredondada</option>
                            <option value="dashed" ${data.borderStyle === 'dashed' ? 'selected' : ''}>Pontilhada Reta</option>
                            <option value="dashed-rounded" ${data.borderStyle === 'dashed-rounded' ? 'selected' : ''}>Pontilhada Arredondada</option>
                            <option value="none" ${data.borderStyle === 'none' ? 'selected' : ''}>Sem Borda</option>
                        </select>
                    </div>
                    <div class="col-span-2 grid grid-cols-2 gap-2">
                        <div><label class="text-xs block">Esp. Slots</label><input type="number" class="line-col-spacing-input w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" value="${data.colSpacing}" min="0"></div>
                        <div><label class="text-xs block">Esp. Abaixo</label><input type="number" class="line-row-spacing-input w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" value="${data.rowSpacing}" min="0"></div>
                    </div>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600 space-y-3">
                    <div class="flex items-center gap-2"><input type="checkbox" class="line-title-toggle h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${data.useFirstSlotAsTitle ? 'checked' : ''}><label class="text-sm font-medium">Usar 1º item como título de oferta</label></div>
                    <div class="line-title-controls ${data.useFirstSlotAsTitle ? '' : 'hidden'} space-y-3">
                        
                        <div>
                            <label class="text-xs block">Estilo do Bloco de Título</label>
                            <select class="line-title-style-select w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm">
                                <option value="individual" ${data.titleStyle === 'individual' ? 'selected' : ''}>Slots Separados</option>
                                <option value="unified" ${data.titleStyle === 'unified' ? 'selected' : ''}>Bloco Único</option>
                            </select>
                        </div>
                        
                        <div class="two-line-controls ${data.titleStyle === 'unified' ? '' : 'hidden'} space-y-3 pt-3 border-t border-gray-600">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" class="line-two-line-toggle h-4 w-4 rounded" ${data.isTwoLineLayout ? 'checked' : ''}>
                                <label class="text-sm font-medium">Ativar layout de 2 linhas</label>
                            </div>
                            <div class="second-line-options ${data.isTwoLineLayout ? '' : 'hidden'}">
                                <label class="text-xs block">Produtos na 2ª Linha</label>
                                <input type="number" class="line-second-line-products w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" value="${data.secondLineProducts}" min="1">
                            </div>
                        </div>

                        <input type="text" class="line-title-text w-full bg-gray-50 dark:bg-gray-700 border rounded p-1 text-sm" value="${data.titleText}" placeholder="Título da Oferta">
                        <div><label class="text-xs block">Tamanho da Fonte do Título</label><input type="number" class="line-title-font-size w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm" value="${data.titleFontSize}" min="10"></div>
                        <label class="block w-full text-center text-xs text-white bg-indigo-600 hover:bg-indigo-700 font-bold py-2 px-4 rounded-lg cursor-pointer">Adicionar Logo <input type="file" class="line-title-logo-input hidden" accept="image/*"></label>
                        
                        <label class="line-bg-upload-label ${data.titleStyle === 'unified' ? '' : 'hidden'} block w-full text-center text-xs text-white bg-teal-600 hover:bg-teal-700 font-bold py-2 px-4 rounded-lg cursor-pointer">
                            Fundo do Bloco <input type="file" class="line-bg-image-input hidden" accept="image/*">
                        </label>

                        <div class="flex items-center gap-2"><input type="checkbox" class="line-title-bg-toggle h-4 w-4 rounded" ${data.titleBgEnabled ? 'checked' : ''}><label class="text-sm font-medium">Cor Fundo Título</label><input type="color" class="line-title-bg-color w-8 h-8 p-0" value="${data.titleBgColor}"></div>
                        <div><label class="text-xs block">Ajuste da Imagem do Título</label><select class="line-title-aspect-ratio w-full bg-gray-50 dark:bg-gray-700 border rounded-md p-1 text-sm"><option value="fill" ${data.titleAspectRatio === 'fill' ? 'selected' : ''}>Distorcer</option><option value="contain" ${data.titleAspectRatio === 'contain' ? 'selected' : ''}>Manter Proporção</option></select></div>
                        <div><label class="text-xs block">Largura Título (%)</label><input type="range" class="line-title-width w-full" min="10" max="200" value="${data.titleWidthPercent}"></div>
                        <div><label class="text-xs block">Altura Título (%)</label><input type="range" class="line-title-height w-full" min="10" max="200" value="${data.titleHeightPercent}"></div>
                    </div>
                </div>`;
            
            lineLayoutContainer.appendChild(newLine);
            
            flyerData.pages[flyerData.currentPageIndex].lineObjects[lineIndex] = { 
                titleLogoImg: data.titleLogoImg, titleLogoSrc: data.titleLogoSrc,
                lineBgImg: data.lineBgImg, lineBgSrc: data.lineBgSrc
            }; 
            
            const titleToggle = newLine.querySelector('.line-title-toggle'); 
            const titleControls = newLine.querySelector('.line-title-controls');
            const titleStyleSelect = newLine.querySelector('.line-title-style-select');
            const bgUploadLabel = newLine.querySelector('.line-bg-upload-label');
            const twoLineControls = newLine.querySelector('.two-line-controls');
            const twoLineToggle = newLine.querySelector('.line-two-line-toggle');
            const secondLineOptions = newLine.querySelector('.second-line-options');

            titleToggle.addEventListener('change', () => titleControls.classList.toggle('hidden', !titleToggle.checked));
            titleStyleSelect.addEventListener('change', () => {
                bgUploadLabel.classList.toggle('hidden', titleStyleSelect.value !== 'unified');
                twoLineControls.classList.toggle('hidden', titleStyleSelect.value !== 'unified');
            });
            twoLineToggle.addEventListener('change', () => secondLineOptions.classList.toggle('hidden', !twoLineToggle.checked));

            newLine.querySelector('.line-title-logo-input').addEventListener('change', e => handleSingleImageUpload(e, img => { 
                const idx = parseInt(e.target.closest('.line-definition').dataset.lineIndex); 
                flyerData.pages[flyerData.currentPageIndex].lineObjects[idx].titleLogoImg = img; 
                flyerData.pages[flyerData.currentPageIndex].lineObjects[idx].titleLogoSrc = img.src; 
                redrawCanvas(); 
            }));

            newLine.querySelector('.line-bg-image-input').addEventListener('change', e => handleSingleImageUpload(e, img => {
                const idx = parseInt(e.target.closest('.line-definition').dataset.lineIndex);
                flyerData.pages[flyerData.currentPageIndex].lineObjects[idx].lineBgImg = img;
                flyerData.pages[flyerData.currentPageIndex].lineObjects[idx].lineBgSrc = img.src;
                redrawCanvas();
            }));

            newLine.querySelector('.remove-line-btn').addEventListener('click', e => { 
                const lineToRemove = e.target.closest('.line-definition'); 
                flyerData.pages[flyerData.currentPageIndex].lineObjects.splice(parseInt(lineToRemove.dataset.lineIndex), 1); 
                lineToRemove.remove(); 
                updateLineLabels(); 
                redrawCanvas(); 
            });
        }
		
		
        function getLayoutFromInputs() {
            return Array.from(document.querySelectorAll('.line-definition')).map((def, index) => ({
                products: parseInt(def.querySelector('.line-input').value, 10) || 1,
                rowSpacing: parseInt(def.querySelector('.line-row-spacing-input').value, 10) || 0,
                colSpacing: parseInt(def.querySelector('.line-col-spacing-input').value, 10) || 0,
                borderStyle: def.querySelector('.line-border-style-input').value,
                useFirstSlotAsTitle: def.querySelector('.line-title-toggle').checked,
                titleText: def.querySelector('.line-title-text').value,
                titleFontSize: parseInt(def.querySelector('.line-title-font-size').value, 10) || 40,
                titleBgEnabled: def.querySelector('.line-title-bg-toggle').checked,
                titleBgColor: def.querySelector('.line-title-bg-color').value,
                titleAspectRatio: def.querySelector('.line-title-aspect-ratio')?.value || 'fill',
                titleWidthPercent: parseInt(def.querySelector('.line-title-width')?.value, 10) || 100,
                titleHeightPercent: parseInt(def.querySelector('.line-title-height')?.value, 10) || 100,
                titleStyle: def.querySelector('.line-title-style-select')?.value || 'individual',
                // Lendo e salvando as novas propriedades de 2 linhas
                isTwoLineLayout: def.querySelector('.line-two-line-toggle')?.checked || false,
                secondLineProducts: parseInt(def.querySelector('.line-second-line-products')?.value, 10) || 6,
                // ---
                titleLogoSrc: flyerData.pages[flyerData.currentPageIndex].lineObjects[index]?.titleLogoSrc || null,
                titleLogoImg: flyerData.pages[flyerData.currentPageIndex].lineObjects[index]?.titleLogoImg || null,
                lineBgSrc: flyerData.pages[flyerData.currentPageIndex].lineObjects[index]?.lineBgSrc || null,
                lineBgImg: flyerData.pages[flyerData.currentPageIndex].lineObjects[index]?.lineBgImg || null
            }));
        }
        // --- General UI Event Listeners ---
        addLineBtn.addEventListener('click', () => { addNewLine(); redrawCanvas(); });
        highlightFirstLineCheckbox.addEventListener('change', () => { 
            const isChecked = highlightFirstLineCheckbox.checked;
            highlightColorContainer.classList.toggle('hidden', !isChecked); 
            highlightedBalloonControls.classList.toggle('hidden', !isChecked); 
            const noBorderContainer = document.getElementById('highlight-no-border-container');
            if (noBorderContainer) {
                noBorderContainer.classList.toggle('hidden', !isChecked);
            }
        });
        enableSlotBorderCheckbox.addEventListener('change', () => slotColorContainer.classList.toggle('hidden', !enableSlotBorderCheckbox.checked));
        enableSloganCheckbox.addEventListener('change', () => sloganOptionsDiv.classList.toggle('hidden', !enableSloganCheckbox.checked));
        enableSloganBorderCheckbox.addEventListener('change', () => sloganBorderColorContainer.classList.toggle('hidden', !enableSloganBorderCheckbox.checked));
        enableFooterTextCheckbox.addEventListener('change', () => footerTextOptionsDiv.classList.toggle('hidden', !enableFooterTextCheckbox.checked));
        enableFooterBackgroundCheckbox.addEventListener('change', () => {
            footerOptionsDiv.classList.toggle('hidden', !enableFooterBackgroundCheckbox.checked)
            const autoPosCheckbox = document.getElementById('footerAutoPosition');
            if(autoPosCheckbox) autoPosCheckbox.dispatchEvent(new Event('change'));
        });
        
        // ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ATUALIZADA ABAIXO ▼▼▼
pageSizeSelect.addEventListener('change', (e) => {
    const selectedFormat = e.target.value;
    const sizeMap = {
        '1080x1080': {w: 1080, h: 1080},
        '1080x1350': {w: 1080, h: 1350},
        '1080x1920': {w: 1080, h: 1920},
        '1843x966': {w: 1843, h: 966}, // Adicionado para paisagem
        '1769x2212': {w: 1769, h: 2212}, // Adicionado para Instagram
        '2953x4134': {w: 2953, h: 4134}, // Adicionado para Tabloide
    };

    if (sizeMap[selectedFormat]) {
        customWidthInput.value = sizeMap[selectedFormat].w;
        customHeightInput.value = sizeMap[selectedFormat].h;
    }

    const marginPresets = {
        '1080x1080': { top: 250, lateral: 50, footer: 150, positionY: 900 },
        '1080x1350': { top: 375, lateral: 40, footer: 100, positionY: 1200 },
        '1080x1920': { top: 450, lateral: 50, footer: 250, positionY: 1700 },
        '1843x966': { top: 80, lateral: 80, footer: 80, positionY: 450 },
        '1769x2212': { top: 375, lateral: 40, footer: 100, positionY: 1200 },
        '2953x4134': { top: 400, lateral: 100, footer: 200, positionY: 10 },
        'custom':    { top: 50,  lateral: 50, footer: 50,  positionY: 1000 }
    };
    const newValues = marginPresets[selectedFormat];
    if (newValues) {
        topMarginInput.value = newValues.top;
        lateralSpacingInput.value = newValues.lateral;
        footerSpacingInput.value = newValues.footer;
        footerPositionYInput.value = newValues.positionY; 
    }
    
    // --- INÍCIO DA LÓGICA ADICIONADA ---
    const instagramFormats = ['1080x1080', '1080x1350', '1769x2212', '1080x1920', '1843x966'];
    if (instagramFormats.includes(selectedFormat)) {
        const currentPage = flyerData.pages[flyerData.currentPageIndex];
        if (currentPage) {
            Object.assign(currentPage.settings.headerValidity, instagramHeaderDefaults);
            // Atualiza os campos do painel para refletir os novos padrões
            applyPageSettingsToUI(currentPage);
        }
    }
    // --- FIM DA LÓGICA ADICIONADA ---

    customSizeInputs.classList.toggle('hidden', selectedFormat !== 'custom');
    updateAndResize();
});


        customWidthInput.addEventListener('input', updateAndResize);
        customHeightInput.addEventListener('input', updateAndResize);
        
        // --- Template Logic ---
        function populateTemplatePreviews() {
            const templates = JSON.parse(localStorage.getItem('flyerTemplates') || '{}');
            savedTemplatesGrid.innerHTML = '';
            for (const name in templates) {
                const card = document.createElement('div');
                card.className = 'template-preview-card bg-white dark:bg-gray-800 p-2 rounded-lg cursor-pointer shadow-md flex flex-col items-center';
                card.dataset.templateName = name;
                const img = document.createElement('img');
                img.src = templates[name].thumbnail;
                img.className = 'w-full h-auto object-contain rounded-md mb-2';
                const nameLabel = document.createElement('span');
                nameLabel.textContent = name;
                nameLabel.className = 'text-xs text-center font-semibold';
                card.appendChild(img);
                card.appendChild(nameLabel);
                card.addEventListener('click', () => { document.querySelectorAll('.template-preview-card.selected').forEach(c => c.classList.remove('selected')); card.classList.add('selected'); templateNameInput.value = name; });
                savedTemplatesGrid.appendChild(card);
            }
        }
        // ======================= INÍCIO DA CORREÇÃO FINAL =======================
saveTemplateBtn.addEventListener('click', () => {
    const name = templateNameInput.value.trim();
    if (!name) {
        showAlert('Por favor, insira um nome para o template.');
        return;
    }
    const thumbnail = canvas.toDataURL('image/jpeg', 0.5);

    // Pega tanto as configurações gerais quanto a estrutura do layout
    const currentSettings = getPageSettingsFromUI();
    const currentLayout = getLayoutFromInputs(); // <-- LINHA NOVA

    const templates = JSON.parse(localStorage.getItem('flyerTemplates') || '{}');

    // Salva ambos no template
    templates[name] = {
        settings: currentSettings,
        layout: currentLayout, // <-- LINHA NOVA
        thumbnail: thumbnail
    };

    localStorage.setItem('flyerTemplates', JSON.stringify(templates));
    showAlert(`Template "${name}" salvo com sucesso!`);
    populateTemplatePreviews();
});
// ======================== FIM DA CORREÇÃO FINAL =========================
        
		// >>> INÍCIO DA CORREÇÃO: Substitua o bloco de código acima por este <<<
loadTemplateBtn.addEventListener('click', () => {
    const name = templateNameInput.value;
    if (!name) {
        showAlert('Por favor, selecione um template para carregar.');
        return;
    }
    const templates = JSON.parse(localStorage.getItem('flyerTemplates') || '{}');
    const templateData = templates[name];

    if (templateData && templateData.settings) {
        const currentPage = flyerData.pages[flyerData.currentPageIndex];
        const newSettings = templateData.settings;
        const newLayout = templateData.layout || []; // <-- LINHA NOVA

        showSpinner(true);

        // Aplica tanto as configurações quanto a estrutura do layout
        currentPage.settings = newSettings;
        currentPage.manualLayout = newLayout; // <-- LINHA NOVA

        const imagePromises = [];

        if (newSettings.backgroundImageSrc) {
            imagePromises.push(new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    currentPage.backgroundImage = img;
                    currentPage.backgroundImageSrc = newSettings.backgroundImageSrc;
                    resolve();
                };
                img.onerror = () => { resolve(); };
                img.src = newSettings.backgroundImageSrc;
            }));
        } else {
            currentPage.backgroundImage = null;
            currentPage.backgroundImageSrc = null;
        }

        if (newSettings.logos) {
            for (const logoKey of ['promo', 'store', 'complementary']) {
                const logoSrc = newSettings.logos[logoKey]?.src;
                if (logoSrc) {
                    imagePromises.push(new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            flyerData.logos[logoKey].img = img;
                            flyerData.logos[logoKey].src = logoSrc;
                            resolve();
                        };
                        img.onerror = () => { resolve(); };
                        img.src = logoSrc;
                    }));
                } else {
                    flyerData.logos[logoKey].img = null;
                    flyerData.logos[logoKey].src = null;
                }
            }
        }

        Promise.all(imagePromises).then(() => {
            applyPageSettingsToUI(currentPage); // Atualiza os controles do painel
            updateAndResize(); 
            showSpinner(false);
            showAlert(`Template "${name}" carregado com sucesso.`);
        });

    } else {
        showAlert('Erro ao carregar o template.');
    }
});
// >>> FIM DA CORREÇÃO <<<
		
		
        deleteTemplateBtn.addEventListener('click', () => { const name = templateNameInput.value; if (!name) { showAlert('Por favor, selecione um template para deletar.'); return; } showConfirm(`Tem certeza que deseja deletar o template "${name}"?`, (confirmed) => { if (confirmed) { const templates = JSON.parse(localStorage.getItem('flyerTemplates') || '{}'); delete templates[name]; localStorage.setItem('flyerTemplates', JSON.stringify(templates)); showAlert(`Template "${name}" deletado.`); templateNameInput.value = ''; populateTemplatePreviews(); } }); });

        // --- Canvas Drawing & HTML Rendering Functions ---
		
		// <<< ADICIONE ESTA NOVA FUNÇÃO AQUI >>>
        function drawSelectionHighlight(ctx, slot) {
            ctx.save();
            ctx.strokeStyle = 'rgba(59, 130, 246, 0.9)'; // Cor da borda do destaque (azul)
            ctx.lineWidth = 6; // Espessura da borda
            ctx.fillStyle = 'rgba(59, 130, 246, 0.2)'; // Cor do preenchimento do destaque
            ctx.strokeRect(slot.x, slot.y, slot.width, slot.height);
            ctx.fillRect(slot.x, slot.y, slot.width, slot.height);
            ctx.restore();
        }
		
		
		// <<< ADICIONE ESTA NOVA FUNÇÃO ABAIXO DA 'drawSelectionHighlight' >>>
        function syncImagePanelSelection() {
            const container = document.getElementById('productMultiSelectContainer');
            if (!container) return;
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');

            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index, 10);
                // Marca ou desmarca o checkbox com base no nosso Set de seleção
                cb.checked = selectedProductIndices.has(index);
            });

            // Atualiza os sliders de controle de imagem com base na nova seleção
            updateImageControlsUI();
        }
		
		
		
        function hexToRgba(hex, opacity) { let r = 0, g = 0, b = 0; if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; } else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; } return `rgba(${+r},${+g},${+b},${opacity / 100})`; }
        function setCanvasSize() { const currentPage = flyerData.pages[flyerData.currentPageIndex]; if (!currentPage) return; const size = currentPage.settings.pageSize; let width, height; if(size === 'custom') { width = currentPage.settings.customWidth; height = currentPage.settings.customHeight; } else { [width, height] = size.split('x').map(Number); } canvas.width = width; canvas.height = height; currentPage.settings.logos.store.x = canvas.width - currentPage.settings.logos.store.width - (currentPage.settings.margins.lateral || 40); redrawCanvas(); }
        
        // ===============================================================
        // == INÍCIO DO BLOCO DE NOVAS FUNÇÕES DE DESENHO DO CANVAS ======
        // ===============================================================

        function drawPriceContent(ctx, details) { ctx.fillStyle = '#FFFFFF', ctx.textAlign = 'left', ctx.textBaseline = 'middle'; const adjustedPriceY = details.priceY + details.intFontSize * 0.15, spacing = details.intFontSize * 0.1; let currentX = details.startX; ctx.font = `bold ${details.currencyFontSize}px '${details.priceFont}'`; ctx.fillText('R$', currentX, adjustedPriceY); currentX += ctx.measureText('R$').width + spacing; ctx.font = `bold ${details.intFontSize}px '${details.priceFont}'`; ctx.fillText(details.integerPart, currentX, adjustedPriceY); currentX += ctx.measureText(details.integerPart).width; ctx.font = `bold ${details.decFontSize}px '${details.priceFont}'`; ctx.fillText(',' + details.decimalPart, currentX, adjustedPriceY); }
        
		// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
// ▼▼▼ PASSO 1: SUBSTITUA TODA A FUNÇÃO 'drawTextOutlinePrice' PELA VERSÃO ABAIXO ▼▼▼

function drawTextOutlinePrice(ctx, x, y, w, h, details, fontSettings, descOffsetY, descScaleX, descScaleY) {
    ctx.save();

    const letterSpacing = 3;
    const priceFont = fontSettings.priceFont;
    const borderWidth = fontSettings.priceBorderWidth;
    const intFontSize = Math.min(details.intFontSize, h * 0.9);
    const decFontSize = intFontSize * 0.5;
    const currencyFontSize = intFontSize * 0.4;
    // Lê a escala do preço a partir do objeto 'details'
    const priceScaleX = details.scaleX || 1;
    const priceScaleY = details.scaleY || 1;

    // --- LÓGICA DO PREÇO (ALINHADO À DIREITA) ---
    ctx.strokeStyle = fontSettings.priceBorderColor;
    ctx.lineWidth = borderWidth;
    ctx.fillStyle = fontSettings.priceColor;
    ctx.textBaseline = "alphabetic";
    ctx.textAlign = 'right';
    ctx.lineJoin = 'round';

    const priceEndX = x + w;
    let priceNaturalWidth = 0;
    const currencyText = "R$";
    const integerText = details.integerPart;
    const decimalText = "," + details.decimalPart;

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    priceNaturalWidth += ctx.measureText(currencyText).width + (letterSpacing * currencyText.length);
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    priceNaturalWidth += ctx.measureText(integerText).width + (letterSpacing * integerText.length);
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    priceNaturalWidth += ctx.measureText(decimalText).width + (letterSpacing * decimalText.length);

    ctx.save();
    const priceCenterX = priceEndX - (priceNaturalWidth * priceScaleX / 2);
    const priceCenterY = y - (intFontSize / 2);
    ctx.translate(priceCenterX, priceCenterY);
    ctx.scale(priceScaleX, priceScaleY);
    
    let currentX = priceNaturalWidth / 2;
    ctx.textAlign = 'right';

    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    let tempX = currentX;
    for (let i = decimalText.length - 1; i >= 0; i--) { const char = decimalText.charAt(i); ctx.strokeText(char, tempX, 0); ctx.fillText(char, tempX, 0); tempX -= ctx.measureText(char).width + letterSpacing; }
    
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for (let i = integerText.length - 1; i >= 0; i--) { const char = integerText.charAt(i); ctx.strokeText(char, tempX, 0); ctx.fillText(char, tempX, 0); tempX -= ctx.measureText(char).width + letterSpacing; }
    
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    for (let i = currencyText.length - 1; i >= 0; i--) { const char = currencyText.charAt(i); ctx.strokeText(char, tempX, 0); ctx.fillText(char, tempX, 0); tempX -= ctx.measureText(char).width + letterSpacing; }
    ctx.restore();

    // --- LÓGICA DA DESCRIÇÃO (COM A ESCALA DOS SLIDERS) ---
    const descFont = fontSettings.descFont;
    const descFontSize = fontSettings.descSize;
    const descColor = fontSettings.descColor;
    const priceBlockWidth = priceNaturalWidth * priceScaleX; // Usa a largura escalada do preço para calcular o espaço
    const descMaxWidth = w - priceBlockWidth - 15;

    if (descMaxWidth > 20) {
        ctx.font = `bold ${descFontSize}px '${descFont}'`;
        ctx.fillStyle = descColor;
        ctx.textAlign = 'left';
        const descY = (y - intFontSize) + descOffsetY;
        // <<< A CHAMADA AGORA INCLUI OS VALORES DE ESCALA DA DESCRIÇÃO >>>
        wrapText(ctx, details.productName.toUpperCase(), x, descY, descMaxWidth, descFontSize * 1.1, 'left', descScaleX, descScaleY);
    }

    ctx.restore();
}
		
		
		
		
      
	  function drawPriceBalloonDefault(ctx, x, y, w, h, styleSettings) { 
    const radius = 15, pointerSize = 12; 
    ctx.fillStyle = styleSettings.color; // Usa a cor das configurações
    ctx.beginPath(); 
    ctx.moveTo(x + radius, y); 
    ctx.lineTo(x + w - radius, y); 
    ctx.arcTo(x + w, y, x + w, y + radius, radius); 
    ctx.lineTo(x + w, y + h - radius); 
    ctx.arcTo(x + w, y + h, x + w - radius, y + h, radius); 
    ctx.lineTo(x + radius, y + h); 
    ctx.arcTo(x, y + h, x, y + h - radius, radius); 
    ctx.lineTo(x, y + radius + pointerSize); 
    ctx.lineTo(x - pointerSize, y + radius + pointerSize / 2); 
    ctx.lineTo(x, y + radius); 
    ctx.closePath(); 
    ctx.fill(); 
}
	  
	  
        // APAGUE A FUNÇÃO 'drawPriceBalloonCircle' ANTIGA E COLE ESTA NO LUGAR
function drawPriceBalloonCircle(ctx, x, y, w, h, details) {
    ctx.save();

    // Desenha o fundo amarelo no formato de "pílula" (retângulo bem arredondado)
    const borderRadius = h / 2; // Cantos perfeitamente redondos
    ctx.fillStyle = '#FFC709'; // Amarelo do modelo
    pathRoundedRect(ctx, x, y, w, h, borderRadius);
    ctx.fill();

    // Define a fonte e a cor do texto
    const textColor = '#00552B'; // Verde escuro do modelo
    const priceFont = details.priceFont || 'Anton';
    ctx.fillStyle = textColor;
    ctx.textBaseline = 'middle'; // Alinha o texto verticalmente pelo meio

    // Define os tamanhos das fontes em relação à altura do balão
    const priceFontSize = h * 0.75;
    const currencyFontSize = h * 0.4;
    
    // Constrói o texto do preço completo
    const priceText = details.integerPart + ',' + details.decimalPart;

    // Calcula a largura total do texto para poder centralizá-lo
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    const currencyWidth = ctx.measureText('R$').width;
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    const priceWidth = ctx.measureText(priceText).width;
    const spacing = w * 0.05; // Espaçamento entre R$ e preço
    const totalTextWidth = currencyWidth + spacing + priceWidth;

    // Ponto inicial X para que o bloco de texto fique centralizado
    let currentX = x + (w - totalTextWidth) / 2;
    const textY = y + h / 2;

    // Desenha o "R$"
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    // O pequeno ajuste (-priceFontSize * 0.15) eleva o "R$" para alinhar com o topo do preço
    ctx.fillText('R$', currentX, textY - priceFontSize * 0.15); 
    currentX += currencyWidth + spacing;

    // Desenha o preço (inteiro e decimal juntos)
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    ctx.fillText(priceText, currentX, textY);

    ctx.restore();
}




function drawPriceBalloonCircleModel(ctx, x, y, w, h, details) {
    ctx.save();
    const centerX = x + w / 2;
    const centerY = y + h / 2;
    const radius = Math.min(w, h) / 2;
    
    // --- INÍCIO DA CORREÇÃO ---
    // Lê a fonte e o tamanho do objeto 'details' que vem do painel
    const priceFont = details.priceFont || 'Anton';
    const baseIntFontSize = details.intFontSize || (radius * 1.1);
    // --- FIM DA CORREÇÃO ---

    // CONTROLES DE DESIGN (permanecem editáveis aqui)
    const letterSpacing = 4;
    const enablePriceStretch = true;
    const maxPriceWidthRatio = 2.0;
    const priceVerticalOffset = 8; // Este controle continua funcionando
    
    // 1. Fundo e bordas
    const outerRedBorderWidth = radius * 0.05;
    const whiteBorderWidth = radius * 0.03;
    const innerRadius = radius - whiteBorderWidth - outerRedBorderWidth;
    const gradient = ctx.createRadialGradient(centerX, centerY, innerRadius * 0.1, centerX, centerY, innerRadius);
    gradient.addColorStop(0, '#E5242A');
    gradient.addColorStop(1, '#A60A0A');
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(centerX, centerY, innerRadius, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = '#FFFFFF';
    ctx.lineWidth = whiteBorderWidth;
    ctx.beginPath();
    ctx.arc(centerX, centerY, innerRadius + whiteBorderWidth / 2, 0, Math.PI * 2);
    ctx.stroke();
    ctx.strokeStyle = '#A60A0A';
    ctx.lineWidth = outerRedBorderWidth;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius - outerRedBorderWidth / 2, 0, Math.PI * 2);
    ctx.stroke();

    // 2. Define tamanhos de fonte relativos ao tamanho base do painel
    const intFontSize = baseIntFontSize;
    const currencyFontSize = intFontSize * 0.35; // Relação ajustada
    const decFontSize = intFontSize * 0.55;

    // 3. Posicionamento vertical
    const spacingBetween = radius * 0.1;
    const totalTextBlockHeight = currencyFontSize + intFontSize + spacingBetween;
    const blockStartY = centerY - totalTextBlockHeight / 2;

    // 4. Desenha o "R$"
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    ctx.fillStyle = '#FFFFFF';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const currencyY = blockStartY + currencyFontSize / 2 + priceVerticalOffset;
    ctx.fillText('R$', centerX, currencyY);

    // 5. Calcula a largura do preço
    let naturalPriceWidth = 0;
    const integerPartText = details.integerPart;
    const decimalPartText = ',' + details.decimalPart;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for (let i = 0; i < integerPartText.length; i++) {
        naturalPriceWidth += ctx.measureText(integerPartText[i]).width;
        if (i < integerPartText.length - 1) naturalPriceWidth += letterSpacing;
    }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for (let i = 0; i < decimalPartText.length; i++) {
        naturalPriceWidth += ctx.measureText(decimalPartText[i]).width;
        if (i < decimalPartText.length - 1) naturalPriceWidth += letterSpacing;
    }

    // 6. Calcula o fator de escala
    const maxPriceWidth = innerRadius * maxPriceWidthRatio;
    let priceScaleX = 1.0;
    if (enablePriceStretch && naturalPriceWidth > maxPriceWidth) {
        priceScaleX = maxPriceWidth / naturalPriceWidth;
    }

    // 7. Desenha o preço com a escala
    ctx.save();
    ctx.translate(centerX, 0); 
    ctx.scale(priceScaleX, 1);
    
    const newCenterX = 0; 
    let currentX = newCenterX - (naturalPriceWidth / 2);

    ctx.fillStyle = '#FFDE17';
    ctx.strokeStyle = '#D92329';
    ctx.lineJoin = 'round';
    ctx.textBaseline = 'middle';
    const priceY = blockStartY + currencyFontSize + spacingBetween + (intFontSize / 2) + priceVerticalOffset;
    ctx.textAlign = 'left';

    // Desenha a PARTE INTEIRA
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    ctx.lineWidth = intFontSize * 0.1;
    for (const char of integerPartText) {
        ctx.strokeText(char, currentX, priceY);
        ctx.fillText(char, currentX, priceY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }

    // Desenha os CENTAVOS
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    ctx.lineWidth = decFontSize * 0.15;
    const decimalY = priceY - (intFontSize - decFontSize) / 2;
    for (const char of decimalPartText) {
        ctx.strokeText(char, currentX, decimalY);
        ctx.fillText(char, currentX, decimalY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    
    ctx.restore(); 
    ctx.restore();
}
		
		
		
		// COLE ESTA NOVA FUNÇÃO INTEIRA NO SEU CÓDIGO
// APAGUE A FUNÇÃO ANTIGA E COLE ESTA VERSÃO CORRIGIDA NO LUGAR
// APAGUE A FUNÇÃO ANTIGA E COLE ESTA VERSÃO COM AJUSTE AUTOMÁTICO NO LUGAR
// VERSÃO DEFINITIVA - COLE ESTA FUNÇÃO NO LUGAR DA ANTIGA
// APAGUE A FUNÇÃO ANTIGA E COLE ESTA VERSÃO COM AJUSTE VERTICAL
// APAGUE A FUNÇÃO ANTIGA E COLE ESTA VERSÃO QUE USA OS CONTROLES DO PAINEL
// APAGUE A FUNÇÃO ANTIGA E COLE ESTA VERSÃO COM AJUSTE VERTICAL
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ORIGINAL ABAIXO ▼▼▼
// ▼▼▼ COLE A FUNÇÃO CORRIGIDA E COMPLETA AQUI ▼▼▼
function drawPriceBalloonYellowTagGreenText(ctx, x, y, w, h, details, styleSettings, isFirstRow) {
    ctx.save();

    const verticalOffset = 5;
    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;
    const largeRadius = h * 0.5;
    const smallRadius = h * 0.25;
    const radii = { tl: largeRadius, tr: smallRadius, br: smallRadius, bl: 0 };
    ctx.fillStyle = '#FFC709';
    pathAsymmetricRoundedRect(ctx, x, y, w, h, radii);
    ctx.fill();

    ctx.save();
    const centerX = x + w / 2;
    const textY = y + h / 2 + verticalOffset;
    ctx.translate(centerX, textY);
    ctx.scale(scaleX, scaleY);
    
    const textColor = '#00552B';
    // CORREÇÃO: Lê a fonte do objeto de configurações
    const priceFont = styleSettings.price.family || 'Anton';
    ctx.fillStyle = textColor;
    ctx.textBaseline = 'middle';

    // CORREÇÃO: Lê o tamanho da fonte do objeto de configurações
    const priceFontSize = isFirstRow ? styleSettings.price.firstLineSize : styleSettings.price.otherLinesSize;
    
    const currencyFontSize = priceFontSize * 0.55; // Proporção ajustada
    const priceText = details.integerPart + ',' + details.decimalPart;

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    const currencyWidth = ctx.measureText('R$').width;
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    const priceWidth = ctx.measureText(priceText).width;
    const spacing = w * 0.05;
    const naturalTotalWidth = currencyWidth + spacing + priceWidth;
    
    let autoScaleX = 1.0;
    if (naturalTotalWidth > w * 0.9) {
        autoScaleX = (w * 0.9) / naturalTotalWidth;
    }
    ctx.scale(autoScaleX, 1);

    let currentX = -naturalTotalWidth / 2;
    ctx.textAlign = 'left';

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    ctx.fillText('R$', currentX, -priceFontSize * 0.2);
    currentX += currencyWidth + spacing;
    
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    ctx.fillText(priceText, currentX, 0);

    ctx.restore();
    ctx.restore();
}
// ▲▲▲ FIM DO BLOCO ▲▲▲



// ▼▼▼ COLE A NOVA FUNÇÃO AQUI, ABAIXO DA ORIGINAL ▼▼▼

// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawPriceBalloonRedTagWhiteText' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawPriceBalloonRedTagWhiteText' PELA VERSÃO FINAL ABAIXO ▼▼▼
// ▼▼▼ COLE A FUNÇÃO CORRIGIDA E COMPLETA AQUI ▼▼▼
function drawPriceBalloonRedTagWhiteText(ctx, x, y, w, h, details, styleSettings, isFirstRow) {
    ctx.save();

    const verticalOffset = 0;
    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;
    const largeRadius = h * 0.5;
    const smallRadius = h * 0.25;
    const radii = { tl: largeRadius, tr: smallRadius, br: smallRadius, bl: 0 };
    ctx.fillStyle = '#FF0000'; // Cor vermelha
    pathAsymmetricRoundedRect(ctx, x, y, w, h, radii);
    ctx.fill();

    ctx.save();
    const centerX = x + w / 2;
    const textY = y + h / 2 + verticalOffset;
    ctx.translate(centerX, textY);
    ctx.scale(scaleX, scaleY);

    const textColor = '#FFFFFF';
    // CORREÇÃO: Lê a fonte do objeto de configurações
    const priceFont = styleSettings.price.family || 'Anton';
    ctx.fillStyle = textColor;
    ctx.textBaseline = 'middle';

    // CORREÇÃO: Lê o tamanho da fonte do objeto de configurações,
    // decidindo entre "1ª Linha" e "Demais Linhas"
    const priceFontSize = isFirstRow ? styleSettings.price.firstLineSize : styleSettings.price.otherLinesSize;

    const currencyFontSize = priceFontSize * 0.6; // Proporção ajustada
    const priceText = details.integerPart + ',' + details.decimalPart;

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    const currencyWidth = ctx.measureText('R$').width;
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    const priceWidth = ctx.measureText(priceText).width;
    const spacing = w * 0.05;
    const naturalTotalWidth = currencyWidth + spacing + priceWidth;

    let autoScaleX = 1.0;
    if (naturalTotalWidth > w * 0.95) { // Permite ocupar mais espaço
        autoScaleX = (w * 0.95) / naturalTotalWidth;
    }
    ctx.scale(autoScaleX, 1);

    let currentX = -naturalTotalWidth / 2;
    ctx.textAlign = 'left';

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    ctx.fillText('R$', currentX, -priceFontSize * 0.15);
    currentX += currencyWidth + spacing;

    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    ctx.fillText(priceText, currentX, 0);

    ctx.restore();
    ctx.restore();
}
// ▲▲▲ FIM DO BLOCO ▲▲▲
		
        // COLE ESTA FUNÇÃO COMPLETA NO LUGAR DA ANTIGA
// COLE ESTA FUNÇÃO COMPLETA E ATUALIZADA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO FINAL E CORRIGIDA NO LUGAR DA ANTIGA
// VERSÃO FINAL - COLE ESTA FUNÇÃO COMPLETA NO LUGAR DA ANTIGA
// VERSÃO FINALÍSSIMA - COLE NO LUGAR DA FUNÇÃO ANTIGA
// VERSÃO FINAL COM ESPAÇAMENTO DE LETRAS - COLE NO LUGAR DA FUNÇÃO ANTIGA
// VERSÃO FINAL CORRIGIDA - COLE NO LUGAR DA FUNÇÃO ANTIGA
// VERSÃO FINAL COM AJUSTE DE LARGURA DO PREÇO
// APAGUE A FUNÇÃO 'drawPriceBalloonCircleModel' ANTIGA E COLE ESTA NO LUGAR
// COLE ESTA NOVA FUNÇÃO
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA E FINAL
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA
// APAGUE A FUNÇÃO 'drawPriceBalloonRedYellowOutlined' ANTIGA E COLE ESTA VERSÃO
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO COM CONTROLE DE ESPAÇAMENTO
// SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawPriceBalloonRedYellowOutlined' POR ESTA VERSÃO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawPriceBalloonRedYellowOutlined' POR ESTA VERSÃO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawPriceBalloonRedYellowOutlined' POR ESTA VERSÃO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawPriceBalloonRedYellowOutlined' PELA VERSÃO ATUALIZADA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawPriceBalloonRedYellowOutlined' PELA VERSÃO ATUALIZADA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawPriceBalloonRedYellowOutlined' PELA VERSÃO ABAIXO ▼▼▼
function drawPriceBalloonRedYellowOutlined(ctx, x, y, w, h, details, styleSettings) {
    ctx.save();

    const widthMultiplier = 0.8;
    const rsHorizontalOffset = 30;
    const letterSpacing = 5;
    const priceFont = styleSettings.price.family || 'Anton';
    const mainRed = '#FF0000';
    const shadowRed = '#C90007';
    const priceYellow = '#FFDE17';
    const currencyOutlineYellow = '#FFDE17';
    const currencyColor = '#000000';
    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;

    const finalW = w * widthMultiplier;
    const finalX = x + (w - finalW) / 2;
    const borderRadius = h * 0.1;
    const shadowOffsetY = h * 0.12;

    ctx.fillStyle = shadowRed;
    pathRoundedRect(ctx, finalX, y + shadowOffsetY, finalW, h, borderRadius);
    ctx.fill();
    ctx.fillStyle = mainRed;
    pathRoundedRect(ctx, finalX, y, finalW, h, borderRadius);
    ctx.fill();

    const currencyFontSize = h * 0.45;
    const currencyX = finalX - rsHorizontalOffset;
    const currencyY = y + h * 0.8;
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';

    ctx.strokeStyle = currencyOutlineYellow;
    ctx.lineWidth = currencyFontSize * 0.15;
    ctx.lineJoin = 'round';
    ctx.strokeText('R$', currencyX, currencyY);
    ctx.fillStyle = currencyColor;
    ctx.fillText('R$', currencyX, currencyY);

    ctx.save();
    const priceCenterX = finalX + finalW / 2;
    
    // ======================= INÍCIO DA CORREÇÃO =======================
    // A linha abaixo agora soma o deslocamento Y definido no painel de opções.
    const priceCenterY = y + h / 2 + (styleSettings.price.priceOffsetY || 0);
    // ======================== FIM DA CORREÇÃO =========================

    ctx.translate(priceCenterX, priceCenterY);
    ctx.scale(scaleX, scaleY);

    const intFontSize = styleSettings.price.firstLineSize || h * 1.3;
    const decFontSize = intFontSize * 0.5;
    const borderWidth = intFontSize * 0.05;
    const integerPartText = details.integerPart;
    const decimalPartText = ',' + details.decimalPart;

    let naturalTotalWidth = 0;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for (const char of integerPartText) { naturalTotalWidth += ctx.measureText(char).width + letterSpacing; }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for (const char of decimalPartText) { naturalTotalWidth += ctx.measureText(char).width + letterSpacing; }
    naturalTotalWidth -= letterSpacing;

    let autoScaleX = 1.0;
    if (naturalTotalWidth > finalW * 0.9) {
        autoScaleX = (finalW * 0.9) / naturalTotalWidth;
    }
    ctx.scale(autoScaleX, 1);

    let currentX = -naturalTotalWidth / 2;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.lineJoin = 'round';

    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    ctx.strokeStyle = mainRed;
    ctx.lineWidth = borderWidth;
    for (const char of integerPartText) {
        ctx.strokeText(char, currentX, 0);
        ctx.fillStyle = priceYellow;
        ctx.fillText(char, currentX, 0);
        currentX += ctx.measureText(char).width + letterSpacing;
    }

    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    ctx.lineWidth = borderWidth * 0.6;
    const decimalY = 0 - (intFontSize * 0.25);
    for (const char of decimalPartText) {
        ctx.strokeText(char, currentX, decimalY);
        ctx.fillStyle = priceYellow;
        ctx.fillText(char, currentX, decimalY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }

    ctx.restore();
    ctx.restore();
}


        function drawPriceBalloonRectangle(ctx, x, y, w, h, styleSettings) { // Recebe as configurações
    ctx.fillStyle = styleSettings.color; // <--- USA A COR DAS CONFIGURAÇÕES
    pathRoundedRect(ctx, x, y, w, h, 10); 
    ctx.fill(); 
}
        // COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
function drawPriceBalloonCurrencyHighlight(ctx, x, y, w, h, details, styleSettings, isFirstRow) {
    const letterSpacing = 4;
    const mainBg = styleSettings.bgColor,
        circleBg = styleSettings.circleColor,
        currencyColor = styleSettings.currencyColor,
        priceColor = styleSettings.priceColor,
        priceFont = styleSettings.priceFont,
        scaleX = details.scaleX || 1,
        scaleY = details.scaleY || 1;

    const circleRadius = (h / 2) * 0.5;
    const circleCenterY = y + h / 2;
    const circleCenterX = x + circleRadius;
    const rectX = x + circleRadius;
    const rectW = w - circleRadius;

    ctx.fillStyle = mainBg;
    pathRoundedRect(ctx, rectX, y, rectW, h, styleSettings.borderRadius);
    ctx.fill();
    ctx.fillStyle = circleBg;
    ctx.beginPath();
    ctx.arc(circleCenterX, circleCenterY, circleRadius, 0, 2 * Math.PI);
    ctx.fill();
    ctx.strokeStyle = '#00897c';
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.fillStyle = currencyColor;
    ctx.font = `bold ${circleRadius * 0.8}px '${priceFont}'`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('R$', circleCenterX, circleCenterY);

    let intFontSize = isFirstRow ? styleSettings.firstLinePriceSize : styleSettings.otherLinesPriceSize;
    let decFontSize = intFontSize * 0.6;
    
    // Medir largura natural para centralizar
    const decimalPartWithComma = ',' + details.decimalPart;
    let totalTextWidth = 0;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for(const char of details.integerPart) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for(const char of decimalPartWithComma) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }
    
    ctx.save();
    // Centro do bloco de texto do preço
    const textBlockCenterX = rectX + rectW / 2;
    const textBlockCenterY = y + h / 2;
    ctx.translate(textBlockCenterX, textBlockCenterY);
    ctx.scale(scaleX, scaleY);

    ctx.fillStyle = priceColor;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    
    // Desenhar relativo à nova origem (0,0)
    let currentX = -totalTextWidth / 2;
    const priceY = (intFontSize * 0.08);

    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for(const char of details.integerPart) {
        ctx.fillText(char, currentX, priceY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for(const char of decimalPartWithComma) {
        ctx.fillText(char, currentX, priceY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.restore();
}
		function pathAsymmetricRoundedRect(ctx, x, y, width, height, radii) {
    ctx.beginPath();
    ctx.moveTo(x + radii.tl, y);
    ctx.lineTo(x + width - radii.tr, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radii.tr);
    ctx.lineTo(x + width, y + height - radii.br);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radii.br, y + height);
    ctx.lineTo(x + radii.bl, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radii.bl);
    ctx.lineTo(x, y + radii.tl);
    ctx.quadraticCurveTo(x, y, x + radii.tl, y);
    ctx.closePath();
}
		// SUBSTITUA A FUNÇÃO ANTIGA PELA VERSÃO ABAIXO
// COLE ESTA VERSÃO ATUALIZADA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO COM GRADIENTE NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
function drawPriceBalloonCurrencyHighlight2(ctx, x, y, w, h, details, styleSettings, isFirstRow) {
    const letterSpacing = 3;
    const circleBg = styleSettings.circleColor,
        currencyColor = styleSettings.currencyColor,
        priceColor = styleSettings.priceColor,
        priceFont = styleSettings.priceFont,
        scaleX = details.scaleX || 1,
        scaleY = details.scaleY || 1;

    const circleRadius = h * 0.3;
    const circleCenterY = y + h / 2;
    const circleCenterX = x + circleRadius * 0.8;
    const rectX = circleCenterX;
    const rectW = w - (rectX - x);
    const radii = { tl: h * 0.1, tr: h * 0.1, br: h * 0.5, bl: h * 0.1 };

    const gradient = ctx.createLinearGradient(rectX, y, rectX, y + h);
    gradient.addColorStop(0, '#00b06e');
    gradient.addColorStop(1, '#007648');
    ctx.fillStyle = gradient;
    pathAsymmetricRoundedRect(ctx, rectX, y, rectW, h, radii);
    ctx.fill();

    ctx.fillStyle = circleBg;
    ctx.beginPath();
    ctx.arc(circleCenterX, circleCenterY, circleRadius, 0, 2 * Math.PI);
    ctx.fill();
    ctx.strokeStyle = '#00897c';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = currencyColor;
    ctx.font = `bold ${circleRadius * 0.9}px '${priceFont}'`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('R$', circleCenterX, circleCenterY);

    let intFontSize = isFirstRow ? styleSettings.firstLinePriceSize : styleSettings.otherLinesPriceSize;
    let decFontSize = intFontSize * 0.6;
    
    const decimalPartWithComma = ',' + details.decimalPart;
    let totalTextWidth = 0;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for(const char of details.integerPart) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for(const char of decimalPartWithComma) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }

    ctx.save();
    const textBlockCenterX = rectX + rectW / 2;
    const textBlockCenterY = y + h / 2;
    ctx.translate(textBlockCenterX, textBlockCenterY);
    ctx.scale(scaleX, scaleY);
    
    ctx.fillStyle = priceColor;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    let currentX = -totalTextWidth / 2;
    const priceY = (intFontSize * 0.1);

    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for(const char of details.integerPart) {
        ctx.fillText(char, currentX, priceY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for(const char of decimalPartWithComma) {
        ctx.fillText(char, currentX, priceY);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.restore();
}
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawYellowTagPrice' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawYellowTagPrice' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawYellowTagPrice' INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ PASSO 2: SUBSTITUA TODA A FUNÇÃO 'drawYellowTagPrice' PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ PASSO 1: SUBSTITUA TODA A FUNÇÃO 'drawYellowTagPrice' PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawYellowTagPrice' PELA VERSÃO ABAIXO ▼▼▼
function drawYellowTagPrice(ctx, x, y, w, h, details, fontSettings, priceSettings, isFirstRow, descScaleX, descScaleY) {
    ctx.save();

    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const priceScaleX = details.scaleX || 1;
    const priceScaleY = details.scaleY || 1;
    
    const descFont = fontSettings.descFont || 'Oswald';
    const descFontSize = fontSettings.descSize || (h * 0.4);
    const descColor = fontSettings.descColor || '#000000';
    const descriptionStartY = pageSettings.fonts.default.descriptionStartY;
    const priceFont = priceSettings.priceFont || 'Oswald';
    const priceFontSize = isFirstRow ? priceSettings.firstLinePriceSize : priceSettings.otherLinesPriceSize;
    const priceColor = priceSettings.priceColor || '#d90429';
    const tagBgColor = priceSettings.tagBgColor || '#ffde00';
    const borderRadius = priceSettings.borderRadius || 15;
    const gap = 15;

    // ======================= INÍCIO DA CORREÇÃO =======================
    // A linha abaixo foi corrigida para ler o deslocamento global do painel de fontes,
    // em vez de um valor interno que não funcionava.
    const descOffsetY = pageSettings.fonts.default.descriptionOffsetY || 0;
    // ======================== FIM DA CORREÇÃO =========================

    const priceTagWidth = w * 0.45;
    const descWidth = w - priceTagWidth - gap;
    const priceTagX = x + descWidth + gap;

    ctx.font = `bold ${descFontSize}px '${descFont}'`;
    ctx.fillStyle = descColor;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    // A chamada abaixo agora usará o valor correto de 'descOffsetY'
    wrapText(ctx, details.productName.toUpperCase(), x + descWidth / 2, y + descriptionStartY + descOffsetY, descWidth * 0.95, descFontSize * 1.1, 'center', descScaleX, descScaleY);

    ctx.fillStyle = tagBgColor;
    pathRoundedRect(ctx, priceTagX, y, priceTagWidth, h, borderRadius);
    ctx.fill();

    ctx.save();
    const priceX = priceTagX + priceTagWidth / 2;
    const priceY = y + h / 2;
    ctx.translate(priceX, priceY);
    ctx.scale(priceScaleX, priceScaleY);

    ctx.fillStyle = priceColor;
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    ctx.textBaseline = 'middle';
    const priceText = `${details.integerPart},${details.decimalPart}`;
    
    let textWidth = ctx.measureText(priceText).width;
    
    if (textWidth > priceTagWidth - 10) {
        const autoScale = (priceTagWidth - 10) / textWidth;
        ctx.scale(autoScale, 1);
    }

    ctx.fillText(priceText, 0, 0);
    
    ctx.restore();
    ctx.restore();
}
		
        // COLE TODO ESTE BLOCO DE CÓDIGO NO SEU ARQUIVO
// COLE ESTA FUNÇÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA FUNÇÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
function drawRedTag3D(ctx, x, y, w, h, details, styleSettings) {
    const letterSpacing = 3;
    const mainBg = styleSettings.color;
    const shadowColor = shadeColor(mainBg, -30);
    const textColor = '#FFFFFF';
    const priceFont = details.priceFont || 'Anton';
    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;
    const intFontSize = details.intFontSize;
    const decFontSize = details.decFontSize;
    const currencyFontSize = details.currencyFontSize;
    const borderRadius = 15;
    const shadowOffsetY = h * 0.1;
    const shearAmount = -0.1;
    
    ctx.save();
    const shearCenterX = x + w / 2;
    const shearCenterY = y + h / 2;
    ctx.translate(shearCenterX, shearCenterY);
    ctx.transform(1, 0, shearAmount, 1, 0, 0);
    ctx.translate(-shearCenterX, -shearCenterY);
    ctx.fillStyle = shadowColor;
    pathRoundedRect(ctx, x, y + shadowOffsetY, w, h, borderRadius);
    ctx.fill();
    ctx.fillStyle = mainBg;
    pathRoundedRect(ctx, x, y, w, h, borderRadius);
    ctx.fill();
    ctx.restore();

    ctx.save();
    const textCenterX = x + w / 2;
    const textCenterY = y + h / 2;
    ctx.translate(textCenterX, textCenterY);
    ctx.scale(scaleX, scaleY);

    ctx.fillStyle = textColor;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    
    const currencyText = 'R$';
    const integerPartText = details.integerPart;
    const decimalPartText = ',' + details.decimalPart;
    let totalTextWidth = 0;
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    totalTextWidth += ctx.measureText(currencyText).width + (letterSpacing * currencyText.length);
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    totalTextWidth += ctx.measureText(integerPartText).width + (letterSpacing * integerPartText.length);
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    totalTextWidth += ctx.measureText(decimalPartText).width + (letterSpacing * decimalPartText.length);
    
    let currentX = -totalTextWidth / 2;
    const textYOffset = 2;

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    for(const char of currencyText) {
        ctx.fillText(char, currentX, textYOffset);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for(const char of integerPartText) {
        ctx.fillText(char, currentX, textYOffset + (intFontSize - currencyFontSize) / 4);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for(const char of decimalPartText) {
        ctx.fillText(char, currentX, textYOffset + (intFontSize - decFontSize) / 3);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.restore();
}
		
        function shadeColor(color, percent) {
    let R = parseInt(color.substring(1,3),16);
    let G = parseInt(color.substring(3,5),16);
    let B = parseInt(color.substring(5,7),16);

    R = parseInt(R * (100 + percent) / 100);
    G = parseInt(G * (100 + percent) / 100);
    B = parseInt(B * (100 + percent) / 100);

    R = (R<255)?R:255;  
    G = (G<255)?G:255;  
    B = (B<255)?B:255;  

    const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
    const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
    const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));

    return "#"+RR+GG+BB;
}
		
		
		
		// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
function drawGreenOnYellowTag(ctx, x, y, w, h, details, styleSettings) {
    ctx.save();

    const priceFont = styleSettings.priceFont || 'Anton';
    const baseFontSize = styleSettings.priceFontSize || (h * 0.8);
    const offsetX = styleSettings.priceOffsetX || 0;
    const offsetY = styleSettings.priceOffsetY || 0;
    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;
    const borderRadius = 20;

    ctx.fillStyle = '#FFC709';
    pathRoundedRect(ctx, x, y, w, h, borderRadius);
    ctx.fill();

    ctx.save();
    const priceX = x + (w / 2) + offsetX;
    const priceY = y + (h / 2) + offsetY;
    ctx.translate(priceX, priceY);
    ctx.scale(scaleX, 1); // Only scaling X for this style to fit, but Y can be distorted by user
    ctx.scale(1, scaleY);
    
    ctx.fillStyle = '#00552B';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    const intFontSize = baseFontSize;
    const currencyFontSize = baseFontSize * 0.5;
    const priceText = `${details.integerPart},${details.decimalPart}`;
    
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    const currencyWidth = ctx.measureText('R$').width;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    const priceWidth = ctx.measureText(priceText).width;
    const spacing = intFontSize * 0.1;
    const naturalTotalWidth = currencyWidth + priceWidth + spacing;

    let textScaleX = 1;
    if (naturalTotalWidth > w * 0.9) {
        textScaleX = (w * 0.9) / naturalTotalWidth;
    }
    ctx.scale(textScaleX, 1);

    let currentX = -naturalTotalWidth / 2;
    ctx.textAlign = 'left';

    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    ctx.fillText('R$', currentX, -intFontSize * 0.15);
    currentX += currencyWidth + spacing;
    
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    ctx.fillText(priceText, currentX, 0);

    ctx.restore();
    ctx.restore();
}
		
		
        // COLE ESTA FUNÇÃO ATUALIZADA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA
// COLE ESTA VERSÃO ATUALIZADA NO LUGAR DA ANTIGA
// COLE ESTA FUNÇÃO CORRIGIDA NO LUGAR DA ANTIGA
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO DEFINITIVA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO DEFINITIVA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E DEFINITIVA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO FINAL E CORRIGIDA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO NOVAMENTE POR ESTA VERSÃO DEFINITIVA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO MAIS UMA VEZ POR ESTA VERSÃO COM CONTROLE MANUAL ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO FINAL QUE OBEDECE O TAMANHO DA FONTE DO PAINEL ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO FINAL COM PREENCHIMENTO AUTOMÁTICO DE ALTURA ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO FINAL E CORRIGIDA ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO FINAL COM A FORMA DA TAG UNIFICADA ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO FINAL COM A FORMA DA TAG UNIFICADA ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO COM O RETÂNGULO TOTALMENTE ARREDONDADO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawRedTagSeparateRS' INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawRedTagSeparateRS' INTEIRA PELA VERSÃO DEFINITIVA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA ESTA FUNÇÃO ▼▼▼
function drawRedTagSeparateRS(ctx, x, y, w, h, details, styleSettings) {
    ctx.save();

    const letterSpacing = 3;
    const circleSizePercentage = 0.6;
    const priceFont = styleSettings.priceFont || 'Anton';
    const offsetX = styleSettings.priceOffsetX || 0;
    const offsetY = styleSettings.priceOffsetY || 0;
    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;
    const mainRed = '#FF0000';
    const borderRadius = 15;
    const padding = 15;
    const baseFontSize = styleSettings.priceFontSize || 100;

    const circleRadius = (h / 2) * circleSizePercentage;
    const circleX = x + circleRadius;
    const circleY = y + h / 2;
    const rectX = circleX;
    const rectW = w - circleRadius;

    ctx.fillStyle = mainRed;
    pathRoundedRect(ctx, rectX, y, rectW, h, borderRadius);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(circleX, circleY, circleRadius, 0, Math.PI * 2);
    ctx.fill();

    ctx.strokeStyle = '#FFFFFF';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(circleX, circleY, circleRadius - 2, 0, Math.PI * 2);
    ctx.stroke();
    ctx.fillStyle = '#FFFFFF';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = `bold ${circleRadius * 0.8}px '${priceFont}'`;
    ctx.fillText('R$', circleX, circleY);

    ctx.save();
    const priceCenterX = rectX + rectW / 2 + offsetX;
    const priceCenterY = y + h / 2 + offsetY;
    ctx.translate(priceCenterX, priceCenterY);
    ctx.scale(scaleX, scaleY);

    ctx.fillStyle = '#FFDE17';
    ctx.strokeStyle = mainRed;
    ctx.lineJoin = 'round';
    ctx.textBaseline = 'middle';
    const priceText = details.integerPart + ',' + details.decimalPart;
    ctx.font = `bold ${baseFontSize}px '${priceFont}'`;
    
    let naturalTextWidth = 0;
    for (const char of priceText) {
        naturalTextWidth += ctx.measureText(char).width + letterSpacing;
    }
    naturalTextWidth = Math.max(0, naturalTextWidth - letterSpacing);

    let autoScale = 1;
    if (naturalTextWidth > (rectW - padding)) {
        autoScale = (rectW - padding) / naturalTextWidth;
    }
    ctx.scale(autoScale, autoScale);

    ctx.textAlign = 'left';
    let currentX = -(naturalTextWidth / 2);
    ctx.lineWidth = baseFontSize * 0.1;
    for (const char of priceText) {
        ctx.strokeText(char, currentX, 0);
        ctx.fillText(char, currentX, 0);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.restore();
    ctx.restore();
}


// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

/**
 * Desenha o balão de preço no estilo da imagem de referência (vermelho, 3D, à direita).
 */
// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO FINAL ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawPriceBalloon3DReference' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO drawPriceBalloon3DReference INTEIRA POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO drawPriceBalloon3DReference INTEIRA POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawPriceBalloon3DReference' PELA VERSÃO ABAIXO ▼▼▼
function drawPriceBalloon3DReference(ctx, x, y, w, h, details, styleSettings, isFirstRow) {
    ctx.save();

    const mainRed = styleSettings.color || '#e62223';
    const shadowRed = shadeColor(mainRed, -20);
    const priceColor = '#ffffff';
    const priceFont = styleSettings.price.family || 'Anton';
    const borderRadius = h * 0.2;
    const shadowOffsetY = h * 0.1;
    const shearAmount = -0.1;
    const pricePartSpacing = 5;
    const letterSpacing = 3;

    // ======================= INÍCIO DA CORREÇÃO =======================
    // Removemos o valor fixo e passamos a ler a configuração do painel
    const priceVerticalOffset = styleSettings.price.priceOffsetY || 0;
    // ======================== FIM DA CORREÇÃO =========================

    const scaleX = details.scaleX || 1;
    const scaleY = details.scaleY || 1;

    ctx.save();
    const centerX = x + w / 2;
    const centerY = y + h / 2;
    ctx.translate(centerX, centerY);
    ctx.transform(1, 0, shearAmount, 1, 0, 0);
    ctx.translate(-centerX, -centerY);
    ctx.fillStyle = shadowRed;
    pathRoundedRect(ctx, x, y + shadowOffsetY, w, h, borderRadius);
    ctx.fill();
    ctx.fillStyle = mainRed;
    pathRoundedRect(ctx, x, y, w, h, borderRadius);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle = priceColor;
    ctx.textBaseline = 'middle';
    ctx.textAlign = 'left';

    const baseSize = isFirstRow ? styleSettings.price.firstLineSize : styleSettings.price.otherLinesSize;
    const intFontSize = baseSize * 0.95;
    const currencyFontSize = baseSize * 0.4;
    const decFontSize = baseSize * 0.55;

    const currencyText = 'R$';
    const integerText = details.integerPart;
    const decimalText = ',' + details.decimalPart;

    let totalTextWidth = 0;
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    for(const char of currencyText) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }
    totalTextWidth += pricePartSpacing;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for(const char of integerText) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for(const char of decimalText) { totalTextWidth += ctx.measureText(char).width + letterSpacing; }
    totalTextWidth -= letterSpacing;

    let textScaleX = 1;
    const availableWidth = w * 0.9;
    if (totalTextWidth > availableWidth) {
        textScaleX = availableWidth / totalTextWidth;
    }

    ctx.save();
    const priceCenterX = x + w / 2;
    const priceCenterY = y + h / 2;
    ctx.translate(priceCenterX, priceCenterY);
    ctx.scale(scaleX * textScaleX, scaleY); 

    let currentX = -totalTextWidth / 2;

    // A variável 'priceVerticalOffset' agora é somada aqui, usando o valor do painel
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    for (const char of currencyText) {
        ctx.fillText(char, currentX, (h * 0.1) + priceVerticalOffset);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    currentX += pricePartSpacing;
    ctx.font = `bold ${intFontSize}px '${priceFont}'`;
    for (const char of integerText) {
        ctx.fillText(char, currentX, (h * 0.05) + priceVerticalOffset);
        currentX += ctx.measureText(char).width + letterSpacing;
    }
    ctx.font = `bold ${decFontSize}px '${priceFont}'`;
    for (const char of decimalText) {
        ctx.fillText(char, currentX, (-h * 0.1) + priceVerticalOffset);
        currentX += ctx.measureText(char).width + letterSpacing;
    }

    ctx.restore();
    ctx.restore();
}


// ▲▲▲ FIM DO BLOCO DE SUBSTITUIÇÃO ▲▲▲
        function drawFeriadaoVerdeTag(ctx, x, y, w, h, details) { ctx.save(); const borderRadius = 20; ctx.fillStyle = '#FFC709'; pathRoundedRect(ctx, x, y, w, h, borderRadius); ctx.fill(); ctx.fillStyle = '#00552B'; ctx.textAlign = 'left'; ctx.textBaseline = 'middle'; const priceY = y + h / 2; ctx.font = `bold ${details.currencyFontSize * 1.2}px '${details.priceFont}'`; const currencyWidth = ctx.measureText('R$').width; ctx.font = `bold ${details.intFontSize}px '${details.priceFont}'`; const priceText = `${details.integerPart},${details.decimalPart}`; const priceWidth = ctx.measureText(priceText).width; const totalTextWidth = currencyWidth + priceWidth + 5; let currentX = x + (w - totalTextWidth) / 2; ctx.font = `bold ${details.currencyFontSize * 1.2}px '${details.priceFont}'`; ctx.fillText('R$', currentX, priceY - details.intFontSize * 0.1); currentX += currencyWidth + 5; ctx.font = `bold ${details.intFontSize}px '${details.priceFont}'`; ctx.fillText(priceText, currentX, priceY); ctx.restore(); }
        
		
		
		// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProductImage' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProductImage' PELA VERSÃO ABAIXO ▼▼▼
function drawProductImage(product, imgAreaX, imageAreaY, imgAreaW, imageAreaHeight) {
    if (product.image) {
        ctx.save();
        ctx.beginPath();
        ctx.rect(imgAreaX, imageAreaY, imgAreaW, imageAreaHeight);
        ctx.clip();
        
        const repetitions = product.imageRepetitions || 1;
        const direction = product.imageRepetitionDirection || 'horizontal';
        const fit = product.imageFit || 'contain';
        const widthPercent = (product.imageWidthPercent || 100) / 100;
        const heightPercent = (product.imageHeightPercent || 100) / 100;
        const positionXPercent = (product.imagePositionX || 50) / 100; 
        const positionYPercent = (product.imagePositionY || 50) / 100;
        
        let tileW, tileH;
        const imgAspectRatio = product.image.width / product.image.height;

        // --- INÍCIO DA LÓGICA CORRIGIDA ---
        if (repetitions > 1) {
            // Se houver repetições, primeiro verificamos o modo de ajuste.
            if (fit === 'fill') {
                // Se for 'Distorcer', dividimos o espaço total pelas repetições.
                if (direction === 'horizontal') {
                    tileW = (imgAreaW * widthPercent) / repetitions;
                    tileH = imageAreaHeight * heightPercent;
                } else { // Direção vertical
                    tileW = imgAreaW * widthPercent;
                    tileH = (imageAreaHeight * heightPercent) / repetitions;
                }
            } else {
                // Para 'Conter' ou 'Preencher', mantemos a proporção.
                if (direction === 'horizontal') {
                    tileH = imageAreaHeight * heightPercent;
                    tileW = tileH * imgAspectRatio;
                } else { // Direção vertical
                    tileW = imgAreaW * widthPercent;
                    tileH = tileW / imgAspectRatio;
                }
            }
        } else {
            // Se for apenas uma imagem, a lógica original que já funciona continua.
            tileW = imgAreaW * widthPercent;
            tileH = imageAreaHeight * heightPercent;
            const areaAspectRatio = imgAreaW / imageAreaHeight;
            if ("contain" === fit) {
                if (imgAspectRatio > areaAspectRatio) {
                    tileH = tileW / imgAspectRatio;
                } else {
                    tileW = tileH * imgAspectRatio;
                }
            } else if ("cover" === fit) {
                if (imgAspectRatio > areaAspectRatio) {
                    tileW = tileH * imgAspectRatio;
                } else {
                    tileH = tileW / imgAspectRatio;
                }
            }
        }
        // --- FIM DA LÓGICA CORRIGIDA ---
        
        const totalWidth = "horizontal" === direction ? tileW * repetitions : tileW;
        const totalHeight = "vertical" === direction ? tileH * repetitions : tileH;
        
        let startX = imgAreaX + (imgAreaW - totalWidth) * positionXPercent;
        let startY = imageAreaY + (imageAreaHeight - totalHeight) * positionYPercent;

        for (let i = 0; i < repetitions; i++) {
            let currentX = startX;
            let currentY = startY;
            if ("horizontal" === direction) {
                currentX += i * tileW;
            } else {
                currentY += i * tileH;
            }
            ctx.drawImage(product.image, currentX, currentY, tileW, tileH);
        }
        ctx.restore();
    } else {
        ctx.fillStyle = '#E5E7EB';
        ctx.fillRect(imgAreaX, imageAreaY, imgAreaW, imageAreaHeight);
        ctx.fillStyle = '#4A5568';
        ctx.font = 'bold 16px Inter';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Sem Imagem', imgAreaX + imgAreaW / 2, imageAreaY + imageAreaHeight / 2);
    }
}
        
		// COLE ESTA VERSÃO CORRIGIDA NO LUGAR DA ANTIGA


// =====================================================================================
// ▼▼▼ PASSO 2: SUBSTITUA TODA A FUNÇÃO drawProduct PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO drawProduct PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawProduct' POR ESTA VERSÃO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProduct' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawProduct' INTEIRA POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProduct' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProduct' PELA VERSÃO DEFINITIVA ABAIXO ▼▼▼
// ▼▼▼ PASSO 2: SUBSTITUA ESTA FUNÇÃO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProduct' PELA VERSÃO ABAIXO ▼▼▼
// Substitua sua função drawProduct inteira por esta versão corrigida
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawProduct' PELA VERSÃO ABAIXO ▼▼▼
function drawProduct(product, x, y, cellWidth, cellHeight, backgroundColor, isFirstRow, line, isPredefined = false) {
    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const balloonStyle = isFirstRow ? pageSettings.balloons.firstLine : pageSettings.balloons.otherLines;
    const [integerPart, decimalPart] = parseFloat(product.price).toFixed(2).split('.');
    
    const descScaleX = (product.descScaleX || 100) / 100;
    const descScaleY = (product.descScaleY || 100) / 100;
    const priceScaleX = (product.priceScaleX || 100) / 100;
    const priceScaleY = (product.priceScaleY || 100) / 100;
	
    const descriptionOffsetY = pageSettings.fonts.default.descriptionOffsetY || 0;

    const priceDetails = { 
        productName: product.name, price: product.price, integerPart, decimalPart,
        scaleX: priceScaleX, scaleY: priceScaleY,
        descScaleX: descScaleX, descScaleY: descScaleY
    };
    const padding = 15;
    
    const isUnifiedHighlight = isFirstRow && pageSettings.highlight.enabled && pageSettings.highlight.style === 'unified';
    if (!isUnifiedHighlight) {
        const defaultSlotRgbaColor = pageSettings.slotBackground.enabled ? hexToRgba(pageSettings.slotBackground.color, pageSettings.slotBackground.opacity) : 'transparent';
        const finalBackgroundColor = product.backgroundColor || backgroundColor || defaultSlotRgbaColor;
        if (finalBackgroundColor && finalBackgroundColor !== "transparent") { ctx.fillStyle = finalBackgroundColor; if (line.borderStyle === "rounded" || line.borderStyle === "dashed-rounded") { pathRoundedRect(ctx, x, y, cellWidth, cellHeight, 20); ctx.fill(); } else { ctx.fillRect(x, y, cellWidth, cellHeight); } }
    }
    const imageAreaScale = (pageSettings.imageAreaScale || 100) / 100;
    const imageAreaW = cellWidth * imageAreaScale;
    const imageAreaHeight = cellHeight * imageAreaScale;
    const imageAreaX = x + (cellWidth - imageAreaW) / 2;
    const imageAreaY = y + (cellHeight - imageAreaHeight) / 2;
    drawProductImage(product, imageAreaX, imageAreaY, imageAreaW, imageAreaHeight);

    const shouldDrawBorder = !(isFirstRow && pageSettings.highlight.enabled && pageSettings.highlight.noBorder);
    if (shouldDrawBorder && line.borderStyle !== 'none') {
        ctx.save();

        // ==========================================================
        // ===== INÍCIO DA CORREÇÃO =====
        // ==========================================================
        // Estas duas linhas foram adicionadas. Elas definem a cor correta (verde ou a escolhida).
        const borderColor = pageSettings.slotBorder.customColorEnabled ? pageSettings.slotBorder.color : '#007c11';
        ctx.strokeStyle = borderColor;
		
		
		  // ▼▼▼ ADICIONE ESTA LINHA PARA CORRIGIR A ESPESSURA ▼▼▼
        ctx.lineWidth = 1.5; // Define uma espessura fixa para a borda do produto
        // ▲▲▲ FIM DA ADIÇÃO ▲▲▲
        // ========================================================
        // ===== FIM DA CORREÇÃO =====
        
        if (line.borderStyle === 'dashed' || line.borderStyle === 'dashed-rounded') { ctx.setLineDash([8, 4]); }
        if (line.borderStyle === 'rounded' || line.borderStyle === 'dashed-rounded') { pathRoundedRect(ctx, x, y, cellWidth, cellHeight, 20); ctx.stroke(); } 
        else { ctx.strokeRect(x, y, cellWidth, cellHeight); }
        ctx.restore();
    }
    
    const stylesWithOwnDescription = ['yellow-tag', 'desc-left-red-tag', 'desc-left-3d-tag', 'gigante-tag', 'text-outline', 'desc-left-custom-balloon'];
    let needsDefaultDescription = !stylesWithOwnDescription.includes(balloonStyle);

    if (balloonStyle.startsWith('custom_')) {
        const customName = balloonStyle.replace('custom_', '');
        const allCustomSettings = pageSettings.balloonStyles.customBalloons || {};
        const styleSettings = allCustomSettings[customName] || {};
        if (styleSettings.descLeftLayout) {
            needsDefaultDescription = false;
        }
    }

    if (needsDefaultDescription) {
        const descriptionStartY = pageSettings.fonts.default.descriptionStartY || 15;
        const descY = y + descriptionStartY + descriptionOffsetY;
        let productNameFontFamily = pageSettings.fonts.default.productName.family;
        let productNameFontSize = pageSettings.fonts.default.productName.size;
        ctx.fillStyle = '#111827';
        ctx.font = `bold ${productNameFontSize}px '${productNameFontFamily}'`;
        const finalDescAlignment = line.descAlignment || 'center';
        let descX;
        switch (finalDescAlignment) {
            case 'center': descX = x + cellWidth / 2; break;
            case 'right': descX = x + cellWidth - padding; break;
            default: descX = x + padding;
        }
        wrapText(ctx, product.name.toUpperCase(), descX, descY, cellWidth - 2 * padding, 1.2 * productNameFontSize, finalDescAlignment, descScaleX, descScaleY);
    }
    
    if ("none" !== balloonStyle) {
        ctx.save();
        const balloonHeight = (cellHeight * 0.25 * 0.9 * (pageSettings.balloons.balloonHeightPercent || 70) / 100);
        const globalOffsetY = pageSettings.balloons.globalOffsetY || 0;
        const highlightedOffsetY = isFirstRow && pageSettings.highlight.enabled ? (pageSettings.balloons.highlightedBalloonOffsetY || 0) : 0;
        const balloonY = y + cellHeight - balloonHeight - padding + highlightedOffsetY + globalOffsetY;

        switch (balloonStyle) {
            case 'default':
            case 'red-tag-3d':
                drawPriceBalloon3DReference(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.default, isFirstRow);
                break;
            case 'desc-left-custom-balloon':
                drawDescLeftCustomPriceBalloon(ctx, x, y, cellWidth, cellHeight, priceDetails, globalOffsetY);
                break;
            case 'currency-highlight':
                drawPriceBalloonCurrencyHighlight(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.currencyHighlight, isFirstRow);
                break;
            case 'currency-highlight-2':
                drawPriceBalloonCurrencyHighlight2(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.currencyHighlight2, isFirstRow);
                break;
            case 'red-yellow-outlined':
                const defaultStyleSettingsForOutlined = pageSettings.balloonStyles.default;
                drawPriceBalloonRedYellowOutlined(ctx, x + cellWidth - (cellWidth * 0.60) - padding, balloonY, cellWidth * 0.60, balloonHeight, priceDetails, defaultStyleSettingsForOutlined);
                break;
            case 'green-on-yellow-tag':
                drawGreenOnYellowTag(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.greenOnYellowTag);
                break;
            case 'desc-left-red-tag':
                const styleSettings = pageSettings.balloonStyles.descLeftRedTag;
                            drawDescLeftRedTag(ctx, x + padding, balloonY, cellWidth - (padding * 2), balloonHeight, priceDetails, styleSettings, descScaleX, descScaleY, priceScaleX, priceScaleY);
                break;
            case 'red-tag-separate-rs':
                drawRedTagSeparateRS(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.redTagSeparateRS);
                break;
            
			// ▼▼▼ COLE O BLOCO CORRIGIDO AQUI ▼▼▼
            case 'yellow-tag-green-text':
                // CORREÇÃO: Agora passa as configurações do painel (styleSettings) e se é a primeira linha (isFirstRow)
                drawPriceBalloonYellowTagGreenText(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.default, isFirstRow);
                break;
// ▲▲▲ FIM DO BLOCO ▲▲▲
            
			// ▼▼▼ COLE O BLOCO CORRIGIDO AQUI ▼▼▼
            case 'red-tag-white-text':
                // CORREÇÃO: Agora passa as configurações do painel (styleSettings) e se é a primeira linha (isFirstRow)
                drawPriceBalloonRedTagWhiteText(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, pageSettings.balloonStyles.default, isFirstRow);
                break;
// ▲▲▲ FIM DO BLOCO ▲▲▲
			
            case 'desc-left-3d-tag': 
                const defaultStyleSettings = pageSettings.balloonStyles.default; 
                drawDescLeft3DTag(ctx, x + padding, balloonY, cellWidth - (padding*2), balloonHeight, priceDetails, defaultStyleSettings, isFirstRow, descScaleX, descScaleY, pageSettings.fonts.default.descriptionOffsetY); 
                break; 
            case 'circle-model':
                drawPriceBalloonCircleModel(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails);
                break;
            case 'rectangle':
                const settings = pageSettings.balloonStyles.default;
                drawPriceBalloonRectangle(ctx, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, { color: settings.color });
                ctx.save();
                const textCenterX = x + (cellWidth / 2);
                const textCenterY = balloonY + balloonHeight / 2;
                ctx.translate(textCenterX, textCenterY);
                ctx.scale(priceScaleX, priceScaleY);
                const priceFontSize = balloonHeight * .6;
                ctx.font = `bold ${priceFontSize}px '${settings.price.family || 'Anton'}'`;
                ctx.fillStyle = '#FFFFFF';
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                const fullPriceText = `R$ ${integerPart},${decimalPart}`;
                ctx.fillText(fullPriceText, 0, 0);
                ctx.restore();
                break;
            case 'yellow-tag':
                const fontSettings = pageSettings.fonts.yellowTag;
                const priceSettings = pageSettings.balloonStyles.yellowTag;
                drawYellowTagPrice(ctx, x + padding, balloonY, cellWidth - (padding * 2), balloonHeight, priceDetails, fontSettings, priceSettings, isFirstRow, descScaleX, descScaleY);
                break;
            case 'text-outline':
                const fontSettingsContour = pageSettings.fonts.contour;
                const finalDescOffsetY = descriptionOffsetY + (fontSettingsContour.descOffsetY || 0);
                const priceSize = isFirstRow ? fontSettingsContour.firstLinePriceSize : fontSettingsContour.otherLinesPriceSize;
                priceDetails.intFontSize = Math.min(priceSize, balloonHeight * 0.9);
                drawTextOutlinePrice(ctx, x + padding, balloonY + balloonHeight, cellWidth - (padding * 2), balloonHeight, priceDetails, fontSettingsContour, finalDescOffsetY, descScaleX, descScaleY);
                break;
            case 'gigante-tag':
                const fontSettingsGigante = { descFont: 'Oswald', descColor: '#FFFFFF' };
                const priceSettingsGigante = { priceFont: 'Anton', ...pageSettings.balloonStyles.giganteTag };
                drawGiganteTag(ctx, product, x + (cellWidth - (cellWidth * 0.85)) / 2, balloonY, cellWidth * 0.85, balloonHeight, priceDetails, fontSettingsGigante, priceSettingsGigante, descScaleX, descScaleY);
                break;
            default:
                if (balloonStyle.startsWith('custom_')) {
                    const customName = balloonStyle.replace('custom_', '');
                    const allCustomSettings = pageSettings.balloonStyles.customBalloons || {};
                    const styleSettings = allCustomSettings[customName] || {};

                    if (styleSettings.descLeftLayout) {
                        drawDescLeftCustomBalloon(ctx, x, y, cellWidth, cellHeight, priceDetails, customName, globalOffsetY);
                    } else {
                        drawCustomImageBalloon(ctx, x, y, cellWidth, cellHeight, priceDetails, customName, globalOffsetY);
                    }
                }
                break;
        }
        ctx.restore();
    }
}
		
		// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawPredefinedGrid' INTEIRA POR ESTA VERSÃO COMPLETA ▼▼▼
function drawPredefinedGrid(layoutName, productGridTopY, productGridBottomY) {
    let productIndex = 0;
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    const pageSettings = currentPage.settings;
    const lateralMargin = pageSettings.margins.lateral;
    const w = canvas.width - 2 * lateralMargin;
    const h = productGridBottomY - productGridTopY;
    const highlightColor = pageSettings.highlight.enabled ? pageSettings.highlight.color : null;
    const spacing = 10;
    const borderStyle = pageSettings.predefinedBorderStyle || 'straight';

    const drawSlot = (pIndex, x, y, pW, pH, isHighlight = false) => {
        productSlots.push({ x: x + lateralMargin, y: y, width: pW, height: pH, productIndex: pIndex });
        const lineStyle = { borderStyle: borderStyle, descAlignment: 'center', priceAlignment: 'center' };
        if (pIndex < currentPage.products.length) {
            drawProduct(currentPage.products[pIndex], x + lateralMargin, y, pW, pH, isHighlight ? highlightColor : null, isHighlight, lineStyle, true);
        } else {
            drawPlaceholderSlot(x + lateralMargin, y, pW, pH, borderStyle);
        }
    };

    switch (layoutName) {
        // Layouts Antigos (Ajustados)
        case '2x2': case '3x3': case '4x4': case '3x2': case '4x2': case '3x4': case '4x5':
            const [cols, rows] = layoutName.split('x').map(Number);
            const cellW = (w - (cols - 1) * spacing) / cols;
            const cellH = (h - (rows - 1) * spacing) / rows;
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, i === 0);
                }
            }
            break;

        // --- NOVOS LAYOUTS ---
        case '5_4_1d': { // 4 produtos + 1 destaque Direito
            const highlightW = w * 0.4;
            const regularW = w - highlightW - spacing;
            const cellW = (regularW - spacing) / 2;
            const cellH = (h - spacing) / 2;
            for(let i=0; i<2; i++) for(let j=0; j<2; j++) drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
            drawSlot(productIndex++, regularW + spacing, productGridTopY, highlightW, h, true);
            break;
        }
        case '5_4_1e': { // 4 produtos + 1 destaque Esquerdo
            const highlightW = w * 0.4;
            const regularW = w - highlightW - spacing;
            const cellW = (regularW - spacing) / 2;
            const cellH = (h - spacing) / 2;
            drawSlot(productIndex++, 0, productGridTopY, highlightW, h, true);
            for(let i=0; i<2; i++) for(let j=0; j<2; j++) drawSlot(productIndex++, highlightW + spacing + j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
		
		case '5_4_1c_center': { // 4 produtos + 1 destaque Central
            const regularW = w * 0.3; // Largura dos slots laterais
            const highlightW = w - (2 * regularW) - (2 * spacing); // Largura do destaque central
            const regularH = (h - spacing) / 2; // Altura dos slots laterais

            // Desenha os 2 slots da esquerda
            drawSlot(productIndex++, 0, productGridTopY, regularW, regularH, false);
            drawSlot(productIndex++, 0, productGridTopY + regularH + spacing, regularW, regularH, false);

            // Desenha o slot de destaque central
            drawSlot(productIndex++, regularW + spacing, productGridTopY, highlightW, h, true);

            // Desenha os 2 slots da direita
            const rightX = regularW + highlightW + (2 * spacing);
            drawSlot(productIndex++, rightX, productGridTopY, regularW, regularH, false);
            drawSlot(productIndex++, rightX, productGridTopY + regularH + spacing, regularW, regularH, false);
            break;
        }
		
		
		case '7_1c_6': { // 1 Destaque central + 6
            const regularW = w * 0.3; // Largura das colunas laterais
            const highlightW = w - (2 * regularW) - (2 * spacing); // Largura do destaque
            const regularH = (h - 2 * spacing) / 3; // Altura dos 3 slots em cada coluna

            // Desenha os 3 slots da esquerda
            for (let i = 0; i < 3; i++) {
                drawSlot(productIndex++, 0, productGridTopY + i * (regularH + spacing), regularW, regularH, false);
            }

            // Desenha o slot de destaque central
            drawSlot(productIndex++, regularW + spacing, productGridTopY, highlightW, h, true);

            // Desenha os 3 slots da direita
            const rightX = regularW + highlightW + (2 * spacing);
            for (let i = 0; i < 3; i++) {
                drawSlot(productIndex++, rightX, productGridTopY + i * (regularH + spacing), regularW, regularH, false);
            }
            break;
        }
		
		
        case '7_1t_6': { // 1 destaque topo + 6 produtos
            const topH = h * 0.4;
            drawSlot(productIndex++, 0, productGridTopY, w, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const bottomH = h - topH - spacing;
            const cellW = (w - 2 * spacing) / 3;
            const cellH = (bottomH - spacing) / 2;
            for(let i=0; i<2; i++) for(let j=0; j<3; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '7_3t_4': { // 3 Destaques no topo e 4 produtos
            const topH = h * 0.5;
            const bottomH = h - topH - spacing;
            const topCellW = (w - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomCellW = (w - 3 * spacing) / 4;
            for(let i=0; i<4; i++) drawSlot(productIndex++, i * (bottomCellW + spacing), productGridTopY + topH + spacing, bottomCellW, bottomH, false);
            break;
        }
        case '7_4_3b': { // 4 produtos e 3 destaques em baixo
            const topH = h * 0.5;
            const bottomH = h - topH - spacing;
            const topCellW = (w - 3 * spacing) / 4;
            for(let i=0; i<4; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, false);
            const bottomCellW = (w - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, i * (bottomCellW + spacing), productGridTopY + topH + spacing, bottomCellW, bottomH, true);
            break;
        }
        case '7_1l_6': { // 1 destaque lateral + 6 produtos
            const leftW = w * 0.4;
            drawSlot(productIndex++, 0, productGridTopY, leftW, h, true);
            const rightX = leftW + spacing;
            const rightW = w - rightX;
            const cellW = (rightW - spacing) / 2;
            const cellH = (h - 2 * spacing) / 3;
            for(let i=0; i<3; i++) for(let j=0; j<2; j++) drawSlot(productIndex++, rightX + j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '8_5_3b': { // 5 produtos e 3 destaques em baixo
             const topH = h * 0.5;
            const bottomH = h - topH - spacing;
            const topCellW = (w - 4 * spacing) / 5;
            for(let i=0; i<5; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, false);
            const bottomCellW = (w - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, i * (bottomCellW + spacing), productGridTopY + topH + spacing, bottomCellW, bottomH, true);
            break;
        }
        case '8_3t_5': { // 3 destaques no topo e 5 produtos
            const topH = h * 0.5;
            const bottomH = h - topH - spacing;
            const topCellW = (w - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomCellW = (w - 4 * spacing) / 5;
            for(let i=0; i<5; i++) drawSlot(productIndex++, i * (bottomCellW + spacing), productGridTopY + topH + spacing, bottomCellW, bottomH, false);
            break;
        }
        case '10_1t_9': { // 1 destaque topo + 9 produtos
            const topH = h * 0.4;
            drawSlot(productIndex++, 0, productGridTopY, w, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const bottomH = h - topH - spacing;
            const cellW = (w - 2 * spacing) / 3;
            const cellH = (bottomH - 2 * spacing) / 3;
            for(let i=0; i<3; i++) for(let j=0; j<3; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '11_3t_8': { // 3 destaque topo + 8 produtos
            const topH = h * 0.4;
            const bottomH = h - topH - spacing;
            const topCellW = (w - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const cellW = (w - 3 * spacing) / 4;
            const cellH = (bottomH - spacing) / 2;
            for(let i=0; i<2; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '11_3x4_c': { // 3x4 com destaque central com 11 produtos
            const rows = 4, cols = 3;
            const cellW = (w - (cols - 1) * spacing) / cols;
            const cellH = (h - (rows - 1) * spacing) / rows;
            for(let i=0; i<rows; i++) for(let j=0; j<cols; j++) {
                if(i > 0 && i < 3 && j === 1) continue;
                if(i === 1 && j === 1) {
                    drawSlot(productIndex++, cellW + spacing, productGridTopY + cellH + spacing, cellW, cellH * 2 + spacing, true);
                } else {
                    drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
                }
            }
            break;
        }
        case '12_4t_8': { // 8 produtos e 4 destaques no topo
            const topH = h * 0.4;
            const bottomH = h - topH - spacing;
            const topCellW = (w - 3 * spacing) / 4;
            for(let i=0; i<4; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const cellW = (w - 3 * spacing) / 4;
            const cellH = (bottomH - spacing) / 2;
            for(let i=0; i<2; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '12_8_4b': { // 8 produtos e 4 destaques em baixo
            const topH = h * 0.6;
            const bottomH = h - topH - spacing;
            const cellW = (w - 3 * spacing) / 4;
            const cellH = (topH - spacing) / 2;
            for(let i=0; i<2; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
            const bottomY = productGridTopY + topH + spacing;
            const bottomCellW = (w - 3 * spacing) / 4;
            for(let i=0; i<4; i++) drawSlot(productIndex++, i * (bottomCellW + spacing), bottomY, bottomCellW, bottomH, true);
            break;
        }
        case '14_13_1tc': { // 3x5 13 produtos e 1 destaque em cima no centro
            const rows = 5, cols = 3;
            const cellW = (w - (cols - 1) * spacing) / cols;
            const cellH = (h - (rows - 1) * spacing) / rows;
            drawSlot(productIndex++, cellW + spacing, productGridTopY, cellW, cellH * 2 + spacing, true);
            for(let i=0; i<rows; i++) for(let j=0; j<cols; j++) {
                if (i < 2 && j === 1) continue;
                drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
            }
            break;
        }
        case '14_13_1bc': { // 3x5 13 produtos e 1 destaque em baixo no centro
            const rows = 5, cols = 3;
            const cellW = (w - (cols - 1) * spacing) / cols;
            const cellH = (h - (rows - 1) * spacing) / rows;
            drawSlot(productIndex++, cellW + spacing, productGridTopY + (cellH + spacing) * (rows - 2), cellW, cellH * 2 + spacing, true);
            for(let i=0; i<rows; i++) for(let j=0; j<cols; j++) {
                if (i >= rows - 2 && j === 1) continue;
                drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, i === 0);
            }
            break;
        }
        case '14_2d_12': { // 2 destaques + 4x3
            const highlightH = (h - spacing) / 2;
            drawSlot(productIndex++, 0, productGridTopY, w, highlightH, true);
            drawSlot(productIndex++, 0, productGridTopY + highlightH + spacing, w, highlightH, true);
            // This layout only holds 2 products, the name is misleading. We will use the name.
            break;
        }
        case '15_3d_12': { // 3 destaques + 4x3
            const highlightH = (h - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, 0, productGridTopY + i * (highlightH + spacing), w, highlightH, true);
             // This layout only holds 3 products.
            break;
        }
        case '17_1t_16': case '18_2t_16': case '19_3t_16': {
            const topCount = layoutName === '17_1t_16' ? 1 : (layoutName === '18_2t_16' ? 2 : 3);
            const topH = h * 0.3;
            const topCellW = (w - (topCount - 1) * spacing) / topCount;
            for(let i=0; i<topCount; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const bottomH = h - topH - spacing;
            const cellW = (w - 3 * spacing) / 4;
            const cellH = (bottomH - 3 * spacing) / 4;
            for(let i=0; i<4; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '18_4t_14': { // 4 Destaques no topo e 14 produtos
            const topH = h * 0.35;
            const topCellW = (w - 3 * spacing) / 4;
            for(let i=0; i<4; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const bottomH = h - topH - spacing;
            const cellW = (w - 4 * spacing) / 5;
            const cellH = (bottomH - 2 * spacing) / 3;
            for(let i=0; i<3; i++) for(let j=0; j<5; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '18_14_4b': { // 14 produtos e 4 destaques em baixo
            const topH = h * 0.65;
            const bottomH = h - topH - spacing;
            const cellW = (w - 4 * spacing) / 5;
            const cellH = (topH - 2 * spacing) / 3;
            for(let i=0; i<3; i++) for(let j=0; j<5; j++) drawSlot(productIndex++, j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, i === 0);
            const bottomY = productGridTopY + topH + spacing;
            const bottomCellW = (w - 3 * spacing) / 4;
            for(let i=0; i<4; i++) drawSlot(productIndex++, i * (bottomCellW + spacing), bottomY, bottomCellW, bottomH, true);
            break;
        }
        case '21_1t_20': case '22_2t_20': case '23_3t_20': {
            const topCount = layoutName === '21_1t_20' ? 1 : (layoutName === '22_2t_20' ? 2 : 3);
            const topH = h * 0.25;
            const topCellW = (w - (topCount - 1) * spacing) / topCount;
            for(let i=0; i<topCount; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const bottomH = h - topH - spacing;
            const cellW = (w - 3 * spacing) / 4;
            const cellH = (bottomH - 4 * spacing) / 5;
            for(let i=0; i<5; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '26_2t_24': { // 2 destaques no topo + 4x6
            const topH = h * 0.2;
            const topCellW = (w - spacing) / 2;
            drawSlot(productIndex++, 0, productGridTopY, topCellW, topH, true);
            drawSlot(productIndex++, topCellW + spacing, productGridTopY, topCellW, topH, true);
            const bottomY = productGridTopY + topH + spacing;
            const bottomH = h - topH - spacing;
            const cellW = (w - 3 * spacing) / 4;
            const cellH = (bottomH - 5 * spacing) / 6;
            for(let i=0; i<6; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '29_3t_8c_18': { // 3x6 com 3 destaques no topo e 8 centrais
            const topH = h * 0.2;
            const topCellW = (w - 2 * spacing) / 3;
            for(let i=0; i<3; i++) drawSlot(productIndex++, i * (topCellW + spacing), productGridTopY, topCellW, topH, true);
            const midY = productGridTopY + topH + spacing;
            const midH = h * 0.5;
            const midCellW = (w - 3 * spacing) / 4;
            const midCellH = (midH - spacing) / 2;
            for(let i=0; i<2; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, j * (midCellW + spacing), midY + i * (midCellH + spacing), midCellW, midCellH, true);
            const bottomY = midY + midH + spacing;
            const bottomH = h - midY - midH;
            const cellW = (w - 2 * spacing) / 3;
            const cellH = (bottomH - 5 * spacing) / 6;
            for(let i=0; i<6; i++) for(let j=0; j<3; j++) drawSlot(productIndex++, j * (cellW + spacing), bottomY + i * (cellH + spacing), cellW, cellH, false);
            break;
        }
        case '30_3l_24_3r': { // 3 laterais + 24 + 3 laterais
            const sideW = w * 0.2;
            const midW = w - 2 * sideW - 2 * spacing;
            const sideCellH = (h - 2 * spacing) / 3;
            for(let i=0; i<3; i++) {
                drawSlot(productIndex++, 0, productGridTopY + i * (sideCellH + spacing), sideW, sideCellH, true);
                drawSlot(productIndex + 23, sideW + midW + 2 * spacing, productGridTopY + i * (sideCellH + spacing), sideW, sideCellH, true);
            }
            const midX = sideW + spacing;
            const cellW = (midW - 3 * spacing) / 4;
            const cellH = (h - 5 * spacing) / 6;
            for(let i=0; i<6; i++) for(let j=0; j<4; j++) drawSlot(productIndex++, midX + j * (cellW + spacing), productGridTopY + i * (cellH + spacing), cellW, cellH, false);
            productIndex += 3; // Jump over the right side products
            break;
        }
        default:
            drawSlot(productIndex, 0, productGridTopY, w, h, true);
            break;
    }
}
// ▲▲▲ FIM DO BLOCO ▲▲▲
	   
	   
	   
        function drawTitleSlot(ctx, line, x, y, width, height) { ctx.save(); if (line.titleBgEnabled) { ctx.fillStyle = line.titleBgColor; ctx.fillRect(x, y, width, height); } if (line.titleLogoImg) { const img = line.titleLogoImg, aspectRatio = line.titleAspectRatio || 'fill', widthPercent = (line.titleWidthPercent || 100) / 100, heightPercent = (line.titleHeightPercent || 100) / 100; let imgW = width * widthPercent, imgH = height * heightPercent; if ("contain" === aspectRatio) { const imgAspectRatio = img.width / img.height, slotAspectRatio = width / height; imgAspectRatio > slotAspectRatio ? (imgW = width * widthPercent, imgH = imgW / imgAspectRatio) : (imgH = height * heightPercent, imgW = imgH * imgAspectRatio) } ctx.drawImage(img, x + (width - imgW) / 2, y + (height - imgH) / 2, imgW, imgH) } else if (line.titleText) { ctx.fillStyle = '#111827'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; const fontSize = line.titleFontSize || 40; ctx.font = `bold ${fontSize}px Anton`; const { lines } = getWrappedLines(ctx, line.titleText.toUpperCase(), .95 * width); const lineHeight = 1.1 * fontSize, totalTextHeight = lines.length * lineHeight; let startY = y + (height - totalTextHeight) / 2 + lineHeight / 2 - .1 * lineHeight; for (let i=0; i<lines.length; i++)ctx.fillText(lines[i], x + width / 2, startY + i * lineHeight) } ctx.restore() }
        
        // ===============================================================
        // ===== FIM DO BLOCO DE NOVAS FUNÇÕES DE DESENHO DO CANVAS ======
        // ===============================================================



// ==========================================================
// ===== INÍCIO DO CÓDIGO DO SELO DE VALIDADE DO CABEÇALHO =====
// ==========================================================

function getDayOfWeekPT(dateString) {
    if (!dateString) return '';
    const days = ['DOM', 'SEG', 'TER', 'QUA', 'QUINT', 'SEX', 'SÁB'];
    const date = new Date(dateString + 'T12:00:00');
    return days[date.getUTCDay()];
}


// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawHeaderValidity' PELA VERSÃO ATUALIZADA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawHeaderValidity' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawHeaderValidity' PELA VERSÃO ABAIXO ▼▼▼
function drawHeaderValidity(ctx, settingsObj) {
    if (!settingsObj || !settingsObj.enabled) return;

    const scale = (settingsObj.headerValidityScale || 100) / 100;

    const { 
        x, y, width, backgroundEnabled, bgColor, textColor, extraTextAlign,
        startDate, endDate, titleText, stockText, extraText2 
    } = settingsObj;

    const LSpacing = (settingsObj.lineSpacing || 10) * scale;
    const separatorSpacing = (settingsObj.headerSeparatorSpacing || 10) * scale; // <-- NOVO: Lê o espaçamento do separador
    const extraSpacing = (settingsObj.extraSpacing || 5) * scale;
    const dateToStockSpacing = (settingsObj.dateToStockSpacing ?? 15) * scale;
    const fontSizeLine1 = (settingsObj.fontSizeLine1 || 25) * scale;
    const fontSizeStartDate = (settingsObj.fontSizeStartDate || 60) * scale;
    const fontSizeDates = (settingsObj.fontSizeDates || 50) * scale;
    const fontSizeStock = (settingsObj.fontSizeStock || 35) * scale;
    const fontSizeExtra2 = (settingsObj.fontSizeExtra2 || 25) * scale;

    const FONT_FAMILY = 'Oswald';
    const aspectRatio = 1.05;
    const height = width / aspectRatio;

    ctx.save();

    if (backgroundEnabled) {
        ctx.fillStyle = bgColor;
        ctx.strokeStyle = textColor;
        ctx.lineWidth = width * 0.015;
        pathRoundedRect(ctx, x, y, width, height, width * 0.05);
        ctx.fill();
        ctx.stroke();
        const ringRadius = width * 0.03;
        const ringSpacing = width * 0.105;
        for (let i = 0; i < 9; i++) {
            const ringX = x + (width * 0.08) + (i * ringSpacing);
            ctx.beginPath();
            ctx.arc(ringX, y, ringRadius, Math.PI, 0);
            ctx.stroke();
        }
    }

    ctx.fillStyle = textColor;
    ctx.textAlign = 'center';

    const linesToDraw = [];
    if (titleText && titleText.trim() !== '') linesToDraw.push({ type: 'title', text: titleText.toUpperCase(), size: fontSizeLine1, font: `bold ${fontSizeLine1}px ${FONT_FAMILY}` });
    if (startDate) {
        const startDay = getDayOfWeekPT(startDate);
        const startDateFormatted = `${startDay} ${startDate.split('-')[2]}/${startDate.split('-')[1]}`;
        linesToDraw.push({ type: 'startDate', text: startDateFormatted, size: fontSizeStartDate, font: `bold ${fontSizeStartDate}px ${FONT_FAMILY}` });
    }
    if (startDate && endDate) {
        linesToDraw.push({ type: 'separator', text: "- a -", size: fontSizeLine1 * 0.9, font: `bold ${fontSizeLine1 * 0.9}px ${FONT_FAMILY}` });
        const endDay = getDayOfWeekPT(endDate);
        const endDateFormatted = `${endDay} ${endDate.split('-')[2]}/${endDate.split('-')[1]}/${endDate.split('-')[0]}`;
        linesToDraw.push({ type: 'endDate', text: endDateFormatted, size: fontSizeDates, font: `bold ${fontSizeDates}px ${FONT_FAMILY}` });
    }

    const bottomTexts = [];
    if (stockText && stockText.trim() !== '') bottomTexts.push({ text: stockText, size: fontSizeStock });
    if (extraText2 && extraText2.trim() !== '') bottomTexts.push({ text: extraText2, size: fontSizeExtra2 });

    let totalBottomHeight = 0;
    const bottomSpacing = extraSpacing || 5;
    bottomTexts.forEach((bt, index) => {
        ctx.font = `bold ${bt.size}px ${FONT_FAMILY}`;
        const { lines } = getWrappedLines(ctx, bt.text, width * 0.9);
        totalBottomHeight += lines.length * (bt.size * 1.1);
        if (index < bottomTexts.length - 1) totalBottomHeight += bottomSpacing;
    });

    let bottomStartY = y + height - totalBottomHeight - (height * 0.05);
    bottomTexts.forEach(bt => {
        ctx.font = `bold ${bt.size}px ${FONT_FAMILY}`;
        const drawnMetrics = wrapText(ctx, bt.text.toUpperCase(), x + width / 2, bottomStartY, width * 0.9, bt.size * 1.1, extraTextAlign);
        bottomStartY += drawnMetrics.totalHeight + bottomSpacing;
    });

    // <-- NOVO: Lógica de cálculo da altura total mais precisa
    let totalTextHeight = 0;
    linesToDraw.forEach((line, index) => {
        totalTextHeight += line.size;
        if (index < linesToDraw.length - 1) {
            totalTextHeight += (line.type === 'separator') ? separatorSpacing : LSpacing;
        }
    });

    const spaceForTopBlock = y + height - totalBottomHeight - (height * 0.1);
    const topBlockYCenter = y + spaceForTopBlock / 2;
    let currentY = topBlockYCenter - (totalTextHeight / 2) - (dateToStockSpacing / 2);

    ctx.textBaseline = 'top';
    let startDateWidth = 0; 

    linesToDraw.forEach(line => {
        ctx.font = line.font;
        const drawX = x + width / 2;

        if (line.type === 'startDate') {
            ctx.fillText(line.text, drawX, currentY);
            startDateWidth = ctx.measureText(line.text).width;
        } else if (line.type === 'endDate' && startDateWidth > 0) {
            const endDateNaturalWidth = ctx.measureText(line.text).width;
            if (endDateNaturalWidth > 0) {
                const scaleX = startDateWidth / endDateNaturalWidth;
                ctx.save();
                ctx.translate(drawX, currentY);
                ctx.scale(scaleX, 1);
                ctx.fillText(line.text, 0, 0);
                ctx.restore();
            }
        } else {
            ctx.fillText(line.text, drawX, currentY);
        }

        // <-- NOVO: Lógica de incremento de Y mais precisa
        const spacingForNextLine = (line.type === 'separator') ? separatorSpacing : LSpacing;
        currentY += line.size + spacingForNextLine;
    });

    ctx.restore();
}


/**
 * Desenha o rodapé do encarte com base nas configurações.
 */
/**
 * Desenha o rodapé do encarte com base nas configurações, respeitando quebras de linha manuais.
 */
function drawFooter(ctx, footerSettings) {
    if (!footerSettings || !footerSettings.textEnabled) {
        return;
    }

    ctx.save();

    const canvasWidth = ctx.canvas.width;
    const canvasHeight = ctx.canvas.height;
    const lateralMargin = flyerData.pages[flyerData.currentPageIndex].settings.margins.lateral;

    const footerX = lateralMargin;
    const footerWidth = canvasWidth - (2 * lateralMargin);

    // --- INÍCIO DA CORREÇÃO ---
    // 1. Processa o Texto Principal (respeitando "Enter")
    const manualMainTextLines = footerSettings.text.toUpperCase().split('\n');
    let finalMainTextLines = [];
    ctx.font = `bold ${footerSettings.fontSize}px '${footerSettings.fontFamily}'`;
    manualMainTextLines.forEach(manualLine => {
        const { lines: wrappedSubLines } = getWrappedLines(ctx, manualLine, footerWidth * 0.95);
        finalMainTextLines.push(...wrappedSubLines.map(l => l.trim()));
    });

    // 2. Processa o Subtexto (respeitando "Enter")
    const manualSubtextLines = footerSettings.footerSubtext.toUpperCase().split('\n');
    let finalSubtextLines = [];
    ctx.font = `bold ${footerSettings.footerSubtextFontSize}px '${footerSettings.subtextFontFamily}'`;
    manualSubtextLines.forEach(manualLine => {
        const { lines: wrappedSubLines } = getWrappedLines(ctx, manualLine, footerWidth * 0.95);
        finalSubtextLines.push(...wrappedSubLines.map(l => l.trim()));
    });
    // --- FIM DA CORREÇÃO ---

    const mainTextHeight = finalMainTextLines.length * (footerSettings.fontSize * 1.2);
    const subtextHeight = finalSubtextLines.length * (footerSettings.footerSubtextFontSize * 1.2);

    const totalTextHeight = mainTextHeight + subtextHeight + (finalMainTextLines.length > 0 && finalSubtextLines.length > 0 ? footerSettings.textSpacing : 0);
    const backgroundHeight = totalTextHeight + (footerSettings.paddingY * 2);

    let backgroundY;
    if (footerSettings.autoPosition) {
        backgroundY = canvasHeight - backgroundHeight - flyerData.pages[flyerData.currentPageIndex].settings.margins.footer;
    } else {
        backgroundY = footerSettings.positionY;
    }

    if (footerSettings.backgroundEnabled) {
        ctx.fillStyle = footerSettings.bgColor;
        pathRoundedRect(ctx, footerX, backgroundY, footerWidth, backgroundHeight, footerSettings.borderRadius);
        ctx.fill();
    }

    let textStartY;
    switch (footerSettings.textVerticalAlign) {
        case 'top': textStartY = backgroundY + footerSettings.paddingY; break;
        case 'bottom': textStartY = backgroundY + backgroundHeight - footerSettings.paddingY - totalTextHeight; break;
        default: textStartY = backgroundY + (backgroundHeight - totalTextHeight) / 2; break;
    }

    ctx.fillStyle = footerSettings.textColor;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    ctx.font = `bold ${footerSettings.fontSize}px '${footerSettings.fontFamily}'`;
    let currentY = textStartY;
    finalMainTextLines.forEach(line => {
        ctx.fillText(line, footerX + footerWidth / 2, currentY);
        currentY += footerSettings.fontSize * 1.2;
    });

    if (finalSubtextLines.length > 0 && finalMainTextLines.length > 0) {
        currentY += footerSettings.textSpacing;
    }

    ctx.font = `bold ${footerSettings.footerSubtextFontSize}px '${footerSettings.subtextFontFamily}'`;
    finalSubtextLines.forEach(line => {
        ctx.fillText(line, footerX + footerWidth / 2, currentY);
        currentY += footerSettings.footerSubtextFontSize * 1.2;
    });

    ctx.restore();
}

// Listener para o novo painel de validade do cabeçalho
document.getElementById('enableHeaderValidity').addEventListener('change', (e) => {
    document.getElementById('header-validity-options').classList.toggle('hidden', !e.target.checked);
});

// Listener para o slider de tamanho da linha de destaque
document.getElementById('highlightHeightMultiplier')?.addEventListener('input', (e) => {
    const multiplierValueSpan = document.getElementById('highlightMultiplierValue');
    if (multiplierValueSpan) {
        multiplierValueSpan.textContent = `${e.target.value}x`;
    }
});
// ==========================================================
// ===== FIM DO CÓDIGO DO SELO DE VALIDADE DO CABEÇALHO =====
// ==========================================================





   // ▼▼▼ COLE ESTA FUNÇÃO INTEIRA DE VOLTA NO SEU SCRIPT ▼▼▼
// ▼▼▼ PASSO 1: SUBSTITUA A FUNÇÃO drawGiganteTag PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ PASSO 1: SUBSTITUA TODA A FUNÇÃO 'drawGiganteTag' PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawGiganteTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawGiganteTag' POR ESTA VERSÃO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO 'drawGiganteTag' PELA VERSÃO ABAIXO ▼▼▼
function drawGiganteTag(ctx, product, finalX, finalY, finalWidth, finalHeight, details, fontSettings, priceSettings, descScaleX, descScaleY) {
    ctx.save();
    const priceScaleX = details.scaleX || 1;
    const priceScaleY = details.scaleY || 1;
    const blackPartWidth = finalWidth * 0.55;
    const yellowPartWidth = finalWidth * 0.45;
    const blackPartX = finalX;
    const yellowPartX = finalX + blackPartWidth;
    const descColor = '#FFFFFF';
    const priceColor = '#d42127';
    const borderRadius = 15;

    ctx.fillStyle = '#000000';
    ctx.beginPath();
    ctx.moveTo(blackPartX + borderRadius, finalY);
    ctx.lineTo(blackPartX + blackPartWidth, finalY);
    ctx.lineTo(blackPartX + blackPartWidth, finalY + finalHeight);
    ctx.lineTo(blackPartX + borderRadius, finalY + finalHeight);
    ctx.arcTo(blackPartX, finalY + finalHeight, blackPartX, finalY + finalHeight - borderRadius, borderRadius);
    ctx.lineTo(blackPartX, finalY + borderRadius);
    ctx.arcTo(blackPartX, finalY, blackPartX + borderRadius, finalY, borderRadius);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = '#ffc906';
    ctx.beginPath();
    ctx.moveTo(yellowPartX, finalY);
    ctx.lineTo(yellowPartX + yellowPartWidth - borderRadius, finalY);
    ctx.arcTo(yellowPartX + yellowPartWidth, finalY, yellowPartX + yellowPartWidth, finalY + borderRadius, borderRadius);
    ctx.lineTo(yellowPartX + yellowPartWidth, finalY + finalHeight - borderRadius);
    ctx.arcTo(yellowPartX + yellowPartWidth, finalY + finalHeight, yellowPartX + yellowPartWidth - borderRadius, finalY + finalHeight, borderRadius);
    ctx.lineTo(yellowPartX, finalY + finalHeight);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = descColor;
    const descFont = priceSettings.descFont || 'Oswald';
    let descFontSize = priceSettings.descFontSize || (finalHeight * 0.22);
    ctx.font = `bold ${descFontSize}px '${descFont}'`;
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    const descOffsetX = priceSettings.descOffsetX || 0;
    const descOffsetY = priceSettings.descOffsetY || 0;
    const rightPadding = 15;
    const descX = blackPartX + blackPartWidth - rightPadding + descOffsetX;
    const descY = finalY + finalHeight / 2 + descOffsetY;
    wrapText(ctx, details.productName.toUpperCase(), descX, descY, blackPartWidth * 0.9, descFontSize * 1.1, 'right', descScaleX, descScaleY);

    ctx.save();
    const priceCenterX = yellowPartX + yellowPartWidth / 2 + (priceSettings.priceOffsetX || 0);
    const priceCenterY = finalY + finalHeight / 2 + (priceSettings.priceOffsetY || 0);
    ctx.translate(priceCenterX, priceCenterY);
    ctx.scale(priceScaleX, priceScaleY);
    ctx.fillStyle = priceColor;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'alphabetic';

    // LINHA ALTERADA: Agora lê a fonte das configurações
    const priceFont = priceSettings.priceFont || 'Anton';

    const intFontSize = finalHeight * 0.70;
    const decimalFontSize = finalHeight * 0.30;
    const currencyFontSize = finalHeight * 0.25;
    const spacing = 5;
    ctx.font = `bold ${currencyFontSize}px ${priceFont}`; const currencyWidth = ctx.measureText('R$').width;
    ctx.font = `bold ${intFontSize}px ${priceFont}`; const integerWidth = ctx.measureText(details.integerPart).width;
    ctx.font = `bold ${decimalFontSize}px ${priceFont}`; const decimalWidth = ctx.measureText(',' + details.decimalPart).width;
    const naturalTotalWidth = currencyWidth + spacing + integerWidth + spacing + decimalWidth;
    const maxWidth = yellowPartWidth * 0.90;
    if (naturalTotalWidth > maxWidth) {
        ctx.scale(maxWidth / naturalTotalWidth, 1);
    }
    const baselineY = (intFontSize / 3.5);
    let currentX = -naturalTotalWidth / 2;
    ctx.font = `bold ${currencyFontSize}px ${priceFont}`;
    ctx.fillText('R$', currentX, baselineY);
    currentX += currencyWidth + spacing;
    ctx.font = `bold ${intFontSize}px ${priceFont}`;
    ctx.fillText(details.integerPart, currentX, baselineY);
    currentX += integerWidth + spacing;
    ctx.font = `bold ${decimalFontSize}px ${priceFont}`;
    ctx.fillText(',' + details.decimalPart, currentX, baselineY);
    ctx.restore(); 
    ctx.restore(); 
}


// ▼▼▼ COLE ESTA NOVA FUNÇÃO ABAIXO DA FUNÇÃO 'drawGiganteTag' ▼▼▼

// ▼▼▼ PASSO 1: SUBSTITUA TODA A FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ PASSO 1: SUBSTITUA TODA A FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO COM TEXTO CENTRALIZADO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ PASSO 2 DE 2: SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO FINAL ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO FINAL ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO FINAL ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO FINAL ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftRedTag' PELA VERSÃO FINAL E CORRIGIDA ABAIXO ▼▼▼
function drawDescLeftRedTag(ctx, x, y, w, h, details, styleSettings, descScaleX, descScaleY, priceScaleX, priceScaleY) {
    ctx.save();

    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const priceFont = styleSettings.priceFont || 'Anton';
    const baseFontSize = styleSettings.priceFontSize || (h * 0.8);
    const descFont = styleSettings.descFont || 'Anton';
    const descFontSize = styleSettings.descFontSize || (h * 0.3);
    const descColor = styleSettings.descColor || '#111827';
    const descriptionStartY = pageSettings.fonts.default.descriptionStartY;
    const padding = 10;
    
    const descWidth = w / 2 - padding / 2;
    const balloonAreaWidth = w / 2 - padding / 2;
    const descX = x;
    const balloonX = x + descWidth + padding;

    const descOffsetY = pageSettings.fonts.default.descriptionOffsetY || 0;

    // Desenha a descrição
    ctx.fillStyle = descColor;
    ctx.font = `bold ${descFontSize}px '${descFont}'`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    const descCenterX = descX + descWidth / 2;
    wrapText(ctx, details.productName.toUpperCase(), descCenterX, y + descriptionStartY + descOffsetY, descWidth * 0.95, descFontSize * 1.1, 'center', descScaleX, descScaleY);
    
    // Calcula as dimensões do balão
    const priceText = `${details.integerPart},${details.decimalPart}`;
    const circleRadius = h * 0.35;
    const pricePadding = h * 0.1;
    const letterSpacing = 2;
    ctx.font = `bold ${baseFontSize}px '${priceFont}'`;
    
    let priceTextWidth = 0;
    for (const char of priceText) {
        priceTextWidth += ctx.measureText(char).width + letterSpacing;
    }
    priceTextWidth -= letterSpacing;
    
    const rectWidth = circleRadius + pricePadding + priceTextWidth + padding;
    const naturalBalloonWidth = circleRadius + rectWidth;
    
    let autoScaleX = 1.0;
    if (naturalBalloonWidth > balloonAreaWidth) {
        autoScaleX = balloonAreaWidth / naturalBalloonWidth;
    }
    
    ctx.save();
    ctx.translate(balloonX, y);
    ctx.scale(autoScaleX, 1);

    // --- ETAPA 1: Desenha as formas do balão ---
    const mainRed = '#FF0000';
    const cornerRadius = h * 0.2;
    
    ctx.fillStyle = mainRed;
    pathRoundedRect(ctx, circleRadius, 0, rectWidth, h, cornerRadius);
    ctx.fill();
    
    const circleCenterY = h / 2;
    ctx.fillStyle = mainRed;
    ctx.beginPath();
    ctx.arc(circleRadius, circleCenterY, circleRadius, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.strokeStyle = '#FFFFFF';
    ctx.lineWidth = 2.5 / autoScaleX;
    ctx.beginPath();
    ctx.arc(circleRadius, circleCenterY, circleRadius - (ctx.lineWidth / 2), 0, Math.PI * 2);
    ctx.stroke();
    
    ctx.fillStyle = '#FFFFFF';
    ctx.font = `bold ${circleRadius * 0.9}px '${priceFont}'`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('R$', circleRadius, circleCenterY);

    // --- ETAPA 2: Desenha o texto do preço com a escala e POSIÇÃO do usuário ---
    ctx.save();

    const priceColor = '#FFFF00';
    const priceAreaCenterX = circleRadius + rectWidth / 2;
    const priceAreaCenterY = h / 2;

    // ==========================================================
    // ===== INÍCIO DA CORREÇÃO =====
    // ==========================================================
    // A linha abaixo agora SOMA os deslocamentos X e Y definidos no painel
    ctx.translate(priceAreaCenterX + styleSettings.priceOffsetX, priceAreaCenterY + styleSettings.priceOffsetY);
    // ========================================================
    // ===== FIM DA CORREÇÃO =====

    ctx.scale(priceScaleX, priceScaleY);

    ctx.fillStyle = priceColor;
    ctx.font = `bold ${baseFontSize}px '${priceFont}'`;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    
    let currentPriceX = -(priceTextWidth / 2);
    const priceY_relative = (baseFontSize * 0.05);

    for (const char of priceText) {
        ctx.fillText(char, currentPriceX, priceY_relative);
        currentPriceX += ctx.measureText(char).width + letterSpacing;
    }

    ctx.restore();
    ctx.restore();
    ctx.restore();
}
// ▼▼▼ COLE A NOVA FUNÇÃO COMPLETA AQUI ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA VERSÃO CORRIGIDA ▼▼▼

// ▼▼▼ SUBSTITUA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO PELA VERSÃO FINAL COM POSICIONAMENTO CORRIGIDO ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO COM TEXTO CENTRALIZADO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'drawDescLeft3DTag' INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA E COM ERRO POR ESTA VERSÃO CORRIGIDA ▼▼▼
// ▼▼▼ COLE A NOVA FUNÇÃO COMPLETA AQUI ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA INTEIRA POR ESTA VERSÃO CORRIGIDA ▼▼▼

// ▼▼▼ COLE ESTA FUNÇÃO CORRETA NO LUGAR DA SUA ANTIGA ▼▼▼
function drawDescLeft3DTag(ctx, x, y, w, h, details, styleSettings, isFirstRow, descScaleX, descScaleY, descOffsetY) {
    ctx.save();

    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const descFont = pageSettings.fonts.default.productName.family;
    const descFontSize = pageSettings.fonts.default.productName.size;
    const descColor = '#111827';
    const gap = 15;

    // Divide a área disponível: 45% para a descrição e 55% para o balão.
    const descWidth = w * 0.45 - gap / 2;
    const balloonWidth = w * 0.55 - gap / 2;
    const descX = x;
    const balloonX = x + descWidth + gap;

    ctx.fillStyle = descColor;
    ctx.font = `bold ${descFontSize}px '${descFont}'`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle'; // Alinha o texto verticalmente pelo meio.

    // A posição vertical do texto agora é calculada para o centro da altura (h) da área do balão
    const descCenterX = descX + descWidth / 2;
    const descCenterY = y + h / 2; // Posição Y verticalmente centralizada.

    // Desenha o texto da descrição na área da esquerda.
    wrapText(
        ctx,
        details.productName.toUpperCase(),
        descCenterX,
        descCenterY + descOffsetY, // Aplica o deslocamento global
        descWidth * 0.95,
        descFontSize * 1.1,
        'center',
        descScaleX,
        descScaleY
    );

    // Desenha o balão 3D vermelho na área da direita.
    drawPriceBalloon3DReference(ctx, balloonX, y, balloonWidth, h, details, styleSettings, isFirstRow);

    ctx.restore();
}




/**
 * NOVO ESTILO:
 * Desenha a descrição do produto à esquerda e um balão de preço customizado (da galeria) à direita.
 */
/**
 * VERSÃO FINAL E DINÂMICA:
 * Desenha a descrição no canto superior esquerdo, fazendo o texto contornar
 * dinamicamente o balão de preço customizado posicionado à direita.
 */
/**
 * NOVO ESTILO:
 * Desenha a descrição do produto à esquerda e um balão de preço customizado (da galeria) à direita.
 */
/**
 * VERSÃO ATUALIZADA:
 * Desenha a descrição do produto no canto inferior esquerdo e o balão customizado à direita.
 */
/**
 * VERSÃO FINAL E DINÂMICA:
 * Desenha a descrição no canto superior esquerdo, fazendo o texto contornar
 * dinamicamente o balão de preço customizado posicionado à direita.
 */
function drawDescLeftCustomPriceBalloon(ctx, x, y, w, h, details, globalOffsetY = 0) {
    ctx.save();
    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const padding = 15;

    // --- 1. CALCULAR A POSIÇÃO E TAMANHO DO BALÃO PRIMEIRO ---
    let balloonBox = null;
    let activeCustomBalloonName = null;
    // Encontra o primeiro balão customizado disponível para usar como modelo
    for (const name in customBalloons) {
        activeCustomBalloonName = name;
        break;
    }

    if (activeCustomBalloonName && customBalloons[activeCustomBalloonName]) {
        const customImg = customBalloons[activeCustomBalloonName];
        const allCustomSettings = pageSettings.balloonStyles.customBalloons || {};
        const styleSettings = allCustomSettings[activeCustomBalloonName] || {};
        
        const balloonWidthPercent = (styleSettings.balloonWidth || 85) / 100;
        const balloonAreaWidth = w * 0.55 - padding; // O balão ocupa a área direita do slot
        const finalW = balloonAreaWidth * balloonWidthPercent;
        
        const aspectRatio = customImg.height / customImg.width;
        const neutralH = finalW * aspectRatio;
        const balloonHeightPercent = (styleSettings.balloonHeight || 85) / 100;
        const finalH = neutralH * balloonHeightPercent;
        
        const balloonAreaX = x + w * 0.45 + padding;
        const finalX = balloonAreaX + (balloonAreaWidth - finalW) / 2;
        const finalY = y + h - finalH - padding + globalOffsetY;

        // Guarda as coordenadas do balão para a lógica do texto
        balloonBox = { x: finalX, y: finalY, w: finalW, h: finalH };
    }

    // --- 2. DESENHAR A DESCRIÇÃO COM QUEBRA DE LINHA DINÂMICA ---
    const descFont = pageSettings.fonts.default.productName.family;
    const descFontSize = pageSettings.fonts.default.productName.size;
    const descriptionStartY = pageSettings.fonts.default.descriptionStartY;
    const descOffsetY = pageSettings.fonts.default.descriptionOffsetY || 0;
    const descColor = '#111827';
    
    ctx.fillStyle = descColor;
    ctx.font = `bold ${descFontSize}px '${descFont}'`;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';

    const words = details.productName.toUpperCase().split(' ');
    let line = '';
    let currentY = y + descriptionStartY + descOffsetY; // Começa a desenhar do topo
    const lineHeight = descFontSize * 1.2;

    for (let n = 0; n < words.length; n++) {
        // Determina a largura máxima para a linha ATUAL
        let maxWidthForThisLine = w - (padding * 2); // Começa com a largura total
        if (balloonBox) {
            // Verifica se a linha de texto está na mesma altura do balão
            if (currentY + lineHeight > balloonBox.y && currentY < balloonBox.y + balloonBox.h) {
                // Se sim, reduz a largura máxima para não sobrepor o balão
                maxWidthForThisLine = balloonBox.x - x - padding;
            }
        }

        let testLine = line + words[n] + ' ';
        let metrics = ctx.measureText(testLine);

        // Se a linha com a nova palavra for muito grande, desenha a linha antiga
        if (metrics.width > maxWidthForThisLine && n > 0) {
            ctx.fillText(line, x + padding, currentY);
            line = words[n] + ' '; // Começa uma nova linha
            currentY += lineHeight; // Move para a próxima linha
        } else {
            // Se couber, continua adicionando palavras à linha atual
            line = testLine;
        }
    }
    ctx.fillText(line, x + padding, currentY); // Desenha a última linha de texto

    // --- 3. DESENHAR O BALÃO DE PREÇO ---
    // A função é chamada no final para garantir que o balão fique por cima de qualquer
    // sobreposição de texto acidental.
    if (activeCustomBalloonName) {
        drawCustomImageBalloon(ctx, x, y, w, h, details, activeCustomBalloonName, globalOffsetY);
    }
    
    ctx.restore();
}



        // ▼▼▼ PASSO 1 DE 2: SUBSTITUA TODA A SUA FUNÇÃO 'pathRoundedRect' PELA VERSÃO ABAIXO ▼▼▼
function pathRoundedRect(ctx, x, y, width, height, radius) {
    // Permite que 'radius' seja um número (para todos os cantos) ou um objeto (para cantos individuais)
    if (typeof radius === 'number') {
        radius = { tl: radius, tr: radius, br: radius, bl: radius };
    } else {
        const defaultRadius = { tl: 0, tr: 0, br: 0, bl: 0 };
        radius = { ...defaultRadius, ...radius };
    }
    ctx.beginPath();
    ctx.moveTo(x + radius.tl, y);
    ctx.lineTo(x + width - radius.tr, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
    ctx.lineTo(x + width, y + height - radius.br);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
    ctx.lineTo(x + radius.bl, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
    ctx.lineTo(x, y + radius.tl);
    ctx.quadraticCurveTo(x, y, x + radius.tl, y);
    ctx.closePath();
}
		
        function getWrappedLines(context, text, maxWidth) { if (!text) return { lines: [], maxWidth: 0 }; const words = text.split(' '); let lines = [], line = '', maxLineWidth = 0; for(let n = 0; n < words.length; n++) { let testLine = line + words[n] + ' '; const metrics = context.measureText(testLine); if (metrics.width > maxWidth && n > 0) { lines.push(line); maxLineWidth = Math.max(maxLineWidth, context.measureText(line).width); line = words[n] + ' '; } else { line = testLine; } } lines.push(line); maxLineWidth = Math.max(maxLineWidth, context.measureText(line).width); return { lines, maxWidth: maxLineWidth }; }
        
		// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'wrapText' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'wrapText' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO wrapText INTEIRA POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA a função wrapText POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA a função wrapText POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'wrapText' POR ESTA VERSÃO ▼▼▼
function wrapText(context, text, x, y, maxWidth, lineHeight, alignment = 'left', scaleX = 1, scaleY = 1) {
    context.save();
    if (!text) {
        context.restore();
        return { totalHeight: 0 };
    }

    const manualLines = text.split('\n');
    let allLines = [];

    manualLines.forEach(manualLine => {
        const { lines: wrappedSubLines } = getWrappedLines(context, manualLine, maxWidth / scaleX);
        allLines.push(...wrappedSubLines.map(l => l.trim()));
    });

    const totalHeight = allLines.length * lineHeight * scaleY;
    let currentY;

    switch(context.textBaseline) {
        case 'middle': currentY = y - (totalHeight / 2); break;
        case 'bottom': currentY = y - totalHeight; break;
        default: currentY = y; break;
    }

    context.textBaseline = 'middle';

    context.translate(x, currentY); 
    context.scale(scaleX, scaleY);

    for (const [index, line] of allLines.entries()) {
        const isLastLine = (index === allLines.length - 1);
        const lineY = (lineHeight / 2) + (index * lineHeight);
        const words = line.split(' ');

        if (alignment === 'justify' && !isLastLine && words.length > 1) {
            context.textAlign = 'left'; // Forçamos o alinhamento à esquerda para desenhar palavra por palavra
            const totalWordWidth = context.measureText(words.join('')).width;
            const totalSpacing = maxWidth - totalWordWidth;
            const spaceWidth = totalSpacing / (words.length - 1);

            let currentX = -maxWidth / 2; // Começa na borda esquerda da caixa de texto
            words.forEach((word, i) => {
                context.fillText(word, currentX, lineY);
                currentX += context.measureText(word).width + spaceWidth;
            });
        } else {
            // Comportamento padrão para 'center', 'left', 'right' ou última linha justificada
            context.textAlign = alignment;
            context.fillText(line, 0, lineY);
        }
    }

    context.restore();
    return { totalHeight: totalHeight };
}






// ▼▼▼ SUBSTITUA A FUNÇÃO ANTERIOR INTEIRA POR ESTA VERSÃO FINAL ▼▼▼

function drawPricePosterLayout(page) {
    // --- CONTROLES DE ESPAÇAMENTO (AJUSTE ESTES VALORES) ---
    const priceLetterSpacing = 20;  // Espaçamento em pixels entre as letras do PREÇO
    const descLetterSpacing = 8;   // Espaçamento em pixels entre as letras da DESCRIÇÃO
    // ---------------------------------------------------------

    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    const settings = page.settings;
    const product = page.products[0];

    // --- ETAPA 1: DESENHA O LAYOUT BASE DO ENCARTE ---
    if (page.backgroundImage) {
        ctx.drawImage(page.backgroundImage, 0, 0, w, h);
    }
    Object.keys(settings.logos).forEach(logoKey => {
        const logoSettings = settings.logos[logoKey];
        const globalLogo = flyerData.logos[logoKey];
        if (globalLogo && globalLogo.img) {
            const logoWidth = logoSettings.width;
            const logoHeight = globalLogo.img.height * (logoWidth / globalLogo.img.width);
            ctx.drawImage(globalLogo.img, logoSettings.x, logoSettings.y, logoWidth, logoHeight);
        }
    });
    drawHeaderValidity(ctx, settings.headerValidity);

    // --- ETAPA 2: DESENHA O RETÂNGULO DE FUNDO PARA O PREÇO ---
    const mainBoxY = settings.margins.top;
    const mainBoxX = settings.margins.lateral;
    const mainBoxWidth = w - (settings.margins.lateral * 2);
    const mainBoxHeight = h - mainBoxY - settings.margins.footer - (settings.footer.textEnabled ? 50 : 0);
    const padding = w * 0.05;

    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(mainBoxX, mainBoxY, mainBoxWidth, mainBoxHeight);

    // --- ETAPA 3: DESENHA O PREÇO GIGANTE COM ESPAÇAMENTO ---
    const [integerPart, decimalPart] = parseFloat(product.price).toFixed(2).split('.');
    const priceText = `${integerPart},${decimalPart}`;
    const priceFont = 'Anton';
    const priceY = mainBoxY + mainBoxHeight * 0.4;
    const priceFontSize = mainBoxHeight * 0.60; 
    
    ctx.font = `bold ${priceFontSize}px ${priceFont}`;
    ctx.fillStyle = '#FF0000';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    
    let naturalPriceWidth = 0;
    for(const char of priceText) {
        naturalPriceWidth += ctx.measureText(char).width + priceLetterSpacing;
    }
    if (priceText.length > 0) naturalPriceWidth -= priceLetterSpacing;

    const availableWidth = mainBoxWidth - padding;
    const scaleX = naturalPriceWidth > availableWidth ? availableWidth / naturalPriceWidth : 1;
    
    ctx.save();
    ctx.translate(w / 2, priceY);
    ctx.scale(scaleX, 1);
    
    let currentX = -naturalPriceWidth / 2;
    for (const char of priceText) {
        ctx.fillText(char, currentX, 0);
        currentX += ctx.measureText(char).width + priceLetterSpacing;
    }
    ctx.restore();

    // --- ETAPA 4: DESENHA A DESCRIÇÃO COM ALINHAMENTO FIXO ---
    const descFont = 'Anton';
    let descFontSize = 320; 
    ctx.font = `bold ${descFontSize}px ${descFont}`;
    ctx.fillStyle = '#000000';
    ctx.textAlign = 'center'; // Centraliza cada linha individualmente
    
    // Posição vertical fixa para a PRIMEIRA linha da descrição
    const descStartY = mainBoxY + mainBoxHeight * 0.75; 
    
    const { lines } = getWrappedLines(ctx, product.name.toUpperCase(), availableWidth);
    const linesToDraw = lines.slice(0, 3);
    const lineHeight = descFontSize * 1.2;

ctx.letterSpacing = '8px'; // Ajuste este valor em pixels conforme sua preferência

    // ==========================================================
    // ===== INÍCIO DA CORREÇÃO DE ALINHAMENTO =====
    // ==========================================================
    // O cálculo que centralizava o bloco de texto foi removido.
    // Agora, o loop simplesmente desenha a primeira linha na posição fixa 'descStartY'
    // e as seguintes abaixo dela.
    linesToDraw.forEach((line, index) => {
        ctx.fillText(line.trim(), w / 2, descStartY + (index * lineHeight));
    });
    // ========================================================
    // ===== FIM DA CORREÇÃO DE ALINHAMENTO =====
    // ========================================================
	    drawFooter(ctx, settings.footer);

}

// ▲▲▲ FIM DO BLOCO ▲▲▲


        
  
// ▼▼▼ SUBSTITUA A FUNÇÃO 'redrawCanvas' INTEIRA POR ESTA VERSÃO CORRIGIDA ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'redrawCanvas' INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
function redrawCanvas() {
    if (!flyerData.pages[flyerData.currentPageIndex]) return;

    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    
    ctx.save();
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.translate(viewTransform.origin.x, viewTransform.origin.y);
    ctx.scale(viewTransform.scale, viewTransform.scale);
    
    if (currentPage.isPricePoster) {
        drawPricePosterLayout(currentPage);
        ctx.restore();
        return; 
    }

    const pageSettings = currentPage.settings;
    productSlots = []; 

    if (currentPage.backgroundImage) {
        ctx.drawImage(currentPage.backgroundImage, 0, 0, canvas.width, canvas.height);
    }
    
    // ==========================================================
    // ===== INÍCIO DA CORREÇÃO =====
    // ==========================================================
    // O bloco que desenha as LOGOS foi movido para ANTES do bloco que desenha a VALIDADE.

    // 1. DESENHA AS LOGOS PRIMEIRO
    Object.keys(pageSettings.logos).forEach(logoKey => {
        const logoSettings = pageSettings.logos[logoKey];
        const globalLogo = flyerData.logos[logoKey];
        if (globalLogo && globalLogo.img) {
            const logoWidth = logoSettings.width;
            const logoHeight = globalLogo.img.height * (logoWidth / globalLogo.img.width);
            ctx.drawImage(globalLogo.img, logoSettings.x, logoSettings.y, logoWidth, logoHeight);
        }
    });

    // 2. DESENHA O SELO DE VALIDADE DEPOIS (por cima das logos)
    drawHeaderValidity(ctx, pageSettings.headerValidity);

    // ========================================================
    // ===== FIM DA CORREÇÃO =====
    // ========================================================
    
    // CÓDIGO CORRIGIDO
    // Bloco Novo e Corrigido
    ctx.save(); 
    if (pageSettings.slogan.enabled && pageSettings.slogan.text) {
        const sloganText = pageSettings.slogan.text;
        const sloganSize = pageSettings.slogan.fontSize;
        const sloganX = pageSettings.slogan.positionX || canvas.width / 2;
        const sloganY = pageSettings.slogan.positionY || 150;
        
        ctx.font = `bold ${sloganSize}px '${pageSettings.slogan.fontFamily || 'Anton'}'`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle'; 
        
        if (pageSettings.slogan.borderEnabled) {
            ctx.strokeStyle = pageSettings.slogan.borderColor;
            ctx.lineWidth = pageSettings.slogan.borderWidth || 4;
            ctx.lineJoin = 'round';
            ctx.strokeText(sloganText, sloganX, sloganY);
        }
        ctx.fillStyle = pageSettings.slogan.color;
        ctx.fillText(sloganText, sloganX, sloganY);
    }
    ctx.restore();

    const topMargin = pageSettings.margins.top;
    const footerMarginAsSpacing = pageSettings.margins.footer;
    const lateralMargin = pageSettings.margins.lateral;
    const footerSettings = pageSettings.footer;

    let finalGridBottomY;
    if (footerSettings.textEnabled && footerSettings.autoPosition) {
         finalGridBottomY = canvas.height - 200 - footerMarginAsSpacing; 
    } else {
         finalGridBottomY = canvas.height - footerMarginAsSpacing;
    }

    if (pageSettings.predefinedLayout !== "manual") {
        drawPredefinedGrid(pageSettings.predefinedLayout, topMargin, finalGridBottomY);
    } else {
        const layout = currentPage.manualLayout;
        if (layout.length > 0) {
            const contentWidth = canvas.width - 2 * lateralMargin;
            const totalRowSpacing = layout.length > 1 ? layout.slice(0, -1).reduce((acc, curr) => acc + curr.rowSpacing, 0) : 0;
            
            let availableHeight;
            if (footerSettings.textEnabled && footerSettings.autoPosition) {
                 availableHeight = canvas.height - topMargin - (footerMarginAsSpacing + 200) - totalRowSpacing;
            } else {
                 availableHeight = canvas.height - topMargin - footerMarginAsSpacing - totalRowSpacing;
            }
            
            const isHighlightEnabled = pageSettings.highlight.enabled;
            const heightMultiplier = pageSettings.highlight.highlightHeightMultiplier || 1.4;
            
            const totalUnits = layout.reduce((acc, line, index) => {
                let lineUnits = 1;
                const isHighlightedForCalc = isHighlightEnabled && (index === 0);
                if (isHighlightedForCalc) {
                    lineUnits *= heightMultiplier;
                }
                return acc + lineUnits;
            }, 0) || 1;
            
            const standardRowHeight = availableHeight > 0 ? availableHeight / totalUnits : 0;
            
            let productIndex = 0;
            let yOffset = topMargin;

            for (let i = 0; i < layout.length; i++) {
                const line = layout[i];
                const isLineHighlighted = isHighlightEnabled && (i === 0);
                const currentRowHeight = isLineHighlighted ? standardRowHeight * heightMultiplier : standardRowHeight;

                if (isLineHighlighted && pageSettings.highlight.style === 'unified') {
                    ctx.fillStyle = pageSettings.highlight.color;
                    pathRoundedRect(ctx, lateralMargin, yOffset, contentWidth, currentRowHeight, line.borderStyle === 'rounded' ? 20 : 0);
                    ctx.fill();
                }

                const productsInRow = line.products;
                const totalColSpacing = Math.max(0, productsInRow - 1) * line.colSpacing;
                const colWidth = (contentWidth - totalColSpacing) / productsInRow;
                for (let j = 0; j < productsInRow; j++) {
                    const x = lateralMargin + j * (colWidth + line.colSpacing);
                    productSlots.push({ x, y: yOffset, width: colWidth, height: currentRowHeight, productIndex: productIndex });
                    let slotBg = (isLineHighlighted && pageSettings.highlight.style === 'individual') ? pageSettings.highlight.color : null;
                    if (productIndex < currentPage.products.length) { 
                        drawProduct(currentPage.products[productIndex], x, yOffset, colWidth, currentRowHeight, slotBg, isLineHighlighted, line, false); 
                    } 
                    else { 
                        drawPlaceholderSlot(x, yOffset, colWidth, currentRowHeight, line.borderStyle); 
                    }
                    productIndex++;
                }
                yOffset += currentRowHeight + line.rowSpacing;
            }
        }
    }

    if (footerSettings.textEnabled) {
        drawFooter(ctx, footerSettings);
    }

    if (selectedProductIndices.size > 0) {
        selectedProductIndices.forEach(index => {
            const slot = productSlots.find(s => s.productIndex === index);
            if (slot) {
                drawSelectionHighlight(ctx, slot);
            }
        });
    }
    
    ctx.restore();
}
		
		
		
		
		
		
		
        
        function drawPlaceholderSlot(x, y, w, h, borderStyle) {
    ctx.save();
    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const defaultSlotRgbaColor = pageSettings.slotBackground.enabled ? hexToRgba(pageSettings.slotBackground.color, pageSettings.slotBackground.opacity) : 'transparent';
    
    if ("transparent" !== defaultSlotRgbaColor) {
        ctx.fillStyle = defaultSlotRgbaColor;
        if (borderStyle === "rounded" || borderStyle === "dashed-rounded") {
            pathRoundedRect(ctx, x, y, w, h, 20);
            ctx.fill();
        } else {
            ctx.fillRect(x, y, w, h);
        }
    }

    if (borderStyle !== 'none') {
        const borderColor = pageSettings.slotBorder.customColorEnabled ? pageSettings.slotBorder.color : '#007c11';
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 1.5;
        
        if (borderStyle === 'dashed' || borderStyle === 'dashed-rounded') {
            ctx.setLineDash([6, 3]);
        }
        
        if (borderStyle === 'rounded' || borderStyle === 'dashed-rounded') {
            pathRoundedRect(ctx, x, y, w, h, 20);
            ctx.stroke();
        } else {
            ctx.strokeRect(x, y, w, h);
        }
    }
    
    ctx.restore();
}
        // ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO updateProductListUI PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'updateProductListUI' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'updateProductListUI' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
function updateProductListUI() {
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (!currentPage) return;

    productListDiv.innerHTML = currentPage.products.length === 0 ? `<p class="text-gray-500 text-sm">Nenhum produto adicionado.</p>` : '';

    currentPage.products.forEach((p, index) => {
        const item = document.createElement('div');
        item.className = 'product-list-item bg-gray-100 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600 flex items-center gap-3';
        item.draggable = true;
        item.dataset.index = index;

        const handle = document.createElement('div');
        handle.className = 'drag-handle cursor-move flex-shrink-0';
        handle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>`;

        const imageContainer = document.createElement('div');
        imageContainer.className = 'flex-shrink-0';
        const imgPreview = document.createElement('img');
        imgPreview.className = 'w-16 h-16 object-cover rounded-md bg-gray-200';
        imgPreview.src = p.image ? p.image.src : 'https://placehold.co/64x64/e2e8f0/adb5bd?text=Sem+Foto';
        imgPreview.draggable = false;

        // Input de arquivo continua existindo, mas escondido, para a opção de upload.
        const imageInput = document.createElement('input');
        imageInput.type = 'file';
        imageInput.className = 'hidden';
        imageInput.accept = 'image/*';
        imageInput.id = `edit-image-${index}`;
        imageInput.dataset.index = index;

        // O 'label' agora não aponta mais para o input, ele vai abrir nosso novo modal.
        const imageLabel = document.createElement('label');
        imageLabel.className = 'cursor-pointer';
        imageLabel.appendChild(imgPreview);
        // ===============================================
        // A MUDANÇA PRINCIPAL ESTÁ AQUI
        // ===============================================
        imageLabel.addEventListener('click', () => openImageSearchModal(index));
        // ===============================================

        imageContainer.appendChild(imageLabel);
        imageContainer.appendChild(imageInput);

        const inputsContainer = document.createElement('div');
        inputsContainer.className = 'flex-grow space-y-1 min-w-0';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.value = p.name;
        nameInput.dataset.index = index;
        nameInput.className = 'edit-name w-full bg-white dark:bg-gray-800 border rounded p-1 text-sm';
        inputsContainer.appendChild(nameInput);

        const bottomRow = document.createElement('div');
        bottomRow.className = 'flex items-center gap-2';

        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.value = p.price;
        priceInput.step = '0.01';
        priceInput.dataset.index = index;
        priceInput.className = 'edit-price w-full bg-white dark:bg-gray-800 border rounded p-1 text-sm flex-grow';
        bottomRow.appendChild(priceInput);

        const colorLabel = document.createElement('label');
        colorLabel.className = 'flex-shrink-0 cursor-pointer p-1 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600';
        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = p.backgroundColor || '#FFFFFF';
        colorInput.dataset.index = index;
        colorInput.className = 'edit-bgcolor h-6 w-8 rounded border-none cursor-pointer';
        colorLabel.appendChild(colorInput);
        bottomRow.appendChild(colorLabel);

        inputsContainer.appendChild(bottomRow);

        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '&times;';
        deleteBtn.dataset.index = index;
        deleteBtn.className = 'remove-btn text-red-500 hover:text-red-700 font-bold text-2xl h-8 w-8 flex-shrink-0';

        item.appendChild(handle);
        item.appendChild(imageContainer);
        item.appendChild(inputsContainer);
        item.appendChild(deleteBtn);

        productListDiv.appendChild(item);
    });

    addDragListeners();
    populateImageMultiSelect();
}

// ▲▲▲ FIM DO BLOCO ▲▲▲
		
		
		
		
        function dragStart() { dragStartIndex = +this.dataset.index; this.classList.add('dragging'); } function dragOver(e) { e.preventDefault(); } function dragEnter() { this.classList.add('drag-over'); } function dragLeave() { this.classList.remove('drag-over'); } function drop() { swapItems(dragStartIndex, +this.dataset.index); this.classList.remove('drag-over'); } function dragEnd() { document.querySelectorAll('.product-list-item').forEach(item => item.classList.remove('dragging', 'drag-over')); }
        function swapItems(fromIndex, toIndex) { const currentPage = flyerData.pages[flyerData.currentPageIndex], item = currentPage.products.splice(fromIndex, 1)[0]; currentPage.products.splice(toIndex, 0, item); updateProductListUI(); redrawCanvas(); }
        
		
		// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'addDragListeners' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

function addDragListeners() {
    document.querySelectorAll('.product-list-item').forEach(d => {
        d.addEventListener('dragstart', dragStart);
        d.addEventListener('dragover', dragOver);
        d.addEventListener('drop', drop);
        d.addEventListener('dragend', dragEnd);
        d.addEventListener('dragenter', dragEnter);
        d.addEventListener('dragleave', dragLeave);
    });
    document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', e => {
        flyerData.pages[flyerData.currentPageIndex].products.splice(parseInt(e.target.dataset.index), 1);
        updateProductListUI();
        redrawCanvas();
    }));
    document.querySelectorAll('.edit-name').forEach(input => input.addEventListener('input', e => {
        flyerData.pages[flyerData.currentPageIndex].products[e.target.dataset.index].name = e.target.value;
        redrawCanvas();
        populateImageMultiSelect(); // Corrigido de populateImageSelect para o novo nome
    }));
    document.querySelectorAll('.edit-price').forEach(input => input.addEventListener('input', e => {
        flyerData.pages[flyerData.currentPageIndex].products[e.target.dataset.index].price = e.target.value;
        redrawCanvas();
    }));
    document.querySelectorAll('.edit-bgcolor').forEach(input => input.addEventListener('input', e => {
        flyerData.pages[flyerData.currentPageIndex].products[e.target.dataset.index].backgroundColor = e.target.value;
        redrawCanvas();
    }));
    
    // ==========================================================
    // --- A LÓGICA DE SALVAR NO BANCO DE DADOS FOI ADICIONADA AQUI ---
    // ==========================================================
    document.querySelectorAll('input[type="file"][id^="edit-image-"]').forEach(input => input.addEventListener('change', e => {
        const index = parseInt(e.target.dataset.index);
        
        handleSingleImageUpload(e, img => {
            const productInFlyer = flyerData.pages[flyerData.currentPageIndex].products[index];
            if (!productInFlyer) return;

            // 1. Atualiza a imagem no encarte (como antes)
            productInFlyer.image = img;
            productInFlyer.src = img.src;

            // 2. (NOVO) Adiciona/Atualiza o produto no banco de dados local
            const productName = productInFlyer.name;
            const productPrice = productInFlyer.price;
            
            productDatabase[productName] = {
                name: productName,
                price: productPrice,
                src: img.src // O 'src' aqui é a imagem em base64
            };

            // 3. (NOVO) Marca o banco de dados como "não sincronizado"
            isDatabaseSynced = false;
            updateSyncStatusUI();

            // 4. Redesenha tudo e avisa o usuário
            redrawCanvas();
            updateProductListUI();
            
            // Avisa o usuário que ele precisa sincronizar
            showAlert(`Imagem de "${productName}" atualizada. Lembre-se de ir ao painel 'Estoque' e sincronizar com a nuvem para salvar permanentemente.`);
        });
    }));
    // ==========================================================
    // --- FIM DA NOVA LÓGICA ---
    // ==========================================================
}
		
		
        function handleSingleImageUpload(e, callback) { const file = e.target.files[0]; if (file) { const reader = new FileReader; reader.onload = event => { const img = new Image; img.onload = () => callback(img); img.src = event.target.result }; reader.readAsDataURL(file) } }
        function handleLogoUpload(e, logoObject) { const file = e.target.files[0]; if (file) { const reader = new FileReader; reader.onload = event => { const img = new Image; img.onload = () => { logoObject.img = img; logoObject.src = img.src; redrawCanvas() }; img.src = event.target.result }; reader.readAsDataURL(file) } }
// =====================================================================================
// ▼▼▼ COLE ESTE BLOCO FINAL E COMPLETO AQUI ▼▼▼
// =====================================================================================

// =====================================================================================
// --- BLOCO DE CONTROLES DO MOUSE NO CANVAS (ZOOM, PAN, SELEÇÃO) ---
// =====================================================================================

// =====================================================================================
// --- BLOCO DE CONTROLES DO MOUSE NO CANVAS (ZOOM, PAN, SELEÇÃO) ---
// =====================================================================================

const resetZoomBtn = document.getElementById('resetZoomBtn');
const prevPageBtn = document.getElementById('prevPageBtn');
const nextPageBtn = document.getElementById('nextPageBtn');

if (resetZoomBtn) {
    resetZoomBtn.addEventListener('click', () => {
        viewTransform.scale = 1;
        viewTransform.origin.x = 0;
        viewTransform.origin.y = 0;
        redrawCanvas();
    });
}

// ▼▼▼ COLE ESTE BLOCO NOVO NO SEU SCRIPT ▼▼▼
const refreshPreviewBtn = document.getElementById('refreshPreviewBtn');
if (refreshPreviewBtn) {
    refreshPreviewBtn.addEventListener('click', () => {
        // Esta função já salva as configurações e redesenha o canvas
        updateAndRedraw();
    });
}
// ▲▲▲ FIM DO BLOCO ▲▲▲



// Desativa o menu de contexto do clique direito no canvas
canvas.addEventListener('contextmenu', e => e.preventDefault());

// Controle de ZOOM com a RODA DO MOUSE
canvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const zoomFactor = 1.1;
    const oldScale = viewTransform.scale;
    let newScale = e.deltaY < 0 ? oldScale * zoomFactor : oldScale / zoomFactor;
    newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
    
    // CORREÇÃO DE ESCALA CSS APLICADA AO ZOOM
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const mouseX = (e.clientX - rect.left) * scaleX;
    const mouseY = (e.clientY - rect.top) * scaleY;

    const worldX = (mouseX - viewTransform.origin.x) / oldScale;
    const worldY = (mouseY - viewTransform.origin.y) / oldScale;
    viewTransform.origin.x = mouseX - worldX * newScale;
    viewTransform.origin.y = mouseY - worldY * newScale;
    viewTransform.scale = newScale;
    redrawCanvas();
});

// Inicia a ação: PAN (botão do meio), ARRASTAR ou SELECIONAR (botão esquerdo)
canvas.addEventListener('mousedown', (e) => {
    e.preventDefault();
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (!currentPage) return;

    panStart.x = e.clientX;
    panStart.y = e.clientY;

    const rect = canvas.getBoundingClientRect();
    // ===== INÍCIO DA CORREÇÃO DE ESCALA CSS =====
    // Converte o clique na tela para as coordenadas internas do canvas
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const canvasX = (e.clientX - rect.left) * scaleX;
    const canvasY = (e.clientY - rect.top) * scaleY;
    // ===== FIM DA CORREÇÃO DE ESCALA CSS =====

    // Usa as coordenadas corrigidas para calcular a posição no "mundo" do encarte
    const worldX = (canvasX - viewTransform.origin.x) / viewTransform.scale;
    const worldY = (canvasY - viewTransform.origin.y) / viewTransform.scale;

    if (e.button === 1) { // Ação do BOTÃO DO MEIO (scroll): Navegar (Pan)
        mouseAction = 'panning';
        canvas.style.cursor = 'grabbing';
        return;
    }

    if (e.button === 0) { // Ação do BOTÃO ESQUERDO: Arrastar objetos ou iniciar Seleção
        for (const logo of Object.values(currentPage.settings.logos)) {
            const globalLogo = flyerData.logos[logo.name];
            if (globalLogo && globalLogo.img) {
                const logoW = logo.width;
                const logoH = globalLogo.img.height * (logoW / globalLogo.img.width);
                if (worldX > logo.x && worldX < logo.x + logoW && worldY > logo.y && worldY < logo.y + logoH) {
                    mouseAction = 'draggingLogo';
                    activeDragObject = logo;
                    activeDragObject.offsetX = worldX - logo.x;
                    activeDragObject.offsetY = worldY - logo.y;
                    return;
                }
            }
        }
        const hvSettings = currentPage.settings.headerValidity;
        if (hvSettings && hvSettings.enabled) {
            const sealHeight = hvSettings.width / 1.05;
            if (worldX >= hvSettings.x && worldX <= hvSettings.x + hvSettings.width &&
                worldY >= hvSettings.y && worldY <= hvSettings.y + sealHeight) {
                mouseAction = 'draggingHeader';
                validityOffsetX = worldX - hvSettings.x;
                validityOffsetY = worldY - hvSettings.y;
                return;
            }
        }
        mouseAction = 'selecting';
        canvas.style.cursor = 'crosshair';
    }
});

// Executa a ação enquanto o mouse se move
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'mousemove' INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼

canvas.addEventListener('mousemove', (e) => {
    e.preventDefault();
    if (mouseAction === 'none') {
        canvas.style.cursor = 'grab';
        return;
    }

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const canvasX = (e.clientX - rect.left) * scaleX;
    const canvasY = (e.clientY - rect.top) * scaleY;
    
    const worldX = (canvasX - viewTransform.origin.x) / viewTransform.scale;
    const worldY = (canvasY - viewTransform.origin.y) / viewTransform.scale;

    switch (mouseAction) {
        case 'draggingLogo':
            if (activeDraggingLogoKey) {
                // Pega uma referência fresca do objeto da logo e atualiza suas coordenadas
                const logoSettings = flyerData.pages[flyerData.currentPageIndex].settings.logos[activeDraggingLogoKey];
                if(logoSettings) {
                    logoSettings.x = worldX - logoOffsetX;
                    logoSettings.y = worldY - logoOffsetY;
                    
                    // ATUALIZA OS CAMPOS DA INTERFACE EM TEMPO REAL
                    document.getElementById(activeDraggingLogoKey + 'X').value = Math.round(logoSettings.x);
                    document.getElementById(activeDraggingLogoKey + 'Y').value = Math.round(logoSettings.y);

                    redrawCanvas();
                }
            }
            break;
        case 'draggingHeader':
            const hvSettings = flyerData.pages[flyerData.currentPageIndex].settings.headerValidity;
            hvSettings.x = worldX - validityOffsetX;
            hvSettings.y = worldY - validityOffsetY;
            document.getElementById('headerValidityX').value = Math.round(hvSettings.x);
            document.getElementById('headerValidityY').value = Math.round(hvSettings.y);
            redrawCanvas();
            break;
        case 'panning':
            const dx = e.clientX - panStart.x;
            const dy = e.clientY - panStart.y;
            viewTransform.origin.x += dx;
            viewTransform.origin.y += dy;
            panStart.x = e.clientX;
            panStart.y = e.clientY;
            redrawCanvas();
            break;
    }
});

// Finaliza a ação ao soltar o botão do mouse
canvas.addEventListener('mouseup', (e) => {
    e.preventDefault();

    if (e.button === 0 && mouseAction === 'selecting') {
        const rect = canvas.getBoundingClientRect();
        // ===== CORREÇÃO DE ESCALA CSS (A MAIS IMPORTANTE ESTÁ AQUI) =====
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const canvasX = (e.clientX - rect.left) * scaleX;
        const canvasY = (e.clientY - rect.top) * scaleY;
        
        const worldX = (canvasX - viewTransform.origin.x) / viewTransform.scale;
        const worldY = (canvasY - viewTransform.origin.y) / viewTransform.scale;
        
        const clickedSlot = productSlots.find(slot =>
            worldX >= slot.x && worldX <= slot.x + slot.width &&
            worldY >= slot.y && worldY <= slot.y + slot.height
        );

        if (clickedSlot && clickedSlot.productIndex < flyerData.pages[flyerData.currentPageIndex].products.length) {
            const productIndex = clickedSlot.productIndex;
            
            if (e.ctrlKey) {
                if (selectedProductIndices.has(productIndex)) {
                    selectedProductIndices.delete(productIndex);
                } else {
                    selectedProductIndices.add(productIndex);
                }
            } else {
                selectedProductIndices.clear();
                selectedProductIndices.add(productIndex);
            }
        } else {
            if (!e.ctrlKey) { 
                selectedProductIndices.clear();
            }
        }
        
        if (selectedProductIndices.size > 0) {
            openControlPanel('panel-images');
            isPanelLocked = true;
            menuBackdrop.style.pointerEvents = 'none';
        } else {
            isPanelLocked = false;
            menuBackdrop.style.pointerEvents = 'auto';
            if(activePanelId === 'panel-images'){
                closeControlPanel();
            }
        }
        syncImagePanelSelection();
        redrawCanvas();
    }

    mouseAction = 'none';
    activeDragObject = null;
    canvas.style.cursor = 'grab';
});

// Reseta a ação se o mouse sair do canvas
canvas.addEventListener('mouseout', (e) => {
    mouseAction = 'none';
    activeDragObject = null;
    canvas.style.cursor = 'default';
});
		
		
        function updateAndRedraw() { if (flyerData.pages[flyerData.currentPageIndex]) { saveCurrentPageSettings(); redrawCanvas(); } }
        function updateAndResize() { if (flyerData.pages[flyerData.currentPageIndex]) { saveCurrentPageSettings(); setCanvasSize(); } }
        function handleControlChange(control) { if (control) { const panel = control.closest('.panel'); if (!['panel-product-list', 'panel-save-load', 'panel-images', 'panel-add-product', 'panel-templates'].includes(panel ? panel.id : '') && 'file' !== control.type) { if ('pageSize' === control.id || 'customWidth' === control.id || 'customHeight' === control.id) { updateAndResize(); } else { updateAndRedraw(); } } } }
        controlPanelContainer.addEventListener('input', e => handleControlChange(e.target)); controlPanelContainer.addEventListener('change', e => handleControlChange(e.target));
        
		// ▼▼▼ SUBSTITUA SUA FUNÇÃO addProductWithDefaults POR ESTA ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'addProductWithDefaults' PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'addProductWithDefaults' PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA ANTIGA FUNÇÃO 'addProductWithDefaults' POR ESTA ▼▼▼
function addProductWithDefaults(productData) {
    // Chama nossa nova função para obter os padrões ideais para a imagem
    const smartDefaults = calculateSmartImageDefaults(productData.image);

    flyerData.pages[flyerData.currentPageIndex].products.push({
        ...productData,
        ...smartDefaults, // Aplica os padrões calculados (repetições, tamanho, posição)
        backgroundColor: null,
        descScaleX: 100,
        descScaleY: 100,
        priceScaleX: 100,
        priceScaleY: 100
    });
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
		
        addProductBtn.addEventListener('click', () => { if (productNameInput.value && priceInput.value && newProductImage) { addProductWithDefaults({ name: productNameInput.value, price: parseFloat(priceInput.value).toFixed(2), image: newProductImage, src: newProductImage.src }); productNameInput.value = ''; priceInput.value = ''; productImageInput.value = ''; newProductImage = null; updateProductListUI(); redrawCanvas() } else { showAlert('Por favor, preencha nome, preço e imagem do produto.'); } });
        
		
		
		
		// =======================================================
// ====== BLOCO CORRIGIDO DO "ADICIONAR (EM LOTE)" =======
// =======================================================
// =======================================================
// =======================================================
// ====== "ADICIONAR EM LOTE" COM ORDEM CORRETA ======
// =======================================================


// =======================================================
// ====== "ADICIONAR EM LOTE" COM NOME DA LISTA ======
// =======================================================
// =======================================================
// ====== "ADICIONAR EM LOTE" COM SEPARADOR ÚNICO (;) ======
// =======================================================
// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO OTIMIZADA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO FINAL ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO FINAL E CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO FINAL E CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO FINAL ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' INTEIRA PELA VERSÃO FINAL E CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' PELA VERSÃO FINAL E CORRETA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' PELA VERSÃO FINAL E CORRETA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO 'bulkAddBtn.addEventListener' PELA VERSÃO FINAL E CORRETA ABAIXO ▼▼▼

bulkAddBtn.addEventListener('click', (e) => {
    const text = bulkAddTextarea.value.trim();
    if (!text) {
        showAlert("Por favor, cole sua lista de produtos na área de texto.");
        return;
    }

    showConfirm("Isso irá criar um novo encarte. Na Página 1, todos os produtos terão fundo e balões de preço destacados. As páginas seguintes usarão o fundo padrão, sem destaque. Deseja continuar?", async (confirmed) => {
        if (!confirmed) return;

        showSpinner(true);

        try {
            const settingsTemplate = JSON.parse(JSON.stringify(flyerData.pages[flyerData.currentPageIndex].settings));
            const highlightColorForPage1 = settingsTemplate.highlight.color || '#FFFF00';
            const bodyBackground_Img = flyerData.pages[0]?.backgroundImage || null;
            const bodyBackground_Src = flyerData.pages[0]?.backgroundImageSrc || null;

            const lines = text.split('\n').filter(line => line.trim());
            const pagesFromFile = [];
            let currentPageLines = [];

            for (const line of lines) {
                if (/^p\s*\d+/i.test(line)) {
                    if (currentPageLines.length > 0) {
                        pagesFromFile.push(currentPageLines);
                    }
                    currentPageLines = [];
                } else {
                    currentPageLines.push(line);
                }
            }
            if (currentPageLines.length > 0) {
                pagesFromFile.push(currentPageLines);
            }

            const allProductPromises = pagesFromFile.flat().map(line => new Promise(resolve => {
                let nameFromList = '';
                let pricePart = '0.00';
                const parts = line.split(';');
                nameFromList = parts[0].trim();
                if (parts.length > 1 && parts[1].trim()) {
                    const priceText = parts[1].trim().split(' ')[0].replace(',', '.');
                    const parsedPrice = parseFloat(priceText);
                    if (!isNaN(parsedPrice)) {
                        pricePart = parsedPrice.toFixed(2);
                    }
                }
                const bestMatchName = findBestMatchInDb(nameFromList);
                const productData = bestMatchName ? productDatabase[bestMatchName] : null;

                if (productData && productData.src) {
                    const img = new Image();
                    img.onload = () => resolve({ name: nameFromList, price: pricePart, src: productData.src, image: img });
                    img.onerror = () => resolve({ name: nameFromList, price: pricePart, src: null, image: null });
                    img.src = productData.src;
                } else {
                    resolve({ name: nameFromList, price: pricePart, src: null, image: null });
                }
            }));
            
            const allResolvedProducts = await Promise.all(allProductPromises);
            
            flyerData.pages = [];
            let productIndex = 0;
            
            for (const pageLines of pagesFromFile) {
                let productsForThisPage = allResolvedProducts.slice(productIndex, productIndex + pageLines.length).filter(p => p);
                productIndex += pageLines.length;

                if (productsForThisPage.length > 0) {
                    let newPage = createDefaultPage(); 
                    newPage.settings = JSON.parse(JSON.stringify(settingsTemplate));
					
					
					 // ▼▼▼ ADICIONE ESTE BLOCO PARA DEFINIR O FORMATO DA PÁGINA ▼▼▼
                    // Define o formato da página para Instagram automaticamente
                    newPage.settings.pageSize = '1769x2212 '; // O valor exato da opção no menu <select>
                    newPage.settings.customWidth = 1769;
                    newPage.settings.customHeight = 2212;
                    // ▲▲▲ FIM DO BLOCO ▲▲▲
					

// ▼▼▼ ADICIONE ESTA LINHA AQUI ▼▼▼
                    Object.assign(newPage.settings.headerValidity, instagramHeaderDefaults);
                    // ▲▲▲ FIM DA ADIÇÃO ▲▲▲


// ▼▼▼ ADICIONE ESTA LINHA PARA AS MARGENS PADRÃO ▼▼▼
                    newPage.settings.margins = instagramMarginDefaults;
                    // ▲▲▲ FIM DA ADIÇÃO ▲▲▲



                    // Desativa a função de destaque de *linha* em todas as páginas, pois vamos controlar a cor manualmente.
                    newPage.settings.highlight.enabled = false;
                    
                    if (flyerData.pages.length === 0) { // Lógica para a nova Página 1
                        newPage.backgroundImage = null;
                        newPage.backgroundImageSrc = null;
                        newPage.settings.backgroundImageSrc = null;

                        // Aplica a cor de destaque em CADA PRODUTO da primeira página.
                        productsForThisPage.forEach(p => {
                            p.backgroundColor = highlightColorForPage1;
                        });
                        
                        // Força TODOS os balões desta página a usarem o estilo da "1ª Linha".
                        if (newPage.settings.balloons) {
                            newPage.settings.balloons.otherLines = newPage.settings.balloons.firstLine;
                        }

                    } else { // Lógica para as novas Páginas 2, 3, 4...
                        newPage.backgroundImage = bodyBackground_Img;
                        newPage.backgroundImageSrc = bodyBackground_Src;
                        newPage.settings.backgroundImageSrc = bodyBackground_Src;
                        
                        // Garante que o estilo dos balões seja o padrão (não o de destaque).
                        if (newPage.settings.balloons) {
                            newPage.settings.balloons.firstLine = newPage.settings.balloons.otherLines;
                        }
                    }
                    
                    newPage.products = productsForThisPage.map(p => ({ ...p, ...calculateSmartImageDefaults(p.image) }));


                    
                    newPage.settings.predefinedLayout = 'manual';
                    newPage.manualLayout = generateAutoLayout(newPage.products.length);

                    flyerData.pages.push(newPage);
                }
            }

            if (flyerData.pages.length > 0) {
                switchPage(0, false);
                showAlert(`${flyerData.pages.length} páginas foram criadas com sucesso!`);
            } else {
                showAlert("Não foi possível criar páginas a partir da lista fornecida.");
            }
            bulkAddTextarea.value = '';

        } catch (error) {
            console.error("Erro ao processar a lista:", error);
            showAlert("Ocorreu um erro inesperado ao processar a lista.");
        } finally {
            showSpinner(false);
        }
    });
});


		
        productImageInput.addEventListener('change', e => handleSingleImageUpload(e, img => { newProductImage = img; }));
        

// ======================= INÍCIO DA CORREÇÃO DEFINITIVA =======================
backgroundImageInput.addEventListener('change', e => handleSingleImageUpload(e, img => {
    const currentPage = flyerData.pages[flyerData.currentPageIndex];

    // 1. Atualiza o objeto da imagem para o canvas poder desenhá-la
    currentPage.backgroundImage = img;
    // 2. Atualiza a variável principal que guarda o link da imagem (Data URL)
    currentPage.backgroundImageSrc = img.src;

    // 3. A LINHA DA CORREÇÃO: Força a sincronização imediata do objeto de configurações.
    //    Isso trata a imagem de fundo como qualquer outra configuração (margem, cor, etc.),
    //    garantindo que o estado a ser salvo esteja sempre 100% atualizado.
    saveCurrentPageSettings(); 

    // 4. Redesenha o canvas para mostrar a nova imagem
    redrawCanvas();
}));
// ======================== FIM DA CORREÇÃO DEFINITIVA =========================
		
		
        promoLogoInput.addEventListener('change', e => handleLogoUpload(e, flyerData.logos.promo));
        storeLogoInput.addEventListener('change', e => handleLogoUpload(e, flyerData.logos.store));
        complementaryLogoInput.addEventListener('change', e => handleLogoUpload(e, flyerData.logos.complementary));
        // >>> SELECIONE E APAGUE TODO ESTE BLOCO ABAIXO <<<


        
        // >>> BOTÃO DE DOWNLOAD ATUALIZADO <<<
       
	   // >>> LÓGICA ATUALIZADA PARA CONTROLE DE MÚLTIPLAS IMAGENS <<<

        // Função para popular a nova lista com checkboxes
       
	   
	   
	   // >>> COLE ESTE BLOCO CORRIGIDO NO LUGAR DAS FUNÇÕES MISTURADAS <<<

        // Função para popular a nova lista com checkboxes
        function populateImageMultiSelect() {
            const container = document.getElementById('productMultiSelectContainer');
            const currentPage = flyerData.pages[flyerData.currentPageIndex];
            if (!container || !currentPage) return;

            container.innerHTML = '';
            if (currentPage.products.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 p-2">Nenhum produto no encarte.</p>';
                imageControlsContainer.classList.add('hidden'); // Esconde os controles se não há produtos
                return;
            }

            currentPage.products.forEach((product, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center gap-2 p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `product-select-${index}`;
                checkbox.dataset.index = index;
                checkbox.className = 'h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500';
                
                // Sincroniza o estado do checkbox com nossa variável de seleção
                checkbox.checked = selectedProductIndices.has(index);

                const label = document.createElement('label');
                label.htmlFor = `product-select-${index}`;
                label.textContent = product.name;
                label.className = 'text-sm cursor-pointer flex-grow';

                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                container.appendChild(itemDiv);

                checkbox.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index, 10);
                    const isChecked = e.target.checked;

                    if (isChecked) {
                        selectedProductIndices.add(index);
                    } else {
                        selectedProductIndices.delete(index);
                    }
                    
                    updateImageControlsUI();
                    redrawCanvas();
                });
            });

            // Chama a função para garantir que os controles apareçam ou desapareçam corretamente
            updateImageControlsUI();
        }

        // Função para pegar os índices de todos os produtos selecionados
        function getSelectedImageIndices() {
            return Array.from(selectedProductIndices);
        }

        // Função para atualizar os sliders baseada na seleção
  // ▼▼▼ SUBSTITUA A FUNÇÃO 'updateImageControlsUI' PELA VERSÃO ABAIXO ▼▼▼
function updateImageControlsUI() {
    const selectedIndices = getSelectedImageIndices();
    const currentPage = flyerData.pages[flyerData.currentPageIndex];

    if (selectedIndices.length === 0 || !currentPage) {
        imageControlsContainer.classList.add('hidden');
        return;
    }

    const firstProduct = currentPage.products[selectedIndices[0]];
    imageControlsContainer.classList.remove('hidden');

    // Controles de Imagem (já existentes)
    imageRepetitionsInput.value = firstProduct.imageRepetitions || 1;
    imageRepetitionDirectionSelect.value = firstProduct.imageRepetitionDirection || 'horizontal';
    imagePositionXInput.value = firstProduct.imagePositionX || 50;
    imagePositionYInput.value = firstProduct.imagePositionY || 50;
    imageFitSelect.value = firstProduct.imageFit || 'contain';
    imageWidthPercentInput.value = firstProduct.imageWidthPercent || 100;
    imageHeightPercentInput.value = firstProduct.imageHeightPercent || 100;

    // --- CORREÇÃO AQUI ---
    // Agora lê os valores da descrição também
    document.getElementById('descScaleX').value = firstProduct.descScaleX || 100;
    document.getElementById('descScaleY').value = firstProduct.descScaleY || 100;
    document.getElementById('priceScaleX').value = firstProduct.priceScaleX || 100;
    document.getElementById('priceScaleY').value = firstProduct.priceScaleY || 100;
    // --- FIM DA CORREÇÃO ---
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

	

        // Nova função centralizada para aplicar mudanças a todos os itens selecionados
        function applyChangeToSelectedProducts(property, value) {
    const selectedIndices = getSelectedImageIndices();
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (selectedIndices.length === 0 || !currentPage) return;

    selectedIndices.forEach(index => {
        if (currentPage.products[index]) {
            currentPage.products[index][property] = value;
        }
    });
    redrawCanvas();
}
	   
	   
	   
	     

        // ▼▼▼ COLE ESTE BLOCO CORRIGIDO NO LUGAR DO ANTIGO ▼▼▼

imageRepetitionsInput.addEventListener('input', e => applyChangeToSelectedProducts('imageRepetitions', parseInt(e.target.value, 10)));
imageRepetitionDirectionSelect.addEventListener('change', e => applyChangeToSelectedProducts('imageRepetitionDirection', e.target.value));
imagePositionXInput.addEventListener('input', e => applyChangeToSelectedProducts('imagePositionX', parseInt(e.target.value, 10)));
imagePositionYInput.addEventListener('input', e => applyChangeToSelectedProducts('imagePositionY', parseInt(e.target.value, 10)));
imageFitSelect.addEventListener('change', e => applyChangeToSelectedProducts('imageFit', e.target.value));
imageWidthPercentInput.addEventListener('input', e => applyChangeToSelectedProducts('imageWidthPercent', parseInt(e.target.value, 10)));
imageHeightPercentInput.addEventListener('input', e => applyChangeToSelectedProducts('imageHeightPercent', parseInt(e.target.value, 10)));

// Event listeners para os sliders de texto (descrição e preço)
document.getElementById('descScaleX').addEventListener('input', e => applyChangeToSelectedProducts('descScaleX', parseInt(e.target.value, 10)));
document.getElementById('descScaleY').addEventListener('input', e => applyChangeToSelectedProducts('descScaleY', parseInt(e.target.value, 10)));
document.getElementById('priceScaleX').addEventListener('input', e => applyChangeToSelectedProducts('priceScaleX', parseInt(e.target.value, 10)));
document.getElementById('priceScaleY').addEventListener('input', e => applyChangeToSelectedProducts('priceScaleY', parseInt(e.target.value, 10)));

	   
	   
	   
        // ▼▼▼ SUBSTITUA A FUNÇÃO 'getFlyerState' PELA VERSÃO ABAIXO ▼▼▼
function getFlyerState() {
    // Garante que as configurações da página atual, incluindo as posições das logos,
    // sejam lidas da interface e salvas no objeto 'flyerData' antes de retornar.
    saveCurrentPageSettings();
    return flyerData;
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
        // ▼▼▼ SUBSTITUA A FUNÇÃO 'applyFlyerState' PELA VERSÃO ABAIXO ▼▼▼
async function applyFlyerState(e) {
    flyerNameInput.value = e.flyerName || '';
    const t = e => new Promise(t => { if (!e) return void t(null); const o = new Image; o.onload = () => t(o); o.onerror = () => t(null); o.src = e });
    flyerData.logos.promo.src = e.logos.promo.src;
    flyerData.logos.promo.img = await t(e.logos.promo.src);
    flyerData.logos.store.src = e.logos.store.src;
    flyerData.logos.store.img = await t(e.logos.store.src);
    flyerData.logos.complementary.src = e.logos.complementary.src;
    flyerData.logos.complementary.img = await t(e.logos.complementary.src);
    const o = e.pages.map(async e => {
        const o = e.products.map(async e => ({ ...e, image: await t(e.src) }));
        const n = e.manualLayout.map(async e => ({ ...e, titleLogoImg: await t(e.titleLogoSrc) }));
        return { ...e, products: await Promise.all(o), manualLayout: await Promise.all(n), backgroundImage: await t(e.backgroundImageSrc) }
    });
    flyerData.pages = await Promise.all(o);
    flyerData.currentPageIndex = e.currentPageIndex || 0;
    0 === flyerData.pages.length && flyerData.pages.push(createDefaultPage());

    // --- INÍCIO DA CORREÇÃO ---
    // Força a atualização da interface com os dados carregados, incluindo as
    // coordenadas X e Y das logos nos campos de input do painel.
    switchPage(flyerData.currentPageIndex, false);
    // --- FIM DA CORREÇÃO ---
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
		
		
        saveFlyerBtn.addEventListener('click', async () => { const e = flyerNameInput.value.trim(); if (!e) return void showAlert('Por favor, insira um nome para o encarte.'); showSpinner(!0); try { const t = getFlyerState(); t.flyerName = e; const o = JSON.parse(JSON.stringify(t, (e, t) => t instanceof HTMLImageElement ? void 0 : t)); const n = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const a = doc(db, 'artifacts', n, 'users', userId, 'flyers', e); await setDoc(a, o); showAlert(`Encarte "${e}" salvo com sucesso na nuvem!`); await populateSavedFlyers() } catch (e) { console.error("Error saving flyer: ", e); showAlert("Erro ao salvar o encarte. Tente novamente.") } finally { showSpinner(!1) } });
        loadFlyerBtn.addEventListener('click', async () => { const e = savedFlyersSelect.value; if (!e) return void showAlert('Por favor, selecione um encarte para carregar.'); showSpinner(!0); try { const t = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const o = doc(db, 'artifacts', t, 'users', userId, 'flyers', e); const n = await getDoc(o); if (n.exists()) { await applyFlyerState(n.data()); showAlert(`Encarte "${e}" carregado com sucesso!`) } else { showAlert('Erro ao carregar o encarte. Dados não encontrados.') } } catch (e) { console.error("Error loading flyer: ", e); showAlert("Erro ao carregar o encarte. Tente novamente.") } finally { showSpinner(!1) } });
        deleteFlyerBtn.addEventListener('click', () => { const e = savedFlyersSelect.value; e ? showConfirm(`Tem certeza que deseja deletar o encarte "${e}"? Esta ação não pode ser desfeita.`, async t => { if (t) { showSpinner(!0); try { const t = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const o = doc(db, 'artifacts', t, 'users', userId, 'flyers', e); await deleteDoc(o); showAlert(`Encarte "${e}" deletado.`); flyerNameInput.value = ''; await populateSavedFlyers() } catch (e) { console.error("Error deleting flyer: ", e); showAlert("Erro ao deletar o encarte. Tente novamente.") } finally { showSpinner(!1) } } }) : showAlert('Por favor, selecione um encarte para deletar.') });
        savedFlyersSelect.addEventListener('change', e => { flyerNameInput.value = e.target.value; });
        async function populateSavedFlyers() { savedFlyersSelect.innerHTML = '<option value="">Selecione para carregar ou deletar</option>'; if (db && userId) try { const e = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; const t = collection(db, 'artifacts', e, 'users', userId, 'flyers'); const o = await getDocs(t); o.forEach(e => { const t = e.id; const o = document.createElement('option'); o.value = t; o.textContent = t; savedFlyersSelect.appendChild(o) }) } catch (e) { console.error("Error populating saved flyers:", e); showAlert("Não foi possível carregar a lista de encartes salvos.") } }
        
		
		
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'updateStyleControlsVisibility' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'updateStyleControlsVisibility' PELA VERSÃO ABAIXO ▼▼▼
function updateStyleControlsVisibility() {
    const activeStyles = new Set([firstLineBalloonStyleSelect.value, otherLinesBalloonStyleSelect.value]);

    const fontMap = {
        'default': document.getElementById('font-controls-default'),
        'circle-model': document.getElementById('font-controls-default'),
        'rectangle': document.getElementById('font-controls-default'),
        'text-outline': document.getElementById('font-controls-contour'),
        'currency-highlight': document.getElementById('font-controls-currency-highlight'),
        'currency-highlight-2': document.getElementById('font-controls-currency-highlight'),
        'yellow-tag': document.getElementById('font-controls-yellow-tag'),
        'red-tag-white-text': document.getElementById('font-controls-default'),
		'desc-left-3d-tag': document.getElementById('font-controls-default'),
        'red-tag-3d': document.getElementById('font-controls-default'),
        'green-on-yellow-tag': document.getElementById('font-controls-default'),
        'red-tag-separate-rs': document.getElementById('font-controls-default'),
        'yellow-tag-green-text': document.getElementById('font-controls-default'),
        'red-yellow-outlined': document.getElementById('font-controls-default')
    };
    
    const balloonMap = {
        'default': document.getElementById('balloon-settings-default'),
        'circle-model': document.getElementById('balloon-settings-default'),
        'rectangle': document.getElementById('balloon-settings-default'),
        'text-outline': document.getElementById('balloon-settings-contour'),
        'currency-highlight': document.getElementById('balloon-settings-currency-highlight'),
        'currency-highlight-2': document.getElementById('balloon-settings-currency-highlight-2'),
        'yellow-tag': document.getElementById('balloon-settings-yellow-tag'),
		'red-tag-white-text': document.getElementById('balloon-settings-default'),
        'red-tag-3d': document.getElementById('balloon-settings-default'),
        'green-on-yellow-tag': document.getElementById('balloon-settings-green-on-yellow-tag'),
        'red-tag-separate-rs': document.getElementById('balloon-settings-red-tag-separate-rs'),
        'gigante-tag': document.getElementById('balloon-settings-gigante-tag'),
		'desc-left-red-tag': document.getElementById('balloon-settings-desc-left-red-tag'), 
        'yellow-tag-green-text': document.getElementById('balloon-settings-default'),
        'red-yellow-outlined': document.getElementById('balloon-settings-default'),
        'custom-image': document.getElementById('balloon-settings-custom-image'),
        'desc-left-custom-balloon': document.getElementById('balloon-settings-desc-left-custom') // <-- Adicionado
    };

    Object.values(fontMap).forEach(el => el?.classList.add('hidden'));
    Object.values(balloonMap).forEach(el => el?.classList.add('hidden'));

    activeStyles.forEach(style => {
        if (style.startsWith('custom_')) {
            if (balloonMap['custom-image']) balloonMap['custom-image'].classList.remove('hidden');
        } else {
            if (fontMap[style]) fontMap[style].classList.remove('hidden');
            if (balloonMap[style]) balloonMap[style].classList.remove('hidden');
        }
    });

    if (!document.getElementById('balloon-settings-custom-image').classList.contains('hidden')) {
        updateCustomBalloonPanelUI();
    }
    if (!document.getElementById('balloon-settings-desc-left-custom').classList.contains('hidden')) {
        populateCustomBalloonSelector();
    }
}
// ▲▲▲ FIM DO BLOCO ▲▲▲
		
		function populateCustomBalloonSelector() {
    const select = document.getElementById('dlc_balloon_select');
    const savedBalloons = JSON.parse(localStorage.getItem('customBalloons') || '{}');
    select.innerHTML = '';
    
    const balloonNames = Object.keys(savedBalloons);
    if (balloonNames.length === 0) {
        select.innerHTML = '<option value="">Nenhum balão customizado salvo</option>';
        return;
    }

    balloonNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
    });

    // Tenta manter a seleção atual se ela existir
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (currentPage && currentPage.settings.balloonStyles.descLeftCustom) {
        select.value = currentPage.settings.balloonStyles.descLeftCustom.selectedBalloonName || balloonNames[0];
    }
}
		
		
		
		
        firstLineBalloonStyleSelect.addEventListener('change', updateStyleControlsVisibility);
        otherLinesBalloonStyleSelect.addEventListener('change', updateStyleControlsVisibility);


// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'createDefaultPage' PELA VERSÃO ABAIXO ▼▼▼
function createDefaultPage() {
    const today = new Date();
    const futureDate = new Date(new Date().setDate(today.getDate() + 7));
    const day = String(futureDate.getDate()).padStart(2, '0'),
        month = String(futureDate.getMonth() + 1).padStart(2, '0'),
        year = futureDate.getFullYear();
    return {
        products: [],
        manualLayout: [],
        lineObjects: [],
        backgroundImage: null,
        backgroundImageSrc: null,
        settings: {
            pageSize: '1580x2212',
            predefinedLayout: 'manual',
            predefinedBorderStyle: 'straight',
            customWidth: 1080,
            customHeight: 1350,
            margins: { top: 580, lateral: 50, footer: 50 },
            backgroundImageSrc: null,
            logos: {
                promo: { name: 'promoLogo', width: 200, x: 40, y: 40, isDragging: false, offsetX: 0, offsetY: 0 },
                store: { name: 'storeLogo', width: 200, x: 840, y: 40, isDragging: false, offsetX: 0, offsetY: 0 },
                complementary: { name: 'complementaryLogo', width: 150, x: 440, y: 50, isDragging: false, offsetX: 0, offsetY: 0 }
            },
            

slogan: { enabled: false, text: 'OFERTAS ARRASADORAS', fontSize: 60, color: '#e63946', borderEnabled: false, borderColor: '#000000', fontFamily: 'Anton', borderWidth: 4, positionX: 540, positionY: 150 },
            slotBorder: { customColorEnabled: false, color: '#007c11' },
            highlight: { enabled: false, color: '#FFFF00', noBorder: false, highlightHeightMultiplier: 1.4, style: 'individual' },
            slotBackground: { enabled: true, color: '#FFFFFF', opacity: 100 },
            imageAreaScale: 100,
            fonts: {
                default: {
                    productName: { family: 'Inter', size: 14 },
                    descriptionOffsetY: 0,
                    descriptionStartY: 25,
                    descScaleX: 100,
                    descScaleY: 100
                },
                contour: { descFont: 'Anton', descSize: 14, descColor: '#000000', descOffsetY: 21, priceFont: 'Anton', firstLinePriceSize: 45, otherLinesPriceSize: 35, priceColor: '#FFDE17', priceBorderColor: '#E62228', priceBorderWidth: 6 },
                currencyHighlight: { chDescFont: 'Inter', chDescFontSize: 14 },
                yellowTag: { descFont: 'Oswald', descSize: 17, descColor: '#000000', descOffsetY: 20 },
            },
            balloonStyles: {
                default: {
                    price: { family: 'Anton', firstLineSize: 40, otherLinesSize: 30, scaleX: 100, scaleY: 100, priceOffsetY: 4 },
                    color: '#FF0000'
                },
                currencyHighlight: { bgColor: '#009688', priceColor: '#FFFFFF', circleColor: '#FFFFFF', currencyColor: '#004D40', priceFont: 'Anton', firstLinePriceSize: 50, otherLinesPriceSize: 40, borderRadius: 20 },
                currencyHighlight2: { bgColor: '#008000', priceColor: '#FFFFFF', circleColor: '#FFFFFF', currencyColor: '#007647', priceFont: 'Anton', firstLinePriceSize: 50, otherLinesPriceSize: 40, borderRadius: 20 },
                yellowTag: { tagBgColor: '#ffde00', priceColor: '#d90429', priceFont: 'Oswald', firstLinePriceSize: 60, otherLinesPriceSize: 50, borderRadius: 15 },
                greenOnYellowTag: { priceFont: 'Anton', priceFontSize: 70, priceOffsetX: 0, priceOffsetY: 7 },
                redTagSeparateRS: { priceFont: 'Anton', priceFontSize: 60, priceOffsetX: 0, priceOffsetY: 0 },
                giganteTag: { height: 20, offsetX: 0, offsetY: 0, priceOffsetX: 0, priceOffsetY: 7, descFont: 'Oswald', descFontSize: 20, descOffsetX: 0, descOffsetY: 0 },
                descLeftRedTag: { descFont: 'Anton', descFontSize: 17, descColor: '#000000', priceFont: 'Anton', priceFontSize: 70, priceOffsetX: 0, priceOffsetY: 0 },
                
                customBalloons: {
                    priceColor: '#FFFFFF',
                    priceFontSize: 80,
                    priceOffsetX: 50,
                    priceOffsetY: 50,
                    balloonWidth: 85,
                    balloonHeight: 85,
                    priceFont: 'Anton',
                    descLeftLayout: false
                },
			},
            balloons: { firstLine: 'default', otherLines: 'default', highlightedBalloonOffsetY: 0, globalOffsetY: 0, balloonHeightPercent: 70 },
            footer: {
                textEnabled: false,
                text: `OFERTAS VÁLidas DE 24/07 ATÉ 27/07/2025. OU ENQUANTO DURAREM OS ESTOQUES.`,
                fontFamily: 'Roboto',
                fontSize: 28,
                footerSubtext: 'POSSÍVEIS ERROS GRÁFICOS NESTE IMPRESSO, TEM RESERVADO O DIREITO DE VERIFICAÇÃO, AS IMAGENS SÃO MERAMENTE ILUSTRATIVAS.',
                subtextFontFamily: 'Roboto',
                footerSubtextFontSize: 18,
                backgroundEnabled: true,
                bgColor: '#000000',
                textColor: '#FFFFFF',
                textVerticalAlign: 'middle',
                borderRadius: 0,
                paddingY: 20,
                positionY: 2150,
                textSpacing: 10,
                autoPosition: true
            },
            headerValidity: {
                enabled: false,
                startDate: '',
                endDate: '',
                titleText: '',
                stockText: 'OU ENQUANTO\nDURAREM OS\nESTOQUES.', // <--- LINHA CORRIGIDA

                extraText2: '',
                x: 50, y: 50, width: 350,
                bgColor: '#00843D', textColor: '#FFFFFF',
                fontSizeLine1: 25, fontSizeStartDate: 60, fontSizeDates: 50, fontSizeStock: 35, fontSizeExtra2: 25,
                extraTextAlign: 'center',
                lineSpacing: 10,
				extraSpacing: 5,
				headerSeparatorSpacing: 10, // <-- ADICIONE ESTA LINHA
				dateToStockSpacing: 15,
                backgroundEnabled: false, // <--- LINHA CORRIGIDA

				headerValidityScale: 100,
            }
        }
    };
}
        
		

// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'getPageSettingsFromUI' PELA VERSÃO ABAIXO ▼▼▼
function getPageSettingsFromUI() {
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    const currentSettings = currentPage.settings;

    // Trecho com erro dentro da função getPageSettingsFromUI()

// Trecho corrigido para a função getPageSettingsFromUI()

// É necessário obter os elementos de input primeiro, caso ainda não os tenha em variáveis.
const promoLogoXInput = document.getElementById('promoLogoX');
const promoLogoYInput = document.getElementById('promoLogoY');
const storeLogoXInput = document.getElementById('storeLogoX');
const storeLogoYInput = document.getElementById('storeLogoY');
const complementaryLogoXInput = document.getElementById('complementaryLogoX');
const complementaryLogoYInput = document.getElementById('complementaryLogoY');

const cleanLogoSettings = {
    promo: {
        name: 'promoLogo',
        width: parseInt(promoLogoWidthInput.value) || 200,
        // CORRIGIDO: Lendo o valor do campo de input HTML
        x: parseInt(promoLogoXInput.value, 10),
        y: parseInt(promoLogoYInput.value, 10),
        src: flyerData.logos.promo.src
    },
    store: {
        name: 'storeLogo',
        width: parseInt(storeLogoWidthInput.value) || 200,
        // CORRIGIDO:
        x: parseInt(storeLogoXInput.value, 10),
        y: parseInt(storeLogoYInput.value, 10),
        src: flyerData.logos.store.src
    },
    complementary: {
        name: 'complementaryLogo',
        width: parseInt(complementaryLogoWidthInput.value) || 150,
        // CORRIGIDO:
        x: parseInt(complementaryLogoXInput.value, 10),
        y: parseInt(complementaryLogoYInput.value, 10),
        src: flyerData.logos.complementary.src
    }
};

    const customBalloonsSettings = JSON.parse(JSON.stringify(currentPage.settings.balloonStyles.customBalloons || {}));
    const activeCustomBalloons = new Set();
    const firstStyle = firstLineBalloonStyleSelect.value;
    const otherStyle = otherLinesBalloonStyleSelect.value;

    if (firstStyle.startsWith('custom_')) activeCustomBalloons.add(firstStyle.replace('custom_', ''));
    if (otherStyle.startsWith('custom_')) activeCustomBalloons.add(otherStyle.replace('custom_', ''));

    if (activeCustomBalloons.size > 0) {
        const currentUISettings = {
            priceColor: document.getElementById('customBalloonPriceColor').value,
            priceFontSize: parseInt(document.getElementById('customBalloonPriceFontSize').value, 10),
            priceOffsetX: parseInt(document.getElementById('customBalloonPriceOffsetX').value, 10),
            priceOffsetY: parseInt(document.getElementById('customBalloonPriceOffsetY').value, 10),
            balloonWidth: parseInt(document.getElementById('customBalloonWidth').value, 10) || 85,
            balloonHeight: parseInt(document.getElementById('customBalloonHeight').value, 10) || 85,
            priceFont: document.getElementById('customBalloonPriceFont').value,
            descLeftLayout: document.getElementById('customBalloonDescLeftToggle').checked
        };
        activeCustomBalloons.forEach(name => {
            customBalloonsSettings[name] = currentUISettings;
        });
    }

    // O restante da função continua idêntico...
    // (Omitido para encurtar, mas a sua substituição deve ser completa)
    return {
        pageSize: pageSizeSelect.value,
        backgroundImageSrc: currentPage ? currentPage.backgroundImageSrc : null,
        predefinedLayout: predefinedLayoutSelect.value,
        predefinedBorderStyle: document.getElementById('predefinedBorderStyle').value,
        customWidth: parseInt(customWidthInput.value) || 1080,
        customHeight: parseInt(customHeightInput.value) || 1350,
        margins: {
            top: parseInt(topMarginInput.value) || 0,
            lateral: parseInt(lateralSpacingInput.value) || 0,
            footer: parseInt(footerSpacingInput.value) || 0
        },
        logos: cleanLogoSettings,
        slogan: { enabled: enableSloganCheckbox.checked, text: sloganTextInput.value, fontSize: parseInt(sloganFontSizeInput.value) || 60, color: sloganColorInput.value, borderEnabled: enableSloganBorderCheckbox.checked, borderColor: sloganBorderColorInput.value, fontFamily: document.getElementById('sloganFontFamily').value, borderWidth: parseInt(document.getElementById('sloganBorderWidth').value, 10) || 4, positionX: parseInt(document.getElementById('sloganPositionX').value, 10) || 540, positionY: parseInt(document.getElementById('sloganPositionY').value, 10) || 150 },
        slotBorder: { customColorEnabled: enableSlotBorderCheckbox.checked, color: slotColorInput.value },
        highlight: { enabled: highlightFirstLineCheckbox.checked, color: highlightColorInput.value, noBorder: document.getElementById('highlightNoBorder')?.checked || false, highlightHeightMultiplier: parseFloat(document.getElementById('highlightHeightMultiplier').value) || 1.4, style: document.getElementById('highlightStyleSelect').value },
        slotBackground: { enabled: enableSlotBackgroundCheckbox.checked, color: slotBackgroundColorInput.value, opacity: parseInt(slotBackgroundOpacityInput.value) || 100 },
        imageAreaScale: parseInt(document.getElementById('imageAreaScale').value, 10) || 100,
        fonts: {
            default: {
                productName: { family: productNameFontSelect.value, size: parseInt(productNameFontSizeInput.value) || 14 },
                descriptionOffsetY: parseInt(descriptionGlobalOffsetYInput.value) || 0,
                descriptionStartY: parseInt(document.getElementById('descriptionStartY').value, 10) || 15,
                descScaleX: parseInt(document.getElementById('descScaleX').value, 10) || 100,
                descScaleY: parseInt(document.getElementById('descScaleY').value, 10) || 100
            },
            contour: {
                descFont: descFontContour.value,
                descSize: parseInt(descFontSizeContour.value) || 14,
                descColor: descColorContour.value,
                descOffsetY: parseInt(descOffsetYContour.value) || 0,
                imageTextSpacing: parseInt(document.getElementById('contourImageTextSpacing').value, 10) || 5,
                priceFont: priceFontContour.value,
                firstLinePriceSize: parseInt(firstLinePriceFontSizeContour.value) || 45,
                otherLinesPriceSize: parseInt(otherLinesPriceFontSizeContour.value) || 35,
                priceColor: priceColorContour.value,
                priceBorderColor: priceBorderColorContour.value,
                priceBorderWidth: parseInt(priceBorderWidthContour.value) || 6
            },
            currencyHighlight: { chDescFont: chDescFontSelect.value, chDescFontSize: parseInt(chDescFontSizeInput.value) || 14 },
            yellowTag: { descFont: ytDescFontSelect.value, descSize: parseInt(ytDescFontSizeInput.value) || 17, descColor: ytDescColorInput.value }
        },
        balloonStyles: {
            default: {
                // ▼▼▼ SUBSTITUA ESTE OBJETO 'price' INTEIRO ▼▼▼
                price: {
                    family: priceFontSelect.value,
                    firstLineSize: parseInt(firstLinePriceFontSizeInput.value) || 40,
                    otherLinesSize: parseInt(otherLinesPriceFontSizeInput.value) || 30,
                    scaleX: parseInt(document.getElementById('priceScaleX').value, 10) || 100,
                    scaleY: parseInt(document.getElementById('priceScaleY').value, 10) || 100, // <-- A VÍRGULA FALTANTE FOI ADICIONADA AQUI
                    priceOffsetY: parseInt(document.getElementById('default_priceOffsetY').value, 10) || 0
                },
                // ▲▲▲ FIM DO BLOCO DE SUBSTITUIÇÃO ▲▲▲
                color: document.getElementById('default_balloon_color').value
            },
            currencyHighlight: { bgColor: chBgColorInput.value, priceColor: chPriceColorInput.value, circleColor: chCircleColorInput.value, currencyColor: chCurrencyColorInput.value, priceFont: chPriceFontSelect.value, firstLinePriceSize: parseInt(firstLineChPriceFontSizeInput.value) || 50, otherLinesPriceSize: parseInt(otherLinesChPriceFontSizeInput.value) || 40, borderRadius: parseInt(chBorderRadiusInput.value) || 20 },
            currencyHighlight2: { bgColor: document.getElementById('ch2BgColor').value, priceColor: document.getElementById('ch2PriceColor').value, circleColor: document.getElementById('ch2CircleColor').value, currencyColor: document.getElementById('ch2CurrencyColor').value, priceFont: document.getElementById('ch2PriceFont').value, firstLinePriceSize: parseInt(document.getElementById('firstLineCh2PriceFontSize').value) || 50, otherLinesPriceSize: parseInt(document.getElementById('otherLinesCh2PriceFontSize').value) || 40, borderRadius: parseInt(document.getElementById('ch2BorderRadius').value) || 20 },
            yellowTag: { tagBgColor: ytBgColorInput.value, priceColor: ytPriceColorInput.value, priceFont: ytPriceFontSelect.value, firstLinePriceSize: parseInt(firstLineYtPriceFontSizeInput.value) || 60, otherLinesPriceSize: parseInt(otherLinesYtPriceFontSizeInput.value) || 50, borderRadius: parseInt(ytBorderRadiusInput.value) || 15 },
            greenOnYellowTag: {
                priceFont: document.getElementById('goy_priceFont').value,
                priceFontSize: parseInt(document.getElementById('goy_priceFontSize').value, 10) || 70,
                priceOffsetX: parseInt(document.getElementById('goy_priceOffsetX').value, 10) || 0,
                priceOffsetY: parseInt(document.getElementById('goy_priceOffsetY').value, 10) || 0
            },
            redTagSeparateRS: {
                priceFont: document.getElementById('rt_priceFont').value,
                priceFontSize: parseInt(document.getElementById('rt_priceFontSize').value, 10) || 60,
                priceOffsetX: parseInt(document.getElementById('rt_priceOffsetX').value, 10) || 0,
                priceOffsetY: parseInt(document.getElementById('rt_priceOffsetY').value, 10) || 0
            },
             giganteTag: {
        height: parseInt(gtBalloonHeightInput.value, 10) || 100,
        offsetX: parseInt(gtOffsetXInput.value, 10) || 0,
        offsetY: parseInt(gtOffsetYInput.value, 10) || 0,
        priceFont: document.getElementById('gt_priceFont').value, // LINHA ADICIONADA
        priceOffsetX: parseInt(document.getElementById('gt_priceOffsetX').value, 10) || 0,
        priceOffsetY: parseInt(document.getElementById('gt_priceOffsetY').value, 10) || 0,
        descFont: document.getElementById('gt_descFont').value,
        descFontSize: parseInt(document.getElementById('gt_descFontSize').value, 10) || 30,
        descOffsetX: parseInt(document.getElementById('gt_descOffsetX').value, 10) || 0,
        descOffsetY: parseInt(document.getElementById('gt_descOffsetY').value, 10) || 0,
    },
            descLeftRedTag: {
                descFont: document.getElementById('dlrt_descFont').value,
                descFontSize: parseInt(document.getElementById('dlrt_descFontSize').value, 10) || 17,
                descColor: document.getElementById('dlrt_descColor').value,
                priceFont: document.getElementById('dlrt_priceFont').value,
                priceFontSize: parseInt(document.getElementById('dlrt_priceFontSize').value, 10) || 70,
                priceOffsetX: parseInt(document.getElementById('dlrt_priceOffsetX').value, 10) || 0,
                priceOffsetY: parseInt(document.getElementById('dlrt_priceOffsetY').value, 10) || 0
            },
			
			
			

			
			
			descLeftCustom: {
                selectedBalloonName: document.getElementById('dlc_balloon_select').value,
                balloonWidthPercent: parseInt(document.getElementById('dlc_balloonWidth').value, 10) || 85,
                balloonHeightPercent: parseInt(document.getElementById('dlc_balloonHeight').value, 10) || 85,
            },
			
			
			
            customBalloons: customBalloonsSettings,
        },
        balloons: {
            firstLine: firstLineBalloonStyleSelect.value, 
            otherLines: otherLinesBalloonStyleSelect.value,
            highlightedBalloonOffsetY: parseInt(highlightedBalloonOffsetYInput.value) || 0,
            globalOffsetY: parseInt(balloonGlobalOffsetYInput.value) || 0,
            balloonHeightPercent: parseInt(balloonHeightPercentInput.value) || 70
        },
        footer: {
            textEnabled: enableFooterTextCheckbox.checked, text: validityInput.value, fontFamily: footerFontSelect.value,
            footerSubtext: footerSubtextInput.value, subtextFontFamily: footerSubtextFontSelect.value,
            footerSubtextFontSize: parseInt(footerSubtextFontSizeInput.value) || 18, backgroundEnabled: enableFooterBackgroundCheckbox.checked,
            bgColor: footerBgColorInput.value, textColor: footerTextColorInput.value, fontSize: parseInt(footerFontSizeInput.value) || 28,
            textVerticalAlign: footerTextVerticalAlignSelect.value, borderRadius: parseInt(footerBorderRadiusInput.value) || 15,
            paddingY: parseInt(footerPaddingYInput.value) || 10, positionY: parseInt(footerPositionYInput.value) || 1325,
            textSpacing: parseInt(footerTextSpacingInput.value) || 10,
            autoPosition: document.getElementById('footerAutoPosition')?.checked ?? true
        },
        headerValidity: {
            enabled: document.getElementById('enableHeaderValidity').checked,
            startDate: document.getElementById('headerStartDate').value,
            endDate: document.getElementById('headerEndDate').value,
            titleText: document.getElementById('headerTitleText').value,
            stockText: document.getElementById('headerStockText').value,
            extraText2: document.getElementById('headerExtraText2').value,
            x: parseInt(document.getElementById('headerValidityX').value, 10) || 50,
            y: parseInt(document.getElementById('headerValidityY').value, 10) || 50,
            width: parseInt(document.getElementById('headerValidityWidth').value, 10) || 350,
            fontSizeLine1: parseInt(document.getElementById('headerFontSizeLine1').value, 10) || 25,
            fontSizeStartDate: parseInt(document.getElementById('headerFontSizeStartDate').value, 10) || 60,
            fontSizeDates: parseInt(document.getElementById('headerFontSizeDates').value, 10) || 50,
            fontSizeStock: parseInt(document.getElementById('headerFontSizeStock').value, 10) || 35,
            fontSizeExtra2: parseInt(document.getElementById('headerFontSizeExtra2').value, 10) || 25,
            extraTextAlign: document.getElementById('headerExtraTextAlign').value,
            lineSpacing: parseInt(document.getElementById('headerLineSpacing').value, 10) || 10,
			headerSeparatorSpacing: parseInt(document.getElementById('headerSeparatorSpacing').value, 10) || 10, // <-- ADICIONE ESTA LINHA
            extraSpacing: parseInt(document.getElementById('headerExtraSpacing').value, 10) || 5,
            dateToStockSpacing: parseInt(document.getElementById('headerDateToStockSpacing').value, 10) || 15,
            backgroundEnabled: document.getElementById('headerValidityEnableBg').checked,
            headerValidityScale: parseInt(document.getElementById('headerValidityScale').value, 10) || 100,
            bgColor: currentSettings.headerValidity.bgColor,
            textColor: currentSettings.headerValidity.textColor
        }
    };
}
		
		
		// COLE ESTE BLOCO INTEIRO NO LUGAR DO QUE VOCÊ APAGOU
// SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ABAIXO
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'applyPageSettingsToUI' PELA VERSÃO ABAIXO ▼▼▼
function applyPageSettingsToUI(page) {

    const settings = page.settings;
    pageSizeSelect.value = settings.pageSize;
    customWidthInput.value = settings.customWidth || 1080;
    customHeightInput.value = settings.customHeight || 1350;
    customSizeInputs.classList.toggle('hidden', settings.pageSize !== 'custom');
    predefinedLayoutSelect.value = settings.predefinedLayout;

    const isManualLayout = settings.predefinedLayout === 'manual';
    manualLayoutControls.classList.toggle('hidden', !isManualLayout);
    document.getElementById('predefined-border-style-container').classList.toggle('hidden', isManualLayout);
    document.getElementById('predefinedBorderStyle').value = settings.predefinedBorderStyle || 'straight';

    topMarginInput.value = settings.margins.top;
    lateralSpacingInput.value = settings.margins.lateral;
    footerSpacingInput.value = settings.margins.footer;
    promoLogoWidthInput.value = settings.logos.promo.width;
    storeLogoWidthInput.value = settings.logos.store.width;
    complementaryLogoWidthInput.value = settings.logos.complementary.width;
	// ▼▼▼ ADICIONE ESTE BLOCO DE CÓDIGO ▼▼▼
document.getElementById('promoLogoX').value = settings.logos.promo.x;
document.getElementById('promoLogoY').value = settings.logos.promo.y;
document.getElementById('storeLogoX').value = settings.logos.store.x;
document.getElementById('storeLogoY').value = settings.logos.store.y;
document.getElementById('complementaryLogoX').value = settings.logos.complementary.x;
document.getElementById('complementaryLogoY').value = settings.logos.complementary.y;
// ▲▲▲ FIM DO BLOCO ▲▲▲
	
	
    enableSloganCheckbox.checked = settings.slogan.enabled;
    sloganTextInput.value = settings.slogan.text;
    sloganFontSizeInput.value = settings.slogan.fontSize;
    sloganColorInput.value = settings.slogan.color;
    enableSloganBorderCheckbox.checked = settings.slogan.borderEnabled;
    sloganBorderColorInput.value = settings.slogan.borderColor;
	// ▼▼▼ ADICIONE ESTAS 2 LINHAS AQUI ▼▼▼
document.getElementById('sloganFontFamily').value = settings.slogan.fontFamily || 'Anton';
document.getElementById('sloganBorderWidth').value = settings.slogan.borderWidth || 4;

// ▼▼▼ ADICIONE ESTAS 2 LINHAS AQUI ▼▼▼
document.getElementById('sloganPositionX').value = settings.slogan.positionX || 540;
document.getElementById('sloganPositionY').value = settings.slogan.positionY || 150;
	
    enableSlotBorderCheckbox.checked = settings.slotBorder.customColorEnabled;
    slotColorInput.value = settings.slotBorder.color;

    const highlightSettings = settings.highlight || {};
    highlightFirstLineCheckbox.checked = highlightSettings.enabled;
    highlightColorInput.value = highlightSettings.color;
    document.getElementById('highlightNoBorder').checked = highlightSettings.noBorder || false;
    document.getElementById('highlightStyleSelect').value = highlightSettings.style || 'individual';

    const multiplierSlider = document.getElementById('highlightHeightMultiplier');
    const multiplierValueSpan = document.getElementById('highlightMultiplierValue');
    if (multiplierSlider) {
        multiplierSlider.value = highlightSettings.highlightHeightMultiplier || 1.4;
        if (multiplierValueSpan) {
            multiplierValueSpan.textContent = `${multiplierSlider.value}x`;
        }
    }

    enableSlotBackgroundCheckbox.checked = settings.slotBackground.enabled;
    slotBackgroundColorInput.value = settings.slotBackground.color;
    slotBackgroundOpacityInput.value = settings.slotBackground.opacity;
    document.getElementById('imageAreaScale').value = settings.imageAreaScale || 100;

    const defaultFonts = settings.fonts.default;
    productNameFontSelect.value = defaultFonts.productName.family;
    productNameFontSizeInput.value = defaultFonts.productName.size;
    descriptionGlobalOffsetYInput.value = defaultFonts.descriptionOffsetY || 0;
	document.getElementById('descriptionStartY').value = defaultFonts.descriptionStartY || 15;
	document.getElementById('descScaleX').value = defaultFonts.descScaleX || 100;
    document.getElementById('descScaleY').value = defaultFonts.descScaleY || 100;
	
    const contourFonts = settings.fonts.contour;
    descFontContour.value = contourFonts.descFont;
    descFontSizeContour.value = contourFonts.descSize;
    descColorContour.value = contourFonts.descColor;
    descOffsetYContour.value = contourFonts.descOffsetY;
    priceFontContour.value = contourFonts.priceFont;
    firstLinePriceFontSizeContour.value = contourFonts.firstLinePriceSize;
    otherLinesPriceFontSizeContour.value = contourFonts.otherLinesPriceSize;
    priceColorContour.value = contourFonts.priceColor;
    priceBorderColorContour.value = contourFonts.priceBorderColor;
    priceBorderWidthContour.value = contourFonts.priceBorderWidth;
	document.getElementById('contourImageTextSpacing').value = contourFonts.imageTextSpacing ?? 5;

    const chDescSettings = settings.fonts.currencyHighlight;
    chDescFontSelect.value = chDescSettings.chDescFont;
    chDescFontSizeInput.value = chDescSettings.chDescFontSize;

    const ytDescSettings = settings.fonts.yellowTag;
    if (ytDescSettings) {
        ytDescFontSelect.value = ytDescSettings.descFont;
        ytDescFontSizeInput.value = ytDescSettings.descSize;
        ytDescColorInput.value = ytDescSettings.descColor;
    }

    const defaultBalloons = settings.balloonStyles.default;
    priceFontSelect.value = defaultBalloons.price.family;
    firstLinePriceFontSizeInput.value = defaultBalloons.price.firstLineSize;
    otherLinesPriceFontSizeInput.value = defaultBalloons.price.otherLinesSize;
	document.getElementById('priceScaleX').value = defaultBalloons.price.scaleX || 100;
    document.getElementById('priceScaleY').value = defaultBalloons.price.scaleY || 100;
	document.getElementById('default_priceOffsetY').value = defaultBalloons.price.priceOffsetY ?? 4; // <-- ADICIONE ESTA LINHA

    balloonHeightPercentInput.value = settings.balloons.balloonHeightPercent || 100;
	document.getElementById('default_balloon_color').value = settings.balloonStyles.default.color || '#e63946';

    const chBalloons = settings.balloonStyles.currencyHighlight;
    chBgColorInput.value = chBalloons.bgColor;
    chPriceColorInput.value = chBalloons.priceColor;
    chCircleColorInput.value = chBalloons.circleColor;
    chCurrencyColorInput.value = chBalloons.currencyColor;
    chPriceFontSelect.value = chBalloons.priceFont;
    firstLineChPriceFontSizeInput.value = chBalloons.firstLinePriceSize;
    otherLinesChPriceFontSizeInput.value = chBalloons.otherLinesPriceSize;
    chBorderRadiusInput.value = chBalloons.borderRadius;

    const ch2Balloons = settings.balloonStyles.currencyHighlight2 || {};
    document.getElementById('ch2BgColor').value = ch2Balloons.bgColor || '#5E548E';
    document.getElementById('ch2PriceColor').value = ch2Balloons.priceColor || '#FFFFFF';
    document.getElementById('ch2CircleColor').value = ch2Balloons.circleColor || '#FFFFFF';
    document.getElementById('ch2CurrencyColor').value = ch2Balloons.currencyColor || '#231942';
    document.getElementById('ch2PriceFont').value = ch2Balloons.priceFont || 'Anton';
    document.getElementById('firstLineCh2PriceFontSize').value = ch2Balloons.firstLinePriceSize || 50;
    document.getElementById('otherLinesCh2PriceFontSize').value = ch2Balloons.otherLinesPriceSize || 40;
    document.getElementById('ch2BorderRadius').value = ch2Balloons.borderRadius || 20;

    const ytBalloons = settings.balloonStyles.yellowTag;
    if (ytBalloons) {
        ytBgColorInput.value = ytBalloons.tagBgColor;
        ytPriceColorInput.value = ytBalloons.priceColor;
        ytPriceFontSelect.value = ytBalloons.priceFont;
        firstLineYtPriceFontSizeInput.value = ytBalloons.firstLinePriceSize;
        otherLinesYtPriceFontSizeInput.value = ytBalloons.otherLinesPriceSize;
        ytBorderRadiusInput.value = ytBalloons.borderRadius;
    }

    const rtBalloons = settings.balloonStyles.redTagSeparateRS;
    if (rtBalloons) {
        document.getElementById('rt_priceFont').value = rtBalloons.priceFont || 'Anton';
        document.getElementById('rt_priceFontSize').value = rtBalloons.priceFontSize || 60;
        document.getElementById('rt_priceOffsetX').value = rtBalloons.priceOffsetX || 0;
        document.getElementById('rt_priceOffsetY').value = rtBalloons.priceOffsetY || 0;
    }

    const goyBalloons = settings.balloonStyles.greenOnYellowTag;
    if (goyBalloons) {
        document.getElementById('goy_priceFont').value = goyBalloons.priceFont || 'Anton';
        document.getElementById('goy_priceFontSize').value = goyBalloons.priceFontSize || 70;
        document.getElementById('goy_priceOffsetX').value = goyBalloons.priceOffsetX || 0;
        document.getElementById('goy_priceOffsetY').value = goyBalloons.priceOffsetY || 0;
    }
    
    // --- INÍCIO DO BLOCO CORRIGIDO E ATUALIZADO ---
    const customBalloonsSettings = settings.balloonStyles.customBalloons; // LINHA CORRIGIDA (era customImage)
    if (customBalloonsSettings) {
        // As configurações de um balão específico são aplicadas se ele estiver ativo
        let activeCustomBalloonName = null;
        const firstStyle = settings.balloons.firstLine;
        const otherStyle = settings.balloons.otherLines;

        if (firstStyle && firstStyle.startsWith('custom_')) {
            activeCustomBalloonName = firstStyle.replace('custom_', '');
        } else if (otherStyle && otherStyle.startsWith('custom_')) {
            activeCustomBalloonName = otherStyle.replace('custom_', '');
        }

        if (activeCustomBalloonName && customBalloonsSettings[activeCustomBalloonName]) {
            const activeSettings = customBalloonsSettings[activeCustomBalloonName];
            document.getElementById('customBalloonPriceColor').value = activeSettings.priceColor || '#FFFFFF';
            document.getElementById('customBalloonPriceFontSize').value = activeSettings.priceFontSize || 80;
            document.getElementById('customBalloonPriceOffsetX').value = activeSettings.priceOffsetX || 50;
            document.getElementById('customBalloonPriceOffsetY').value = activeSettings.priceOffsetY || 50;
            document.getElementById('customBalloonWidth').value = activeSettings.balloonWidth || 85;
            document.getElementById('customBalloonHeight').value = activeSettings.balloonHeight || 85; // LINHA NOVA
            document.getElementById('customBalloonPriceFont').value = activeSettings.priceFont || 'Anton'; // LINHA NOVA
        }
    }
    // --- FIM DO BLOCO CORRIGIDO E ATUALIZADO ---

    const gtBalloons = settings.balloonStyles.giganteTag;
    if (gtBalloons) {
        gtBalloonHeightInput.value = gtBalloons.height || 100;
        gtOffsetXInput.value = gtBalloons.offsetX || 0;
        gtOffsetYInput.value = gtBalloons.offsetY || 0;
        document.getElementById('gt_priceFont').value = gtBalloons.priceFont || 'Anton'; // LINHA ADICIONADA
        document.getElementById('gt_priceOffsetX').value = gtBalloons.priceOffsetX || 0;
        document.getElementById('gt_priceOffsetY').value = gtBalloons.priceOffsetY || 0;
        document.getElementById('gt_descFont').value = gtBalloons.descFont || 'Oswald';
        document.getElementById('gt_descFontSize').value = gtBalloons.descFontSize || 30;
        document.getElementById('gt_descOffsetX').value = gtBalloons.descOffsetX || 0;
        document.getElementById('gt_descOffsetY').value = gtBalloons.descOffsetY || 0;
    }

// ▼▼▼ ADICIONE ESTE BLOCO DE CÓDIGO NOVO ▼▼▼
    const dlcBalloons = settings.balloonStyles.descLeftCustom;
    if (dlcBalloons) {
        // Popula o dropdown primeiro
        populateCustomBalloonSelector();
        // LINHA CORRIGIDA
document.getElementById('dlc_balloon_select').value = dlcBalloons.selectedBalloonName || '';
        document.getElementById('dlc_balloonWidth').value = dlcBalloons.balloonWidthPercent || 85;
        document.getElementById('dlc_balloonHeight').value = dlcBalloons.balloonHeightPercent || 85;
    }
    // ▲▲▲ FIM DO BLOCO NOVO ▲▲▲


    firstLineBalloonStyleSelect.value = settings.balloons.firstLine;
    otherLinesBalloonStyleSelect.value = settings.balloons.otherLines;
    highlightedBalloonOffsetYInput.value = settings.balloons.highlightedBalloonOffsetY || 0;
    balloonGlobalOffsetYInput.value = settings.balloons.globalOffsetY || 0;

    const footerSettings = settings.footer;
    enableFooterTextCheckbox.checked = footerSettings.textEnabled;
    validityInput.value = footerSettings.text;
    footerFontSelect.value = footerSettings.fontFamily;
    footerSubtextInput.value = footerSettings.footerSubtext;
    footerSubtextFontSelect.value = footerSettings.subtextFontFamily;
    footerTextSpacingInput.value = footerSettings.textSpacing;
    enableFooterBackgroundCheckbox.checked = footerSettings.backgroundEnabled;
    footerBgColorInput.value = footerSettings.bgColor;
    footerTextColorInput.value = footerSettings.textColor;
    footerFontSizeInput.value = footerSettings.fontSize;
    footerSubtextFontSizeInput.value = footerSettings.footerSubtextFontSize;
    footerTextVerticalAlignSelect.value = footerSettings.textVerticalAlign;
    footerBorderRadiusInput.value = footerSettings.borderRadius;
    footerPaddingYInput.value = footerSettings.paddingY;
    footerPositionYInput.value = footerSettings.positionY;
    const autoPosCheckbox = document.getElementById('footerAutoPosition');
    if (autoPosCheckbox) autoPosCheckbox.checked = footerSettings.autoPosition ?? true;

    sloganOptionsDiv.classList.toggle('hidden', !settings.slogan.enabled);
    sloganBorderColorContainer.classList.toggle('hidden', !settings.slogan.borderEnabled);
    slotColorContainer.classList.toggle('hidden', !settings.slotBorder.customColorEnabled);
    highlightColorContainer.classList.toggle('hidden', !settings.highlight.enabled);
    document.getElementById('highlight-no-border-container').classList.toggle('hidden', !settings.highlight.enabled);
    highlightedBalloonControls.classList.toggle('hidden', !settings.highlight.enabled);
    footerTextOptionsDiv.classList.toggle('hidden', !settings.footer.textEnabled);
    footerOptionsDiv.classList.toggle('hidden', !settings.footer.backgroundEnabled);
    slotBackgroundOptionsDiv.classList.toggle('hidden', !settings.slotBackground.enabled);

    lineLayoutContainer.innerHTML = '';
    page.manualLayout.forEach(line => addNewLine(line));
    updateStyleControlsVisibility();

    const hvSettings = settings.headerValidity || {};
    const enableHeaderCheckbox = document.getElementById('enableHeaderValidity');
    const headerOptionsDiv = document.getElementById('header-validity-options');

    if (enableHeaderCheckbox) {
        enableHeaderCheckbox.checked = hvSettings.enabled || false;
        headerOptionsDiv.classList.toggle('hidden', !enableHeaderCheckbox.checked);
        document.getElementById('headerStartDate').value = hvSettings.startDate || '';
        document.getElementById('headerEndDate').value = hvSettings.endDate || '';
        document.getElementById('headerStockText').value = hvSettings.stockText || 'OU ENQUANTO DURAREM OS ESTOQUES.';
		document.getElementById('headerExtraText2').value = hvSettings.extraText2 || '';
        document.getElementById('headerValidityX').value = hvSettings.x || 50;
        document.getElementById('headerValidityY').value = hvSettings.y || 50;
        document.getElementById('headerValidityWidth').value = hvSettings.width || 350;
        document.getElementById('headerFontSizeLine1').value = hvSettings.fontSizeLine1 || 25;
		document.getElementById('headerFontSizeStartDate').value = hvSettings.fontSizeStartDate || 60;
        document.getElementById('headerFontSizeDates').value = hvSettings.fontSizeDates || 50;
        document.getElementById('headerFontSizeStock').value = hvSettings.fontSizeStock || 35;
		document.getElementById('headerFontSizeExtra2').value = hvSettings.fontSizeExtra2 || 25;
        document.getElementById('headerExtraTextAlign').value = hvSettings.extraTextAlign || 'center';
        document.getElementById('headerLineSpacing').value = hvSettings.lineSpacing || 10;
		document.getElementById('headerSeparatorSpacing').value = hvSettings.headerSeparatorSpacing ?? 10; // <-- ADICIONE ESTA LINHA
		document.getElementById('headerExtraSpacing').value = hvSettings.extraSpacing || 5;
        document.getElementById('headerDateToStockSpacing').value = hvSettings.dateToStockSpacing ?? 15;
        document.getElementById('headerValidityEnableBg').checked = hvSettings.backgroundEnabled !== undefined ? hvSettings.backgroundEnabled : true;
    }
}
		
        
// FIM DO BLOCO PARA COPIAR
		
        function saveCurrentPageSettings() { if (flyerData.pages.length) { const e = flyerData.pages[flyerData.currentPageIndex]; e.settings = getPageSettingsFromUI(); e.manualLayout = getLayoutFromInputs() } }
        function updatePageUI() { pageListContainer.innerHTML = ''; flyerData.pages.forEach((e, t) => { const o = document.createElement('button'); o.textContent = `Página ${t + 1}`; o.dataset.index = t; const n = 'w-full text-left p-2 rounded-md', a = 'bg-blue-600 text-white', l = 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'; o.className = `${n} ${t === flyerData.currentPageIndex ? a : l}`; o.addEventListener('click', () => switchPage(t)); pageListContainer.appendChild(o) }); useFirstPageBgContainer.classList.toggle('hidden', !(flyerData.pages.length > 0 && flyerData.pages[0].backgroundImage)) }
        
		function switchPage(e, t = !0) {
    if (!(e < 0 || e >= flyerData.pages.length)) {
        t && saveCurrentPageSettings();
        flyerData.currentPageIndex = e;
        const o = flyerData.pages[e];
        applyPageSettingsToUI(o);
        setCanvasSize();
        updatePageUI();
        updateProductListUI();
        updateNavButtonStates(); // <-- ADICIONE ESTA LINHA
    }
}
		
		
		
		
        
		addPageBtn.addEventListener('click', () => {
    saveCurrentPageSettings();
    const e = createDefaultPage();
    useFirstPageBgCheckbox.checked && flyerData.pages.length > 0 && flyerData.pages[0].backgroundImage && (e.backgroundImage = flyerData.pages[0].backgroundImage, e.backgroundImageSrc = flyerData.pages[0].backgroundImageSrc);
    flyerData.pages.push(e);
    switchPage(flyerData.pages.length - 1, !1);
    updateNavButtonStates(); // <-- ADICIONE ESTA LINHA
});
		
        deletePageBtn.addEventListener('click', () => {
    flyerData.pages.length <= 1 ? showAlert("Não é possível deletar a última página.") : showConfirm("Tem certeza que deseja deletar esta página?", e => {
        if (e) {
            flyerData.pages.splice(flyerData.currentPageIndex, 1);
            const t = Math.max(0, flyerData.currentPageIndex - 1);
            switchPage(t, !1);
            updateNavButtonStates(); // <-- ADICIONE ESTA LINHA
        }
    })
});
		
		
        // ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA PELA VERSÃO ABAIXO ▼▼▼
async function loadCustomFontsFromStorage() {
    try {
        const { data: fonts, error } = await supabaseClient
            .from('custom_fonts')
            .select('name, font_url');

        if (error) throw error;

        for (const font of fonts) {
            // Cria a regra @font-face para que o navegador carregue a fonte da nuvem
            const style = document.createElement('style');
            style.textContent = `@font-face { font-family: '${font.name}'; src: url('${font.font_url}'); }`;
            document.head.appendChild(style);
        }
        
        // Atualiza a lista de fontes no painel de gerenciamento
        updateCustomFontUI(fonts);

    } catch (e) {
        console.error("Erro ao carregar fontes da nuvem:", e);
        showAlert("Não foi possível carregar as fontes customizadas da nuvem.");
    }
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
        // ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA PELA VERSÃO ABAIXO ▼▼▼
function updateCustomFontUI(fonts = []) {
    customFontList.innerHTML = '';
    document.querySelectorAll('optgroup[id^="custom-fonts-"]').forEach(group => group.innerHTML = '');

    for (const font of fonts) {
        const name = font.name;
        const listItem = document.createElement('div');
        listItem.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded';
        listItem.textContent = name;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '&times;';
        deleteBtn.className = 'text-red-500 hover:text-red-700 font-bold text-xl';
        deleteBtn.onclick = () => { deleteCustomFont(name); };
        
        listItem.appendChild(deleteBtn);
        customFontList.appendChild(listItem);
        
        document.querySelectorAll('optgroup[id^="custom-fonts-"]').forEach(group => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            group.appendChild(option);
        });
    }
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
		
        // ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA PELA VERSÃO ABAIXO ▼▼▼
async function deleteCustomFont(name) {
    showConfirm(`Tem certeza que deseja deletar a fonte "${name}" da nuvem?`, async (confirmed) => {
        if (!confirmed) return;

        showSpinner(true);
        try {
            // 1. Pega o caminho do arquivo no banco de dados
            const { data: fontData, error: selectError } = await supabaseClient
                .from('custom_fonts')
                .select('file_path')
                .eq('name', name)
                .single();

            if (selectError) throw selectError;

            // 2. Deleta o arquivo do Storage
            if (fontData && fontData.file_path) {
                const { error: storageError } = await supabaseClient.storage
                    .from('custom-fonts')
                    .remove([fontData.file_path]);
                if (storageError) console.warn("Aviso: falha ao remover arquivo do storage, mas o registro do DB será removido.", storageError);
            }

            // 3. Deleta o registro da tabela 'custom_fonts'
            const { error: dbError } = await supabaseClient
                .from('custom_fonts')
                .delete()
                .eq('name', name);
            
            if (dbError) throw dbError;
            
            showAlert(`Fonte "${name}" deletada com sucesso!`);
            location.reload(); // Recarrega a página para remover a fonte do cache do navegador

        } catch (e) {
            console.error("Erro ao deletar fonte:", e);
            showAlert(`Falha ao deletar a fonte: ${e.message}`);
        } finally {
            showSpinner(false);
        }
    });
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
        
		// ▼▼▼ SUBSTITUA O BLOCO ANTIGO PELO CÓDIGO ABAIXO ▼▼▼
addCustomFontBtn.addEventListener('click', async () => {
    const file = customFontInput.files[0];
    const name = customFontNameInput.value.trim();

    if (!file || !name) {
        showAlert('Por favor, selecione um arquivo de fonte e dê um nome a ela.');
        return;
    }

    showSpinner(true);
    showAlert("Enviando fonte para a nuvem...");

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error("Usuário não autenticado.");

        // 1. Envia o arquivo da fonte para o Storage
        const fileExtension = file.name.split('.').pop();
        const filePath = `${user.id}/${name}.${fileExtension}`;
        
        const { error: uploadError } = await supabaseClient.storage
            .from('custom-fonts')
            .upload(filePath, file, { upsert: true }); // upsert: true substitui se já existir

        if (uploadError) throw uploadError;

        // 2. Pega a URL pública do arquivo que acabamos de enviar
        const { data: publicUrlData } = supabaseClient.storage
            .from('custom-fonts')
            .getPublicUrl(filePath);

        // 3. Salva as informações da fonte na tabela do Database
        const { error: dbError } = await supabaseClient
            .from('custom_fonts')
            .upsert({
                name: name,
                font_url: publicUrlData.publicUrl,
                file_path: filePath,
                            }, { onConflict: 'name' });

        if (dbError) throw dbError;
        
        // 4. Recarrega a lista de fontes da nuvem
        await loadCustomFontsFromStorage();
        customFontInput.value = '';
        customFontNameInput.value = '';
        showAlert(`Fonte "${name}" salva na nuvem com sucesso!`);

    } catch (err) {
        console.error("Erro ao salvar fonte na nuvem:", err);
        showAlert(`Falha ao salvar a fonte: ${err.message}`);
    } finally {
        showSpinner(false);
    }
});
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
		
		
		// --- LÓGICA PARA ADICIONAR FONTES VIA PASTA ---
const addFontsFromFolderBtn = document.getElementById('addFontsFromFolderBtn');
const fontFolderInput = document.getElementById('fontFolderInput');

addFontsFromFolderBtn.addEventListener('click', () => {
    fontFolderInput.click();
});

// ▼▼▼ COLE ESTE NOVO BLOCO NO LUGAR DO ANTIGO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO DE ADICIONAR FONTES POR PASTA POR ESTE CÓDIGO DE TESTE ▼▼▼
// ▼▼▼ SUBSTITUA O CÓDIGO DE TESTE POR ESTE BLOCO FUNCIONAL ▼▼▼
// ▼▼▼ SUBSTITUA O BLOCO ANTIGO POR ESTE CÓDIGO CORRIGIDO ▼▼▼
fontFolderInput.addEventListener('change', async (event) => {
    const files = event.target.files;
    if (!files || files.length === 0) {
        return;
    }

    showSpinner(true);
    showAlert(`Iniciando upload de ${files.length} fontes para a nuvem. Aguarde...`);

    // Filtra apenas os arquivos de fonte válidos
    const fontFiles = Array.from(files).filter(file => {
        const extension = file.name.split('.').pop().toLowerCase();
        return ['ttf', 'otf', 'woff', 'woff2'].includes(extension);
    });

    if (fontFiles.length === 0) {
        showSpinner(false);
        showAlert('Nenhum arquivo de fonte válido (.ttf, .otf, .woff, .woff2) foi encontrado na pasta.');
        return;
    }

    let successCount = 0;
    let errorCount = 0;

    try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error("Usuário não autenticado. Por favor, recarregue a página.");

        // Cria uma promessa de upload para cada arquivo de fonte
        const uploadPromises = fontFiles.map(async (file) => {
            const fontName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
            const fileExtension = file.name.split('.').pop();
            const filePath = `${user.id}/${fontName}.${fileExtension}`;

            // 1. Envia o arquivo para o Supabase Storage
            const { error: uploadError } = await supabaseClient.storage
                .from('custom-fonts')
                .upload(filePath, file, { upsert: true });

            if (uploadError) throw uploadError;

            // 2. Obtém a URL pública do arquivo
            const { data: publicUrlData } = supabaseClient.storage
                .from('custom-fonts')
                .getPublicUrl(filePath);

            // 3. Salva as informações no banco de dados Supabase
            const { error: dbError } = await supabaseClient
                .from('custom_fonts')
                .upsert({
                    name: fontName,
                    font_url: publicUrlData.publicUrl,
                    file_path: filePath,
                    user_id: user.id
                }, { onConflict: 'name' });

            if (dbError) throw dbError;
        });

        // Aguarda todas as promessas de upload serem concluídas
        const results = await Promise.allSettled(uploadPromises);

        results.forEach(result => {
            if (result.status === 'fulfilled') {
                successCount++;
            } else {
                errorCount++;
                console.error("Falha no upload de uma fonte:", result.reason);
            }
        });

        // Após todos os uploads, recarrega a lista de fontes a partir da nuvem
        await loadCustomFontsFromStorage();

        // Monta uma mensagem de resumo para o usuário
        let summary = `${successCount} fontes foram salvas na nuvem com sucesso!`;
        if (errorCount > 0) {
            summary += `\n${errorCount} fontes falharam ao enviar. Verifique o console para mais detalhes.`;
        }
        showAlert(summary);

    } catch (err) {
        showAlert(`Ocorreu um erro geral durante o processo: ${err.message}`);
        console.error(err);
    } finally {
        fontFolderInput.value = ''; // Limpa o seletor de arquivo
        showSpinner(false);
    }
});
// ▲▲▲ FIM DO BLOCO DE SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DO BLOCO ▲▲▲
// ▲▲▲ FIM DO CÓDIGO DE TESTE ▲▲▲
// ▲▲▲ FIM DO NOVO BLOCO ▲▲▲
		
		
		
        useFirstPageBgCheckbox.addEventListener('change', () => { if (flyerData.pages.length > 1 && flyerData.pages[0].backgroundImage) { const firstPageBg = flyerData.pages[0].backgroundImage; const firstPageBgSrc = flyerData.pages[0].backgroundImageSrc; for (let i = 1; i < flyerData.pages.length; i++) { if (useFirstPageBgCheckbox.checked) { flyerData.pages[i].backgroundImage = firstPageBg; flyerData.pages[i].backgroundImageSrc = firstPageBgSrc; } else { if (flyerData.pages[i].backgroundImageSrc === firstPageBgSrc) { flyerData.pages[i].backgroundImage = null; flyerData.pages[i].backgroundImageSrc = null; } } } redrawCanvas(); } });
        
        
		
		
        
		// --- LÓGICA PARA GERAR PDF ---

// Pega os novos botões que criamos no HTML
const downloadPdfBtn = document.getElementById('downloadPdfBtn');
const downloadPdfAllBtn = document.getElementById('downloadPdfAllBtn');

// Função para gerar PDF de uma única página
function generateSinglePagePDF() {
    console.log("Gerando PDF da página atual...");
    const { jsPDF } = window.jspdf; // Pega a biblioteca jsPDF que adicionamos

    const width = canvas.width;
    const height = canvas.height;
    const orientation = width > height ? 'l' : 'p'; // 'l' para paisagem, 'p' para retrato

    // Cria um novo documento PDF com o mesmo tamanho do canvas
    const pdf = new jsPDF({
        orientation: orientation,
        unit: 'px',
        format: [width, height]
    });

    // Converte o canvas para uma imagem
    const imgData = canvas.toDataURL('image/png');

    // Adiciona a imagem ao PDF
    pdf.addImage(imgData, 'PNG', 0, 0, width, height);

    // Salva o arquivo
    pdf.save(`encarte-pagina-${flyerData.currentPageIndex + 1}.pdf`);
}

// Função para gerar PDF de TODAS as páginas
async function generateMultiPagePDF() {
    console.log("Gerando PDF de todas as páginas...");
    showSpinner(true); // Mostra o ícone de carregamento

    const { jsPDF } = window.jspdf;
    const originalPageIndex = flyerData.currentPageIndex; // Salva a página atual para voltar depois

    let pdf; // Declara a variável do PDF aqui

    for (let i = 0; i < flyerData.pages.length; i++) {
        console.log(`Processando página ${i + 1}...`);
        // Muda para a página que queremos renderizar
        switchPage(i, true); 

        // Dá um pequeno tempo para o canvas redesenhar completamente, especialmente as imagens
        await new Promise(resolve => setTimeout(resolve, 500));

        const width = canvas.width;
        const height = canvas.height;
        const orientation = width > height ? 'l' : 'p';
        const imgData = canvas.toDataURL('image/png');

        if (i === 0) {
            // Na primeira página, cria o documento PDF
            pdf = new jsPDF({
                orientation: orientation,
                unit: 'px',
                format: [width, height]
            });
        } else {
            // Para as páginas seguintes, adiciona uma nova folha no PDF
            pdf.addPage([width, height], orientation);
        }

        // Adiciona a imagem da página atual ao PDF
        pdf.addImage(imgData, 'PNG', 0, 0, width, height);
    }

    // Salva o arquivo PDF com todas as páginas
    pdf.save('encarte-completo.pdf');

    // Volta para a página original que o usuário estava vendo
    switchPage(originalPageIndex, false);
    showSpinner(false); // Esconde o ícone de carregamento
    showAlert('PDF com todas as páginas gerado com sucesso!');
}

// Adiciona os eventos de clique aos botões
downloadPdfBtn.addEventListener('click', generateSinglePagePDF);
downloadPdfAllBtn.addEventListener('click', generateMultiPagePDF);


// Adiciona a funcionalidade de volta para o botão de download PNG
downloadBtn.addEventListener('click', () => {
    const link = document.createElement('a');
    link.download = `encarte-pagina-${flyerData.currentPageIndex + 1}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
});
		
		
		// Adiciona a funcionalidade de clique para o novo botão de limpar lista
clearProductListBtn.addEventListener('click', () => {
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (!currentPage || currentPage.products.length === 0) {
        showAlert("A lista de produtos já está vazia.");
        return;
    }

    // Pede confirmação antes de apagar tudo, para segurança
    showConfirm("Tem certeza que deseja remover TODOS os produtos do encarte? Esta ação não pode ser desfeita.", (confirmed) => {
        if (confirmed) {
            // Limpa a lista de produtos da página atual
            currentPage.products = [];

            // Atualiza a interface do painel para mostrar que a lista está vazia
            updateProductListUI();

            // Redesenha o canvas para mostrar os slots vazios
            redrawCanvas();

            showAlert("Todos os produtos foram removidos.");
        }
    });
});
		
		
		// --- LÓGICA DE EXPORTAÇÃO E IMPORTAÇÃO DE TEMPLATES ---

        // Pega os novos elementos que criamos no HTML
        const exportTemplatesBtn = document.getElementById('exportTemplatesBtn');
        const importTemplatesBtn = document.getElementById('importTemplatesBtn');
        const importTemplateInput = document.getElementById('importTemplateInput');

        // Função para EXPORTAR
        exportTemplatesBtn.addEventListener('click', () => {
            // Pega os templates do armazenamento local do navegador
            const templatesJSON = localStorage.getItem('flyerTemplates');
            
            if (!templatesJSON || templatesJSON === '{}') {
                showAlert('Não há templates salvos para exportar.');
                return;
            }

            // Cria um arquivo virtual (Blob) com os dados dos templates
            const blob = new Blob([templatesJSON], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Cria um link temporário para fazer o download
            const a = document.createElement('a');
            a.href = url;
            a.download = 'meus_templates_encartes.json'; // Nome do arquivo
            document.body.appendChild(a);
            a.click(); // Simula o clique no link para baixar o arquivo
            
            // Limpa os elementos temporários
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // O botão "Importar" vai, na verdade, clicar no campo de arquivo oculto
        importTemplatesBtn.addEventListener('click', () => {
            importTemplateInput.click();
        });

        // Função para IMPORTAR (quando um arquivo é selecionado)
        importTemplateInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                return; // Nenhum arquivo selecionado
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    // Lê o conteúdo do arquivo como texto e converte de volta para objeto
                    const importedTemplates = JSON.parse(e.target.result);

                    // Validação simples para ver se é um objeto válido
                    if (typeof importedTemplates !== 'object' || importedTemplates === null) {
                        throw new Error('O arquivo não parece ser um template válido.');
                    }
                    
                    // Pega os templates que já existem no computador atual
                    const existingTemplates = JSON.parse(localStorage.getItem('flyerTemplates') || '{}');
                    
                    // Junta os templates existentes com os importados.
                    // Se houver um com o mesmo nome, o importado irá substituir o antigo.
                    const mergedTemplates = { ...existingTemplates, ...importedTemplates };
                    
                    // Salva a lista combinada no armazenamento local
                    localStorage.setItem('flyerTemplates', JSON.stringify(mergedTemplates));
                    
                    // Atualiza a lista de templates na tela
                    populateTemplatePreviews();
                    showAlert('Templates importados com sucesso!');

                } catch (error) {
                    showAlert('Erro ao importar. Verifique se o arquivo está no formato correto.');
                    console.error('Falha na importação do template:', error);
                }
            };
            
            // Lê o arquivo
            reader.readAsText(file);
            // Limpa o valor do input para permitir importar o mesmo arquivo novamente
            event.target.value = '';
        });
		
		
		// ▼▼▼ ADICIONE TODO ESTE BLOCO DE CÓDIGO NO FINAL DO SEU SCRIPT ▼▼▼

// --- LÓGICA PARA ADAPTAÇÃO DE ENCARTE ---

// Mostra o modal de opções quando o botão principal é clicado
adaptForSocialMediaBtn.addEventListener('click', () => {
    if (flyerData.pages.flatMap(p => p.products).length === 0) {
        showAlert("Seu encarte não tem produtos para adaptar.");
        return;
    }
    adaptModal.classList.add('visible');
});

// Esconde o modal se o usuário cancelar
cancelAdaptationBtn.addEventListener('click', () => {
    adaptModal.classList.remove('visible');
});

// Executa a função principal de adaptação
runAdaptationBtn.addEventListener('click', () => {
    const targetFormat = document.getElementById('targetFormatSelect').value;
    const productsPerPage = parseInt(document.getElementById('productsPerPageSelect').value, 10);
    
    adaptFlyerForSocialMedia(targetFormat, productsPerPage);
    
    adaptModal.classList.remove('visible');
});


const applyFontsToAllOthersBtn = document.getElementById('applyFontsToAllOthersBtn');
if (applyFontsToAllOthersBtn) {
    applyFontsToAllOthersBtn.addEventListener('click', applyCurrentFontsToAllOthers);
}


// ▼▼▼ ADICIONE ESTE NOVO BLOCO ABAIXO ▼▼▼
const applyPosterLayoutToAllBtn = document.getElementById('applyPosterLayoutToAllBtn');
if (applyPosterLayoutToAllBtn) {
    applyPosterLayoutToAllBtn.addEventListener('click', applyCurrentPosterLayoutToOthers);
}
// ▲▲▲ FIM DO NOVO BLOCO ▲▲▲


// ▼▼▼ SUBSTITUA A FUNÇÃO 'adaptFlyerForSocialMedia' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

/**
 * Função principal que reorganiza o encarte, respeitando as páginas originais.
 * @param {string} targetFormat - O novo tamanho da página (ex: '1080x1350').
 * @param {number} productsPerPage - Quantos produtos caberão em cada nova página.
 */
// ▼▼▼ SUBSTITUA A FUNÇÃO 'adaptFlyerForSocialMedia' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO 'adaptFlyerForSocialMedia' INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'adaptFlyerForSocialMedia' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'adaptFlyerForSocialMedia' PELA VERSÃO ABAIXO ▼▼▼

function adaptFlyerForSocialMedia(targetFormat, productsPerPage) {
    showSpinner(true);

    const originalPages = [...flyerData.pages];
    if (originalPages.length === 0 || originalPages.flatMap(p => p.products).length === 0) {
        showAlert("Seu encarte não tem produtos para adaptar.");
        showSpinner(false);
        return;
    }

    const baseSettings = JSON.parse(JSON.stringify(originalPages[0].settings));
    const originalLogos = JSON.parse(JSON.stringify(flyerData.logos));

    let newSocialMediaPages = [];

    for (const originalPage of originalPages) {
        const productsOnThisPage = originalPage.products;
        if (productsOnThisPage.length === 0) continue;

        const newPageCountForThisSection = Math.ceil(productsOnThisPage.length / productsPerPage);

        for (let i = 0; i < newPageCountForThisSection; i++) {
            let newPage = createDefaultPage();

            const startIndex = i * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            
            newPage.products = productsOnThisPage.slice(startIndex, endIndex).map(p => ({ ...p }));

            // ===== AQUI ESTÁ A LINHA CORRIGIDA =====
            newPage.settings = JSON.parse(JSON.stringify({ ...newPage.settings, ...baseSettings }));
            // =======================================
            
            newPage.settings.pageSize = targetFormat;

            if (productsPerPage === 4) {
                newPage.settings.predefinedLayout = '2x2';
                newPage.settings.margins = { top: 200, lateral: 50, footer: 150 };
            } else if (productsPerPage === 6) {
                newPage.manualLayout = [{ products: 2, rowSpacing: 20 }, { products: 2, rowSpacing: 20 }, { products: 2, rowSpacing: 0 }];
                newPage.settings.predefinedLayout = 'manual';
                newPage.settings.margins = { top: 150, lateral: 50, footer: 150 };
            } else if (productsPerPage === 3) {
                newPage.manualLayout = [{ products: 1, rowSpacing: 20 }, { products: 1, rowSpacing: 20 }, { products: 1, rowSpacing: 0 }];
                newPage.settings.predefinedLayout = 'manual';
                newPage.settings.margins = { top: 200, lateral: 80, footer: 150 };
            }

            newPage.settings.footer.text = ``;
            newPage.settings.footer.footerSubtext = ``;
            newPage.settings.footer.backgroundEnabled = false;
            
            if (newSocialMediaPages.length === 0) {
                newPage.settings.highlight.enabled = true;
            } else {
                newPage.settings.highlight.enabled = false;
                if (newPage.settings.balloons) {
                    newPage.settings.balloons.firstLine = newPage.settings.balloons.otherLines;
                }
            }
            newSocialMediaPages.push(newPage);
        }
    }

    flyerData.pages = newSocialMediaPages;
    flyerData.logos = originalLogos;

    switchPage(0, false);
    showSpinner(false);
    showAlert(`Encarte adaptado com sucesso em ${newSocialMediaPages.length} páginas!`);
}
		
		
        

		// =================================================================
// --- LÓGICA FINAL E UNIFICADA DE GERENCIAMENTO DE PROJETOS ---
// =================================================================

// Pega os elementos do painel unificado
const projectNameInput = document.getElementById('projectNameInput');
const savedProjectsLabel = document.getElementById('savedProjectsLabel');
const saveProjectBtn = document.getElementById('saveProjectBtn');
const loadProjectBtn = document.getElementById('loadProjectBtn');
const deleteProjectBtn = document.getElementById('deleteProjectBtn');

// Pega os elementos de import/export de arquivo
const exportProjectBtn = document.getElementById('exportProjectBtn');
const importProjectBtn = document.getElementById('importProjectBtn');
const importProjectInput = document.getElementById('importProjectInput');


// Função "inteligente" para listar os projetos de acordo com a conexão
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▼▼▼ SUBSTITUA A FUNÇÃO DE SALVAR PROJETO PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA O BLOCO ANTIGO POR ESTE ▼▼▼
saveProjectBtn.addEventListener('click', async () => {
    const projectName = projectNameInput.value.trim();
    if (!projectName) {
        showAlert('Por favor, insira um nome para o projeto.');
        return;
    }

    showSpinner(true);
    try {
        // Pega o usuário autenticado para obter o ID
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
            throw new Error("Usuário não está autenticado. Recarregue a página.");
        }

        const thumbnail = canvas.toDataURL('image/jpeg', 0.5);
        const projectState = getFlyerState();
        const serializableState = JSON.parse(JSON.stringify(projectState, (key, value) => (value instanceof HTMLImageElement ? undefined : value)));

        // Envia os dados para o Supabase
        const { error } = await supabaseClient
            .from('projects')
            .upsert({
                name: projectName,
                project_data: serializableState,
                thumbnail: thumbnail,
                user_id: user.id // <-- LINHA CRÍTICA ADICIONADA
            }, { onConflict: 'name' });

        if (error) {
            // Se o Supabase retornar um erro, lança para o catch
            throw error;
        }

        await populateSavedProjectsList();
        showAlert(`Projeto "${projectName}" salvo com sucesso na nuvem!`);

    } catch (e) {
        // Mostra o erro específico no console para facilitar futuras depurações
        console.error("Erro detalhado ao salvar projeto:", e);
        showAlert(`Ocorreu um erro ao salvar na nuvem: ${e.message}`);
    } finally {
        showSpinner(false);
    }
});
// ▲▲▲ FIM DO BLOCO DE SUBSTITUIÇÃO ▲▲▲


// ▼▼▼ SUBSTITUA A FUNÇÃO DE CARREGAR PROJETO PELA VERSÃO ABAIXO ▼▼▼
loadProjectBtn.addEventListener('click', async () => {
    const projectName = selectedProjectName;
    if (!projectName) {
        showAlert('Por favor, selecione um projeto da lista para carregar.');
        return;
    }
    showSpinner(true);
    try {
        const { data, error } = await supabaseClient
            .from('projects')
            .select('project_data')
            .eq('name', projectName)
            .single();
        if (error) throw error;
        if (data && data.project_data) {
            await applyFlyerState(data.project_data);
            projectNameInput.value = projectName;
            showAlert(`Projeto "${projectName}" carregado com sucesso!`);
        } else {
            showAlert('Não foi possível encontrar os dados do projeto.');
        }
    } catch (e) {
        showAlert('Ocorreu um erro ao carregar o projeto.');
        console.error(e);
    } finally {
        showSpinner(false);
    }
});

// ▼▼▼ SUBSTITUA A FUNÇÃO DE DELETAR PROJETO PELA VERSÃO ABAIXO ▼▼▼
deleteProjectBtn.addEventListener('click', async () => {
    const projectName = selectedProjectName;
    if (!projectName) {
        showAlert('Por favor, selecione um projeto da lista para deletar.');
        return;
    }
    showConfirm(`Tem certeza que deseja deletar o projeto "${projectName}" da nuvem?`, async (confirmed) => {
        if (confirmed) {
            showSpinner(true);
            try {
                const { error } = await supabaseClient
                    .from('projects')
                    .delete()
                    .eq('name', projectName);
                if (error) throw error;
                await populateSavedProjectsList();
                projectNameInput.value = '';
                showAlert(`Projeto "${projectName}" deletado da nuvem.`);
            } catch(e) {
                showAlert('Erro ao deletar da nuvem.');
                console.error(e);
            } finally {
                showSpinner(false);
            }
        }
    });
});

// ▼▼▼ SUBSTITUA A FUNÇÃO DE LISTAR PROJETOS PELA VERSÃO ABAIXO ▼▼▼
async function populateSavedProjectsList() {
    const projectsGrid = document.getElementById('savedProjectsGrid');
    const projectsLabel = document.getElementById('savedProjectsLabel');
    if (!projectsGrid || !projectsLabel) return;
    projectsGrid.innerHTML = '<p class="col-span-2 text-center text-sm">Carregando...</p>';
    projectsLabel.innerHTML = 'Projetos Salvos (Nuvem) ☁️';
    selectedProjectName = null;
    try {
        const { data: projects, error } = await supabaseClient
            .from('projects')
            .select('name, thumbnail');
        if (error) throw error;
        projectsGrid.innerHTML = '';
        if (!projects || projects.length === 0) {
            projectsGrid.innerHTML = '<p class="col-span-2 text-center text-sm text-gray-500">Nenhum projeto salvo.</p>';
            return;
        }
        projects.forEach(project => {
            const card = document.createElement('div');
            card.className = 'template-preview-card bg-white dark:bg-gray-800 p-2 rounded-lg cursor-pointer shadow-md flex flex-col items-center';
            card.dataset.projectName = project.name;
            const img = document.createElement('img');
            img.src = project.thumbnail || 'https://placehold.co/200x250/e2e8f0/adb5bd?text=Sem+Preview';
            img.className = 'w-full h-auto object-contain rounded-md mb-2';
            const nameLabel = document.createElement('span');
            nameLabel.textContent = project.name;
            nameLabel.className = 'text-[10px] text-center font-semibold break-words';
            card.appendChild(img);
            card.appendChild(nameLabel);
            card.addEventListener('click', () => {
                document.querySelectorAll('#savedProjectsGrid .selected').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedProjectName = project.name;
                projectNameInput.value = project.name;
            });
            projectsGrid.appendChild(card);
        });
    } catch (e) {
        console.error("Erro ao buscar projetos da nuvem:", e);
        projectsLabel.innerHTML = '<span class="text-red-400">Falha ao carregar projetos</span>';
        projectsGrid.innerHTML = '<p class="col-span-2 text-center text-sm text-red-400">Erro ao carregar.</p>';
    }
}


// Ação do botão "Deletar" unificado
// ▼▼▼ SUBSTITUA O 'addEventListener' INTEIRO PELA VERSÃO ABAIXO ▼▼▼


// --- Lógica de import/export de arquivo (Backup / Transferência) ---
exportProjectBtn.addEventListener('click', () => {
    const projectName = projectNameInput.value.trim() || 'meu-encarte';
    const projectState = getFlyerState();
    const serializableState = JSON.parse(JSON.stringify(projectState, (key, value) => (value instanceof HTMLImageElement ? undefined : value)));
    const projectJSON = JSON.stringify(serializableState, null, 2);
    const blob = new Blob([projectJSON], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${projectName}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
importProjectBtn.addEventListener('click', () => { importProjectInput.click(); });
importProjectInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
        showSpinner(true);
        try {
            const projectData = JSON.parse(e.target.result);
            await applyFlyerState(projectData);
            showAlert('Projeto importado com sucesso!');
        } catch (error) {
            showAlert('Erro ao importar o projeto. Verifique se é um arquivo válido.');
        } finally {
            showSpinner(false);
            event.target.value = '';
        }
    };
    reader.readAsText(file);
});





// ▼▼▼ COLE ESTE BLOCO DE CÓDIGO NO SEU SCRIPT ▼▼▼

/**
 * Funções para navegar entre as páginas.
 */
function goToPrevPage() {
    if (flyerData.currentPageIndex > 0) {
        switchPage(flyerData.currentPageIndex - 1);
    }
}

function goToNextPage() {
    if (flyerData.currentPageIndex < flyerData.pages.length - 1) {
        switchPage(flyerData.currentPageIndex + 1);
    }
}

/**
 * Ativa/desativa os botões de navegação se estiver na primeira ou última página.
 */
function updateNavButtonStates() {
    prevPageBtn.disabled = flyerData.currentPageIndex === 0;
    nextPageBtn.disabled = flyerData.currentPageIndex >= flyerData.pages.length - 1;
}



// ▼▼▼ COLE ESTE BLOCO DE CÓDIGO NOVO ▼▼▼

// SVG para o ícone de nuvem/upload
const cloudUploadIconSVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-4-4V7a4 4 0 014-4h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V16a4 4 0 01-4 4H7z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 9h-4a2 2 0 00-2 2v6" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m-2-3h4" /></svg>`;
const refreshIconSVG = `<svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 4v5h5M20 20v-5h-5M20 4h-5v5M4 20h5v-5" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;

/**
 * Atualiza o indicador visual de status de sincronização no painel de estoque.
 */
function updateSyncStatusUI() {
    if (!stockDbLabel || !refreshStockListBtn) return;

    if (isDatabaseSynced) {
        stockDbLabel.innerHTML = 'Produtos (Sincronizado ☁️)';
        stockDbLabel.className = 'text-lg font-semibold text-green-400';
        refreshStockListBtn.title = 'Atualizar Lista da Nuvem';
        refreshStockListBtn.innerHTML = refreshIconSVG;
        refreshStockListBtn.classList.remove('border-yellow-400');
        refreshStockListBtn.classList.add('border-green-400');
    } else {
        stockDbLabel.innerHTML = 'Produtos (Não Sincronizado ⚠️)';
        stockDbLabel.className = 'text-lg font-semibold text-yellow-400';
        refreshStockListBtn.title = 'Sincronizar com a Nuvem Agora';
        refreshStockListBtn.innerHTML = cloudUploadIconSVG;
        refreshStockListBtn.classList.remove('border-green-400');
        refreshStockListBtn.classList.add('border-yellow-400');
    }
}
// ▲▲▲ FIM DO BLOCO ▲▲▲



async function initialize() {
    showSpinner(true);
    
    try {
        // ETAPA 1: FAZ O LOGIN COM O "USUÁRIO MESTRE"
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: 'carlosdeathnote@gmail.com',    // <-- Use o email que você criou
            password: 'Arte.com13061994*', // <-- Use a senha que você criou
        });

        if (error) {
            // Se o login falhar, mostra um erro grave e para a aplicação.
            throw error;
        }

        console.log("Login com Usuário Mestre realizado com sucesso:", data.user.id);

    } catch(e) {
        console.error("Falha crítica na autenticação com Supabase:", e);
        // Alerta para o usuário de que a conexão com a base de dados falhou
        document.body.innerHTML = `<div style="padding: 40px; text-align: center; color: red; font-family: sans-serif;">
            <h1>Erro de Conexão</h1>
            <p>Não foi possível conectar ao banco de dados. Verifique o email/senha do usuário mestre no código ou as configurações do Supabase.</p>
        </div>`;
        return; // Para a execução
    }
    
    // ETAPA 2: Carrega o restante da aplicação normalmente.
    await loadProductDatabase();
    await populateSavedProjectsList();
    await loadCustomFontsFromStorage();
    await loadCustomBalloons();
    populateTemplatePreviews();

    if (flyerData.pages.length === 0) {
        flyerData.pages.push(createDefaultPage());
    }
    
    switchPage(0, false);
    showSpinner(false);
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲




// ▼▼▼ ADICIONE ESTE BLOCO DE CÓDIGO NO FINAL DO SEU SCRIPT ▼▼▼

/**
 * Aplica o fundo da página 2 a todas as páginas subsequentes (da 3 em diante).
 */
function applyP2BackgroundToRest() {
    // 1. Verifica se há páginas suficientes para a operação fazer sentido
    if (flyerData.pages.length < 3) {
        showAlert("Você precisa de pelo menos 3 páginas para usar esta função.");
        return;
    }

    // 2. Pega o fundo da página 2 (que tem índice 1)
    const backgroundTemplate = flyerData.pages[1].backgroundImage;
    const backgroundTemplateSrc = flyerData.pages[1].backgroundImageSrc;

    // 3. Verifica se a página 2 realmente tem um fundo definido
    if (!backgroundTemplate) {
        showAlert("A página 2 não tem uma imagem de fundo para ser aplicada.");
        return;
    }

    // 4. Aplica o fundo em um loop, começando da página 3 (índice 2)
    for (let i = 2; i < flyerData.pages.length; i++) {
        flyerData.pages[i].backgroundImage = backgroundTemplate;
        flyerData.pages[i].backgroundImageSrc = backgroundTemplateSrc;
    }

    // 5. Redesenha o canvas e avisa o usuário
    redrawCanvas();
    showAlert("Fundo da página 2 aplicado a todas as páginas seguintes com sucesso!");
}

applyP2BackgroundBtn.addEventListener('click', applyP2BackgroundToRest);

// ▲▲▲ FIM DO BLOCO ▲▲▲





// ▼▼▼ ADICIONE ESTE BLOCO DE CÓDIGO NO FINAL DO SEU SCRIPT ▼▼▼

/**
 * Ativa o selo de validade em todas as páginas e aplica as configurações 
 * da página 2 a todas as páginas subsequentes (da 3 em diante).
 */
function applyP2ValidityToRest() {
    // 1. Verifica se há pelo menos 2 páginas
    if (flyerData.pages.length < 2) {
        showAlert("Você precisa de pelo menos 2 páginas para usar esta função.");
        return;
    }

    // 2. Pega as configurações completas do selo da página 2 para usar como modelo
    const validityTemplate = JSON.parse(JSON.stringify(flyerData.pages[1].settings.headerValidity));

    // 3. Verifica se o selo da página 2 está ativado para ter o que copiar
    if (!validityTemplate.enabled) {
        showAlert("Por favor, ative e configure o selo de validade na Página 2 primeiro.");
        return;
    }

    // 4. Itera sobre TODAS as páginas do encarte
    for (let i = 0; i < flyerData.pages.length; i++) {
        // Garante que o objeto de validade exista em todas as páginas
        if (!flyerData.pages[i].settings.headerValidity) {
            flyerData.pages[i].settings.headerValidity = createDefaultPage().settings.headerValidity;
        }

        // Ativa o selo em TODAS as páginas
        flyerData.pages[i].settings.headerValidity.enabled = true;

        // Se a página for a 3ª ou posterior (índice 2+), aplica as configurações da página 2
        if (i >= 2) {
            // Usa uma cópia para evitar problemas de referência
            flyerData.pages[i].settings.headerValidity = JSON.parse(JSON.stringify(validityTemplate));
        }
    }

    // 5. Atualiza a interface para refletir as mudanças e avisa o usuário
    switchPage(flyerData.currentPageIndex); // Atualiza os controles do painel
    showAlert("Configuração de validade aplicada com sucesso a todas as páginas!");
}

applyP2ValidityBtn.addEventListener('click', applyP2ValidityToRest);

// ▲▲▲ FIM DO BLOCO ▲▲▲


// ▼▼▼ ADICIONE ESTE BLOCO DE CÓDIGO NO FINAL DO SEU SCRIPT ▼▼▼

/**
 * Aplica o formato de página e as margens da página atual para todas as páginas,
 * exceto a primeira.
 */
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'applyCurrentLayoutToAllOthers' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

function applyCurrentLayoutToAllOthers() {
    if (flyerData.pages.length < 2) {
        showAlert("Você precisa de pelo menos 2 páginas para usar esta função.");
        return;
    }

    showConfirm("Isso aplicará o formato e as margens atuais a todas as páginas, exceto a primeira. Deseja continuar?", (confirmed) => {
        if (confirmed) {
            // --- INÍCIO DA CORREÇÃO ---
            // Garante que as configurações da UI sejam salvas no projeto antes de copiar.
            saveCurrentPageSettings();
            // --- FIM DA CORREÇÃO ---

            const currentPageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
            const sizeTemplate = {
                pageSize: currentPageSettings.pageSize,
                customWidth: currentPageSettings.customWidth,
                customHeight: currentPageSettings.customHeight
            };
            const marginsTemplate = JSON.parse(JSON.stringify(currentPageSettings.margins));

            for (let i = 1; i < flyerData.pages.length; i++) {
                flyerData.pages[i].settings.pageSize = sizeTemplate.pageSize;
                flyerData.pages[i].settings.customWidth = sizeTemplate.customWidth;
                flyerData.pages[i].settings.customHeight = sizeTemplate.customHeight;
                flyerData.pages[i].settings.margins = JSON.parse(JSON.stringify(marginsTemplate));
            }

            redrawCanvas();
            showAlert("Layout aplicado com sucesso a todas as páginas a partir da segunda!");
        }
    });
}

applyLayoutToAllOthersBtn.addEventListener('click', applyCurrentLayoutToAllOthers);

// ▲▲▲ FIM DO BLOCO ▲▲▲



// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

/**
 * Lógica para o novo painel de atualização de preços.
 */
const priceUpdateBtn = document.getElementById('priceUpdateBtn');

// Função principal que lê a lista e atualiza os preços no encarte
function updatePricesFromList() {
    const text = document.getElementById('priceUpdateTextarea').value.trim();
    if (!text) {
        showAlert("Por favor, cole a lista de produtos e preços na área de texto.");
        return;
    }

    showSpinner(true);
    const lines = text.split('\n').filter(line => line.trim());
    const priceUpdates = new Map();

    // 1. Lê a lista colada e cria um "mapa" de Nomes e Preços
    for (const line of lines) {
        const parts = line.split(';');
        if (parts.length >= 2) {
            // Normaliza o nome para uma busca mais precisa (ignora maiúsculas/minúsculas e acentos)
            const name = normalizeString(parts[0].trim());
            const priceText = parts[1].trim().replace(',', '.');
            const price = parseFloat(priceText);
            
            if (name && !isNaN(price)) {
                priceUpdates.set(name, price.toFixed(2));
            }
        }
    }

    if (priceUpdates.size === 0) {
        showSpinner(false);
        showAlert("Nenhum preço válido encontrado. Use o formato: NOME DO PRODUTO; PREÇO");
        return;
    }

    let updatedCount = 0;
    const initialUpdateSize = priceUpdates.size;

    // 2. Passa por todas as páginas e produtos do encarte
    flyerData.pages.forEach(page => {
        page.products.forEach(productInFlyer => {
            const normalizedFlyerName = normalizeString(productInFlyer.name);
            
            // 3. Se encontrar um produto com o mesmo nome, atualiza o preço
            if (priceUpdates.has(normalizedFlyerName)) {
                productInFlyer.price = priceUpdates.get(normalizedFlyerName);
                updatedCount++;
                // Remove o item do mapa para identificar os que não foram encontrados
                priceUpdates.delete(normalizedFlyerName);
            }
        });
    });

    // 4. Redesenha tudo e mostra um resumo
    redrawCanvas();
    updateProductListUI(); // Atualiza os preços no painel "No Encarte"

    const notFoundNames = [...priceUpdates.keys()]; // O que sobrou no mapa não foi encontrado
    let summaryMessage = `${updatedCount} preço(s) foram atualizados com sucesso.`;
    if (notFoundNames.length > 0) {
        summaryMessage += `\n\n${notFoundNames.length} produto(s) da sua lista não foram encontrados no encarte e foram ignorados.`;
    }
    
    showSpinner(false);
    showAlert(summaryMessage);
    document.getElementById('priceUpdateTextarea').value = ''; // Limpa a área de texto
}

// Adiciona o evento de clique ao botão
priceUpdateBtn.addEventListener('click', updatePricesFromList);

// ▲▲▲ FIM DO BLOCO ▲▲▲


// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// ▼▼▼ COLE ESTE BLOCO NO LUGAR DA LÓGICA ANTIGA DO GERADOR DE CARTAZES ▼▼▼

// ▼▼▼ COLE ESTE BLOCO NO LUGAR DA LÓGICA ANTIGA DO GERADOR DE CARTAZES ▼▼▼

// ▼▼▼ COLE ESTE BLOCO NO LUGAR DA LÓGICA ANTIGA DO GERADOR DE CARTAZES ▼▼▼

// --- LÓGICA DO GERADOR DE CARTAZ DE PREÇO (VERSÃO 3.0 - EM LOTE) ---

const priceTagProductList = document.getElementById('priceTagProductList');
const generatePriceTagBtn = document.getElementById('generatePriceTagBtn');
const priceTagSelectAllBtn = document.getElementById('priceTagSelectAllBtn');
const priceTagDeselectAllBtn = document.getElementById('priceTagDeselectAllBtn');

// Popula a lista com checkboxes
function populatePriceTagProductList() {
    const allProducts = flyerData.pages.flatMap((page, pageIndex) => 
        page.products.map((product, productIndex) => ({
            name: product.name,
            id: `${pageIndex}-${productIndex}`
        }))
    );

    priceTagProductList.innerHTML = '';

    if (allProducts.length === 0) {
        priceTagProductList.innerHTML = '<p class="text-xs text-gray-500 p-2">Nenhum produto no encarte.</p>';
        generatePriceTagBtn.disabled = true;
        return;
    }

    generatePriceTagBtn.disabled = false;
    allProducts.forEach(product => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex items-center gap-2 p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `pricetag-select-${product.id}`;
        checkbox.value = product.id;
        checkbox.className = 'h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500';

        const label = document.createElement('label');
        label.htmlFor = `pricetag-select-${product.id}`;
        label.textContent = `P.${parseInt(product.id.split('-')[0]) + 1} - ${product.name}`;
        label.className = 'text-sm cursor-pointer flex-grow';
        
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        priceTagProductList.appendChild(itemDiv);
    });
}

// Evento do botão "Gerar Cartazes"
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
generatePriceTagBtn.addEventListener('click', () => {
    const selectedCheckboxes = document.querySelectorAll('#priceTagProductList input[type="checkbox"]:checked');
    
    if (selectedCheckboxes.length === 0) {
        showAlert("Por favor, marque pelo menos um produto para gerar o cartaz.");
        return;
    }

    showSpinner(true);

    const templatePage = flyerData.pages[flyerData.currentPageIndex];
    const templateSettings = JSON.parse(JSON.stringify(templatePage.settings));
    
    // --- INÍCIO DA CORREÇÃO ---
    // 1. Lê o valor do espaçamento diretamente do campo da interface
    const lineSpacingValue = parseFloat(document.getElementById('priceTagLineSpacing').value) || 1.2;
    // --- FIM DA CORREÇÃO ---

    selectedCheckboxes.forEach(checkbox => {
        const selectedId = checkbox.value;
        const [pageIndex, productIndex] = selectedId.split('-').map(Number);
        const originalProduct = flyerData.pages[pageIndex].products[productIndex];

        if (originalProduct) {
            const newPriceTagPage = createDefaultPage();
            newPriceTagPage.settings = JSON.parse(JSON.stringify(templateSettings));
            
            newPriceTagPage.settings.pageSize = 'custom';
            newPriceTagPage.settings.customWidth = 3780;
            newPriceTagPage.settings.customHeight = 5315;
            
            newPriceTagPage.settings.margins = {
                top: 1370,
                lateral: 150,
                footer: 150
            };
            
            const headerValiditySettings = newPriceTagPage.settings.headerValidity;
            headerValiditySettings.enabled = true;
            headerValiditySettings.fontSizeStartDate = 110;
            headerValiditySettings.fontSizeDates = 110;
            headerValiditySettings.fontSizeStock = 85;
            headerValiditySettings.dateToStockSpacing = -431;
            headerValiditySettings.width = 1000;
            headerValiditySettings.x = 2792;
            headerValiditySettings.y = -12;
            headerValiditySettings.lineSpacing = -3;
            headerValiditySettings.headerSeparatorSpacing = 10;
            
            // --- INÍCIO DA CORREÇÃO ---
            // 2. Garante que o objeto pricePoster exista e aplica o valor lido
            if (!newPriceTagPage.settings.pricePoster) {
                newPriceTagPage.settings.pricePoster = {};
            }
            newPriceTagPage.settings.pricePoster.lineSpacing = lineSpacingValue;
            // --- FIM DA CORREÇÃO ---
            
            if (templatePage.backgroundImage) {
                newPriceTagPage.backgroundImage = templatePage.backgroundImage;
                newPriceTagPage.backgroundImageSrc = templatePage.backgroundImageSrc;
            }

            newPriceTagPage.products = [ { ...originalProduct } ];
            newPriceTagPage.isPricePoster = true;
            newPriceTagPage.manualLayout = [];
            
            flyerData.pages.push(newPriceTagPage);
        }
    });

    const firstNewPageIndex = flyerData.pages.length - selectedCheckboxes.length;
    switchPage(firstNewPageIndex, true);

    showSpinner(false);
    showAlert(`${selectedCheckboxes.length} cartaz(es) de preço gerado(s) como novas páginas no final do seu projeto.`);
});

// Eventos para os botões de selecionar/desselecionar todos
priceTagSelectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('#priceTagProductList input[type="checkbox"]').forEach(cb => cb.checked = true);
});

priceTagDeselectAllBtn.addEventListener('click', () => {
    document.querySelectorAll('#priceTagProductList input[type="checkbox"]').forEach(cb => cb.checked = false);
});


// Atualiza a lista de produtos sempre que o painel for aberto
document.querySelector('a[data-panel="panel-price-tag"]').addEventListener('click', populatePriceTagProductList);

// ▲▲▲ FIM DO BLOCO ▲▲▲


// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// --- LÓGICA DE EXPORTAÇÃO DE CARTAZES DE PREÇO EM PDF ---

// ▼▼▼ SUBSTITUA TODO O BLOCO DE LÓGICA DE EXPORTAÇÃO POR ESTE ▼▼▼

// --- LÓGICA DE EXPORTAÇÃO DE CARTAZES DE PREÇO EM PDF ---

// ▼▼▼ SUBSTITUA TODO O BLOCO DE LÓGICA DE EXPORTAÇÃO POR ESTE ▼▼▼

// --- LÓGICA DE EXPORTAÇÃO DE CARTAZES DE PREÇO EM PDF ---

// --- LÓGICA DE EXPORTAÇÃO DE CARTAZES DE PREÇO EM PDF ---

const exportPostersPdfBtn = document.getElementById('exportPostersPdfBtn');
const exportPosterModal = document.getElementById('exportPosterModal');
const cancelPosterExportBtn = document.getElementById('cancelPosterExportBtn');
const runPosterExportBtn = document.getElementById('runPosterExportBtn');
const posterDPISelect = document.getElementById('posterDPI');
const customDpiContainer = document.getElementById('customDpiContainer');
const jpegQualitySlider = document.getElementById('jpegQualitySlider');
const jpegQualityValue = document.getElementById('jpegQualityValue');

// Mostra o modal de opções
exportPostersPdfBtn.addEventListener('click', () => {
    const posterPages = flyerData.pages.filter(p => p.isPricePoster);
    if (posterPages.length === 0) {
        showAlert("Nenhum cartaz de preço foi gerado para exportar.");
        return;
    }
    customDpiContainer.classList.toggle('hidden', posterDPISelect.value !== 'custom');
    exportPosterModal.classList.add('visible');
});

// Esconde o modal
cancelPosterExportBtn.addEventListener('click', () => {
    exportPosterModal.classList.remove('visible');
});

// Mostra/esconde o campo de DPI personalizado
posterDPISelect.addEventListener('change', () => {
    customDpiContainer.classList.toggle('hidden', posterDPISelect.value !== 'custom');
});

// Atualiza o texto de porcentagem do slider de qualidade
jpegQualitySlider.addEventListener('input', (e) => {
    jpegQualityValue.textContent = `${Math.round(e.target.value * 100)}%`;
});

// Função principal que gera o PDF
async function generatePosterPDF() {
    const posterPages = flyerData.pages
        .map((page, index) => ({ page, originalIndex: index }))
        .filter(item => item.page.isPricePoster);

    if (posterPages.length === 0) {
        showAlert("Nenhum cartaz de preço foi gerado para exportar.");
        return;
    }

    exportPosterModal.classList.remove('visible');
    showSpinner(true);
    showAlert("Gerando PDF... Isso pode demorar um pouco dependendo da qualidade.");

    const sheetSize = document.getElementById('posterSheetSize').value;
    const layout = document.getElementById('posterLayout').value;
    const jpegQuality = parseFloat(jpegQualitySlider.value);
    
    let dpi;
    const dpiSelection = posterDPISelect.value;
    if (dpiSelection === 'custom') {
        dpi = parseInt(document.getElementById('customDpiInput').value, 10) || 72;
    } else {
        dpi = parseInt(dpiSelection, 10);
    }

    const { jsPDF } = window.jspdf;

    const originalPageIndex = flyerData.currentPageIndex;
    const originalCanvasSize = { width: canvas.width, height: canvas.height };
    const delay = ms => new Promise(res => setTimeout(res, ms));

    const MM_PER_INCH = 25.4;
    const sizes_mm = { A5: [148, 210], A4: [210, 297], SRA3: [320, 450] };
    const mmToPx = (mm, dpi) => (mm / MM_PER_INCH) * dpi;

    try {
        if (layout === '1up') {
            const [w_mm, h_mm] = sizes_mm[sheetSize];
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: [w_mm, h_mm] });
            const tempWidth = Math.round(mmToPx(w_mm, dpi));
            const tempHeight = Math.round(mmToPx(h_mm, dpi));

            for (let i = 0; i < posterPages.length; i++) {
                const { page, originalIndex } = posterPages[i];
                
                canvas.width = tempWidth;
                canvas.height = tempHeight;
                switchPage(originalIndex, false);
                await delay(200);
                redrawCanvas();
                await delay(300);

                const canvasImg = canvas.toDataURL('image/jpeg', jpegQuality);
                if (i > 0) pdf.addPage([w_mm, h_mm], 'portrait');
                pdf.addImage(canvasImg, 'JPEG', 0, 0, w_mm, h_mm, undefined, 'FAST');
            }
            pdf.save(`cartazes_1_por_folha_${sheetSize}_${dpi}dpi.pdf`);

        } else if (layout === '2up') {
            const [w_mm, h_mm] = sizes_mm.A4;
            const pdf = new jsPDF({ orientation: 'landscape', unit: 'mm', format: [h_mm, w_mm] });
            
            const poster_w_mm = sizes_mm.A5[0];
            const poster_h_mm = sizes_mm.A5[1];
            const tempWidth = Math.round(mmToPx(poster_w_mm, dpi));
            const tempHeight = Math.round(mmToPx(poster_h_mm, dpi));

            for (let i = 0; i < posterPages.length; i += 2) {
                if (i > 0) pdf.addPage([h_mm, w_mm], 'landscape');
                
                canvas.width = tempWidth;
                canvas.height = tempHeight;
                
                const { page: page1, originalIndex: originalIndex1 } = posterPages[i];
                switchPage(originalIndex1, false);
                await delay(200);
                redrawCanvas();
                await delay(300);
                const canvasImg1 = canvas.toDataURL('image/jpeg', jpegQuality);
                pdf.addImage(canvasImg1, 'JPEG', 0, 0, poster_w_mm, poster_h_mm, undefined, 'FAST');

                if (i + 1 < posterPages.length) {
                    const { page: page2, originalIndex: originalIndex2 } = posterPages[i + 1];
                    switchPage(originalIndex2, false);
                    await delay(200);
                    redrawCanvas();
                    await delay(300);
                    const canvasImg2 = canvas.toDataURL('image/jpeg', jpegQuality);
                    pdf.addImage(canvasImg2, 'JPEG', h_mm / 2, 0, poster_w_mm, poster_h_mm, undefined, 'FAST');
                }
            }
            pdf.save(`cartazes_2_por_folha_A4_${dpi}dpi.pdf`);
        }
    } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        showAlert("Ocorreu um erro ao gerar o PDF. Tente novamente.");
    } finally {
        canvas.width = originalCanvasSize.width;
        canvas.height = originalCanvasSize.height;
        switchPage(originalPageIndex, false);
        redrawCanvas();
        showSpinner(false);
        showAlert("PDF com os cartazes gerado com sucesso!");
    }
}

// =========================================================
// ===== LINHA FALTANTE QUE CAUSA O PROBLEMA ADICIONADA AQUI =====
// =========================================================
runPosterExportBtn.addEventListener('click', generatePosterPDF); // LINHA ADICIONADA

prevPageBtn.addEventListener('click', goToPrevPage);
nextPageBtn.addEventListener('click', goToNextPage);



// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// ▼▼▼ SUBSTITUA TODO ESTE BLOCO DE CÓDIGO NO SEU SCRIPT ▼▼▼

// --- LÓGICA DE BALÕES DE PREÇO CUSTOMIZADOS ---

const customBalloonImageInput = document.getElementById('customBalloonImageInput');
const customBalloonNameInput = document.getElementById('customBalloonNameInput');
const saveCustomBalloonBtn = document.getElementById('saveCustomBalloonBtn');
const customBalloonList = document.getElementById('customBalloonList');

let customBalloons = {}; // Objeto para guardar as imagens dos balões

// Salva um novo balão no armazenamento do navegador
function saveCustomBalloon(name, imageDataUrl) {
    const saved = JSON.parse(localStorage.getItem('customBalloons') || '{}');
    saved[name] = imageDataUrl;
    localStorage.setItem('customBalloons', JSON.stringify(saved));
}

// Carrega os balões salvos ao iniciar
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA ▼▼▼
async function loadCustomBalloons() {
    customBalloonList.innerHTML = '';
    [firstLineBalloonStyleSelect, otherLinesBalloonStyleSelect].forEach(select => {
        const optgroup = select.querySelector('optgroup[label="Balões Customizados"]');
        if (optgroup) optgroup.innerHTML = '';
    });

    try {
        const { data, error } = await supabaseClient
            .from('custom_balloons')
            .select('name, image_data_url');
        
        if (error) throw error;

        for (const balloon of data) {
            addCustomBalloonToUIAndSelects(balloon.name, balloon.image_data_url);
        }
    } catch (e) {
        console.error("Erro ao carregar balões da nuvem:", e);
        showAlert("Não foi possível carregar os balões customizados da nuvem.");
    }
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// Deleta um balão customizado
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA ▼▼▼
async function deleteCustomBalloon(name) {
    try {
        const { error } = await supabaseClient
            .from('custom_balloons')
            .delete()
            .eq('name', name);

        if (error) throw error;

        await loadCustomBalloons(); // Apenas recarrega a lista, sem dar refresh na página
        showAlert(`Balão "${name}" deletado da nuvem com sucesso.`);
    } catch (e) {
        console.error("Erro ao deletar balão:", e);
        showAlert(`Falha ao deletar balão: ${e.message}`);
    }
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// Adiciona o balão na interface e nos menus de seleção
function addCustomBalloonToUIAndSelects(name, imageDataUrl) {
    // Adiciona o item na lista de gerenciamento "Balões Salvos"
    const listItem = document.createElement('div');
    listItem.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded';
    listItem.innerHTML = `
        <span class="text-sm font-semibold">${name}</span>
        <button data-name="${name}" class="delete-custom-balloon-btn text-red-500 hover:text-red-700 font-bold text-xl">&times;</button>
    `;
    customBalloonList.appendChild(listItem);

    const optionValue = `custom_${name}`;

    // Itera sobre os dois menus de seleção de estilo de balão
    [firstLineBalloonStyleSelect, otherLinesBalloonStyleSelect].forEach(select => {
        // Procura pelo grupo de opções "Balões Customizados"
        let optgroup = select.querySelector('optgroup[label="Balões Customizados"]');

        // Se o grupo não existir (este é o primeiro balão customizado)
        if (!optgroup) {
            optgroup = document.createElement('optgroup');
            optgroup.label = 'Balões Customizados';
            select.appendChild(optgroup); // Adiciona o novo grupo ao menu
        }

        // Cria a nova opção para o balão que está sendo salvo
        const option = document.createElement('option');
        option.value = optionValue;
        option.textContent = name;
        
        // Adiciona a nova opção ao grupo
        optgroup.appendChild(option);
    });

    // Carrega a imagem do balão na memória para uso no canvas
    const img = new Image();
    img.onload = () => { customBalloons[name] = img; };
    img.src = imageDataUrl;
}

// Evento para o botão de salvar
// ▼▼▼ SUBSTITUA O BLOCO ANTIGO POR ESTE ▼▼▼
saveCustomBalloonBtn.addEventListener('click', async () => {
    const file = customBalloonImageInput.files[0];
    const name = customBalloonNameInput.value.trim();

    if (!file || !name) {
        showAlert('Por favor, selecione uma imagem e dê um nome ao novo estilo.');
        return;
    }
    
    showSpinner(true);
    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageDataUrl = e.target.result;
        try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) throw new Error("Usuário não autenticado.");

            const { error } = await supabaseClient
                .from('custom_balloons')
                .upsert({ name: name, image_data_url: imageDataUrl, user_id: user.id }, { onConflict: 'name' });

            if (error) throw error;

            await loadCustomBalloons(); // Recarrega a lista da nuvem
            customBalloonImageInput.value = '';
            customBalloonNameInput.value = '';
            showAlert(`Balão "${name}" salvo na nuvem com sucesso!`);
        } catch(err) {
            console.error("Erro ao salvar balão na nuvem:", err);
            showAlert(`Falha ao salvar o balão: ${err.message}`);
        } finally {
            showSpinner(false);
        }
    };
    reader.readAsDataURL(file);
});
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// Evento para os botões de deletar
customBalloonList.addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-custom-balloon-btn')) {
        const name = e.target.dataset.name;
        showConfirm(`Tem certeza que deseja deletar o balão "${name}"?`, (confirmed) => {
            if (confirmed) {
                deleteCustomBalloon(name);
            }
        });
    }
});

// Função para desenhar o balão customizado
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawCustomImageBalloon' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawCustomImageBalloon' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawCustomImageBalloon' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawCustomImageBalloon' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawCustomImageBalloon' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA NOVAMENTE PELA VERSÃO COM CENTRALIZAÇÃO CORRIGIDA ▼▼▼
// ▼▼▼ SUBSTITUA PELA VERSÃO QUE APLICA A ESCALA DO PREÇO ▼▼▼
function drawCustomImageBalloon(ctx, x, y, w, h, details, balloonName, globalOffsetY = 0) {
    const customImg = customBalloons[balloonName];
    if (!customImg || customImg.width === 0) {
        return;
    }

    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const allCustomSettings = pageSettings.balloonStyles.customBalloons || {};
    const styleSettings = allCustomSettings[balloonName] || {
        priceColor: '#FFFFFF', priceFontSize: 80, priceOffsetX: 50, priceOffsetY: 50,
        balloonWidth: 85, balloonHeight: 85, priceFont: 'Anton'
    };

    const balloonWidthPercent = styleSettings.balloonWidth / 100;
    const finalW = w * balloonWidthPercent;
    const aspectRatio = customImg.height / customImg.width;
    const neutralH = finalW * aspectRatio;
    const balloonHeightPercent = styleSettings.balloonHeight / 100;
    const finalH = neutralH * balloonHeightPercent;
    const finalX = x + (w - finalW) / 2;
    const paddingBottom = 15;
    
    const finalY = y + h - finalH - paddingBottom + globalOffsetY;

    ctx.drawImage(customImg, finalX, finalY, finalW, finalH);

    const priceColor = styleSettings.priceColor;
    const priceFont = styleSettings.priceFont || 'Anton';
    const priceOffsetX = styleSettings.priceOffsetX / 100;
    const priceOffsetY = styleSettings.priceOffsetY / 100;
    
    // Pega os valores de escala dos sliders que vêm do produto
    const priceScaleX = details.scaleX || 1;
    const priceScaleY = details.scaleY || 1;

    const priceFontSize = styleSettings.priceFontSize;
    const currencyFontSize = priceFontSize * 0.5;

    const currencyText = 'R$';
    const priceText = `${details.integerPart},${details.decimalPart}`;

    const spacing = priceFontSize * 0.1;
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    const currencyWidth = ctx.measureText(currencyText).width;
    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    const priceWidth = ctx.measureText(priceText).width;
    const totalTextWidth = currencyWidth + spacing + priceWidth;
    
    const priceX = finalX + finalW * priceOffsetX;
    const priceY = finalY + finalH * priceOffsetY;
    
    // --- INÍCIO DA CORREÇÃO DE ESCALA ---
    ctx.save(); // Salva o estado do canvas antes de aplicar a escala

    // Move o "ponto de origem" do canvas para o centro do texto
    ctx.translate(priceX, priceY); 
    // Aplica a escala (esticar/achatar) a partir desse ponto central
    ctx.scale(priceScaleX, priceScaleY); 
    
    // Agora desenhamos o texto na nova origem (0, 0)
    let currentX = -(totalTextWidth / 2);

    ctx.fillStyle = priceColor;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle'; 
    
    ctx.font = `bold ${currencyFontSize}px '${priceFont}'`;
    const currencyY = -(priceFontSize * 0.15);
    ctx.fillText(currencyText, currentX, currencyY);

    currentX += currencyWidth + spacing;

    ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
    ctx.fillText(priceText, currentX, 0); // O texto principal é desenhado no ponto (0,0) escalado

    ctx.restore(); // Restaura o canvas ao estado original, removendo a escala
    // --- FIM DA CORREÇÃO DE ESCALA ---
}



// ▼▼▼ ADICIONE ESTA NOVA FUNÇÃO AO SEU CÓDIGO ▼▼▼
/**
 * Calcula os padrões de repetição e tamanho da imagem com base em suas proporções.
 * @param {Image} image - O objeto da imagem do produto.
 * @returns {object} Um objeto com os padrões calculados.
 */
function calculateSmartImageDefaults(image) {
    // Padrões que definimos anteriormente
    let defaults = {
        imageRepetitions: 1,
        imageWidthPercent: 75,
        imageHeightPercent: 70,
        imagePositionY: 20,
        imagePositionX: 50,
        imageFit: 'contain',
        imageRepetitionDirection: 'horizontal'
    };

    // Se não houver imagem, retorna os padrões básicos
    if (!image || image.height === 0) return defaults;

    const aspectRatio = image.width / image.height;
    
    // --- LÓGICA DE AUTO-REPETIÇÃO REFINADA ---
    const NARROW_THRESHOLD = 0.8; 
    const VERY_NARROW_THRESHOLD = 0.5; 
    // NOVA CONDIÇÃO: A largura real da imagem em pixels.
    // Imagens com largura menor que este valor serão candidatas à repetição.
    const PIXEL_WIDTH_THRESHOLD = 450; // <-- AJUSTE ESTE VALOR SE NECESSÁRIO
    const TARGET_WIDTH_PERCENT = 95;

    // CONDIÇÃO 1: A imagem é proporcionalmente estreita (mais alta que larga)?
    if (aspectRatio < NARROW_THRESHOLD) {
        
        // CONDIÇÃO 2: A imagem também é fisicamente fina (tem menos de 450px de largura)?
        if (image.width < PIXEL_WIDTH_THRESHOLD) { 
        
            // SÓ SE AMBAS as condições forem verdadeiras, a imagem será repetida.
            if (aspectRatio < VERY_NARROW_THRESHOLD) {
                defaults.imageRepetitions = 3; // Triplica se for muito fina
            } else {
                defaults.imageRepetitions = 2; // Duplica se for apenas fina
            }
            // Ajusta a largura para ocupar o espaço alvo
            defaults.imageWidthPercent = TARGET_WIDTH_PERCENT;
        }
    }
    
    return defaults;
}
// ▲▲▲ FIM DA NOVA FUNÇÃO ▲▲▲






// ▼▼▼ SUBSTITUA TODA A SUA FUNÇÃO 'drawDescLeftCustomBalloon' PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ PASSO 1: SUBSTITUA ESTA FUNÇÃO ▼▼▼
/**
 * VERSÃO CORRIGIDA E FINAL:
 * Desenha o layout com a descrição à esquerda e o balão de preço customizado à direita,
 * com ambos os elementos centralizados verticalmente para garantir a visibilidade.
 */
// ▼▼▼ SUBSTITUA PELA VERSÃO QUE APLICA A ESCALA DA DESCRIÇÃO ▼▼▼
/**
 * VERSÃO FINAL COM CONTROLE DE TAMANHO:
 * Desenha a descrição à esquerda e o balão de preço customizado à direita,
 * usando os sliders de Largura e Altura do painel para redimensionar o balão.
 */
/**
 * VERSÃO FINAL COM CONTROLE DE TAMANHO CORRIGIDO:
 * Lê os sliders de Largura/Altura do painel "Opções do Balão Customizado"
 * e os aplica ao balão no layout de descrição à esquerda.
 */
function drawDescLeftCustomBalloon(ctx, x, y, w, h, details, customBalloonName, globalOffsetY = 0) {
    ctx.save();
    const pageSettings = flyerData.pages[flyerData.currentPageIndex].settings;
    const padding = 15;
    const gap = w * 0.10;
    const descAreaWidth = w * 0.45;
    const balloonAreaWidth = w * 0.45;
    const descAreaX = x;
    const balloonAreaX = x + descAreaWidth + gap;

    // --- Lógica para desenhar a DESCRIÇÃO ---
    const descFont = pageSettings.fonts.default.productName.family;
    const descFontSize = pageSettings.fonts.default.productName.size;
    const descriptionStartY = pageSettings.fonts.default.descriptionStartY;
    const descOffsetY = pageSettings.fonts.default.descriptionOffsetY || 0;
    const descColor = '#111827';
    const descScaleX = (details.descScaleX || 100) / 100;
    const descScaleY = (details.descScaleY || 100) / 100;

    ctx.fillStyle = descColor;
    ctx.font = `bold ${descFontSize}px '${descFont}'`;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    const finalDescX = descAreaX + padding;
    const finalDescY = y + descriptionStartY + descOffsetY;
    wrapText(ctx, details.productName.toUpperCase(), finalDescX, finalDescY, descAreaWidth - (padding * 2), descFontSize * 1.2, 'left', descScaleX, descScaleY);

    // --- Lógica para desenhar o BALÃO DE PREÇO ---
    const customImg = customBalloons[customBalloonName];
    if (customImg && customImg.width > 0) {
        const allCustomSettings = pageSettings.balloonStyles.customBalloons || {};
        const styleSettings = allCustomSettings[customBalloonName] || {};
        
        const balloonWidthPercent = (styleSettings.balloonWidth || 85) / 100;
        const balloonHeightPercent = (styleSettings.balloonHeight || 85) / 100;
        const finalW = balloonAreaWidth * balloonWidthPercent;
        const aspectRatio = customImg.height / customImg.width;
        const finalH = (finalW * aspectRatio) * balloonHeightPercent;
        
        const finalX = balloonAreaX + (balloonAreaWidth - finalW) / 2;
        const finalY = y + (h - finalH) / 2 + globalOffsetY;
        
        ctx.drawImage(customImg, finalX, finalY, finalW, finalH);
        
        const priceColor = styleSettings.priceColor || '#FFFFFF';
        const priceFontSize = styleSettings.priceFontSize || 80;
        const priceOffsetX = (styleSettings.priceOffsetX || 50) / 100;
        const priceOffsetY = (styleSettings.priceOffsetY || 50) / 100;
        const priceFont = styleSettings.priceFont || 'Anton';
        const priceX = finalX + finalW * priceOffsetX;
        const priceY = finalY + finalH * priceOffsetY;
        
        ctx.fillStyle = priceColor;
        ctx.font = `bold ${priceFontSize}px '${priceFont}'`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const priceText = `R$ ${details.integerPart},${details.decimalPart}`;
        
        const textWidth = ctx.measureText(priceText).width;
        if (textWidth > finalW * 0.9) {
            const scale = (finalW * 0.9) / textWidth;
            ctx.save();
            ctx.translate(priceX, priceY);
            ctx.scale(scale, scale);
            ctx.fillText(priceText, 0, 0);
            ctx.restore();
        } else {
            ctx.fillText(priceText, priceX, priceY);
        }
    }
    
    ctx.restore();
}
// ▲▲▲ FIM DO BLOCO DE SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DO BLOCO ▲▲▲
// ▲▲▲ FIM DO BLOCO ▲▲▲
// ▲▲▲ FIM DO BLOCO ▲▲▲


// --- Conecta o botão de formatar lista à sua função ---
const formatarBotao = document.getElementById('formatarListaBtn');
if (formatarBotao) {
    formatarBotao.addEventListener('click', formatarLista);
}




// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// --- LÓGICA PARA O BOTÃO DE COPIAR A LISTA FORMATADA ---

// 1. Pega os elementos do HTML
const copyOutputBtn = document.getElementById('copyOutputBtn');
const outputListTextarea = document.getElementById('outputList');

// 2. Adiciona o evento de clique ao botão
copyOutputBtn.addEventListener('click', () => {
    const textToCopy = outputListTextarea.value;

    // Verifica se há algo para copiar
    if (!textToCopy) {
        showAlert("Nada para copiar!");
        return;
    }

    // Tenta usar a API moderna e segura de clipboard
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            showAlert("Lista copiada para a área de transferência!");
        }).catch(err => {
            console.error("Falha ao copiar com a API moderna: ", err);
            showAlert("Não foi possível copiar a lista.");
        });
    } else {
        // Fallback para navegadores mais antigos ou contextos não seguros
        try {
            outputListTextarea.select(); // Seleciona o texto
            document.execCommand('copy'); // Executa o comando de cópia
            showAlert("Lista copiada para a área de transferência!");
        } catch (err) {
            console.error("Falha ao copiar com o método antigo: ", err);
            showAlert("Não foi possível copiar a lista.");
        }
    }
});

// ▲▲▲ FIM DO BLOCO PARA COPIAR ▲▲▲


// ▼▼▼ COLE O BLOCO DE LÓGICA DA SENHA AQUI ▼▼▼

// --- LÓGICA DE PROTEÇÃO POR SENHA ---

// 1. DEFINA SUA SENHA AQUI
const SENHA_CORRETA = "Arte.com13061994*"; // Troque para uma senha de sua preferência

const passwordOverlay = document.getElementById('password-overlay');
const passwordInput = document.getElementById('password-input');
const passwordSubmit = document.getElementById('password-submit');
const passwordError = document.getElementById('password-error');

// Função para verificar a senha
// ▼▼▼ COLE ESTA NOVA VERSÃO DA FUNÇÃO ▼▼▼
function verificarSenha() {
    // Pega o checkbox DENTRO da função para garantir que temos o estado mais recente
    const rememberMeCheckbox = document.getElementById('remember-me');

    if (passwordInput.value === SENHA_CORRETA) {
        // Se a caixa "Lembrar de mim" estiver marcada...
        if (rememberMeCheckbox.checked) {
            // ...salva a autenticação no localStorage (permanente)
            localStorage.setItem('autenticado', 'true');
            // e limpa o sessionStorage por segurança.
            sessionStorage.removeItem('autenticado');
        } else {
            // ...senão, salva no sessionStorage (temporário)
            sessionStorage.setItem('autenticado', 'true');
            // e limpa o localStorage para "deslembrar" o usuário.
            localStorage.removeItem('autenticado');
        }
        // Esconde a tela de senha
        passwordOverlay.style.display = 'none';
    } else {
        // Se a senha estiver errada, mostra uma mensagem de erro
        passwordError.textContent = 'Senha incorreta. Tente novamente.';
        passwordInput.value = '';
    }
}
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// Adiciona o evento de clique ao botão
passwordSubmit.addEventListener('click', verificarSenha);

// Permite que o usuário pressione "Enter" para tentar logar
passwordInput.addEventListener('keyup', (event) => {
    if (event.key === 'Enter') {
        verificarSenha();
    }
});

// Verifica se o usuário JÁ está autenticado nesta sessão
// Isso evita que ele precise digitar a senha toda vez que recarregar a página (F5)
// ▼▼▼ SUBSTITUA A LINHA DE VERIFICAÇÃO POR ESTA ▼▼▼
if (localStorage.getItem('autenticado') === 'true' || sessionStorage.getItem('autenticado') === 'true') {
    passwordOverlay.style.display = 'none';
}

// ▲▲▲ FIM DO BLOCO DE LÓGICA DA SENHA ▲▲▲



// --- LÓGICA PARA DELETAR MÚLTIPLAS PÁGINAS ---

// 1. Pega os elementos que acabamos de criar no HTML
const multiDeletePageBtn = document.getElementById('multiDeletePageBtn');
const multiDeleteModal = document.getElementById('multiDeleteModal');
const multiDeletePageListContainer = document.getElementById('multiDeletePageListContainer');
const selectAllDeleteBtn = document.getElementById('selectAllDeleteBtn');
const deselectAllDeleteBtn = document.getElementById('deselectAllDeleteBtn');
const confirmMultiDeleteBtn = document.getElementById('confirmMultiDeleteBtn');
const cancelMultiDeleteBtn = document.getElementById('cancelMultiDeleteBtn');

/**
 * Abre o painel para selecionar as páginas a serem deletadas.
 */
function openMultiDeleteModal() {
    if (flyerData.pages.length <= 1) {
        showAlert("Você só tem uma página. Não é possível deletar.");
        return;
    }

    // Limpa a lista antiga e recria com as páginas atuais
    multiDeletePageListContainer.innerHTML = '';
    flyerData.pages.forEach((page, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'flex items-center gap-2 p-1 rounded';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `delete-page-${index}`;
        checkbox.value = index;
        checkbox.className = 'h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500';

        const label = document.createElement('label');
        label.htmlFor = `delete-page-${index}`;
        label.textContent = `Página ${index + 1}`;
        label.className = 'text-sm cursor-pointer flex-grow';

        // Impede que o usuário selecione a página que está vendo atualmente
        if (index === flyerData.currentPageIndex) {
            checkbox.disabled = true;
            itemDiv.classList.add('opacity-50');
        }

        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        multiDeletePageListContainer.appendChild(itemDiv);
    });

    // Mostra o painel
    multiDeleteModal.classList.add('visible');
}

/**
 * Executa a exclusão das páginas selecionadas.
 */
function executeMultiDelete() {
    const checkedBoxes = document.querySelectorAll('#multiDeletePageListContainer input[type="checkbox"]:checked');
    if (checkedBoxes.length === 0) {
        showAlert("Nenhuma página foi selecionada para exclusão.");
        return;
    }

    // Pega os índices (números das páginas) para deletar
    const indexesToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.value, 10));

    showConfirm(`Você tem certeza que deseja deletar ${indexesToDelete.length} página(s)? Esta ação não pode ser desfeita.`, (confirmed) => {
        if (confirmed) {
            // IMPORTANTE: Deleta as páginas da última para a primeira para não errar os índices
            indexesToDelete.sort((a, b) => b - a).forEach(index => {
                flyerData.pages.splice(index, 1);
            });

            // Após deletar, volta para a primeira página por segurança
            switchPage(0, false);
            
            // Fecha o painel e mostra mensagem de sucesso
            multiDeleteModal.classList.remove('visible');
            showAlert(`${indexesToDelete.length} página(s) foram deletadas com sucesso.`);
        }
    });
}

// Conecta as funções aos botões
multiDeletePageBtn.addEventListener('click', openMultiDeleteModal);
cancelMultiDeleteBtn.addEventListener('click', () => multiDeleteModal.classList.remove('visible'));
confirmMultiDeleteBtn.addEventListener('click', executeMultiDelete);

selectAllDeleteBtn.addEventListener('click', () => {
    document.querySelectorAll('#multiDeletePageListContainer input:not(:disabled)').forEach(cb => cb.checked = true);
});

deselectAllDeleteBtn.addEventListener('click', () => {
    document.querySelectorAll('#multiDeletePageListContainer input').forEach(cb => cb.checked = false);
});

// ▲▲▲ FIM DO BLOCO ▲▲▲



// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// --- LÓGICA DE EXPORTAÇÃO E IMPORTAÇÃO DO BANCO DE DADOS DE ESTOQUE ---

// 1. Pega os novos botões que criamos no HTML
const exportDbBtn = document.getElementById('exportDbBtn');
const importDbBtn = document.getElementById('importDbBtn');
const importDbInput = document.getElementById('importDbInput');

// 2. Lógica do botão "Exportar"
exportDbBtn.addEventListener('click', () => {
    if (Object.keys(productDatabase).length === 0) {
        showAlert("Seu banco de dados de produtos está vazio. Não há nada para exportar.");
        return;
    }

    // Converte o objeto do banco de dados para um texto no formato JSON
    const dbJson = JSON.stringify(productDatabase, null, 2);
    // Cria um arquivo virtual na memória
    const blob = new Blob([dbJson], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    // Cria um link temporário para fazer o download
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_produtos_encarte.json`; // Nome do arquivo de backup
    a.click(); // Simula o clique para baixar

    // Limpa o link da memória
    URL.revokeObjectURL(url);
    showAlert("Arquivo de backup gerado com sucesso! Salve-o em um lugar seguro.");
});

// 3. O botão "Importar" apenas aciona o clique no seletor de arquivo escondido
importDbBtn.addEventListener('click', () => {
    importDbInput.click();
});

// 4. Lógica que executa quando um arquivo de backup é selecionado
importDbInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedDb = JSON.parse(e.target.result);

            showConfirm("Deseja substituir seu banco de dados atual pelo do arquivo ou juntar os dois? (Juntar manterá os produtos atuais e apenas adicionará/atualizará os do arquivo).", (confirmed) => {
                if (confirmed === null) return; // Ação cancelada pelo usuário

                if (confirmed) { // Opção: JUNTAR
                    productDatabase = { ...productDatabase, ...importedDb };
                } else { // Opção: SUBSTITUIR
                    productDatabase = importedDb;
                }

                // Salva o banco de dados atualizado e atualiza a tela
                syncProductDatabase();
                populateStockList();
                showAlert("Banco de dados importado e atualizado com sucesso!");
            }, "Juntar", "Substituir"); // Textos customizados para os botões de confirmação

        } catch (error) {
            showAlert("Erro ao importar. O arquivo parece não ser um backup válido.");
            console.error(error);
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Limpa o input para poder importar o mesmo arquivo novamente
});

// ▲▲▲ FIM DO BLOCO ▲▲▲

// ▼▼▼ NOVO BLOCO DE LÓGICA PARA O MODAL DE BUSCA DE IMAGEM ▼▼▼

const imageSearchModal = document.getElementById('imageSearchModal');
const imageSearchInput = document.getElementById('imageSearchInput');
const imageSearchResults = document.getElementById('imageSearchResults');
const useSelectedImageBtn = document.getElementById('useSelectedImageBtn');
const cancelImageSearchBtn = document.getElementById('cancelImageSearchBtn');
const triggerFileUploadBtn = document.getElementById('triggerFileUploadBtn');

let productIndexToUpdate = null; // Guarda o índice do produto que estamos editando

/**
 * Abre o modal de busca, guarda o índice do produto e popula a lista.
 * @param {number} index - O índice do produto na lista do encarte.
 */
function openImageSearchModal(index) {
    productIndexToUpdate = index;
    imageSearchInput.value = '';
    populateImageSearchResults(''); // Mostra todos os produtos inicialmente
    imageSearchModal.classList.add('visible');
}

/**
 * Popula a grade de resultados de imagem com base em um filtro de busca.
 * @param {string} filter - O texto digitado pelo usuário.
 */
function populateImageSearchResults(filter = '') {
    imageSearchResults.innerHTML = '';
    useSelectedImageBtn.disabled = true;
    const normalizedFilter = normalizeString(filter);

    const products = Object.values(productDatabase)
        .filter(p => normalizeString(p.name).includes(normalizedFilter))
        .sort((a, b) => a.name.localeCompare(b.name));

    if (products.length === 0) {
        imageSearchResults.innerHTML = '<p class="col-span-full text-center text-gray-500 py-4">Nenhum produto encontrado.</p>';
        return;
    }

    products.forEach(product => {
        const item = document.createElement('div');
        item.className = 'result-item flex flex-col items-center p-2 rounded-lg bg-white dark:bg-gray-800';
        item.dataset.productName = product.name;

        const img = document.createElement('img');
        img.src = product.src;
        img.className = 'w-20 h-20 object-contain mb-2';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = product.name;
        nameSpan.className = 'text-xs text-center';

        item.appendChild(img);
        item.appendChild(nameSpan);

        item.addEventListener('click', () => {
            // Remove a seleção de qualquer outro item e seleciona o clicado
            document.querySelectorAll('#imageSearchResults .result-item.selected').forEach(el => el.classList.remove('selected'));
            item.classList.add('selected');
            useSelectedImageBtn.disabled = false;
        });

        imageSearchResults.appendChild(item);
    });
}

// Evento de digitação na busca
imageSearchInput.addEventListener('keyup', () => {
    populateImageSearchResults(imageSearchInput.value);
});

// Evento do botão "Cancelar"
cancelImageSearchBtn.addEventListener('click', () => {
    imageSearchModal.classList.remove('visible');
    productIndexToUpdate = null;
});

// Evento do botão "Fazer Upload"
triggerFileUploadBtn.addEventListener('click', () => {
    if (productIndexToUpdate !== null) {
        // Clica no input de arquivo escondido correspondente ao produto
        document.getElementById(`edit-image-${productIndexToUpdate}`).click();
    }
    imageSearchModal.classList.remove('visible');
});

// Evento do botão "Usar Imagem Selecionada"
useSelectedImageBtn.addEventListener('click', () => {
    const selectedItem = imageSearchResults.querySelector('.result-item.selected');
    if (!selectedItem || productIndexToUpdate === null) return;

    const productName = selectedItem.dataset.productName;
    const productData = productDatabase[productName];
    const currentPage = flyerData.pages[flyerData.currentPageIndex];

    if (productData && currentPage.products[productIndexToUpdate]) {
        showSpinner(true);
        const newImage = new Image();
        newImage.onload = () => {
            const productToUpdate = currentPage.products[productIndexToUpdate];
            productToUpdate.image = newImage;
            productToUpdate.src = newImage.src;
            
            // Recalcula os padrões inteligentes para a nova imagem
            const smartDefaults = calculateSmartImageDefaults(newImage);
            Object.assign(productToUpdate, smartDefaults);
            
            redrawCanvas();
            updateProductListUI();
            imageSearchModal.classList.remove('visible');
            productIndexToUpdate = null;
            showSpinner(false);
        };
        newImage.onerror = () => {
            showAlert("Erro ao carregar a imagem selecionada.");
            showSpinner(false);
        };
        newImage.src = productData.src;
    }
});
// ▲▲▲ FIM DO BLOCO ▲▲▲





window.onload = initialize;











// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// Ação do botão "Salvar Produtos no Banco de Dados"
// ▼▼▼ SUBSTITUA PELA VERSÃO SIMPLIFICADA ▼▼▼
// Ação do botão "Salvar Produtos no Banco de Dados"
// ▼▼▼ SUBSTITUA PELA VERSÃO SIMPLIFICADA ▼▼▼
saveProductsToDbBtn.addEventListener('click', async () => {
    const productsToSave = flyerData.pages.flatMap(p => p.products);
    if (productsToSave.length === 0) {
        showAlert('Não há produtos no encarte para salvar.');
        return;
    }

    showSpinner(true);
    let newProductsCount = 0;
    productsToSave.forEach(p => {
        if (p.name && !productDatabase[p.name]) {
            newProductsCount++;
        }
        if (p.name && p.src) { // Salva apenas se tiver nome e imagem
           // CORREÇÃO AQUI: Adicionado "name: p.name"
           productDatabase[p.name] = { name: p.name, price: p.price, src: p.src };
        }
    });

    // Chama a função de sincronização corrigida
    await syncProductDatabase();

    showAlert(`${newProductsCount} novos produtos foram adicionados/atualizados no banco de dados!`);
    showSpinner(false);
});
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲






// =================================================================
// --- BLOCO CORRIGIDO DO BOTÃO "BUSCAR E ADICIONAR AO ENCARTE" ---
// =================================================================




// =================================================================
// --- VERSÃO FINAL DO BOTÃO "BUSCAR E ADICIONAR AO ENCARTE" ---
// =================================================================
// =====================================================================
// --- VERSÃO FINAL E DEFINITIVA DO BOTÃO DE BUSCA INTELIGENTE ---
// =====================================================================
// =====================================================================
// --- VERSÃO FINAL E DEFINITIVA DO BOTÃO DE BUSCA INTELIGENTE (COM ORDEM CORRETA) ---
// =====================================================================
// =====================================================================
// --- VERSÃO FINAL (COM CRIAÇÃO DE SLOT) DO BOTÃO DE BUSCA INTELIGENTE ---
// =====================================================================
// =====================================================================
// --- BOTÃO DE BUSCA INTELIGENTE COM NOME DA LISTA ---
// =====================================================================
// =======================================================
// ====== BUSCA INTELIGENTE COM SEPARADOR ÚNICO (;) ======
// =======================================================
// COLE ESTE BLOCO CORRIGIDO NO LUGAR DO ANTIGO
searchDbBtn.addEventListener('click', async () => {
    const queries = productSearchTextarea.value.trim().split('\n').filter(q => q.trim());
    if (queries.length === 0) {
        showAlert('Digite os nomes dos produtos que deseja buscar.');
        return;
    }

    showSpinner(true);

    const productPromises = queries.map(query => new Promise(async (resolve) => {
        let nameFromList = '';
        let pricePart = '0.00';

        if (query.includes(';')) {
            const parts = query.split(';');
            nameFromList = parts[0].trim();
            const priceText = parts[1] ? parts[1].trim() : '0';
            const parsedPrice = parseFloat(priceText.replace(',', '.'));
            if (!isNaN(parsedPrice)) {
                pricePart = parsedPrice.toFixed(2);
            }
        } else {
            nameFromList = query.trim();
        }

        const bestMatchName = findBestMatchInDb(nameFromList);

        if (bestMatchName) {
            const productData = productDatabase[bestMatchName];

            // ===== INÍCIO DA CORREÇÃO =====
            // Se um preço foi informado na busca, usa ele. 
            // Senão, usa o do banco de dados, e se não houver, usa '0.00' como último recurso.
            const priceForFlyer = pricePart !== '0.00' ? pricePart : (productData.price || '0.00');
            // ===== FIM DA CORREÇÃO =====

            const img = new Image();
            img.onload = () => resolve({ name: nameFromList, price: priceForFlyer, src: productData.src, image: img });
            img.onerror = () => resolve({ name: nameFromList, price: priceForFlyer, src: productData.src, image: null });
            img.src = productData.src;
        } else {
            resolve({
                name: nameFromList,
                price: pricePart,
                src: null,
                image: null
            });
        }
    }));

    const productsToAdd = await Promise.all(productPromises);

    if (productsToAdd.length > 0) {
        productsToAdd.forEach(p => addProductWithDefaults(p));
        productSearchTextarea.value = '';
        updateProductListUI();
        redrawCanvas();
        showAlert(`${productsToAdd.length} produto(s) adicionado(s) ao encarte!`);
    } else {
        showAlert('Não foi possível processar nenhum produto da lista.');
    }
    showSpinner(false);
});



// =======================================================
// ====== FUNÇÃO DE BUSCA INTELIGENTE ATUALIZADA =========
// =======================================================


// =======================================================
// ====== NOVA FUNÇÃO PARA REMOVER ACENTOS (NORMALIZAR) ======
// =======================================================
function normalizeString(str) {
    if (!str) return '';
    return str
        .normalize("NFD") // Separa os caracteres dos acentos
        .replace(/[\u0300-\u036f]/g, "") // Remove os acentos
        .toUpperCase() // Converte para maiúsculas
        .replace(/,/g, ''); // Remove vírgulas
}



// =======================================================
// ====== FUNÇÃO DE BUSCA INTELIGENTE 2.0 ATUALIZADA ======
// =======================================================
// =======================================================
// ====== FUNÇÃO DE BUSCA INTELIGENTE 3.0 (CORRIGIDA) ======
// =======================================================
function findBestMatchInDb(query) {
    if (!query) return null;

    // Normaliza o nome do produto que você está buscando
    const nameQuery = query.split(';')[0].trim();
    const queryWords = new Set(normalizeString(nameQuery).split(' ').filter(Boolean));

    if (queryWords.size === 0) return null;

    let bestMatch = null;
    let highestScore = 0;

    // Itera por todos os produtos no seu banco de dados
    for (const dbProductName in productDatabase) {
        const dbWords = new Set(normalizeString(dbProductName).split(' ').filter(Boolean));
        if (dbWords.size === 0) continue;

        // Encontra as palavras em comum
        const intersection = new Set([...queryWords].filter(word => dbWords.has(word)));

        // Calcula a pontuação de correspondência usando o Coeficiente de Dice.
        // Este método é ótimo para lidar com palavras extras ou faltantes.
        const diceCoefficient = (2 * intersection.size) / (queryWords.size + dbWords.size);

        // Se a pontuação for a maior até agora, guarda como a melhor correspondência
        if (diceCoefficient > highestScore) {
            highestScore = diceCoefficient;
            bestMatch = dbProductName;
        }
    }

    // Retorna a melhor correspondência apenas se a pontuação for boa o suficiente (acima de 60%)
    // Isso evita que o sistema retorne um produto totalmente errado.
    if (highestScore > 0.6) {
        return bestMatch;
    }

    return null;
}
		
		
		
		
		// =================================================================
// --- LÓGICA DO PAINEL DE ESTOQUE (BD DE PRODUTOS) ---
// =================================================================


// =======================================================
// ========= COLE ESTE BLOCO DE VARIÁVEIS FALTANTES ========
// =======================================================
// Pega os novos elementos do painel de estoque
const registerFromFolderBtn = document.getElementById('registerFromFolderBtn');
const folderInput = document.getElementById('folderInput');
const stockProductList = document.getElementById('stockProductList');
const stockDbLabel = document.getElementById('stockDbLabel');
const refreshStockListBtn = document.getElementById('refreshStockListBtn');



// Função para exibir a lista de produtos do banco de dados no painel
// =======================================================
// ====== FUNÇÃO ATUALIZADA PARA POPULAR O ESTOQUE =======
// =======================================================
// ▼▼▼ SUBSTITUA SUA FUNÇÃO ANTIGA POR ESTA ▼▼▼
function populateStockList() {
    stockProductList.innerHTML = '';
    
    // Mantém a lógica de exibir o status da nuvem
    if (userId) {
        updateSyncStatusUI(); // Atualiza o texto e cor do título
    } else {
        stockDbLabel.innerHTML = 'Produtos (Local)';
    }

    if (Object.keys(productDatabase).length === 0) {
        stockProductList.innerHTML = '<p class="col-span-3 text-center text-sm text-gray-500 py-4">Nenhum produto cadastrado.</p>';
        return;
    }
    
    const sortedProductNames = Object.keys(productDatabase).sort();

    for (const productName of sortedProductNames) {
        const product = productDatabase[productName];
        const card = document.createElement('div');
        card.className = 'bg-white dark:bg-gray-800 p-2 rounded-lg shadow flex flex-col items-center text-center relative';
        
        // --- INÍCIO DA MODIFICAÇÃO: Adiciona os botões de ação ---
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'absolute top-1 right-1 flex flex-col space-y-1';

        const editBtn = document.createElement('button');
        editBtn.className = 'edit-stock-btn p-1 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-transform hover:scale-110';
        editBtn.title = 'Editar Produto';
        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>`;
        editBtn.dataset.productName = productName;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-stock-btn p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition-transform hover:scale-110';
        deleteBtn.title = 'Excluir Produto';
        deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>`;
        deleteBtn.dataset.productName = productName;
        
        controlsDiv.appendChild(editBtn);
        controlsDiv.appendChild(deleteBtn);
        // --- FIM DA MODIFICAÇÃO ---
        
        const img = document.createElement('img');
        img.src = product.src || 'https://placehold.co/100x100/e2e8f0/adb5bd?text=Sem+Foto';
        img.className = 'w-20 h-20 object-contain rounded-md mb-2';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = productName;
        nameSpan.className = 'text-xs font-semibold break-words';
        
        card.appendChild(controlsDiv); // Adiciona os botões ao card
        card.appendChild(img);
        card.appendChild(nameSpan);
        stockProductList.appendChild(card);
    }
}



// O botão "Cadastrar via Pasta" aciona o campo de seleção de pasta
registerFromFolderBtn.addEventListener('click', () => {
    folderInput.click();
});

// ▼▼▼ SUBSTITUA O ANTIGO 'addEventListener' DESTE BOTÃO POR ESTE NOVO BLOCO ▼▼▼
refreshStockListBtn.addEventListener('click', () => {
    // Se não estiver sincronizado, o botão funciona para SALVAR.
    // Se já estiver sincronizado, ele funciona para RECARREGAR a lista da nuvem.
    if (!isDatabaseSynced) {
        syncProductDatabase();
    } else {
        loadProductDatabase();
    }
});


// Processa a pasta selecionada pelo usuário
// ▼▼▼ SUBSTITUA PELA VERSÃO SIMPLIFICADA ▼▼▼
// ▼▼▼ COLE ESTA NOVA VERSÃO DO EVENTO ▼▼▼
folderInput.addEventListener('change', async (event) => {
    const files = event.target.files;
    if (!files.length) return;

    showSpinner(true);
    showAlert('Cadastrando produtos... Isso pode levar um momento.');

    const newProducts = {};
    const fileReadPromises = Array.from(files).map(file => new Promise((resolve) => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const productName = file.name.substring(0, file.name.lastIndexOf('.')) || file.name;
                // Adiciona apenas se não existir, para não sobreescrever dados de preço
                                if (!productDatabase[productName]) {

                   newProducts[productName] = {
                        name: productName,
                        price: "0.00",
                        src: e.target.result
                    };
                }
                resolve();
            };
            reader.onerror = () => resolve();
            reader.readAsDataURL(file);
        } else {
            resolve();
        }
    }));

    await Promise.all(fileReadPromises);

    // Adiciona os novos produtos ao banco de dados local
    Object.assign(productDatabase, newProducts);

    // Chama a função de sincronia e AGUARDA o resultado
    const success = await syncProductDatabase();

    if (success) {
        showAlert(`${Object.keys(newProducts).length} produtos foram cadastrados/atualizados com sucesso!`);
    } else {
        showAlert(`Falha ao salvar os produtos. Verifique as permissões e tente novamente.`);
    }

    folderInput.value = ''; // Limpa o seletor de arquivos
});
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
		
		
		
		// =================================================================
// --- LÓGICA DE EDIÇÃO E EXCLUSÃO DO ESTOQUE ---
// =================================================================

// Pega o novo botão "Deletar Tudo"
const deleteAllStockBtn = document.getElementById('deleteAllStockBtn');

// Função para Sincronizar (Salvar) o banco de dados
// ▼▼▼ SUBSTITUA PELA VERSÃO CORRIGIDA E ROBUSTA ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO 'syncProductDatabase' PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO "syncProductDatabase" INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'syncProductDatabase' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'syncProductDatabase' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'syncProductDatabase' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲

// Ação do botão "Deletar TODO o Estoque"
// ▼▼▼ SUBSTITUA AS DUAS FUNÇÕES DE EVENTO DE ESTOQUE POR ESTE BLOCO ▼▼▼
deleteAllStockBtn.addEventListener('click', () => {

// ▼▼▼ ADICIONE ESTE NOVO BLOCO DE LÓGICA DE CLIQUE ▼▼▼


    showConfirm("TEM CERTEZA? Isso apagará TODOS os produtos do seu banco de dados. Esta ação não pode ser desfeita.", async (confirmed) => {
        if (confirmed) {
            showSpinner(true);
            productDatabase = {};
            await syncProductDatabase(); // Usa a função corrigida
            populateStockList();
            showSpinner(false);
            showAlert("Todos os produtos do estoque foram deletados.");
        }
    });
});

stockProductList.addEventListener('click', (e) => {
    const targetButton = e.target.closest('button');
    if (!targetButton) return;
    const productName = targetButton.dataset.productName;

    if (targetButton.classList.contains('delete-stock-btn')) {
        showConfirm(`Deseja realmente deletar "${productName}" do seu estoque?`, (confirmed) => {
            if (confirmed) {
                delete productDatabase[productName];
                isDatabaseSynced = false; // ALTERAÇÃO AQUI
                updateSyncStatusUI(); // ALTERAÇÃO AQUI
                populateStockList();
                showAlert(`"${productName}" deletado. Clique no botão de nuvem para salvar as alterações.`);
            }
        });
    }

    if (targetButton.classList.contains('edit-stock-btn')) {
        const product = productDatabase[productName];
        if (!product) return;
        // ... (o código do modal de edição continua o mesmo) ...
        document.getElementById('modalMessage').textContent = `Editando: ${productName}`;
        document.getElementById('modal-edit-form').classList.remove('hidden');
        document.getElementById('originalProductNameInput').value = productName;
        document.getElementById('editProductNameInput').value = productName;
        document.getElementById('editProductPriceInput').value = product.price;
        document.getElementById('editProductImagePreview').src = product.src || 'https://placehold.co/100x100/e2e8f0/adb5bd?text=Sem+Foto';
        document.getElementById('editProductImageInput').value = '';
        modalOkBtn.style.display = 'none';
        modalCancelBtn.style.display = 'inline-block';
        modalConfirmBtn.style.display = 'inline-block';
        modalConfirmBtn.textContent = 'Salvar Alterações';

        modalConfirmBtn.onclick = async () => {
            const originalName = document.getElementById('originalProductNameInput').value;
            const newName = document.getElementById('editProductNameInput').value.trim();
            const newPrice = parseFloat(document.getElementById('editProductPriceInput').value).toFixed(2);
            const newImageFile = document.getElementById('editProductImageInput').files[0];
            if (!newName || isNaN(newPrice)) { showAlert("Nome e preço são obrigatórios."); return; }
            
            let newSrc = productDatabase[originalName].src;
            if (newImageFile) {
                newSrc = await new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(newImageFile);
                });
            }
            if (originalName !== newName) { delete productDatabase[originalName]; }
             productDatabase[newName] = { name: newName, price: newPrice, src: newSrc };
            
            isDatabaseSynced = false; // ALTERAÇÃO AQUI
            updateSyncStatusUI();     // ALTERAÇÃO AQUI
            populateStockList();      // ALTERAÇÃO AQUI
            customModal.classList.remove('visible');
            showAlert("Produto atualizado. Lembre-se de sincronizar com a nuvem.");
        };
        modalCancelBtn.onclick = () => customModal.classList.remove('visible');
        customModal.classList.add('visible');
    }
});
// ▲▲▲ FIM DA SUBSTITUIÇÃO ▲▲▲
		
		
		
		// ▼▼▼ COLE ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

deselectAllProductsBtn.addEventListener('click', () => {
    // 1. Limpa a lista de produtos selecionados
    selectedProductIndices.clear();

    // 2. Destrava o painel lateral para o usuário poder navegar para outros menus
    isPanelLocked = false;
    menuBackdrop.style.pointerEvents = 'auto';

    // 3. Sincroniza a interface, desmarcando todas as caixas de seleção
    syncImagePanelSelection();

    // 4. Esconde os sliders de controle de imagem, já que nada está selecionado
    updateImageControlsUI();

    // 5. Redesenha o encarte para remover os destaques azuis de seleção
    redrawCanvas();
});

// ▲▲▲ FIM DO BLOCO ▲▲▲
		
		
		
		// ▼▼▼ ADICIONE ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

selectAllProductsBtn.addEventListener('click', () => {
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (!currentPage || currentPage.products.length === 0) return;

    // 1. Adiciona todos os produtos da página atual à lista de seleção
    for (let i = 0; i < currentPage.products.length; i++) {
        selectedProductIndices.add(i);
    }

    // 2. Trava o painel, pois o modo de edição múltipla está ativo
    isPanelLocked = true;
    menuBackdrop.style.pointerEvents = 'none';

    // 3. Atualiza a interface (marcando as caixas, mostrando os sliders e o destaque)
    syncImagePanelSelection();
    updateImageControlsUI();
    redrawCanvas();
});

// ▲▲▲ FIM DO BLOCO ▲▲▲


// (Aqui embaixo fica o código do botão de desselecionar que você já adicionou)
deselectAllProductsBtn.addEventListener('click', () => {
    // ...
});
		
		// ▼▼▼ ADICIONE ESTA NOVA FUNÇÃO AO SEU CÓDIGO ▼▼▼
// ▼▼▼ SUBSTITUA A FUNÇÃO 'updateCustomBalloonPanelUI' INTEIRA POR ESTA ▼▼▼
function updateCustomBalloonPanelUI() {
    const currentPage = flyerData.pages[flyerData.currentPageIndex];
    if (!currentPage) return;

    let activeCustomBalloonName = null;
    const firstStyle = firstLineBalloonStyleSelect.value;
    const otherStyle = otherLinesBalloonStyleSelect.value;

    if (firstStyle.startsWith('custom_')) {
        activeCustomBalloonName = firstStyle.replace('custom_', '');
    } else if (otherStyle.startsWith('custom_')) {
        activeCustomBalloonName = otherStyle.replace('custom_', '');
    }

    if (activeCustomBalloonName) {
        const allCustomSettings = currentPage.settings.balloonStyles.customBalloons || {};
        const settingsForActive = allCustomSettings[activeCustomBalloonName] || {};
document.getElementById('customBalloonPriceFont').value = settingsForActive.priceFont || 'Anton'; // <-- ADICIONE ESTA LINHA
        document.getElementById('customBalloonDescLeftToggle').checked = settingsForActive.descLeftLayout || false;
        document.getElementById('customBalloonPriceColor').value = settingsForActive.priceColor || '#FFFFFF';
        document.getElementById('customBalloonWidth').value = settingsForActive.balloonWidth || 85;
        document.getElementById('customBalloonHeight').value = settingsForActive.balloonHeight || 85; // <-- ADICIONE ESTA LINHA
        document.getElementById('customBalloonPriceFontSize').value = settingsForActive.priceFontSize || 80;
        document.getElementById('customBalloonPriceOffsetX').value = settingsForActive.priceOffsetX || 50;
        document.getElementById('customBalloonPriceOffsetY').value = settingsForActive.priceOffsetY || 50;
    }
}
		
		
		
		
		// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// --- LÓGICA PARA DUPLICAR A PÁGINA ATUAL SEM OS PRODUTOS ---

// Pega o novo botão que criamos no HTML
const duplicatePageBtn = document.getElementById('duplicatePageBtn');

/**
 * Cria uma cópia da página atual, mas com a lista de produtos vazia.
 * A nova página é inserida logo após a página atual.
 */
function duplicateCurrentPage() {
    // Garante que as últimas alterações da página atual sejam salvas antes de duplicar
    saveCurrentPageSettings();

    // Pega o objeto da página atual
    const currentPage = flyerData.pages[flyerData.currentPageIndex];

    // Cria uma cópia profunda (deep copy) de todas as configurações da página.
    // Isso garante que a nova página seja totalmente independente.
    const newPage = JSON.parse(JSON.stringify(currentPage));

    // Copia a referência da imagem de fundo (que não é copiada pelo JSON.stringify)
    newPage.backgroundImage = currentPage.backgroundImage;
    
    // Zera a lista de produtos da nova página, conforme solicitado
    newPage.products = [];

    // Adiciona a nova página ao array de páginas, logo após a atual
    const newPageIndex = flyerData.currentPageIndex + 1;
    flyerData.pages.splice(newPageIndex, 0, newPage);

    // Muda a visualização para a página recém-criada
    switchPage(newPageIndex);
    
    showAlert('Página duplicada com sucesso! Adicione novos produtos.');
}

// Adiciona o evento de clique ao novo botão
duplicatePageBtn.addEventListener('click', duplicateCurrentPage);

// ▲▲▲ FIM DO BLOCO ▲▲▲
		
		
		
		
	// ▼▼▼ COLE TODO ESTE BLOCO NO FINAL DO SEU SCRIPT ▼▼▼

// --- LÓGICA PARA ATUALIZAR DESCRIÇÕES EM LOTE ---

// Pega o novo botão que criamos no HTML
const descriptionUpdateBtn = document.getElementById('descriptionUpdateBtn');

/**
 * Lê uma lista de "nome antigo; nova descrição" e atualiza os nomes dos produtos
 * em todas as páginas do encarte.
 */
// ▼▼▼ SUBSTITUA A FUNÇÃO ANTIGA POR ESTA NOVA FUNÇÃO ▼▼▼

/**
 * Sincroniza o encarte inteiro com base em uma lista de texto.
 * Atualiza descrições, reordena produtos e remove os que não estão na lista.
 */
// ▼▼▼ COLE ESTA NOVA FUNÇÃO AUXILIAR ▼▼▼

/**
 * Encontra o produto com o nome mais parecido dentro de uma lista de produtos do encarte.
 * Usa a mesma lógica de "busca por aproximação" do banco de dados.
 * @param {string} queryName - O nome do produto que estamos procurando.
 * @param {Array} productList - A lista de produtos do encarte onde procurar.
 * @returns {object|null} O objeto do produto encontrado ou null.
 */
function findBestMatchInFlyer(queryName, productList) {
    if (!queryName || productList.length === 0) return null;

    const queryWords = new Set(normalizeString(queryName).split(' ').filter(Boolean));
    if (queryWords.size === 0) return null;

    let bestMatch = null;
    let highestScore = 0;

    for (const product of productList) {
        const productWords = new Set(normalizeString(product.name).split(' ').filter(Boolean));
        if (productWords.size === 0) continue;

        const intersection = new Set([...queryWords].filter(word => productWords.has(word)));
        const diceCoefficient = (2 * intersection.size) / (queryWords.size + productWords.size);

        if (diceCoefficient > highestScore) {
            highestScore = diceCoefficient;
            bestMatch = product;
        }
    }

    // Retorna a melhor correspondência apenas se a pontuação for razoável (acima de 60%)
    if (highestScore > 0.6) {
        return bestMatch;
    }
    return null;
}

// ▲▲▲ FIM DA NOVA FUNÇÃO ▲▲▲

// Adiciona o evento de clique ao novo botão
descriptionUpdateBtn.addEventListener('click', syncFlyerWithList);
// ▲▲▲ FIM DO BLOCO ▲▲▲	
		
		


// ▼▼▼ COLE ESTA NOVA FUNÇÃO NO SEU SCRIPT ▼▼▼

/**
 * Gera páginas de cartaz de preço a partir de uma lista de texto.
 * Busca as imagens no banco de dados de estoque.
 */
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO "generatePostersFromList" INTEIRA PELA VERSÃO ABAIXO ▼▼▼

/**
 * Gera páginas de cartaz de preço a partir de uma lista de texto.
 * Se o produto existe no banco de dados, carrega sua imagem.
 * Se não existe, cria um cartaz apenas com nome e preço.
 */
// ▼▼▼ SUBSTITUA A FUNÇÃO INTEIRA PELA VERSÃO CORRIGIDA ABAIXO ▼▼▼
async function generatePostersFromList() {
    const text = document.getElementById('priceTagListTextarea').value.trim();
    if (!text) {
        showAlert("Por favor, cole a lista de produtos na área de texto.");
        return;
    }

    showSpinner(true);
    showAlert("Gerando cartazes... Buscando imagens no banco de dados.");

    // --- INÍCIO DA CORREÇÃO ---
    // 1. Lê o valor do espaçamento diretamente do campo da interface
    const lineSpacingValue = parseFloat(document.getElementById('priceTagLineSpacing').value) || 1.2;
    // --- FIM DA CORREÇÃO ---

    const lines = text.split('\n').filter(line => line.trim());
    const productPromises = lines.map(line => new Promise(async (resolve) => {
        const parts = line.split(';');
        const name = parts[0].trim();
        let price = '0.00';
        if (parts.length > 1 && parts[1].trim()) {
            const parsedPrice = parseFloat(parts[1].trim().replace(',', '.'));
            if (!isNaN(parsedPrice)) {
                price = parsedPrice.toFixed(2);
            }
        }

        const dbMatchName = findBestMatchInDb(name);
        if (dbMatchName && productDatabase[dbMatchName]) {
            const dbProduct = productDatabase[dbMatchName];
            const img = new Image();
            img.onload = () => resolve({ name: name, price: price, src: dbProduct.src, image: img });
            img.onerror = () => resolve({ name: name, price: price, src: null, image: null });
            img.src = dbProduct.src;
        } else {
            resolve({ name: name, price: price, src: null, image: null });
        }
    }));

    const productsForPosters = (await Promise.all(productPromises)).filter(Boolean);

    if (productsForPosters.length === 0) {
        showSpinner(false);
        showAlert("Nenhum produto válido encontrado na lista. Verifique o formato NOME; PREÇO.");
        return;
    }

    const templatePage = flyerData.pages[flyerData.currentPageIndex];
    const templateSettings = JSON.parse(JSON.stringify(templatePage.settings));

    productsForPosters.forEach(product => {
        const newPriceTagPage = createDefaultPage();
        newPriceTagPage.settings = JSON.parse(JSON.stringify(templateSettings));
        
        newPriceTagPage.settings.pageSize = 'custom';
        newPriceTagPage.settings.customWidth = 3780;
        newPriceTagPage.settings.customHeight = 5315;
        
        newPriceTagPage.settings.margins = {
           top: 1370,
                lateral: 150,
                footer: 150
        };
        
        const headerValiditySettings = newPriceTagPage.settings.headerValidity;
        headerValiditySettings.enabled = true;
        headerValiditySettings.fontSizeStartDate = 110;
        headerValiditySettings.fontSizeDates = 110;
        headerValiditySettings.fontSizeStock = 85;
        headerValiditySettings.dateToStockSpacing = -431;
        headerValiditySettings.width = 1000;
        headerValiditySettings.x = 2792;
        headerValiditySettings.y = -12;
        headerValiditySettings.lineSpacing = -3;
        headerValiditySettings.headerSeparatorSpacing = 10;
        
        // --- INÍCIO DA CORREÇÃO ---
        // 2. Garante que o objeto pricePoster exista e aplica o valor lido
        if (!newPriceTagPage.settings.pricePoster) {
            newPriceTagPage.settings.pricePoster = {};
        }
        newPriceTagPage.settings.pricePoster.lineSpacing = lineSpacingValue;
        // --- FIM DA CORREÇÃO ---

        if (templatePage.backgroundImage) {
            newPriceTagPage.backgroundImage = templatePage.backgroundImage;
            newPriceTagPage.backgroundImageSrc = templatePage.backgroundImageSrc;
        }

        newPriceTagPage.products = [ { ...product } ];
        newPriceTagPage.isPricePoster = true;
        newPriceTagPage.manualLayout = [];
        
        flyerData.pages.push(newPriceTagPage);
    });

    const firstNewPageIndex = flyerData.pages.length - productsForPosters.length;
    switchPage(firstNewPageIndex, true);

    showSpinner(false);
    showAlert(`${productsForPosters.length} cartaz(es) de preço gerado(s) com sucesso como novas páginas!`);
}





// ▼▼▼ SUBSTITUA A FUNÇÃO syncFlyerWithList PELA VERSÃO FINAL E CORRETA ABAIXO ▼▼▼

async function syncFlyerWithList() {
    const text = document.getElementById('descriptionUpdateTextarea').value.trim();
    if (!text) {
        showAlert("Por favor, cole a lista de produtos na área de texto.");
        return;
    }

    const pageIndex = flyerData.currentPageIndex;
    const currentPage = flyerData.pages[pageIndex];

    showConfirm(`Isso irá sincronizar a PÁGINA ATUAL (${pageIndex + 1}) com a lista (adicionando, atualizando, reordenando e deletando produtos). As outras páginas não serão afetadas. Deseja continuar?`, async (confirmed) => {
        if (!confirmed) return;

        showSpinner(true);
        showAlert("Sincronizando página atual... Isso pode levar um momento.");

        // ETAPA 1: Ler a lista do textarea
        const sourceList = text.split('\n').filter(line => line.trim()).map((line, index) => {
            const parts = line.split(';');
            const name = parts[0].trim();
            let price = '0.00';
            if (parts.length > 1 && parts[1].trim()) {
                const parsedPrice = parseFloat(parts[1].trim().replace(',', '.'));
                if (!isNaN(parsedPrice)) {
                    price = parsedPrice.toFixed(2);
                }
            }
            return { name, price, originalOrder: index };
        });

        // ETAPA 2: Comparar a lista com os produtos APENAS DA PÁGINA ATUAL
        let productsToKeep = [];
        let itemsToAdd = new Map(sourceList.map(item => [normalizeString(item.name), item]));

        for (const product of currentPage.products) {
            const normalizedName = normalizeString(product.name);
            const match = findBestMatchInList(normalizedName, Array.from(itemsToAdd.values()));

            if (match) {
                // Se o produto da página atual está na lista, atualiza e mantém
                product.name = match.name;
                product.price = match.price;
                product.originalOrder = match.originalOrder;
                productsToKeep.push(product);
                // Remove da lista de "itens a adicionar"
                itemsToAdd.delete(normalizeString(match.name));
            }
        }

        // ETAPA 3: Preparar os novos produtos para serem adicionados
        const newProductPromises = Array.from(itemsToAdd.values()).map(item => new Promise(async (resolve) => {
            const dbMatchName = findBestMatchInDb(item.name);
            if (dbMatchName && productDatabase[dbMatchName]) {
                const dbProduct = productDatabase[dbMatchName];
                const img = new Image();
                img.onload = () => resolve({
    name: item.name, 
    price: item.price, 
    src: dbProduct.src, 
    image: img, 
    originalOrder: item.originalOrder,
    ...calculateSmartImageDefaults(img), // Aplica os padrões calculados
    backgroundColor: null, 
    descScaleX: 100, 
    descScaleY: 100, 
    priceScaleX: 100, 
    priceScaleY: 100
});
                img.onerror = () => resolve(null);
                img.src = dbProduct.src;
            } else {
                resolve(null);
            }
        }));
        
        const newProducts = await Promise.all(newProductPromises);
        const finalProductList = [...productsToKeep, ...newProducts.filter(Boolean)];
        
        // Reordena a lista final para corresponder à ordem da lista do textarea
        finalProductList.sort((a, b) => a.originalOrder - b.originalOrder);
        
        // ETAPA 4: Atualizar a página atual
        const deletedCount = currentPage.products.length - productsToKeep.length;
        currentPage.products = finalProductList;
        currentPage.manualLayout = generateAutoLayout(finalProductList.length);
        currentPage.settings.predefinedLayout = 'manual';

        // ETAPA 5: Finalização
        await switchPage(pageIndex);
        
        let summaryMessage = `Página ${pageIndex + 1} sincronizada!\n- ${finalProductList.length} produtos no total.\n- ${newProducts.filter(Boolean).length} produtos adicionados.\n- ${deletedCount} produtos foram excluídos.`;
        
        showSpinner(false);
        showAlert(summaryMessage);
        document.getElementById('descriptionUpdateTextarea').value = '';
    });
}

// Função auxiliar para encontrar a melhor correspondência em uma lista (necessária para a lógica acima)
function findBestMatchInList(queryName, list) {
    if (!queryName || list.length === 0) return null;
    const queryWords = new Set(normalizeString(queryName).split(' ').filter(Boolean));
    if (queryWords.size === 0) return null;

    let bestMatch = null;
    let highestScore = 0;

    for (const item of list) {
        const itemWords = new Set(normalizeString(item.name).split(' ').filter(Boolean));
        if (itemWords.size === 0) continue;
        const intersection = new Set([...queryWords].filter(word => itemWords.has(word)));
        const diceCoefficient = (2 * intersection.size) / (queryWords.size + itemWords.size);
        if (diceCoefficient > highestScore) {
            highestScore = diceCoefficient;
            bestMatch = item;
        }
    }
    if (highestScore > 0.6) return bestMatch;
    return null;
}
		
		
		
		// ▼▼▼ COLE ESTA FUNÇÃO DENTRO DA TAG <SCRIPT> ▼▼▼

// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'formatarLista' INTEIRA PELA VERSÃO ABAIXO ▼▼▼
// ▼▼▼ SUBSTITUA A SUA FUNÇÃO 'formatarLista' INTEIRA PELA VERSÃO ABAIXO ▼▼▼

function formatarLista() {
    const inputArea = document.getElementById('inputList');
    const outputArea = document.getElementById('outputList');
    const removePricesCheckbox = document.getElementById('removePricesToggle');
    const shouldRemovePrices = removePricesCheckbox.checked;

    const linhas = inputArea.value.split('\n');
    const resultado = [];

    for (const linha of linhas) {
        const trimmedLine = linha.trim();
        const pageMarkerRegex = /^P(G)?\s*\d+$/i;

        if (pageMarkerRegex.test(trimmedLine) || trimmedLine === '') {
            resultado.push(linha);
            continue;
        }

        let linhaFinal;

        if (shouldRemovePrices) {
            // LÓGICA NOVA: Remove o preço e tudo depois dele
            let descricao = trimmedLine;
            
            // Tenta encontrar um separador ( : ou ; )
            const separadorIndex = Math.min(
                trimmedLine.indexOf(':') > -1 ? trimmedLine.indexOf(':') : Infinity,
                trimmedLine.indexOf(';') > -1 ? trimmedLine.indexOf(';') : Infinity
            );

            if (separadorIndex !== Infinity) {
                // Se encontrou um separador, pega tudo antes dele
                descricao = trimmedLine.substring(0, separadorIndex);
            } else {
                // Se não, procura pelo padrão de preço (ex: 21,40 ou 21.40)
                const match = trimmedLine.match(/\d+([,.]\d{1,2})/);
                if (match && match.index > 0) {
                    // Se encontrou um preço, pega tudo antes dele
                    descricao = trimmedLine.substring(0, match.index);
                }
            }
            linhaFinal = descricao.trim();
        } else {
            // LÓGICA ORIGINAL: Formata para "Descrição; Preço"
            let descricao = '';
            let preco = '';
            let separadorIndex = linha.indexOf(':');
            if (separadorIndex === -1) {
                separadorIndex = linha.indexOf(';');
            }

            if (separadorIndex !== -1) {
                descricao = linha.substring(0, separadorIndex);
                let parteDoPreco = linha.substring(separadorIndex + 1);
                const match = parteDoPreco.match(/\d+([,.]\d{1,2})?/);
                if (match) preco = match[0];
                else descricao = linha;
            } else {
                const matches = [...linha.matchAll(/\d+([,.]\d{1,2})?/g)];
                if (matches.length > 0) {
                    const ultimoMatch = matches[matches.length - 1];
                    preco = ultimoMatch[0];
                    descricao = linha.substring(0, ultimoMatch.index);
                } else {
                    descricao = linha;
                }
            }

            descricao = descricao.replace(/R\$/gi, '').trim();
            if (preco) {
                linhaFinal = `${descricao}; ${preco}`;
            } else {
                linhaFinal = descricao.replace(/[:;]/g, '').trim();
            }
        }
        resultado.push(linhaFinal);
    }
    outputArea.value = resultado.join('\n');
}

// ▲▲▲ FIM DO BLOCO DE SUBSTITUIÇÃO ▲▲▲

// ▲▲▲ FIM DO BLOCO PARA COLAR ▲▲▲
		
		
		
		// ▼▼▼ ADICIONE ESTA NOVA FUNÇÃO AUXILIAR AO SEU SCRIPT ▼▼▼
/**
 * Converte uma string de imagem base64 (Data URL) em um objeto Blob.
 * @param {string} dataUrl - A string da imagem no formato base64.
 * @returns {Blob} O objeto Blob da imagem.
 */

// ▲▲▲ FIM DO BLOCO ▲▲▲
		
		
		
		
		// ▼▼▼ COLE ESTE BLOCO PARA REATIVAR O BOTÃO "APLICAR ESTILO MESTRE" ▼▼▼

if (masterPageSelect) {
    masterPageSelect.addEventListener('change', updateTargetPagesState);
}

if (applyMasterSettingsBtn) {
    applyMasterSettingsBtn.addEventListener('click', applyMasterSettingsToSelectedPages);
}

if (selectAllTargetsBtn) {
    selectAllTargetsBtn.addEventListener('click', () => {
        targetPagesContainer.querySelectorAll('input[type="checkbox"]:not(:disabled)').forEach(cb => cb.checked = true);
    });
}

if (deselectAllTargetsBtn) {
    deselectAllTargetsBtn.addEventListener('click', () => {
        targetPagesContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    });
}

// Também é importante popular os controles quando o painel de páginas é aberto
document.querySelector('a[data-panel="panel-pages"]').addEventListener('click', populateMasterPageControls);

// ▲▲▲ FIM DO BLOCO ▲▲▲
		
    </script>
</body>
</html>
